<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="루틴트래커">
    <link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>하루 루틴 트래커 v3.2</title>
    <style>
    @font-face {
        font-family: 'KBIZHanmaumMyungjo';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --bg-color: #f4f7f9;
        --primary-color: #4A90E2;
        --primary-dark: #3a7ac8;
        --primary-light: #eaf2fa;
        --text-color: #2c3e50;
        --text-color-light: #7f8c8d;
        --border-color: #dfe3e8;
        --container-bg: #ffffff;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --success-color: #2ecc71;
        --neutral-color: #95a5a6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'KBIZHanmaumMyungjo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 20px; color: var(--text-color); }
    button, input, select, textarea { font-family: inherit; }
    .container { 
        background: var(--container-bg); 
        border-radius: 20px; 
        padding: 50px 30px 100px 30px; /* 첫 번째 값(50px)이 상단 패딩 */
        width: 100%; 
        max-width: 500px; 
        margin: 0 auto; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
    }
    .header { text-align: center; margin-bottom: 25px; position: relative; }
    .header h1 { color: var(--text-color); font-size: 26px; font-weight: 700; margin-bottom: 8px; }
    .header p { color: var(--text-color-light); font-size: 14px; }
    #gameWarning { background: #fffbe6; color: #b77900; border: 1px solid #ffe58f; border-radius: 8px; padding: 10px; font-size: 14px; font-weight: 500; margin-bottom: 20px; display: none; }
    .page { display: none; }
    .page.active { display: block; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-nav { background: none; border: none; font-size: 24px; color: var(--text-color-light); cursor: pointer; padding: 10px; border-radius: 50%; transition: background 0.3s ease; }
    .month-nav:hover { background: var(--bg-color); }
    .month-year { font-size: 20px; font-weight: 700; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
    .calendar-header-cell { text-align: center; padding: 10px 5px; font-weight: 600; color: var(--text-color-light); font-size: 12px; }
    .calendar-cell { aspect-ratio: 1; display: grid; grid-template-rows: 1fr auto 1fr; padding: 2px; align-items: center; justify-items: center; position: relative }
    .cell-top-icons { grid-row: 1; display: flex; justify-content: center; gap: 2px; font-size: 9px; width: 100%; height: 100%; align-items: center; }
    .cell-day-number { grid-row: 2; font-weight: 500; }
    .calendar-cell.today .cell-day-number { font-weight: 700; }
    .cell-bottom-info { grid-row: 3; font-size: 8px; font-weight: 600; color: var(--text-color-light); width: 100%; text-align: left; padding-right: 4px; align-self: end; padding-bottom: 2px; }

    .calendar-cell.has-data .cell-bottom-info { color: rgba(255, 255, 255, 0.8); }
    .calendar-cell.off-day { background: #e9ecef; color: var(--neutral-color); }
    .off-day-indicator { position: absolute; top: 4px; right: 4px; font-size: 10px; }
    .calendar-cell:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .calendar-cell.other-month { color: #ccc; background: var(--bg-color); border-color: transparent; pointer-events: none; }
    .calendar-cell.today { border-color: var(--primary-color); font-weight: 700; color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
    .calendar-cell.has-data { color: white; border: none; font-weight: bold; }
    .calendar-cell.score-high { background: var(--success-color); }
    .calendar-cell.score-medium { background: var(--warning-color); }
    .calendar-cell.score-low { background: var(--danger-color); }
    .calendar-cell.score-negative { background: #34495e; }
    .score-indicator { position: absolute; bottom: 4px; right: 4px; font-size: 9px; background: rgba(0,0,0,0.25); color: white; padding: 1px 4px; border-radius: 4px; font-weight: 700; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'KBIZHanmaumMyungjo', sans-serif; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
    .main-actions { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .main-actions .btn { flex: 1; }
    .btn.secondary { background: var(--neutral-color); }
    .btn.secondary:hover { background: #7f8c8d; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-color); padding: 0; border-radius: 16px; width: 90%; max-width: 800px; max-height: 95vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    #dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px; }
    #dayModal .modal-body { padding: 25px; }
    .modal-layout { display: block; }
    @media (min-width: 768px) { .modal-layout { display: block; } }
    .modal-side-column { display: flex; flex-direction: column; }
    .modal-input-group { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
    .modal-input-group h4 { font-size: 16px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .modal-input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
    
    #commentDetails summary { font-weight: 600; color: var(--text-color); cursor: pointer; padding: 10px; border-radius: 8px; background-color: var(--bg-color); border: 1px solid var(--border-color); list-style: none; position: relative; padding-left: 30px; }
    #commentDetails summary::-webkit-details-marker { display: none; }
    #commentDetails summary::before { content: '▶'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 10px; transition: transform 0.2s; }
    #commentDetails[open] > summary::before { transform: translateY(-50%) rotate(90deg); }

    #dayModal .form-group { margin-bottom: 0; }
    #dayModal .form-group label { font-size: 13px; margin-bottom: 6px; }
    #dayModal .form-group input { padding: 10px; font-size: 16px; }
    #dayModal .modal-input-group,
    #dayModal .score-display-card { margin-bottom: 5px; }
    #dayModal .modal-layout > div:last-child { margin-bottom: 0; }
    .modal-header { display: flex; justify-content: center; align-items: center; position: relative; gap: 20px; }
    .modal-title { flex: none; text-align: center; margin: 0; }

    .date-nav-btn { background: none; border: none; font-size: 24px; color: var(--text-color-light); cursor: pointer; padding: 10px; border-radius: 50%; transition: all 0.2s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .date-nav-btn:hover { background: var(--bg-color); color: var(--text-color); }
    .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-color-light); line-height: 1; position: absolute; right: 0; top: 50%; transform: translateY(-50%); }
    .score-display-card { background: #fff; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-color); }
    .score-display-card .score { font-size: 40px; font-weight: 700; color: var(--primary-color); line-height: 1; }
    .score-display-card .score.is-off { color: var(--neutral-color); }
    .score-display-card div:last-child { font-size: 14px; color: var(--text-color-light); margin-top: 5px; }
    .exercise-toggle-group { margin-bottom: 15px; }
    .exercise-toggle-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .exercise-toggle-btns { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .exercise-toggle-btn { flex: 1; padding: 10px; border: none; background: #fff; cursor: pointer; font-weight: 600; transition: all 0.2s ease; font-size: 14px; }
    .exercise-toggle-btn.active { background: var(--success-color); color: #fff; }
    .legend { display: flex; justify-content: center; flex-wrap: wrap; margin: 20px 0 0; font-size: 12px; gap: 15px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    .goal-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .goal-tab { padding: 8px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
    .goal-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .goal-type-toggle { display: flex; gap: 5px; margin-bottom: 15px; }
    .goal-type-toggle button { flex: 1; padding: 8px; font-size: 14px; border: 1px solid var(--border-color); background: var(--bg-color); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
    .goal-type-toggle button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    #personalGoalsPage .header { text-align: left; }
    .dday-header-container { height: auto; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-start; position: absolute; top: 10px; left: 10px; right: 10px; z-index: 10; pointer-events: none; }
    .dday-chip { background: var(--primary-light); backdrop-filter: blur(5px); color: var(--primary-color); padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 11px; display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); pointer-events: all; border: 1px solid rgba(0,0,0,0.05); }
    .battery { display: none; width: 30px; height: 14px; border: 1.5px solid var(--text-color-light); border-radius: 4px; position: relative; padding: 1.5px; }
    .battery::after { content: ''; position: absolute; top: 50%; right: -4px; transform: translateY(-50%); width: 2px; height: 6px; background: var(--text-color-light); border-radius: 0 1px 1px 0; }
    .battery-level { height: 100%; border-radius: 2px; transition: width 0.3s ease; }
    .battery-level.green { background: var(--success-color); } .battery-level.yellow { background: var(--warning-color); } .battery-level.red { background: var(--danger-color); } .battery-level.black { background: var(--text-color); }
    .budget-summary { display: flex; gap: 10px; margin-bottom: 20px; }
    .budget-card { flex: 1; background: var(--primary-light); color: var(--primary-color); padding: 15px; border-radius: 12px; text-align: center; }
    .budget-card-title { font-size: 12px; opacity: 0.9; margin-bottom: 8px; font-weight: 600; }
    .budget-card-value { font-size: 22px; font-weight: 700; }
    #budgetPage .header p { font-size: 16px; font-weight: 600; color: var(--text-color); }
    .personal-goals-section { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
    #modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
    .personal-goal-checkbox { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); }
    .personal-goal-item { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
    .personal-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .personal-goal-name { font-weight: 600; }
    .personal-goal-actions button { padding: 5px 10px; border-radius: 6px; font-size: 12px; border: none; cursor: pointer; color: white; }
    .edit-btn { background: var(--warning-color); }
    .delete-btn { background: var(--danger-color); }
    .complete-btn { background: var(--success-color); }
    .reopen-btn { background: var(--primary-color); }
    .empty-goals { text-align: center; color: var(--text-color-light); padding: 40px 20px; background: var(--bg-color); border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color); }
    .budget-settings, .dday-settings { margin-bottom: 30px; }
    .budget-input, .dday-actions { display: flex; gap: 10px; align-items: center; }
    .dday-item { background: var(--bg-color); border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .budget-input button { padding: 12px 20px; background: var(--success-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .wakeup-prompt { background: var(--primary-light); color: var(--primary-color); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
    .monthly-summary { display: flex; justify-content: space-around; gap: 15px; margin-bottom: 30px; }
    .summary-card { flex-basis: 30%; background: var(--primary-light); color: var(--primary-color); padding: 20px; border-radius: 15px; text-align: center; }
    .summary-title { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 600; }
    .summary-value { font-size: 24px; font-weight: 700; }
    .week-card { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); }
    .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 600; }
    .week-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; font-size: 22px; font-weight: 600; }
    .empty-expenses { text-align: center; color: var(--text-color-light); padding: 40px 20px; }
    .feedback-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 2000; animation: fadeIn 0.3s ease; justify-content: center; align-items: center; }
    .feedback-content { position: relative; background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.5s ease; }
    .feedback-emoji { font-size: 60px; margin-bottom: 20px; display: block; }
    .feedback-title { font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #333; }
    .feedback-message { font-size: 16px; color: #666; line-height: 1.5; margin-bottom: 25px; }
    .feedback-celebration .feedback-title, .feedback-celebration .feedback-message, .feedback-reflection .feedback-title, .feedback-reflection .feedback-message, .feedback-disaster .feedback-title, .feedback-disaster .feedback-message, .feedback-encouragement .feedback-title, .feedback-encouragement .feedback-message, .feedback-warning .feedback-title, .feedback-warning .feedback-message { color: rgba(255,255,255,0.95); }
    .feedback-celebration { background: linear-gradient(135deg, #2ecc71, #28b463); } .feedback-reflection { background: linear-gradient(135deg, #f39c12, #e67e22); } .feedback-disaster { background: linear-gradient(135deg, #34495e, #2c3e50); } .feedback-encouragement { background: linear-gradient(135deg, #3498db, #2980b9); } .feedback-warning { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    .feedback-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 0 10px; }
    .feedback-btn:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }
    .feedback-budget-red { background: linear-gradient(135deg, #e74c3c, #c0392b) !important; }
    .feedback-budget-black { background: linear-gradient(135deg, #34495e, #2c3e50) !important; }
    .expense-input-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    .expense-input-row input { flex: 1; padding: 12px; font-size: 14px; border-radius: 8px; }
    .expense-input-row button { flex-shrink: 0; width: 44px; height: 44px; border-radius: 12px; background: var(--primary-color); border: none; color: white; font-weight: bold; cursor: pointer; font-size: 24px; line-height: 44px; transition: background 0.2s ease; }
    .expense-input-row button:hover { background: var(--primary-dark); }
    .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 14px; }
    .dday-settings h4 { margin-bottom: 15px; }
    .dday-item .dday-actions { display: flex; gap: 5px; }
    .dday-item .dday-actions button { background: none; border: 1px solid var(--border-color); width: 30px; height: 30px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.2s ease; color: var(--text-color-light); }
    .dday-item .dday-actions button:hover { background: var(--bg-color); color: var(--text-color); transform: scale(1.1); }
    .excel-option-item { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
    .excel-option-item input[type="radio"] { width: 18px; height: 18px; margin-right: 12px; }
    .excel-option-item label { font-size: 16px; }
    #customDateRange { display: flex; gap: 10px; align-items: center; margin-top: 10px; margin-bottom: 20px; }
    #customDateRange input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); flex: 1; font-family: inherit; }

    .number-input-group { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .number-input-group input { border: none; text-align: center; flex: 1; padding: 10px 5px; background: white; }
    .number-input-group input:focus { box-shadow: none; border: none; }
    .number-btn {
    width: 32px;
    height: 42px;
    border: none;
    background: var(--bg-color);
    color: var(--text-color);
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

        /* 숫자 입력 필드의 스핀 버튼 숨기기 */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .number-btn:hover { background: var(--primary-light); }
    .number-btn:active { background: var(--primary-color);  color: white; }

    .food-page-actions { display: flex; gap: 10px; margin-bottom: 10px; }
    .food-page-actions .btn.secondary.danger { background-color: var(--danger-color); color: white; }
    .food-date-header { display: flex; align-items: center; text-align: center; margin: 30px 0 10px; color: var(--text-color-light); }
    .food-date-header::before, .food-date-header::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
    .food-date-header span { padding: 0 15px; font-size: 13px; font-weight: 600; }
    .food-record-item { display: grid; grid-template-columns: 50px 30px 1fr auto; gap: 15px; align-items: center; padding: 14px 5px; border-bottom: 1px solid var(--bg-color); position: relative; }
    .food-record-item .food-admin-actions { position: absolute; right: 0px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .food-records.admin-mode .food-record-item .food-admin-actions { opacity: 1; pointer-events: auto; }
    .food-admin-actions button { background: none; border: 1px solid var(--border-color); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 13px; transition: background-color 0.2s; }
    .food-admin-actions button.edit { color: var(--warning-color); }
    .food-admin-actions button.delete { color: var(--danger-color); }
    .food-admin-actions button:hover { background-color: var(--bg-color); }
    
#foodExportModal .modal-content { max-width: 90vw; background: white; padding: 0; }
#foodExportPreview { background: white; border-radius: 8px; padding: 0; margin: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-family: 'Courier New', monospace; }
.food-receipt-header { padding: 15px 20px 10px; background: var(--primary-light); }
.food-receipt-title { display: block; text-align: center; margin-bottom: 5px; }
.food-receipt-title h3 { margin: 0; font-size: 16px; color: var(--primary-color); font-weight: 700; }
.food-receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
.food-receipt-divider {
    height: 1px;
    background: repeating-linear-gradient(
        to right,
        var(--border-color) 0px,
        var(--border-color) 3px,
        transparent 3px,
        transparent 6px
    );
    margin: 0 15px;
}
.food-receipt-items { padding: 15px 20px 10px; }
.food-receipt-date-header { font-weight: 700; color: var(--primary-color); font-size: 13px; margin: 15px 0 8px 0; padding-bottom: 5px; border-bottom: 1px dashed var(--border-color); }
.food-receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 13px; line-height: 1.3; }
.food-receipt-time { color: var(--text-color-light); font-size: 11px; min-width: 45px; margin-right: 10px; }
.food-receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 10px; }
.food-receipt-quantity { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 60px; }
#foodExportModal .close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.1);
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-size: 20px;
    color: var(--text-color);
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}

#foodExportModal .close-btn:hover { background: rgba(0, 0, 0, 0.2); }

@media (max-width: 767px) { #foodExportModal.modal-overlay { background: white; backdrop-filter: none; }
    
    #foodExportModal .modal-content { max-width: 100vw; width: 100vw; height: 100vh; margin: 0; padding: 0; border-radius: 0; box-shadow: none; }
    #foodExportPreview { margin: 0; border-radius: 0; box-shadow: none; height: calc(100vh - 50px); overflow-y: auto; }
    
    /* 닫기 버튼 */
    #foodExportModal .close-btn {
        position: fixed;                /* absolute → fixed */
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 22px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 1000;
    }
    
    /* 안내 텍스트 */
    #foodExportModal .modal-content > div:last-child { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid var(--border-color); } }
    .food-modal { max-width: 420px; background-color: white; overflow: hidden; }
    .food-modal .modal-header { padding: 15px 20px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
    .food-modal .modal-header h2 { font-size: 18px; }
    .food-modal .modal-body { padding: 20px; }
    .food-modal .form-group { margin-bottom: 15px; }
    .food-modal .form-group label { font-size: 13px; margin-bottom: 6px; }
    .food-modal .form-group input, .food-modal .form-group select { padding: 10px; font-size: 15px; }
    .food-modal .quantity-input { display: flex; gap: 8px; }
    .food-modal .quantity-input select { width: 90px; }
    .food-modal .food-modal-actions { margin-top: 20px; display: flex; gap: 10px; }
    .food-modal .food-modal-actions .btn { flex: 1; padding: 12px; }

    .fame-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
    .fame-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; }
    .fame-card-title { font-size: 18px; margin-bottom: 8px; }
    .fame-card-value { font-size: 20px; font-weight: 700; color: var(--primary-color); }
    .fame-card-date { font-size: 12px; color: var(--text-color-light); margin-top: 4px; }
    #wallOfShame .fame-card-value { color: var(--danger-color); }

    #modalCommentSection { margin-top: 20px; }
    #modalComment { width: 100%; margin-top: 15px; height: 80px; resize: vertical; font-size: 16px; }
    #modalPersonalGoalsList input[type="number"] { font-size: 16px; }

    .comment-history-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
    .comment-item { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 15px 20px; margin-bottom: 12px; }
    .comment-item-header { font-size: 13px; color: var(--text-color-light); font-weight: 600; margin-bottom: 10px; }
    .comment-item-body { font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
    .empty-comments { text-align: center; color: var(--text-color-light); padding: 50px 20px; background: var(--bg-color); border-radius: 12px; border: 1px solid var(--border-color); }
    
    .receipt-container { background: white; border-radius: 8px; padding: 0; margin-top: 0; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-family: 'Courier New', monospace; max-width: 100%; overflow: hidden; }
    .receipt-header { padding: 15px 20px 10px; background: var(--primary-light); }
    .receipt-title { display: block; text-align: center; margin-bottom: 5px; position: relative; }
    .receipt-title h3 { margin: 0; font-size: 16px; color: var(--primary-color); font-weight: 700; }
    .budget-info { display: flex; flex-direction: column; gap: 3px; font-size: 11px; color: var(--text-color); font-weight: 600; text-align: right; position: absolute; top: -5px; right: -8px; }
    .receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
    .receipt-divider { height: 1px; background: repeating-linear-gradient(to right, var(--border-color) 0px, var(--border-color) 3px, transparent 3px, transparent 6px); margin: 0 15px; }
    .receipt-items { padding: 15px 20px 10px; }
    .receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; font-size: 13px; line-height: 1.3; }
    .receipt-date { color: var(--text-color-light); font-size: 11px; min-width: 60px; margin-right: 15px; }
    .receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 15px; }
    .receipt-amount { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 70px; }
    .receipt-total { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg-color); font-weight: 700; font-size: 16px; font-family: 'Courier New', monospace; color: var(--primary-color); }

.calendar-cell.skeleton { background: #fafafa; border: 1px solid #f0f0f0; position: relative; overflow: hidden; }
.calendar-cell.skeleton::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
.calendar-cell.skeleton .cell-day-number { color: #d0d0d0; background: transparent; }
.calendar-cell.skeleton .cell-top-icons,
.calendar-cell.skeleton .cell-bottom-info { background: transparent; }
@keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }

/* 로딩 상태 표시 */
.loading-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-color-light);
    font-size: 12px;
    z-index: 10;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

    #dailyQuestModal .modal-header { padding-top: 25px; padding-bottom: 15px; }
    /* 퀘스트 페이지 스타일 */
    .quest-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .quest-tab { padding: 8px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
    .quest-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .quest-list { display: flex; flex-direction: column; gap: 10px; }
    .quest-item { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; transition: all 0.2s ease; }
    .quest-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .quest-item.completed { background: var(--success-color); color: white; border-color: var(--success-color); }
    .quest-item.completed .quest-reward { color: rgba(255,255,255,0.9); }
    .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quest-title { font-weight: 600; font-size: 14px; }
    .quest-reward { font-size: 12px; color: var(--primary-color); font-weight: 600; }
    .quest-desc { font-size: 13px; color: var(--text-color-light); margin-bottom: 10px; }
    .quest-progress { display: flex; justify-content: space-between; align-items: center; }
    .quest-progress-bar { flex: 1; height: 6px; background: var(--bg-color); border-radius: 3px; margin-right: 10px; overflow: hidden; }
    .quest-progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s ease; }
    .quest-progress-text { font-size: 11px; color: var(--text-color-light); min-width: 40px; text-align: right; }
    .quest-item.completed .quest-progress-bar { background: rgba(255,255,255,0.3); }
    .quest-item.completed .quest-progress-fill { background: rgba(255,255,255,0.8); }
    .quest-item.completed .quest-progress-text { color: rgba(255,255,255,0.9); }

    /* 보상 시스템 스타일 */
    #rewardsModal .modal-header { padding: 30px 25px 20px 25px; border-bottom: 1px solid var(--border-color); background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px; }
    .rewards-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
    .reward-item { background: #fff; border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
    .reward-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .reward-item.bronze { border-color: #CD7F32; background: linear-gradient(135deg, #FFF8DC, #F5F5DC); }
    .reward-item.silver { border-color: #C0C0C0; background: linear-gradient(135deg, #F8F8FF, #E6E6FA); }
    .reward-item.gold { border-color: #FFD700; background: linear-gradient(135deg, #FFFACD, #FFEFD5); }
    .reward-item.legend { border-color: #9400D3; background: linear-gradient(135deg, #F8F0FF, #E6E6FA); }
    .reward-item.used { opacity: 0.5; filter: grayscale(50%); }
    .reward-info { flex: 1; }
    .reward-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .reward-desc { font-size: 13px; color: var(--text-color-light); }
    .reward-tier { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; display: inline-block; }
    .reward-tier.bronze { background: #CD7F32; color: white; }
    .reward-tier.silver { background: #C0C0C0; color: white; }
    .reward-tier.gold { background: #FFD700; color: #333; }
    .reward-tier.legend { background: #9400D3; color: white; }
    .reward-actions { display: flex; gap: 8px; }
    .reward-btn { padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .reward-btn.use { background: var(--success-color); color: white; }
    .reward-btn.use:hover { background: #27ae60; }
    .reward-btn.delete { background: var(--danger-color); color: white; }
    .reward-btn.delete:hover { background: #c0392b; }
    .reward-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .empty-rewards { text-align: center; padding: 40px 20px; color: var(--text-color-light); }

    /* 프로필 메뉴 스타일 */
    .profile-menu-item:hover { background: var(--primary-light); color: var(--primary-color); }
    
    #profileWidget:hover { transform: translateY(-2px); }
    #profileWidget { transition: transform 0.2s ease; }

    .achievements-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
    .achievement-item { background: #fff; border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; transition: all 0.2s ease; }
    .achievement-item.unlocked { border-color: var(--success-color); background: linear-gradient(135deg, #f8fff8, #e8f5e8); }
    .achievement-item.locked { opacity: 0.6; }
    .achievement-emoji { font-size: 24px; min-width: 40px; text-align: center; }
    .achievement-info { flex: 1; }
    .achievement-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .achievement-desc { font-size: 13px; color: var(--text-color-light); }
    .achievement-status { font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
    .achievement-status.unlocked { background: var(--success-color); color: white; }
    .achievement-status.locked { background: var(--border-color); color: var(--text-color-light); }
    .achievement-item.hidden { background: linear-gradient(135deg, #2c3e50, #34495e); color: #ecf0f1; border-color: #34495e; }
    .achievement-item.hidden .achievement-desc { color: #bdc3c7; font-style: italic; }

    @media (max-width: 767px) {
        .modal-content { padding: 0; width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
        .food-modal { width: 90%; height: auto; border-radius: 16px; max-height: 90vh; }
        .food-modal .modal-body { overflow-y: auto; max-height: calc(90vh - 120px); }
        #dayModal .modal-body { padding: 20px 15px; }
        .modal-input-group { padding: 15px; }
        .modal-input-group h4 { font-size: 15px; }
        #dayModal .form-group label { font-size: 13px; }
        #dayModal .modal-input-row { grid-template-columns: 1fr; gap: 15px; }
        .exercise-toggle-btns { max-width: 180px; }
        .score-display-card, .personal-goals-section { width: 100%; max-width: none; margin: 0; padding: 15px; }
        .score-display-card .score { font-size: 36px; }

        #modalTotalExpense { text-align: left !important; }
        .expense-item { font-size: 13px; word-break: break-all; }
        .expense-item span:first-child { flex-grow: 1; margin-right: 10px; }
        .expense-item > div { flex-shrink: 0; }
        
        .modal-actions-container { padding: 0 15px 20px; display: flex; flex-direction: column; align-items: center; }
        .modal-actions-container .btn.delete { order: 2; background-color: transparent; color: var(--text-color-light); font-size: 14px; font-weight: normal; padding: 8px; box-shadow: none; margin-top: 10px; max-width: 150px; }
        .modal-actions-container .btn.delete:hover { background-color: transparent; color: var(--danger-color); }
        .modal-actions-container .btn.save { order: 1; }

        #budgetPage .budget-summary { flex-wrap: wrap; }
        #budgetPage .budget-summary .budget-card:first-child { flex-basis: 100%; }
        #budgetPage .budget-card-value { font-size: 20px; }
        #dayModal .expense-input-row { flex-direction: column; gap: 10px; }
        #dayModal .expense-input-row input,
        #dayModal .expense-input-row button { width: 100%; }
        .dday-header-container { top: 8px; left: 3px; right: 3px; }
        .container { padding: 40px 20px 95px 20px; }
        .dday-chip { font-size: 10px; padding: 3px 8px; }
        .battery { width: 25px; height: 12px; }
        .receipt-item { font-size: 12px; }
        .receipt-date { min-width: 50px; margin-right: 10px; font-size: 10px; }
        .receipt-desc { margin-right: 10px; }
        .receipt-amount { min-width: 60px; font-size: 12px; }
        .budget-info { flex-direction: column; gap: 2px; font-size: 10px; text-align: right; }
    }
    
    /* 영어 모드일 때 폰트 크기 조정 */
body.lang-en { font-size: 10px; }
body.lang-en .header h1 { font-size: 24px; }
body.lang-en .header p { font-size: 12px; }
body.lang-en .btn { font-size: 12px; }
body.lang-en .modal-content { font-size: 9px; }
body.lang-en .form-group label { font-size: 9px; }
body.lang-en .form-group input,
body.lang-en .form-group textarea,
body.lang-en .form-group select { font-size: 10px; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Profile Widget (Outside Container) -->
    <div id="profileWidget" style="position: fixed; bottom: 20px; left: 20px; z-index: 15; cursor: pointer;" onclick="showProfileMenu()">
        <div style="background: var(--container-bg); border-radius: 0; padding: 8px 12px; border: 3px solid var(--primary-color); min-width: 120px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span id="profileEmoji" style="font-size: 18px;">👾</span>
                <div>
                    <div id="profileLevel" style="font-size: 8px; font-weight: normal; color: var(--primary-color); text-transform: uppercase;">LV.1</div>
                    <div id="profileTitle" style="font-size: 12px; color: var(--text-color-light); text-transform: uppercase;">뉴비</div>
                </div>
            </div>
            <div style="background: var(--bg-color); border-radius: 0; height: 4px; overflow: hidden; border: 1px solid var(--border-color);">
                <div id="expBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); transition: width 0.3s ease;"></div>
            </div>
            <div id="expText" style="font-size: 9px; color: var(--text-color-light); text-align: center; margin-top: 2px; text-transform: uppercase;">0/10 EXP</div>
        </div>
    </div>

    <!-- Profile Menu (Dropdown) -->
    <div id="profileMenu" style="position: fixed; bottom: 100px; left: 20px; z-index: 16; display: none;">
        <div style="background: var(--container-bg); border-radius: 0; padding: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); border: 2px solid var(--border-color); min-width: 160px;">
            <div class="profile-menu-item" onclick="showQuestPage()" style="padding: 8px 12px; border-radius: 0; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; transition: background 0.2s ease; text-transform: uppercase;">
                <span>🎯</span> 퀘스트
            </div>
            <div class="profile-menu-item" onclick="showRewardsModal()" style="padding: 8px 12px; border-radius: 0; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; transition: background 0.2s ease; text-transform: uppercase;">
                <span>🎁</span> 보상 목록
            </div>
            <div class="profile-menu-item" onclick="showAchievementsModal()" style="padding: 8px 12px; border-radius: 0; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: background 0.2s ease; text-transform: uppercase;">
                <span>🏅</span> 업적
            </div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" style="position: fixed; bottom: 15px; right: 20px; text-align: right; z-index: 10;">
        <div id="userInfo" style="display: none; font-size: 6px; margin-bottom: 5px; text-transform: uppercase; color: var(--text-color-light);"></div>
        <button id="loginBtn" class="btn" style="padding: 5px 10px; font-size: 12px; text-transform: uppercase;">Google 로그인</button>
        <button id="logoutBtn" class="btn secondary" style="display: none; padding: 5px 10px; font-size: 12px; text-transform: uppercase;">로그아웃</button>
    </div>

    <div class="container">

        <!-- Goal Setup Page -->
        <div id="goalSetup" class="page">
             <div class="header"><h1>🎯 목표 설정</h1><p>시작이 반! 목표 기상 시간을 설정해주세요.</p></div>
             <div class="form-group">
                <label for="targetWakeTime">목표 기상 시간</label>
                <input type="text" id="targetWakeTime" placeholder="HH:MM (예: 07:30)">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">한 번 설정하면 자동으로 저장됩니다.</small>
            </div>
            <button class="btn" onclick="saveGoalAndContinue()">저장하고 시작하기</button>
        </div>
        
        <!-- Wake Up Prompt Page -->
        <div id="wakeUpPrompt" class="page">
            <div class="wakeup-prompt">
                <h2>🌅 좋은 아침이에요!</h2>
                <p id="wakeupDate"></p>
                <p>오늘의 기상 시간을 입력해주세요.</p>
            </div>
            <div class="form-group">
                <label for="promptWakeTime">실제 기상 시간</label>
                <input type="text" id="promptWakeTime" placeholder="HH:MM (예: 07:30)">
            </div>
            <button class="btn" onclick="saveWakeTimeFromPrompt()">저장하고 시작</button>
            <button class="btn secondary" onclick="skipToCalendar()" style="margin-top:10px;">나중에 입력</button>
        </div>

        <!-- Calendar Page -->
        <div id="calendarPage" class="page active">
            <div class="dday-header-container">
                <div id="ddayContainer" style="display: flex; flex-direction: column; gap: 3px; pointer-events:all; padding-left: 5px;"></div>
                <div class="dday-right-container" style="display: flex; align-items: center; gap: 10px; pointer-events:all; padding-right: 5px;">
                    <div id="budgetBarSmall" class="battery">
                        <div class="battery-level" id="budgetBarFillSmall"></div>
                    </div>
                </div>
            </div>
            <div class="header">
                <h1>🗓️ 루틴 캘린더</h1>
                <div id="gameWarning"></div>
                <div id="syncStatus" style="
                    position: absolute; 
                    top: 10px; 
                    right: 120px; 
                    font-size: 11px; 
                    color: var(--text-color-light);
                    background: rgba(255,255,255,0.9);
                    padding: 3px 8px;
                    border-radius: 12px;
                    display: none;
                    ">☁️ 동기화 중...</div>
            </div>
            <div class="calendar-header">
                <button class="month-nav" onclick="changeMonth(-1)"><</button>
                <div class="month-year" id="monthYear"></div>
                <button class="month-nav" onclick="changeMonth(1)">></button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="legend"><div class="legend-item"><div class="legend-color" style="background: var(--success-color)"></div><span>우수(80+)</span></div><div class="legend-item"><div class="legend-color" style="background: var(--warning-color)"></div><span>보통(40+)</span></div><div class="legend-item"><div class="legend-color" style="background: var(--danger-color)"></div><span>미흡(1+)</span></div><div class="legend-item"><div class="legend-color" style="background: #34495e"></div><span>최악(0미만)</span></div><div class="legend-item"><div class="legend-color" style="background: #e9ecef"></div><span>휴식일</span></div></div>
            <div class="main-actions" style="margin-top: 20px;">
                <button class="btn" onclick="showMonthlyStats()">통계</button>
                <button class="btn" onclick="showPersonalGoals()">목표</button>
            </div>
            <div class="main-actions" style="margin-top: 10px;">
                <button class="btn" onclick="showBudgetPage()">가계부</button>
                <button class="btn" onclick="showFoodPage()">식단</button>
            </div>
            <button class="btn secondary" onclick="showSettings()" style="margin-top:0px;">⚙️ 설정</button>
        </div>

        <!-- Day Modal -->
        <div id="dayModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="date-nav-btn" onclick="navigateModalDate(-1)"><</button>
                    <div class="modal-title" id="modalTitle"></div>
                    <button class="date-nav-btn" onclick="navigateModalDate(1)">></button>
                    <button class="close-btn" onclick="closeDayModal()">×</button>
                </div>
            <div class="modal-body">
            <div class="modal-layout">
    
    <!-- 1. 인생은 타이밍 -->
    <div class="modal-input-group">
        <h4>⏰ 인생은 타이밍</h4>
        <div class="modal-input-row">
            <div class="form-group"><label for="modalWakeTime">기상 시간</label><input type="text" id="modalWakeTime" placeholder="HH:MM"></div>
            <div class="form-group"><label for="modalSeatTime">착석 시간</label><input type="text" id="modalSeatTime" placeholder="HH:MM"></div>
            <div class="form-group"><label for="modalSleepTime">취침 시간</label><input type="text" id="modalSleepTime" placeholder="HH:MM (익일 1시→25:00)"></div>
        </div>
    </div>

    <!-- 2. 집중의 뽀모도로 -->
    <div class="modal-input-group">
        <h4>🍅 집중의 뽀모도로</h4>
        <div class="modal-input-row">
            <div class="form-group">
                <label for="modalMorningPomodoro">오전</label>
                <div class="number-input-group">
                    <button type="button" class="number-btn minus" onclick="adjustPomodoro('modalMorningPomodoro', -1)">−</button>
                    <input type="number" id="modalMorningPomodoro" min="0" value="0" readonly>
                    <button type="button" class="number-btn plus" onclick="adjustPomodoro('modalMorningPomodoro', 1)">+</button>
                </div>
            </div>
            <div class="form-group">
                <label for="modalAfternoonPomodoro">오후</label>
                <div class="number-input-group">
                    <button type="button" class="number-btn minus" onclick="adjustPomodoro('modalAfternoonPomodoro', -1)">−</button>
                    <input type="number" id="modalAfternoonPomodoro" min="0" value="0" readonly>
                    <button type="button" class="number-btn plus" onclick="adjustPomodoro('modalAfternoonPomodoro', 1)">+</button>
                </div>
            </div>
            <div class="form-group">
                <label for="modalEveningPomodoro">저녁</label>
                <div class="number-input-group">
                    <button type="button" class="number-btn minus" onclick="adjustPomodoro('modalEveningPomodoro', -1)">−</button>
                    <input type="number" id="modalEveningPomodoro" min="0" value="0" readonly>
                    <button type="button" class="number-btn plus" onclick="adjustPomodoro('modalEveningPomodoro', 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. 개인 목표 -->
    <div class="personal-goals-section modal-input-group">
        <h4>🎯 개인 목표</h4>
        <div id="modalPersonalGoalsList"></div>
    </div>

    <!-- 4. 자기계발 -->
    <div class="modal-input-group">
        <h4>💪 자기계발</h4>
        <div class="exercise-toggle-group">
            <label>오늘 운동했나요?</label>
            <div class="exercise-toggle-btns">
                <button id="exerciseBtnYes" class="exercise-toggle-btn" onclick="toggleExercise(true)">✔️ Yes</button>
                <button id="exerciseBtnNo" class="exercise-toggle-btn active" onclick="toggleExercise(false)">✖️ No</button>
            </div>
        </div>
        <div class="modal-input-row" style="align-items: flex-end;">
            <div class="form-group" id="modalExerciseTimeGroup" style="display: none; width: 100%;">
                <label for="modalExerciseMinutes">운동 시간 (분)</label>
                <input type="number" id="modalExerciseMinutes" min="0" value="0">
            </div>
            <div class="form-group" style="width: 100%;">
                <label for="modalWriting">글쓰기 (자)</label>
                <input type="text" id="modalWriting" value="0" inputmode="numeric" oninput="formatNumberWithCommas(this)">
            </div>
            <div class="form-group" style="width: 100%;">
                <label for="modalGameTime">게임 (분)</label>
                <input type="number" id="modalGameTime" min="0" value="0">
            </div>
        </div>
    </div>

    <!-- 5. 지출 기록 -->
    <div class="modal-input-group">
        <h4>💰 지출 기록</h4>
        <div id="modalTotalExpense" style="text-align: left; font-weight: 600; margin-bottom: 10px; color: var(--primary-color); font-size: 14px;"></div>
        <div id="modalExpenseList" class="expense-list"></div>
        <div class="expense-input-row">
            <input type="text" id="expenseDesc" placeholder="지출 내역">
            <input type="text" id="expenseAmount" placeholder="금액" inputmode="numeric" oninput="formatNumberWithCommas(this)">
            <button onclick="addExpense()">+</button>
        </div>
    </div>

    <!-- 6. 오늘의 점수 -->
    <div class="score-display-card">
        <div class="score" id="modalScore">0</div>
        <div>오늘의 점수</div>
    </div>

    <!-- 7. 오늘의 한마디 -->
    <div class="modal-input-group" id="modalCommentSection">
        <details id="commentDetails">
            <summary>💬 오늘의 한마디 남기기</summary>
                <textarea id="modalComment" placeholder="오늘 하루는 어땠나요? (최대 500자)" maxlength="500" oninput="updateCommentCounter()"></textarea>
                <div id="commentCharCounter" style="text-align: right; font-size: 12px; color: var(--text-color-light); margin-top: 5px;">0/500</div>
        </details>
    </div>

    <!-- 8. 오늘은 쉬기 -->
    <div class="modal-input-group">
        <div class="checkbox-group" style="display:flex; align-items:center; gap:10px; padding: 5px 0;">
            <input type="checkbox" id="modalOffDay" style="width:18px; height:18px;">
            <label for="modalOffDay" style="margin:0; font-weight:normal;">☕️ 오늘 쉬기 (Off Day)</label>
        </div>
    </div>
</div>
                </div>
                <div id="saveStatus" style="text-align: center; font-size: 12px; color: var(--text-color-light); height: 20px; margin-bottom: 5px;"></div>
                <div class="modal-actions-container">
                    <button class="btn save" onclick="finalizeDay()">오늘의 일정 종료</button>
                    <button class="btn delete" onclick="deleteModalData()">삭제</button>
                </div>
            </div>
        </div>
        
        <!-- Quest Page -->
        <div id="questPage" class="page">
            <div class="header">
                <h1>🧩 퀘스트</h1>
                <p>경험치를 획득하고 레벨업하세요!</p>
            </div>
            
            <!-- 퀘스트 탭 -->
            <div class="quest-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="quest-tab active" onclick="switchQuestTab('daily')">일간</button>
                <button class="quest-tab" onclick="switchQuestTab('weekly')">주간</button>
                <button class="quest-tab" onclick="switchQuestTab('monthly')">월간</button>
            </div>
            
            <!-- 일간 퀘스트 -->
            <div id="dailyQuestTab" class="quest-tab-content">
                <h3>🔖 오늘의 퀘스트 (5개)</h3>
                <div id="dailyQuestList" class="quest-list">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
                <div style="text-align: center; margin: 15px 0; font-size: 12px; color: var(--text-color-light);">
                    완료한 퀘스트마다 +2 경험치 획득!
                </div>
            </div>
            
            <!-- 주간 퀘스트 -->
            <div id="weeklyQuestTab" class="quest-tab-content" style="display: none;">
                <h3>🥏 이번 주 퀘스트 (8개)</h3>
                <div id="weeklyQuestList" class="quest-list">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
                <div style="text-align: center; margin: 15px 0; font-size: 12px; color: var(--text-color-light);">
                    완료한 퀘스트마다 +3~5 경험치 획득!
                </div>
            </div>
            
            <!-- 월간 퀘스트 -->
            <div id="monthlyQuestTab" class="quest-tab-content" style="display: none;">
                <h3>⛳ 이번 달 퀘스트</h3>
                <div id="monthlyQuestList" class="quest-list">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
                <div style="text-align: center; margin: 15px 0; font-size: 12px; color: var(--text-color-light);">
                    완료한 퀘스트마다 +7~10 경험치 획득!
                </div>
            </div>
            
            <button class="btn secondary" onclick="backToCalendar()" style="margin-top: 20px;">돌아가기</button>
        </div>

        <!-- Personal Goals Page -->
        <div id="personalGoalsPage" class="page">
            <div class="header">
                <h1>🎯 집중 목표</h1>
                <p>나만의 목표를 추가하고 달성률을 관리하세요.</p>
            </div>
            <div class="goal-tabs">
                <button class="goal-tab active" onclick="switchGoalTab('active')">진행 중</button>
                <button class="goal-tab" onclick="switchGoalTab('completed')">완료</button>
            </div>
            <div id="personalGoalsList" class="personal-goals-list"></div>
            <div class="modal-input-group" style="margin-top:20px;">
                <h4>새 목표 추가</h4>
                <div class="goal-type-toggle">
                    <button id="goalTypePositive" class="active" onclick="toggleGoalType('positive')">👍 늘리기 (Good Habits)</button>
                    <button id="goalTypeNegative" onclick="toggleGoalType('negative')">👎 줄이기 (Bad Habits)</button>
                </div>
                <div class="form-group">
                   <label for="newGoalName">목표 이름</label>
                   <input type="text" id="newGoalName" placeholder="예: 수학 문제집 풀기">
                </div>
                <div class="modal-input-row">
                    <div class="form-group">
                        <label for="newGoalTarget">목표량</label>
                        <input type="number" id="newGoalTarget" placeholder="예: 200" min="1">
                    </div>
                    <div class="form-group">
                        <label for="newGoalUnit">기간 (일)</label>
                        <input type="number" id="newGoalUnit" placeholder="예: 10" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="newGoalCustomUnit">단위</label>
                    <input type="text" id="newGoalCustomUnit" placeholder="예: 쪽, 분, 개">
                </div>
                <button class="btn" onclick="addPersonalGoal()">목표 추가</button>
            </div>
            <button class="btn secondary" onclick="backToCalendar()" style="margin-top:20px;">돌아가기</button>
        </div>

        <!-- Budget Page -->
        <div id="budgetPage" class="page">
            <div id="expenseList" class="expense-list-page"></div>
            <button class="btn secondary" onclick="backToCalendar()" style="margin-top: 30px;">돌아가기</button>
        </div>

                <!-- Food Page -->
                <div id="foodPage" class="page">
                    <div class="header">
                        <h1>🍽️ 식단 기록</h1>
                        <p>오늘 뭘 드셨나요?</p>
                    </div>
        
                    <!-- 컨트롤 버튼 -->
                    <div class="food-page-actions">
                        <button class="btn" onclick="showAddFoodModal()">+ 식단 추가</button>
                        <button class="btn secondary" onclick="toggleFoodManageMode()" id="foodManageBtn">🔧 관리</button>
                    </div>
        
                    <!-- 식단 기록이 표시될 영역 -->
                    <div id="foodRecordsList" class="food-records"></div>
        
                    <!-- [위치 변경] 내보내기 버튼을 식단 목록 아래, 돌아가기 버튼 위로 이동 -->
                    <div class="main-actions" style="margin-top: 30px; margin-bottom: 10px;">
                         <button class="btn" onclick="exportFoodAsImage()" style="background-color: var(--primary-dark);">📸 이미지로 내보내기</button>
                    </div>
        
                    <!-- 돌아가기 버튼 -->
                    <button class="btn secondary" onclick="backToCalendar()">돌아가기</button>
                </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="header"><h1>⚙️ 설정</h1></div>
            <div class="form-group"><label for="settingsWakeTime">☀️ 목표 기상 시간</label><input type="text" id="settingsWakeTime" placeholder="HH:MM (예: 07:30)"></div>
            <div class="budget-settings form-group">
                <label for="monthlyBudgetInput">💰 월 예산 설정</label>
                <input type="text" id="monthlyBudgetInput" placeholder="월 예산 (원)" inputmode="numeric" oninput="formatNumberWithCommas(this)">
            </div>
            <div class="form-group">
                <label for="partnerEmailInput">🤝 책임 공유 파트너 이메일</label>
                <input type="email" id="partnerEmailInput" placeholder="주간 리포트를 받을 파트너의 이메일">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">주간 평균 점수가 40점 미만일 경우, 파트너에게 자동으로 성과 보고서가 발송됩니다.</small>
            </div>
            <div class="dday-settings form-group">
                <label>⏰ D-Day 설정</label>
                <div id="ddaySettingsList" class="dday-settings-list"></div>
                <button id="addDdayBtn" class="btn secondary" onclick="addDday()" style="margin-top: 10px;">D-Day 추가</button>
            </div>
            <button class="btn" onclick="updateSettings()" style="margin-top:20px;">설정 저장</button>
            <button class="btn secondary" onclick="showCommentHistory()" style="margin-top:10px;">💬 나의 기록들 보기</button>
            <button class="btn secondary" onclick="openExcelModal()" style="margin-top:10px;">📈 엑셀로 내보내기</button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn secondary" onclick="exportData()" style="flex: 1;">데이터 내보내기 (백업)</button>
                <button class="btn secondary" onclick="document.getElementById('importFile').click()" style="flex: 1;">데이터 불러오기 (복구)</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" onclick="syncAllToFirebase()" style="flex: 1;">☁️ 클라우드 백업</button>
                <button class="btn secondary" onclick="loadFromFirebase()" style="flex: 1;">📥 클라우드에서 복원</button>
            </div>
            <button class="btn secondary" onclick="backToCalendar()" style="margin-top:10px;">돌아가기</button>
            
            <!-- 숨겨진 개발자 도구 -->
            <div id="devTools" style="display: none; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #e74c3c;">
                <h4 style="margin: 0 0 15px 0;">🔧 시크릿 개발자 도구</h4>
                <p style="font-size: 12px; opacity: 0.8; margin-bottom: 15px;">제목을 5번 연속 클릭하면 나타납니다</p>
                
                <!-- 테마 & 언어 섹션 -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <h5 style="margin: 0 0 10px 0; font-size: 14px;">🎨 테마 & 언어</h5>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button onclick="changeTheme('light')" style="background: #f8f9fa; color: #333; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">라이트</button>
                        <button onclick="changeTheme('dark')" style="background: #343a40; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">다크</button>
                        <button onclick="changeTheme('excel')" style="background: #00ff41; color: black; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">엑셀</button>
                        <button onclick="changeTheme('sakura')" style="background: #ec4899; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">벚꽃</button>
                        <button onclick="changeTheme('paperbook')" style="background: #2563eb; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">페이퍼북</button>
                        <button onclick="changeTheme('nature')" style="background: #256c2f; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">자연</button>
                        <button onclick="changeTheme('military')" style="background: #323238; color: rgba(255, 255, 255, 0.758); padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">밀리터리</button>
                    </div>
                    <button onclick="toggleLanguage()" style="background: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">🌐 언어 전환 (<span id="currentLangDisplay">한국어</span>)</button>
                </div>
                
                <!-- 기존 개발자 도구들 -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button onclick="resetQuests()" style="background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">🗑️ 퀘스트 리셋</button>
                    <button onclick="resetExperience()" style="background: #f39c12; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">⚡ 경험치 리셋</button>
                    <button onclick="resetAchievements()" style="background: #e67e22; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">🏅 업적 리셋</button>
                    <button onclick="resetAll()" style="background: #8e44ad; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">💀 전체 리셋</button>
                    <button onclick="testPersonalGoalAchievements()" style="background: #9b59b6; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">🎯 목표 업적 테스트</button>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="addExperience(100, '개발자 치트')" style="background: #27ae60; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">🎁 +100 EXP</button>
                    <button onclick="addExperience(1000, '개발자 대박치트')" style="background: #16a085; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">💎 +1000 EXP</button>
                    <button onclick="toggleDevTools()" style="background: #95a5a6; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">👻 숨기기</button>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(231, 76, 60, 0.2); border-radius: 8px;">
                    <small>⚠️ <strong>주의:</strong> 이 기능들은 되돌릴 수 없습니다. 신중하게 사용하세요!</small>
                </div>
            </div>
        
        </div> <!-- 이 태그가 settingsPage의 닫는 태그입니다. -->

        <!-- Monthly Stats Page -->
        <div id="monthlyStatsPage" class="page">
            <div class="header">
                <h1>📊 월간통계</h1>
                <p id="statsMonth"></p>
            </div>
            <div class="monthly-summary">
                <div class="summary-card">
                    <div class="summary-title">평균 점수</div>
                    <div class="summary-value" id="avgScore">📈 0점</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">개인목표 달성률</div>
                    <div class="summary-value" id="avgGoalRate">😐 0%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">글쓰기 완성</div>
                    <div class="summary-value" id="writingBooks">📖 0권</div>
                </div>
            </div>
            <div class="hall-of-fame-container" style="margin-bottom: 30px;">
                <h3 style="text-align: center; margin-bottom: 15px;">🏆 명예의 전당 🏆</h3>
                <div id="hallOfFame" class="fame-grid">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
            </div>
            
            <div class="wall-of-shame-container" style="margin-bottom: 30px;">
                <h3 style="text-align: center; margin-bottom: 15px;">🧱 반성의 벽 🧱</h3>
                <div id="wallOfShame" class="fame-grid">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
            </div>
            <div id="weeklyDetails" class="weekly-details"></div>
            <button class="btn secondary" onclick="backToCalendar()">돌아가기</button>
        </div>
        
        <!-- Feedback and Reason Modals -->
        <div id="feedbackPopup" class="feedback-popup"> <div class="feedback-content"><div class="feedback-emoji" id="feedbackEmoji">🎉</div><div class="feedback-title" id="feedbackTitle"></div><div class="feedback-message" id="feedbackMessage"></div><div style="margin-top: 20px;"><button class="feedback-btn" onclick="closeFeedbackPopup()">확인</button></div></div></div>
        <div id="reasonModal" class="modal-overlay"> <div class="modal-content" style="background:white; padding: 25px;"><div class="modal-header"><h2 class="modal-title">주간 성찰</h2><button class="close-btn" onclick="closeReasonModal()">×</button></div><p style="margin-bottom: 15px; color: #555;">이번 주 평균 점수가 25점 미만입니다. 성과가 저조했던 이유를 솔직하게 적어주세요.</p><div class="form-group"><textarea id="reasonText" rows="5" placeholder="예: 회사 프로젝트 마감 때문에 너무 바빴어요."></textarea></div><button class="btn" onclick="submitReason()">제출하고 피드백 받기</button></div></div>
        
        <!-- Comment History Page -->
        <div id="commentHistoryPage" class="page">
            <div class="header">
                <h1>💬 나의 기록들</h1>
                <p>내가 남긴 하루의 흔적들</p>
            </div>
            <div id="commentHistoryList" class="comment-history-list">
                <!-- JS로 내용이 채워질 예정 -->
            </div>
            <button class="btn secondary" onclick="showSettings()" style="margin-top:20px;">돌아가기</button>
        </div>

        <!-- Excel Export Modal -->
        <div id="excelExportModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 class="modal-title">엑셀 데이터 내보내기</h2>
                    <button class="close-btn" onclick="closeExcelModal()">×</button>
                </div>
                <div style="padding: 25px;">
                    <p style="margin-bottom: 15px; color: #555;">내보낼 데이터의 기간을 선택해주세요.</p>
                    <div id="periodSelector">
                        <div class="excel-option-item"><input type="radio" id="periodThisMonth" name="period" value="thisMonth" checked onchange="toggleDateInputs(false)"><label for="periodThisMonth">이번 달</label></div>
                        <div class="excel-option-item"><input type="radio" id="periodLastMonth" name="period" value="lastMonth" onchange="toggleDateInputs(false)"><label for="periodLastMonth">지난달</label></div>
                        <div class="excel-option-item"><input type="radio" id="periodAllTime" name="period" value="allTime" onchange="toggleDateInputs(false)"><label for="periodAllTime">전체 기간</label></div>
                        <div class="excel-option-item"><input type="radio" id="periodCustom" name="period" value="custom" onchange="toggleDateInputs(true)"><label for="periodCustom">기간 직접 선택</label></div>
                    </div>
                    <div id="customDateRange" style="display: none;"><input type="date" id="startDate"><span>~</span><input type="date" id="endDate"></div>
                    <button class="btn" onclick="exportToExcel()" style="margin-top: 20px;">확인 및 내보내기</button>
                </div>
            </div>
        </div>
    </div>

        <!-- [컴팩트 모달] Food Modals (키워드/수동) -->
        <div id="foodSuggestionModal" class="modal-overlay">
            <div class="modal-content food-modal">
                <div class="modal-header"><h2 class="modal-title">🍽️ 식단 기록</h2><button class="close-btn" onclick="closeFoodSuggestion()">×</button></div>
                <div class="modal-body">
                    <p style="text-align:center; color: var(--text-color-light); margin-bottom: 20px;">지출 내역에 음식 관련 키워드가 감지되었어요!</p>
                    <div class="form-group"><label for="foodNameInput">무엇을 드셨나요?</label><input type="text" id="foodNameInput" placeholder="예: 아메리카노"></div>
                    <div class="form-group"><label for="foodQuantityInput">얼마나 드셨나요?</label><div class="quantity-input"><input type="text" id="foodQuantityInput" placeholder="1" inputmode="decimal"><select id="foodUnitSelect"><option>개</option><option>잔</option><option>ml</option><option>g</option><option>봉지</option><option>조각</option><option>그릇</option><option>인분</option><option>병</option></select></div></div>
                    <div class="food-modal-actions"><button class="btn" onclick="saveFoodRecord()">식단 저장</button><button class="btn secondary" onclick="closeFoodSuggestion()">취소</button></div>
                </div>
            </div>
        </div>
    
        <div id="manualFoodModal" class="modal-overlay">
            <div class="modal-content food-modal">
                <div class="modal-header"><h2 class="modal-title" id="manualFoodModalTitle">🍽️ 식단 기록 추가</h2><button class="close-btn" onclick="closeManualFoodModal()">×</button></div>
                <div class="modal-body">
                    <div class="form-group"><label for="manualFoodDate">날짜</label><input type="date" id="manualFoodDate"></div>
                    <div class="form-group"><label for="manualFoodTime">시간</label><input type="time" id="manualFoodTime"></div>
                    <div class="form-group"><label for="manualFoodName">무엇을 드셨나요?</label><input type="text" id="manualFoodName" placeholder="예: 닭가슴살 샐러드"></div>
                    <div class="form-group"><label for="manualFoodQuantity">얼마나 드셨나요?</label><div class="quantity-input"><input type="text" id="manualFoodQuantity" placeholder="1" inputmode="decimal"><select id="manualFoodUnit"><option>개</option><option>잔</option><option>ml</option><option>g</option><option>봉지</option><option>조각</option><option>그릇</option><option>인분</option><option>병</option></select></div></div>
                    <div class="food-modal-actions"><button class="btn" onclick="saveManualFoodRecord()">식단 저장</button><button class="btn secondary" onclick="closeManualFoodModal()">취소</button></div>
                </div>
            </div>
        </div>

        <!-- Gacha Modal -->
    <div id="gachaModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; background: white;">
            <div class="modal-header">
                <h2 class="modal-title">🎰 레벨업 보상 뽑기</h2>
                <button class="close-btn" onclick="closeGachaModal()">×</button>
            </div>
            <div style="padding: 25px; text-align: center;">
                <div id="gachaContent">
                    <p style="font-size: 16px; margin-bottom: 20px; color: var(--text-color);">
                        레벨업을 축하합니다! 🎊<br>
                        특별한 보상을 획득할 기회입니다!
                    </p>
                    
                    <div style="background: var(--bg-color); border-radius: 12px; padding: 20px; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                            <div><span style="color: #CD7F32;">●</span> 브론즈 70%</div>
                            <div><span style="color: #C0C0C0;">●</span> 실버 25%</div>
                            <div><span style="color: #FFD700;">●</span> 골드 4%</div>
                            <div><span style="color: #9400D3;">●</span> 레전드 1%</div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="executeGacha()" style="font-size: 18px; padding: 15px 30px;">
                        🎰 뽑기 실행!
                    </button>
                </div>
                
                <div id="gachaResult" style="display: none;">
                    <div id="gachaResultCard" style="background: linear-gradient(135deg, #CD7F32, #A0522D); color: white; border-radius: 16px; padding: 30px; margin: 20px 0;">
                        <div id="gachaResultEmoji" style="font-size: 60px; margin-bottom: 15px;">🎁</div>
                        <div id="gachaResultTier" style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">BRONZE</div>
                        <div id="gachaResultName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">보상 이름</div>
                        <div id="gachaResultDesc" style="font-size: 14px; opacity: 0.9;">보상 설명</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="useRewardNow()" id="useNowBtn">지금 사용</button>
                        <button class="btn secondary" onclick="saveForLater()">나중에 사용</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Inventory Modal -->
    <div id="rewardsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; background: white;">
            <div class="modal-header">
                <h2 class="modal-title">🎁 보상 목록</h2>
                <button class="close-btn" onclick="closeRewardsModal()">×</button>
            </div>
            <div style="padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>보유한 보상들</h3>
                    <div id="availableGachaCount" style="background: var(--primary-light); color: var(--primary-color); padding: 8px 12px; border-radius: 8px; font-weight: 600;">
                        뽑기 기회: 0회
                    </div>
                </div>
                
                <div id="rewardsList" class="rewards-list">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn secondary" onclick="closeRewardsModal()">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; background: white;">
            <div class="modal-header" style="padding: 30px 25px 20px 25px; border-bottom: 1px solid var(--border-color);">
                <h2 class="modal-title">🏅 업적 목록</h2>
                <button class="close-btn" onclick="closeAchievementsModal()">×</button>
            </div>
            <div style="padding: 25px;">
                <div id="achievementsList" class="achievements-list">
                    <!-- JS로 내용이 채워질 예정 -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn secondary" onclick="closeAchievementsModal()">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Food Export Modal for Image Capture -->
    <div id="foodExportModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeFoodExportModal()">×</button>
            <div id="foodExportPreview">
                <!-- 여기에 내보낼 식단 기록이 렌더링됩니다. -->
            </div>
            <div style="padding: 20px; text-align: center;">
                <p style="color: var(--text-color-light); font-size: 14px; margin: 0;">이 화면을 캡처하여 저장하거나 공유하세요!</p>
            </div>
        </div>
    </div>

    <!-- Daily Quest Modal -->
<div id="dailyQuestModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px; background: white;">
        <div class="modal-header">
            <h2 class="modal-title">🔖 오늘의 퀘스트</h2>
            <!-- "X" 버튼 클릭 시, 오늘 다시 보지 않도록 설정 -->
            <button class="close-btn" onclick="closeDailyQuestModal(true)">×</button>
        </div>
        <div style="padding: 25px;">
            <p style="font-size: 14px; color: var(--text-color-light); margin-bottom: 20px; text-align: center;">
                퀘스트를 완료하여 경험치를 획득하세요!
            </p>
            <div id="dailyQuestModalList" class="quest-list">
                <!-- JS로 내용이 채워질 예정 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <!-- "확인" 버튼은 단순히 창만 닫음 -->
                <button class="btn" onclick="closeDailyQuestModal(false)">확인</button>
                <!-- "전체 퀘스트 보기" 클릭 시, 창을 닫고 오늘 다시 보지 않도록 설정 -->
                <button class="btn secondary" onclick="openQuestPage(); closeDailyQuestModal(true);">전체 퀘스트 보기</button>
            </div>
        </div>
    </div>
</div>

    <script>
        // IndexedDB 관리 클래스
class IndexedDBManager {
    constructor() {
        this.dbName = 'RoutineTrackerDB';
        this.version = 1;
        this.db = null;
    }
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('data')) {
                    db.createObjectStore('data', { keyPath: 'key' });
                }
            };
        });
    }
    
    async set(key, value) {
        const transaction = this.db.transaction(['data'], 'readwrite');
        const store = transaction.objectStore('data');
        return store.put({ key, value, timestamp: Date.now() });
    }
    
    async get(key) {
        const transaction = this.db.transaction(['data'], 'readonly');
        const store = transaction.objectStore('data');
        const result = await new Promise((resolve) => {
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
        });
        return result ? result.value : null;
    }
    
    async getAll() {
        const transaction = this.db.transaction(['data'], 'readonly');
        const store = transaction.objectStore('data');
        return new Promise((resolve) => {
            const request = store.getAll();
            request.onsuccess = () => {
                resolve(request.result.map(item => ({ key: item.key, value: item.value })));
            };
        });
    }
    
    async delete(key) {
        const transaction = this.db.transaction(['data'], 'readwrite');
        const store = transaction.objectStore('data');
        return store.delete(key);
    }
}

const localDB = new IndexedDBManager();
let syncQueue = new Set(); // 동기화 대기 큐
        
        // 레벨 시스템 데이터 구조
const LEVEL_SYSTEM = {
    // 레벨별 필요 경험치 (2배씩 증가)
    getRequiredExp: (level) => {
        if (level <= 1) return 10;
        return 10 * Math.pow(2, level - 1);
    },
    
    // 경험치로 레벨 계산
    calculateLevel: (totalExp) => {
        let level = 1;
        let requiredExp = 0;
        
        while (totalExp >= requiredExp + LEVEL_SYSTEM.getRequiredExp(level)) {
            requiredExp += LEVEL_SYSTEM.getRequiredExp(level);
            level++;
        }
        
        return {
            level: level,
            currentExp: totalExp - requiredExp,
            maxExp: LEVEL_SYSTEM.getRequiredExp(level),
            totalExp: totalExp
        };
    }
};

// 프로필 정보 (레벨별 이모티콘과 타이틀)
const PROFILE_DATA = {
    1: { emoji: '👶', title: '루틴 갓난아기', subtitle: '아무것도 모르는 상태에서 시작하는 루틴의 첫걸음!' },
    3: { emoji: '👧', title: '명랑한 소녀', subtitle: '세상 밖으로 나온 당신, 이제 퀘스트를 찾아 떠날 시간입니다!' },
    5: { emoji: '🚶‍♀️', title: '풋내기 모험가', subtitle: '어색한 발걸음이지만, 한 걸음씩 나아가면 됩니다.' },
    8: { emoji: '🧑‍🎓', title: '호그와트 입학생', subtitle: '당신에게 마법사로서의 자질이 보이는군요! 🧙‍♀️' },
    12: { emoji: '👩‍🎓', title: '그리핀도르 용사', subtitle: '용감하고 대담한 정신으로 루틴에 임하세요!' },
    16: { emoji: '🧙‍♀️', title: '마법부 유능한 오러', subtitle: '어둠의 마법사처럼 당신의 나태함을 추적하세요!' },
    20: { emoji: '🏹', title: '하이랄의 신입 용사', subtitle: '젤다 공주가 당신을 기다립니다. ⚔️' },
    25: { emoji: '🌲', title: '숲의 현자', subtitle: '코로그를 모두 찾을 기세로 숨겨진 루틴을 발견하세요.' },
    30: { emoji: '⚡', title: '재앙 가논 격파자', subtitle: '모든 난관을 극복하고 마침내 재앙을 물리쳤습니다!' },
    35: { emoji: '📝', title: '파이어 엠블렘 전학생', subtitle: '새로운 학급에서 당신의 빛을 보여줄 시간입니다!' },
    40: { emoji: '⚔️', title: '청사자반 지휘관', subtitle: '디미트리와 함께 최강의 학급을 만드세요! 🛡️' },
    45: { emoji: '🦅', title: '흑수리반 지휘관', subtitle: '에델가르트의 길을 따를 것인가, 말 것인가! ⚔️' },
    50: { emoji: '🐉', title: '금사슴반 지휘관', subtitle: '클로드와 함께 비책으로 승리하세요! 🏹' },
    55: { emoji: '🪖', title: '콜 오브 듀티 신병', subtitle: '전장에 오신 것을 환영합니다. 생존이 최우선입니다.' },
    60: { emoji: '💥', title: 'SAS 베테랑 병사', subtitle: '프라이스 대위가 당신의 실력을 인정합니다.' },
    65: { emoji: '🎖️', title: '최정예 오퍼레이터', subtitle: '가장 위험한 임무를 완수하는 당신은 전설입니다.' },
    70: { emoji: '✨', title: '발더스 게이트의 드루이드', subtitle: '자연의 힘으로 당신의 루틴을 수호하세요! 🌿' },
    75: { emoji: '⚖️', title: '명예로운 팔라딘', subtitle: '정의로운 루틴으로 선을 실천하는 수호자입니다!' }, 
    80: { emoji: '🎭', title: '전설의 바드', subtitle: '음악과 이야기로 사람들의 루틴에 영감을 주는 자! 🎶' }, 
    85: { emoji: '🕵️‍♀️', title: '어둠 속의 로그', subtitle: '숨겨진 루틴 함정을 찾아내고 영리하게 회피합니다!' }, 
    90: { emoji: '👑', title: '페이룬의 여왕', subtitle: '발더스 게이트 대륙을 평정한 루틴의 지배자!' }, 
    95: { emoji: '🗡️', title: '전설의 영웅', subtitle: '모든 게임 세계관을 아우르는 루틴의 궁극적인 영웅!' }, 
    100: { emoji: '🌌', title: '루틴 세계관 창조자', subtitle: '당신은 루틴이라는 장르를 개척한 진정한 개척자입니다.' } 
};

// 퀘스트 정의
const QUEST_DEFINITIONS = {
    daily: [
    { id: 'attendance', title: '✅ 출석하기', desc: '기상 시간을 입력하세요', reward: 2 },
    { id: 'pomodoro_3', title: '🍅 뽀모도로 3개 달성', desc: '집중의 뽀모도로를 3개 이상 완료하세요', reward: 2 },
    { id: 'sleep_time', title: '💤 취침시간 입력하기', desc: '취침 시간을 기록하세요', reward: 2 },
    { id: 'seat_time', title: '🪑 착석시간 입력하기', desc: '착석 시간을 기록하세요', reward: 2 },
    { id: 'writing_300', title: '✍️ 글쓰기 300자 이상', desc: '300자 이상 글을 써보세요', reward: 2 },
    { id: 'exercise_10min', title: '💪 운동 10분 이상', desc: '10분 이상 운동하세요', reward: 2 },
    { id: 'personal_goal_50', title: '🎯 개인목표 평균 50% 달성', desc: '개인 목표를 50% 이상 달성하세요', reward: 2 },
    { id: 'expense_under_10k', title: '💰 지출 ₩10,000 이하', desc: '하루 지출을 1만원 이하로 관리하세요', reward: 2 },
    { id: 'food_record_1', title: '🍽️ 식단 기록 1회 이상', desc: '식단을 1회 이상 기록하세요', reward: 2 },
    { id: 'daily_comment', title: '📝 오늘의 한마디 작성', desc: '하루를 돌아보며 한마디 남겨보세요', reward: 2 },
    { id: 'game_under_60min', title: '🎮 게임시간 60분 이하', desc: '게임 시간을 60분 이하로 관리하세요', reward: 2 },
    { id: 'wake_on_time_1hour', title: '🌅 목표시간 ±1시간 내 기상', desc: '목표 기상 시간 전후 1시간 이내에 일어나세요', reward: 2 },
    { id: 'no_negative_score_today', title: '✨ 마이너스 점수 피하기', desc: '오늘 루틴 점수가 0점 아래로 떨어지지 않게 관리하세요.', reward: 2 }
    ],
    
    weekly: [
    { id: 'weekly_attendance_6days', title: '📅 주간 출석 6일', desc: '출석 체크하다 보면 꼭 하나쯤은 빠지죠. 근데 청사자반은, 그거 놓치면 분위기 싸해졌습니다.', reward: 6 }, //기상 시간 입력으로 출석 체크
{ id: 'weekly_early_sleep_4times', title: '🌙 01:00 이전 취침 4회', desc: '링크는 전투 전에 반드시 쉼을 챙겼습니다. 하이랄을 구하는 건 피로한 상태론 어렵거든요.', reward: 4 },
{ id: 'weekly_no_game_weekend', title: '🎮 주말 디지털 디톡스', desc: '젤다는 기다리면서도 한 마디도 안 했습니다. 그 침묵, 우리 양심에 맡겨볼까요.', reward: 7 },
{ id: 'weekly_expense_under_100k', title: '💰 주간 지출 ₩100,000 이하', desc: '한때 크로커다일도 재정관리를 했답니다. 무너진 조직, 돈부터 다시 챙겼거든요.', reward: 5 },
{ id: 'weekly_high_score_5days', title: '✨ 주간 우수생 (5일)', desc: '선생님들 사이에서 “요즘 얘 좀 해” 소리 들으려면, 딱 5일이면 충분했습니다.', reward: 6 }, //일일 루틴 점수 50점 이상 5번
{ id: 'weekly_no_fastfood', title: '🍔 패스트푸드 주 1회 미만', desc: '군장을 오래 들고 뛰려면 몸이 가벼워야죠. 오퍼레이터들이 감자튀김을 멀리한 이유, 이해됩니다.', reward: 6 },
{ id: 'weekly_low_game_total', title: '👾 주간 게임 3시간 이하', desc: '링크는 게임 안 했어요. 왜냐면 지금도 계속, 진짜 미션을 뛰고 있으니까요.', reward: 5 },
{ id: 'weekly_expense_tracking_7days', title: '💳 지출 기록 7일', desc: '니플하임 회계부서도 여기까진 안 합니다. 근데 우리가 해낸다면? 전략이죠, 그건.', reward: 5 },
{ id: 'weekly_stress_relief_comment', title: '🧘‍♀️ 스트레스 해소 기록', desc: '버키를 안정시킨 건 와칸다에서의 명상이었습니다. 마음을 비우고, 털어놓는 것… 필요한 일이죠.', reward: 4 }, // ‘오늘의 한마디’에 명상 같은 특정 키워드 감지
{ id: 'weekly_all_time_input_5days', title: '⏰ 모든 시간 기록 5일', desc: '기록은 마법보다 강력하죠. 헤르미온느가 계획 짤 때 해리도 뭐라 할 수 없었거든요.', reward: 5 }, // 기상, 착석, 취침 시간을 기록
{ id: 'weekly_no_alcohol', title: '🍷 주간 금주 챌린지', desc: '샹크스가 술잔을 내려놓습니다. 진지하게 할 말이 있나봐요.', reward: 4 },
{ id: 'weekly_writing_8000', title: '✍️ 주간 글쓰기 8,000자', desc: '호그와트에서 일기장 안 쓰는 사람 없었어요. 톰 리들도 썼습니다, 아주 열심히.', reward: 6 },
{ id: 'weekly_personal_goal_avg_70', title: '🎯 개인 목표 주평균 70%', desc: '클로드는 70%만 보여주고도 모두를 속였습니다. 보시는 분이 중요한 거죠.', reward: 6 },
{ id: 'weekly_perfect_morning_3', title: '🌅 완벽한 아침 3회', desc: '청사자반 훈련은 아침부터 시작했어요. 디미트리 눈치 보려면 그게 기본이죠.', reward: 6 }, //목표시간 ±1시간 내 기상 3번 성공
{ id: 'weekly_exercise_4times', title: '🏃‍♀️ 주간 운동 4회 달성', desc: '버기도 도주를 위해 열심히 뜁니다. 이 정도는 몸 풀기죠.', reward: 5 },
{ id: 'weekly_pomodoro_25', title: '🍅 주간 뽀모도로 25개', desc: '고스트가 집중 끊긴 사람 쳐다보는 거, 솔직히 무섭지 않으세요?', reward: 5 }
    ],
    
    monthly: [
    { id: 'monthly_perfect_attendance', title: '🌟 완벽한 한 달 (아이언맨)', desc: '토니 스타크가 아크 리액터를 완성하는 데 걸린 시간은 한 달. 매일 한 걸음씩, 당신만의 리액터를 만들어보세요.', reward: 30 }, // 한 달 동안 매일 기상 시간 기록
{ id: 'monthly_consistent_seat_time_input', title: '🪑 왕좌의 주인 (아이언 쓰론)', desc: '진짜 왕은 왕좌에 앉아있는 시간이 아니라 그 자리를 지키는 의지로 만들어집니다. 당신의 자리를 지켜보세요.', reward: 20 }, // 한 달 동안 20번 착석 시간 기록
{ id: 'monthly_exercise_15times', title: '💪 월간 피트니스 챔피언', desc: '쾨니히가 그 몸을 만든 건 하루아침이 아니었습니다. 꾸준한 단련이 만든 완벽한 솔져의 길을 걸어보세요.', reward: 8 }, // 한 달 동안 15회 이상 운동 기록
{ id: 'monthly_budget_50percent', title: '💎 절약의 달인', desc: '크로커다일이 바로크워크스를 운영할 때도 예산 관리는 철저했습니다. 진짜 보스는 돈도 아끼거든요.', reward: 10 }, // 한 달 동안 총 지출을 월 예산의 50% 이내로 관리
{ id: 'monthly_early_bird_15times', title: '🌅 새벽형 인간의 등불', desc: '버기 선장은 보물선이 떠나기 전에는 일찍 일어났습니다. 기회는 일찍 일어나는 자의 몫입니다.', reward: 9 }, // 한 달 동안 15회 이상 목표 기상시간 전후 30분 내에 기상
{ id: 'monthly_no_game_entire_month', title: '🎮 링크의 독립 선언', desc: '당신이 없어도 링크는 세상을 구하고 있습니다. 걱정 말고 한 달 동안 게임 세상을 떠나보세요.', reward: 10 }, // 한 달 동안 게임 시간 0분 유지
{ id: 'monthly_writing_80k', title: '📚 풍화설월 비밀 문서 (8만 자)', desc: '가르그 마크에서 발견된 고대 문명의 기록들. 8만 자면 세이로스 교단의 비밀도 밝혀낼 수 있어요.', reward: 9 }, // 한 달 동안 누적 글쓰기 80,000자 이상
{ id: 'monthly_consistent_sleep_input', title: '🌙 미호크의 명상 시간 (20일)', desc: '세계 최강의 검사도 매일 밤 명상으로 마음을 정리했습니다. 검은 칼날보다 중요한 건 맑은 정신이니까요.', reward: 7 }, // 한 달 동안 20일 이상 취침 시간 기록
{ id: 'monthly_high_score_15days', title: '🏆 월간 우수생', desc: '호랑이는 "운" 대신 "꾸준함"을 택했습니다. 15일간의 압도적인 루틴 점수! 15일이면 새로운 인생의 시작이에요.', reward: 10 }, // 한 달 동안 루틴 점수 80점 이상인 날이 15일 이상
{ id: 'monthly_personal_goal_avg_70', title: '🎯 디미트리의 이상과 현실 (월평균 70%)', desc: '디미트리는 완벽을 꿈꿨지만, 때론 현실적인 70%의 노력으로도 빛났습니다. 당신의 꾸준함, 왕도를 걷는 당신만의 방식입니다.', reward: 9 } // 한 달 모든 개인 목표의 평균 달성률 70% 이상 유지
    ]
};

// 뽑기 보상 정의
const ENHANCED_GACHA_REWARDS = {
    bronze: [
        { 
            id: 'golden_day_token', 
            name: '🌟 골든데이 토큰', 
            desc: '선택한 하루의 루틴 점수가 아무리 낮아도 마이너스 점수는 책정되지 않습니다.', 
            probability: 20,
            type: 'date_selector',
            immediate: false
        },
        { 
            id: 'double_exp_booster', 
            name: '⚡ 더블 경험치 부스터', 
            desc: '다음 24시간 동안 획득하는 모든 경험치가 2배로 증가합니다!', 
            probability: 20,
            type: 'immediate_buff',
            immediate: true
        },
        { 
            id: 'quest_reroll', 
            name: '🎲 퀘스트 리롤권', 
            desc: '오늘 일일 퀘스트 목록이 마음에 들지 않나요? 한 번 다시 뽑을 수 있습니다!', 
            probability: 20,
            type: 'immediate_action',
            immediate: true
        },
        { 
            id: 'cheat_day_gaming', 
            name: '🥳 치팅 데이 미니 토큰', 
            desc: '오늘 하루, 루틴 점수에 대한 게임 시간 페널티가 완전히 사라집니다!', 
            probability: 20,
            type: 'today_flag',
            immediate: true
        },
        { 
            id: 'coach_encouragement', 
            name: '💬 코치의 응원 한마디', 
            desc: '당신의 현재 루틴 상태에 맞춰 코치가 진심으로 작성한 개인화된 응원 메시지를 드립니다.', 
            probability: 20,
            type: 'ai_message',
            immediate: true
        }
    ],
    
    silver: [
        { 
            id: 'cafe_budget_bonus', 
            name: '☕ 카페 지출 보너스', 
            desc: '월 예산과 별도로 5,000원의 카페 지출 여유를 드립니다. 맛있는 커피 한 잔 즐기세요!', 
            probability: 20,
            type: 'budget_bonus',
            amount: 5000,
            immediate: true
        },
        { 
            id: 'streaming_free_pass', 
            name: '📺 넷플릭스/유튜브 프리 패스', 
            desc: '오늘 루틴 점수에 영향을 받지 않고 3시간 동안 마음껏 시청하세요.', 
            probability: 20,
            type: 'today_flag',
            immediate: true
        },
        { 
            id: 'sleep_in_permit', 
            name: '🛌 늦잠 허가증', 
            desc: '내일 목표 기상 시간보다 2시간 늦게 일어나도 정시 기상으로 인정됩니다.', 
            probability: 20,
            type: 'tomorrow_buff',
            immediate: true
        },
        { 
            id: 'meal_freedom', 
            name: '🍕 원하는 식사 자유권', 
            desc: '오늘 한 끼는 어떤 식단 규칙이나 지출 걱정 없이 원하는 것을 먹으세요!', 
            probability: 20,
            type: 'today_flag',
            immediate: true
        },
        { 
            id: 'audio_focus_time', 
            name: '🎧 게임 집중권', 
            desc: '3시간 동안 아무 방해 없이 좋아하는 음악이나 오디오북으로 온전히 휴식하세요.', 
            probability: 20,
            type: 'timer_reward',
            duration: 180, // 3시간 (분)
            immediate: false
        }
    ],
    
    gold: [
        { 
            id: 'book_budget_bonus', 
            name: '📚 도서 구매 지원금', 
            desc: '월 예산과 별도로 30,000원의 도서 구매 여유를 드립니다. 읽고 싶었던 책을 구매하세요!', 
            probability: 20,
            type: 'budget_bonus',
            amount: 30000,
            immediate: true
        },
        { 
            id: 'luxury_budget_bonus', 
            name: '🛍️ 작은 사치 지출 보너스', 
            desc: '월 예산과 별도로 50,000원을 마음껏 사용할 수 있는 보너스. 나를 위한 작은 선물을 해보세요!', 
            probability: 20,
            type: 'budget_bonus',
            amount: 50000,
            immediate: true
        },
        { 
            id: 'movie_ticket', 
            name: '🎬 영화 한 편 관람권', 
            desc: '영화 한 편을 감상하는 시간은 루틴 점수에 반영되지 않습니다. 죄책감 없이 즐기세요!', 
            probability: 20,
            type: 'today_flag',
            immediate: true
        },
        { 
            id: 'unlimited_gaming', 
            name: '🎮 게임 시간 무제한 패스', 
            desc: '오늘 하루 루틴 점수 페널티 걱정 없이 원하는 만큼 게임을 플레이할 수 있습니다.', 
            probability: 20,
            type: 'today_flag',
            immediate: true
        },
        { 
            id: 'gratitude_message', 
            name: '💖 나를 위한 감사 메시지', 
            desc: '지금까지 루틴을 열심히 지켜온 당신에게 코치가 심리적 위안과 깊은 감사를 담은 장문의 메시지를 보내드립니다.', 
            probability: 20,
            type: 'ai_message_deep',
            immediate: true
        }
    ],
    
    legend: [
        { 
            id: 'ultimate_wish', 
            name: '💎 궁극의 소원 성취권', 
            desc: '당신이 진정으로 원하는 것 한 가지를 100,000원 이내에서 이룰 수 있는 권리. 루틴 앱이 당신의 소원을 적극적으로 응원합니다!', 
            probability: 33,
            type: 'wish_fulfillment',
            amount: 100000,
            immediate: false
        },
        { 
            id: 'complete_freedom_day', 
            name: '🌟 완전 자유의 날', 
            desc: '하루 동안 모든 루틴 규칙에서 완벽하게 해방됩니다! 모든 제한과 점수 계산이 사라집니다.', 
            probability: 33,
            type: 'date_selector_special',
            immediate: false
        },
        { 
            id: 'routine_king_day', 
            name: '🏆 오늘 하루는 내가 왕이다!', 
            desc: '당신이 선택한 날짜에 루틴의 왕으로 선언됩니다. 그날 모든 행동을 칭찬하고 격려합니다.', 
            probability: 34,
            type: 'date_selector_special',
            immediate: false
        }
    ]
};

// 사용자 레벨 데이터 관리
async function getUserLevelData() {
    const defaultData = {
        totalExp: 0,
        level: 1,
        currentExp: 0,
        maxExp: 10,
        unlockedRewards: [],
        activeBuffs: {}
    };
    
    const saved = await dbGet('userLevelData');
    return saved || defaultData;
}

        async function saveUserLevelData(data) { await dbSet('userLevelData', data); }

// 경험치 추가 및 레벨업 처리 (버프 적용)
async function addExperience(amount, source = '') {
    const userData = await getUserLevelData();
    
    // 더블 경험치 버프 체크
    let finalAmount = amount;
    if (userData.activeBuffs.doubleExp && userData.activeBuffs.doubleExp > Date.now()) {
        finalAmount = amount * 2;
        source += ' (더블 EXP 적용)';
    }
    
    const oldLevel = userData.level;
    userData.totalExp += finalAmount;
    const levelInfo = LEVEL_SYSTEM.calculateLevel(userData.totalExp);
    
    userData.level = levelInfo.level;
    userData.currentExp = levelInfo.currentExp;
    userData.maxExp = levelInfo.maxExp;
    
    await saveUserLevelData(userData);
    
    // 레벨업 체크
    if (userData.level > oldLevel) {
        await handleLevelUp(oldLevel, userData.level);
    }
    
    // 프로필 위젯 업데이트
    await updateProfileWidget();
    
    // 경험치 획득 알림 (조건부)
    if (finalAmount >= 5) {
        showExpGainNotification(finalAmount, source);
    }
    
    return {
        gained: finalAmount,
        levelUp: userData.level > oldLevel,
        newLevel: userData.level,
        source: source
    };
}

// 경험치 획득 알림
function showExpGainNotification(amount, source) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 120px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        z-index: 9998;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = `⚡ +${amount} EXP ${source ? `<br><span style="font-size:10px; opacity:0.8;">${source}</span>` : ''}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// 레벨업 처리 (뽑기 기회 제공)
async function handleLevelUp(oldLevel, newLevel) {
    const profileInfo = getProfileInfo(newLevel);
    
    // 레벨업 축하 팝업
    showFeedbackPopup(100, {
        class: 'feedback-celebration',
        emoji: profileInfo.emoji,
        title: `레벨업! Lv.${newLevel}`,
        message: `축하합니다! ${profileInfo.title}이(가) 되셨습니다!${profileInfo.subtitle ? '\n\n' + profileInfo.subtitle : ''}`
    });
    
    // 뽑기 기회 제공 (10레벨마다)
    if (newLevel % 10 === 0) {
        const rewardData = await getUserRewards();
        rewardData.availableGacha += 1;
        
        // 50레벨, 100레벨은 추가 기회
        if (newLevel % 50 === 0) {
            rewardData.availableGacha += 1;
        }
        
        await saveUserRewards(rewardData);
        
        setTimeout(() => {
            showGachaModal();
        }, 2500);
    }
    
    // 특별 레벨 보너스
    if (newLevel === 50) {
        await addExperience(50, '50레벨 달성 보너스');
    } else if (newLevel === 100) {
        await addExperience(100, '100레벨 달성 보너스');
    }
}

// 프로필 정보 가져오기
function getProfileInfo(level) {
    // 가장 가까운 하위 레벨의 프로필 정보 반환
    const availableLevels = Object.keys(PROFILE_DATA).map(Number).sort((a, b) => b - a);
    const targetLevel = availableLevels.find(l => l <= level) || 1;
    return PROFILE_DATA[targetLevel];
}

// 퀘스트 데이터 관리
async function getDailyQuests(date) {
    const dateStr = formatDate(date);
    const saved = await dbGet(`dailyQuests_${dateStr}`);
    
    if (saved) return saved;
    
    // 새로운 일간 퀘스트 생성 (랜덤 5개)
    const allDailyQuests = [...QUEST_DEFINITIONS.daily];
    const selectedQuests = [];
    
    // 혹시 모를 오류를 방지하기 위해 정의된 퀘스트 수와 5개 중 작은 값을 선택
    const numQuestsToSelect = Math.min(5, allDailyQuests.length);

    for (let i = 0; i < numQuestsToSelect; i++) {
        const randomIndex = Math.floor(Math.random() * allDailyQuests.length);
        
        // 1. 선택된 퀘스트를 변수에 할당합니다.
        const selectedQuestObject = allDailyQuests[randomIndex]; 
        
        selectedQuests.push({
            // 2. 할당된 변수를 사용하여 객체를 복사합니다.
            ...selectedQuestObject,
            completed: false,
            progress: 0,
            // 3. 할당된 변수에서 id를 가져와 함수에 전달합니다.
            maxProgress: getQuestMaxProgress(selectedQuestObject.id)
        });
        
        // 중복 선택을 방지하기 위해 배열에서 제거
        allDailyQuests.splice(randomIndex, 1);
    }
    
    const questData = {
        date: dateStr,
        quests: selectedQuests,
        completedCount: 0
    };
    
    await dbSet(`dailyQuests_${dateStr}`, questData);
    return questData;
}

async function getWeeklyQuests(date) {
    const weekStart = getWeekDates(date)[0];
    const saved = await dbGet(`weeklyQuests_${weekStart}`);
    
    if (saved) return saved;
    
    // 새로운 주간 퀘스트 생성 (랜덤 8개)
    const allWeeklyQuests = [...QUEST_DEFINITIONS.weekly];
    const selectedQuests = [];
    
    for (let i = 0; i < Math.min(8, allWeeklyQuests.length); i++) {
        const randomIndex = Math.floor(Math.random() * allWeeklyQuests.length);
        const quest = allWeeklyQuests[randomIndex];
        
        selectedQuests.push({
            ...quest,
            completed: false,
            progress: 0,
            maxProgress: getQuestMaxProgress(quest.id)
        });
        allWeeklyQuests.splice(randomIndex, 1);
    }
    
    const questData = {
        weekStart: weekStart,
        quests: selectedQuests,
        completedCount: 0
    };
    
    await dbSet(`weeklyQuests_${weekStart}`, questData);
    return questData;
}

async function getMonthlyQuests(date) {
    const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
    const saved = await dbGet(`monthlyQuests_${monthKey}`);
    
    if (saved) return saved;
    
    // 월간 퀘스트는 모든 퀘스트 포함
    const selectedQuests = QUEST_DEFINITIONS.monthly.map(quest => ({
        ...quest,
        completed: false,
        progress: 0,
        maxProgress: getQuestMaxProgress(quest.id)
    }));
    
    const questData = {
        month: monthKey,
        quests: selectedQuests,
        completedCount: 0
    };
    
    await dbSet(`monthlyQuests_${monthKey}`, questData);
    return questData;
}

// 퀘스트별 최대 진행도 설정
function getQuestMaxProgress(questId) {
    const progressMap = {
        // 일간
        'attendance': 1,
        'pomodoro_3': 3, 
        'sleep_time': 1,
        'seat_time': 1,
        'writing_300': 300,
        'exercise_10min': 10,
        'personal_goal_50': 50,
        'expense_under_10k': 10000, 
        'food_record_1': 1,
        'daily_comment': 1,
        'game_under_60min': 1,
        'wake_on_time_1hour': 1,
        'no_negative_score_today': 1, 
        
        // 주간
        'weekly_attendance_6days': 6,
        'weekly_early_sleep_4times': 4,
        'weekly_no_game_weekend': 1,
        'weekly_expense_under_100k': 1,
        'weekly_high_score_5days': 5,
        'weekly_no_fastfood': 1,
        'weekly_low_game_total': 1,
        'weekly_expense_tracking_7days': 7,
        'weekly_stress_relief_comment': 1,
        'weekly_all_time_input_5days': 5,
        'weekly_no_alcohol': 1,
        'weekly_writing_8000': 8000,
        'weekly_personal_goal_avg_70': 1,
        'weekly_perfect_morning_3': 3,
        'weekly_exercise_4times': 4,
        'weekly_pomodoro_25': 25,
        
        // 월간
        'monthly_perfect_attendance': 30,
        'monthly_consistent_seat_time_input': 20,
        'monthly_exercise_15times': 15,
        'monthly_budget_50percent': 1,
        'monthly_early_bird_15times': 15,
        'monthly_no_game_entire_month': 1,
        'monthly_writing_80k': 80000,
        'monthly_consistent_sleep_input': 20,
        'monthly_high_score_15days': 15,
        'monthly_personal_goal_avg_70': 1
    };
    
    return progressMap[questId] || 1;
}

// 뽑기 시스템 관리
async function getUserRewards() {
    const defaultData = {
        availableGacha: 0,
        unlockedRewards: [],
        activeBuffs: {},
        gachaHistory: []
    };
    
    const saved = await dbGet('userRewards');
    return saved || defaultData;
}

        async function saveUserRewards(data) { await dbSet('userRewards', data); }

// 뽑기 실행
async function executeGacha() {
    const rewardData = await getUserRewards();
    
    if (rewardData.availableGacha <= 0) {
        alert('뽑기 기회가 없습니다!');
        return;
    }
    
    // 확률 계산
    const rand = Math.random() * 100;
    let rewardTier;
    
    if (rand < 1) rewardTier = 'legend';        // 1%
    else if (rand < 5) rewardTier = 'gold';     // 4%
    else if (rand < 30) rewardTier = 'silver';  // 25%
    else rewardTier = 'bronze';                 // 70%
    
    // 해당 티어에서 보상 선택
    const tierRewards = ENHANCED_GACHA_REWARDS[rewardTier];
    const totalProbability = tierRewards.reduce((sum, reward) => sum + reward.probability, 0);
    let randReward = Math.random() * totalProbability;
    
    let selectedReward = null;
    for (const reward of tierRewards) {
        randReward -= reward.probability;
        if (randReward <= 0) {
            selectedReward = reward;
            break;
        }
    }
    
    // 보상 저장
    rewardData.availableGacha--;
    rewardData.unlockedRewards.push({
        ...selectedReward,
        obtainedAt: new Date().toISOString(),
        used: false
    });
    rewardData.gachaHistory.push({
        date: new Date().toISOString(),
        tier: rewardTier,
        reward: selectedReward
    });
    
    await saveUserRewards(rewardData);
    
    // 결과 표시
    showGachaResult(selectedReward, rewardTier);

    // 히든 업적: 레전드 보물 사냥꾼
if (rewardTier === 'legend') {
        const unlocked = await dbGet('unlockedAchievements') || [];
        if (!unlocked.includes('ACH_HIDDEN_LEGEND_GACHA')) {
            await unlockAchievement('ACH_HIDDEN_LEGEND_GACHA');
        }
    }
    
    return selectedReward;
}

// 뽑기 결과 표시
function showGachaResult(reward, tier) {
    const tierColors = {
        bronze: 'linear-gradient(135deg, #CD7F32, #A0522D)',
        silver: 'linear-gradient(135deg, #C0C0C0, #808080)',
        gold: 'linear-gradient(135deg, #FFD700, #FFA500)',
        legend: 'linear-gradient(135deg, #9400D3, #FF1493)'
    };
    
    showFeedbackPopup(100, {
        class: 'feedback-celebration',
        emoji: reward.name.split(' ')[0],
        title: `${tier.toUpperCase()} 등급!`,
        message: `${reward.name}을(를) 획득했습니다!\n\n${reward.desc}`
    });
}

// 뽑기 모달 관련 함수들
let currentGachaReward = null;

        function showGachaModal() { document.getElementById('gachaContent').style.display = 'block'; document.getElementById('gachaResult').style.display = 'none'; document.getElementById('gachaModal').style.display = 'flex'; }
        function closeGachaModal() { document.getElementById('gachaModal').style.display = 'none'; currentGachaReward = null; }

async function executeGacha() {
    const rewardData = await getUserRewards();
    
    if (rewardData.availableGacha <= 0) {
        alert('뽑기 기회가 없습니다!');
        return;
    }
    
    // 뽑기 애니메이션 효과
    const gachaBtn = document.querySelector('#gachaContent button');
    gachaBtn.disabled = true;
    gachaBtn.textContent = '뽑는 중...';
    
    setTimeout(async () => {
        const reward = await performGacha();
        if (reward) {
            showGachaResult(reward);
        }
    }, 1500);
}

async function performGacha() {
    const rewardData = await getUserRewards();
    
    // 확률 계산
    const rand = Math.random() * 100;
    let rewardTier;
    
    if (rand < 1) rewardTier = 'legend';        // 1%
    else if (rand < 5) rewardTier = 'gold';     // 4%
    else if (rand < 30) rewardTier = 'silver';  // 25%
    else rewardTier = 'bronze';                 // 70%
    
    // 해당 티어에서 보상 선택
    const tierRewards = ENHANCED_GACHA_REWARDS[rewardTier];
    const totalProbability = tierRewards.reduce((sum, reward) => sum + reward.probability, 0);
    let randReward = Math.random() * totalProbability;
    
    let selectedReward = null;
    for (const reward of tierRewards) {
        randReward -= reward.probability;
        if (randReward <= 0) {
            selectedReward = reward;
            break;
        }
    }
    
    // 보상 저장
    rewardData.availableGacha--;
    const rewardInstance = {
        ...selectedReward,
        tier: rewardTier,
        obtainedAt: new Date().toISOString(),
        used: false,
        instanceId: Date.now().toString()
    };
    
    rewardData.unlockedRewards.push(rewardInstance);
    rewardData.gachaHistory.push({
        date: new Date().toISOString(),
        tier: rewardTier,
        reward: selectedReward
    });
    
    await saveUserRewards(rewardData);
    currentGachaReward = rewardInstance;
    
    return rewardInstance;
}

function showGachaResult(reward) {
    document.getElementById('gachaContent').style.display = 'none';
    
    const tierColors = {
        bronze: 'linear-gradient(135deg, #CD7F32, #A0522D)',
        silver: 'linear-gradient(135deg, #C0C0C0, #808080)',
        gold: 'linear-gradient(135deg, #FFD700, #FFA500)',
        legend: 'linear-gradient(135deg, #9400D3, #FF1493)'
    };
    
    document.getElementById('gachaResultCard').style.background = tierColors[reward.tier];
    document.getElementById('gachaResultEmoji').textContent = reward.name.split(' ')[0];
    document.getElementById('gachaResultTier').textContent = reward.tier.toUpperCase();
    document.getElementById('gachaResultName').textContent = reward.name;
    document.getElementById('gachaResultDesc').textContent = reward.desc;
    
    // 즉시 사용 가능한 보상인지 체크
    const immediateUseRewards = ['golden_day', 'fail_shield', 'double_exp', 'reroll', 'cheat_day'];
    const useNowBtn = document.getElementById('useNowBtn');
    if (immediateUseRewards.includes(reward.id)) {
        useNowBtn.style.display = 'inline-block';
        useNowBtn.textContent = '지금 사용';
    } else {
        useNowBtn.style.display = 'inline-block';
        useNowBtn.textContent = '보상 확인';
    }
    
    document.getElementById('gachaResult').style.display = 'block';
}

        async function useRewardNow() { if (!currentGachaReward) return; await useEnhancedReward(currentGachaReward.instanceId); closeGachaModal(); }
        function saveForLater() { alert('보상이 인벤토리에 저장되었습니다!'); closeGachaModal(); }
        async function showRewardsModal() { document.getElementById('rewardsModal').style.display = 'flex'; await renderEnhancedRewardsList(); }
        function closeRewardsModal() { document.getElementById('rewardsModal').style.display = 'none'; }

        // 보상 목록 렌더링 개선 (사용된 보상의 세부 정보 표시)
async function renderEnhancedRewardsList() {
    const rewardData = await getUserRewards();
    const container = document.getElementById('rewardsList');
    const countElement = document.getElementById('availableGachaCount');
    
    countElement.textContent = `뽑기 기회: ${rewardData.availableGacha}회`;
    
    if (rewardData.unlockedRewards.length === 0) {
        container.innerHTML = `
            <div class="empty-rewards">
                <div style="font-size: 48px; margin-bottom: 15px;">🎁</div>
                <p>아직 획득한 보상이 없습니다.</p>
                <p>레벨업을 통해 보상을 획득해보세요!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    for (const reward of rewardData.unlockedRewards.reverse()) {
        const usedClass = reward.used ? 'used' : '';
        const obtainedDate = new Date(reward.obtainedAt).toLocaleDateString('ko-KR');
        
        // 사용된 보상의 추가 정보
        let usageInfo = '';
        if (reward.used) {
            const usedDate = new Date(reward.usedAt).toLocaleDateString('ko-KR');
            usageInfo = `<div style="font-size: 11px; color: var(--text-color-light); margin-top: 4px;">사용일: ${usedDate}</div>`;
            
            // 소원 성취권의 경우 소원 내용 표시
            if (reward.wishText) {
                usageInfo += `<div style="font-size: 11px; color: var(--primary-color); margin-top: 2px; font-style: italic;">"${reward.wishText}"</div>`;
            }
        }
        
        html += `
            <div class="reward-item ${reward.tier} ${usedClass}">
                <div class="reward-info">
                    <div class="reward-tier ${reward.tier}">${reward.tier.toUpperCase()}</div>
                    <div class="reward-name">${reward.name}</div>
                    <div class="reward-desc">${reward.desc}</div>
                    <div style="font-size: 11px; color: var(--text-color-light); margin-top: 4px;">
                        획득일: ${obtainedDate}
                    </div>
                    ${usageInfo}
                </div>
                <div class="reward-actions">
                    ${!reward.used ? `
                        <button class="reward-btn use" onclick="useEnhancedReward('${reward.instanceId}')">사용</button>
                        <button class="reward-btn delete" onclick="deleteReward('${reward.instanceId}')">삭제</button>
                    ` : `
                        <span style="color: var(--text-color-light); font-size: 12px;">사용됨</span>
                    `}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// 보상 사용 처리
async function useEnhancedReward(instanceId) {
    const rewardData = await getUserRewards();
    const reward = rewardData.unlockedRewards.find(r => r.instanceId === instanceId);
    
    if (!reward || reward.used) {
        alert('사용할 수 없는 보상입니다.');
        return;
    }

    // 보상 타입별 처리
    switch(reward.type) {
        case 'immediate_buff':
            await applyImmediateBuff(reward);
            break;
        case 'immediate_action':
            await applyImmediateAction(reward);
            break;
        case 'today_flag':
            await applyTodayFlag(reward);
            break;
        case 'tomorrow_buff':
            await applyTomorrowBuff(reward);
            break;
        case 'budget_bonus':
            await applyBudgetBonus(reward);
            break;
        case 'date_selector':
            await showDateSelector(reward, instanceId);
            return; // 날짜 선택 후 처리되므로 여기서 return
        case 'date_selector_special':
            await showSpecialDateSelector(reward, instanceId);
            return;
        case 'timer_reward':
            await startTimerReward(reward);
            break;
        case 'ai_message':
            await generateAIMessage(reward, false);
            break;
        case 'ai_message_deep':
            await generateAIMessage(reward, true);
            break;
        case 'wish_fulfillment':
            await showWishFulfillment(reward, instanceId);
            return;
        default:
            alert(`${reward.name}을(를) 사용했습니다! 마음껏 즐기세요! 🎉`);
            break;
    }
    
    // 보상을 사용됨으로 표시
    reward.used = true;
    reward.usedAt = new Date().toISOString();
    
    await saveUserRewards(rewardData);
    
    // 모달이 열려있으면 새로고침
    if (document.getElementById('rewardsModal').style.display === 'flex') {
        await renderEnhancedRewardsList();
    }
}

// 즉시 버프 적용
async function applyImmediateBuff(reward) {
    switch(reward.id) {
        case 'double_exp_booster':
            const expiryTime = Date.now() + (24 * 60 * 60 * 1000);
            const userData = await getUserLevelData();
            userData.activeBuffs.doubleExp = expiryTime;
            await saveUserLevelData(userData);
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '⚡',
                title: '더블 경험치 활성화!',
                message: '24시간 동안 모든 경험치가 2배입니다! 지금이 루틴을 열심히 할 때예요!'
            });
            break;
    }
}

// 즉시 액션 적용
async function applyImmediateAction(reward) {
    switch(reward.id) {
        case 'quest_reroll':
            const today = new Date();
            const todayStr = formatDate(today);
            
            // 기존 일간 퀘스트 삭제
            await dbDelete(`dailyQuests_${todayStr}`);
            
            // 새로운 퀘스트 생성
            await getDailyQuests(today);
            
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🎲',
                title: '퀘스트 리롤 완료!',
                message: '새로운 일간 퀘스트가 생성되었습니다! 퀘스트 페이지에서 확인해보세요.'
            });
            break;
    }
}

// 오늘 플래그 적용
async function applyTodayFlag(reward) {
    const today = formatDate(new Date());
    let flagKey = '';
    let message = '';
    
    switch(reward.id) {
        case 'cheat_day_gaming':
            flagKey = `cheatDayGaming_${today}`;
            message = '🥳 치팅 데이 미니 토큰이 적용되었습니다! 오늘은 게임 시간 페널티가 없습니다.';
            break;
        case 'streaming_free_pass':
            flagKey = `streamingFreePass_${today}`;
            message = '📺 넷플릭스/유튜브 프리 패스가 적용되었습니다! 3시간 동안 마음껏 시청하세요.';
            break;
        case 'meal_freedom':
            flagKey = `mealFreedom_${today}`;
            message = '🍕 원하는 식사 자유권이 적용되었습니다! 오늘 한 끼는 자유롭게!';
            break;
        case 'movie_ticket':
            flagKey = `movieTicket_${today}`;
            message = '🎬 영화 한 편 관람권이 적용되었습니다! 죄책감 없이 영화를 즐기세요.';
            break;
        case 'unlimited_gaming':
            flagKey = `unlimitedGaming_${today}`;
            message = '🎮 게임 시간 무제한 패스가 적용되었습니다! 오늘은 진정한 자유!';
            break;
    }
    
    await dbSet(flagKey, true);
    alert(message);
}

// 내일 버프 적용
async function applyTomorrowBuff(reward) {
    switch(reward.id) {
        case 'sleep_in_permit':
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = formatDate(tomorrow);
            await dbSet(`sleepInPermit_${tomorrowStr}`, 120); // 2시간 (분)
            alert('🛌 늦잠 허가증이 적용되었습니다! 내일은 2시간 늦게 일어나도 정시 기상으로 인정됩니다.');
            break;
    }
}

// 예산 보너스 적용
async function applyBudgetBonus(reward) {
    const currentBonusBudget = await dbGet('currentMonthBonusBudget') || 0;
    const newBonusBudget = currentBonusBudget + reward.amount;
    await dbSet('currentMonthBonusBudget', newBonusBudget);
    
    // 소형 예산 바 업데이트
    await renderSmallBudgetBarEnhanced();
    
    showFeedbackPopup(100, {
        class: 'feedback-celebration',
        emoji: reward.name.split(' ')[0],
        title: '예산 보너스 적용!',
        message: `${reward.amount.toLocaleString()}원이 이번 달 예산에 추가되었습니다! 마음껟 사용하세요.`
    });
}

// 날짜 선택기 표시
async function showDateSelector(reward, instanceId) {
    const selectedDate = prompt(`${reward.name}을(를) 적용할 날짜를 입력하세요 (YYYY-MM-DD 형식):`, formatDate(new Date()));
    
    if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) {
        alert('올바른 날짜 형식이 아닙니다.');
        return;
    }
    
    switch(reward.id) {
        case 'golden_day_token':
            await dbSet(`goldenDay_${selectedDate}`, true);
            alert(`🌟 골든데이 토큰이 ${selectedDate}에 적용되었습니다! 그날은 마이너스 점수가 없습니다.`);
            break;
    }
    
    // 보상을 사용됨으로 표시
    const rewardData = await getUserRewards();
    const rewardToUse = rewardData.unlockedRewards.find(r => r.instanceId === instanceId);
    if (rewardToUse) {
        rewardToUse.used = true;
        rewardToUse.usedAt = new Date().toISOString();
        await saveUserRewards(rewardData);
    }
    
    if (document.getElementById('rewardsModal').style.display === 'flex') {
        await renderEnhancedRewardsList();
    }
}

// 특별 날짜 선택기 표시
async function showSpecialDateSelector(reward, instanceId) {
    const selectedDate = prompt(`${reward.name}을(를) 적용할 날짜를 입력하세요 (YYYY-MM-DD 형식):`, formatDate(new Date()));
    
    if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) {
        alert('올바른 날짜 형식이 아닙니다.');
        return;
    }
    
    switch(reward.id) {
        case 'complete_freedom_day':
            await dbSet(`completeFreedomDay_${selectedDate}`, true);
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🌟',
                title: '완전 자유의 날 예약 완료!',
                message: `${selectedDate}에 완전 자유의 날이 적용됩니다! 그날은 모든 규칙에서 해방됩니다.`
            });
            break;
        case 'routine_king_day':
            await dbSet(`routineKingDay_${selectedDate}`, true);
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🏆',
                title: '루틴의 왕 선언 완료!',
                message: `${selectedDate}에 당신은 루틴의 왕입니다! 그날은 모든 행동이 칭찬받을 것입니다.`
            });
            break;
    }
    
    // 보상을 사용됨으로 표시
    const rewardData = await getUserRewards();
    const rewardToUse = rewardData.unlockedRewards.find(r => r.instanceId === instanceId);
    if (rewardToUse) {
        rewardToUse.used = true;
        rewardToUse.usedAt = new Date().toISOString();
        await saveUserRewards(rewardData);
    }
    
    if (document.getElementById('rewardsModal').style.display === 'flex') {
        await renderEnhancedRewardsList();
    }
}

// 타이머 보상 시작
async function startTimerReward(reward) {
    if (reward.id === 'audio_focus_time') {
        const startTime = Date.now();
        const endTime = startTime + (reward.duration * 60 * 1000);
        
        // 타이머 UI 표시 (간단한 알림)
        showFeedbackPopup(100, {
            class: 'feedback-celebration',
            emoji: '🎧',
            title: '게임 집중권 시작!',
            message: `3시간 동안 마음껏 휴식하세요! 타이머가 끝나면 10XP를 드립니다.`
        });
        
        // 3시간 후 경험치 지급
        setTimeout(async () => {
            await addExperience(10, '게임 집중권 완료 보너스');
            alert('🎧 게임 집중권이 완료되었습니다! 10XP를 획득했습니다.');
        }, reward.duration * 60 * 1000);
    }
}

// AI 메시지 생성 (실제로는 미리 정의된 메시지 사용)
async function generateAIMessage(reward, isDeep = false) {
    const userData = await getUserLevelData();
    const allData = await dbGetAll();
    const dayRecords = allData.filter(item => item.key.startsWith('day_')).length;
    
    let message = '';
    
    if (isDeep) {
        // 깊은 감사 메시지
        const messages = [
            `지금까지 ${dayRecords}일 동안 기록을 남겨주셨군요. 레벨 ${userData.level}까지 올라온 당신의 여정이 정말 대단합니다. 매일 조금씩 나아지려는 당신의 의지가 저에게도 큰 감동을 줍니다. 앞으로도 함께 성장해나가요.`,
            `당신은 이미 충분히 훌륭합니다. ${userData.totalExp}의 경험치를 쌓으며 여기까지 온 것이 그 증거예요. 완벽하지 않아도 괜찮습니다. 매일 기록하고, 반성하고, 다시 시작하는 당신의 모습이 진정한 성장입니다.`,
            `혹시 힘들 때가 있나요? 루틴을 지키는 것이 때로는 버겁게 느껴질 수 있어요. 하지만 지금까지 ${dayRecords}일을 기록한 당신이라면 충분히 할 수 있습니다. 저는 언제나 당신을 응원하고 있어요.`
        ];
        message = messages[Math.floor(Math.random() * messages.length)];
    } else {
        // 일반 응원 메시지
        const messages = [
            `레벨 ${userData.level}! 정말 멋지네요! 지금까지의 노력이 헛되지 않았어요. 계속 이런 식으로 해나가시면 곧 더 큰 성취를 이룰 수 있을 거예요!`,
            `${dayRecords}일 동안의 기록, 정말 대단합니다! 매일매일 성실하게 기록하는 당신의 모습이 저에게는 영감이 됩니다.`,
            `요즘 어떠세요? 루틴이 많이 자리잡혔나요? 완벽하지 않아도 괜찮아요. 중요한 건 포기하지 않는 마음이니까요!`,
            `당신의 ${userData.totalExp} 경험치 하나하나가 모두 소중한 노력의 결과예요. 앞으로도 함께 성장해나가요!`
        ];
        message = messages[Math.floor(Math.random() * messages.length)];
    }
    
    showFeedbackPopup(100, {
        class: 'feedback-celebration',
        emoji: isDeep ? '💖' : '💬',
        title: isDeep ? '코치의 깊은 감사 인사' : '코치의 응원 한마디',
        message: message
    });
}

// 소원 성취 처리
async function showWishFulfillment(reward, instanceId) {
    const wish = prompt('당신이 진정으로 원하는 것을 적어주세요:');
    
    if (!wish || wish.trim() === '') {
        alert('소원을 입력해주세요.');
        return;
    }
    
    // 예산 보너스 적용
    const currentBonusBudget = await dbGet('currentMonthBonusBudget') || 0;
    const newBonusBudget = currentBonusBudget + reward.amount;
    await dbSet('currentMonthBonusBudget', newBonusBudget);
    
    // 소원 기록
    await dbSet(`userWish_${Date.now()}`, {
        wish: wish,
        grantedAt: new Date().toISOString(),
        budget: reward.amount
    });
    
    showFeedbackPopup(100, {
        class: 'feedback-celebration',
        emoji: '💎',
        title: '소원 성취권 발동!',
        message: `"${wish}" - 당신의 소원을 적극 응원합니다! ${reward.amount.toLocaleString()}원이 이번 달 예산에 추가되었습니다. 꼭 이루시길 바라요!`
    });
    
    // 보상을 사용됨으로 표시
    const rewardData = await getUserRewards();
    const rewardToUse = rewardData.unlockedRewards.find(r => r.instanceId === instanceId);
    if (rewardToUse) {
        rewardToUse.used = true;
        rewardToUse.usedAt = new Date().toISOString();
        rewardToUse.wishText = wish; // 소원 텍스트 저장
        await saveUserRewards(rewardData);
    }
    
    if (document.getElementById('rewardsModal').style.display === 'flex') {
        await renderEnhancedRewardsList();
    }
}

// 루틴의 왕 데이 특별 UI 처리
async function checkRoutineKingDay() {
    const today = formatDate(new Date());
    const isRoutineKingDay = await dbGet(`routineKingDay_${today}`);
    
    if (isRoutineKingDay) {
        // 헤더에 왕관 추가
        const header = document.querySelector('.header h1');
        if (header && !header.textContent.includes('👑')) {
            header.textContent = '👑 ' + header.textContent + ' 👑';
            header.style.color = 'gold';
        }
        
        // 특별한 환영 메시지
        setTimeout(() => {
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🏆',
                title: '루틴의 왕이 오셨습니다!',
                message: '오늘 하루 당신은 루틴의 왕입니다! 모든 행동이 칭찬받을 것이며, 최소 50점이 보장됩니다!'
            });
        }, 1000);
    }
}

// 완전 자유의 날 UI 처리
async function checkCompleteFreedomDay() {
    const today = formatDate(new Date());
    const isCompleteFreedomDay = await dbGet(`completeFreedomDay_${today}`);
    
    if (isCompleteFreedomDay) {
        // 헤더 메시지 변경
        const header = document.querySelector('.header h1');
        if (header) {
            header.textContent = '🌟 완전 자유의 날 🌟';
            header.style.color = 'var(--success-color)';
        }
        
        // 설명 메시지 변경
        const headerP = document.querySelector('.header p');
        if (headerP) {
            headerP.textContent = '오늘은 모든 규칙에서 해방된 완전 자유의 날입니다!';
        }
        
        // 특별한 환영 메시지
        setTimeout(() => {
            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🌟',
                title: '완전 자유의 날입니다!',
                message: '오늘은 모든 루틴 규칙에서 해방됩니다! 마음껏 자유롭게 보내세요!'
            });
        }, 1000);
    }
}

// 보상 효과 적용 함수들
async function applyGoldenDay() {
    const today = formatDate(new Date());
    await dbSet(`goldenDay_${today}`, true);
    alert('🌟 골든데이가 적용되었습니다! 오늘은 마이너스 점수가 적용되지 않습니다.');
}

async function applyFailShield() {
    const userData = await getUserLevelData();
    userData.activeBuffs.failShield = (userData.activeBuffs.failShield || 0) + 1;
    await saveUserLevelData(userData);
    alert('🛡️ 실패 방어권이 적용되었습니다! 다음 퀘스트 실패가 무효화됩니다.');
}

async function applyDoubleExp() {
    const expiryTime = Date.now() + (24 * 60 * 60 * 1000); // 24시간
    const userData = await getUserLevelData();
    userData.activeBuffs.doubleExp = expiryTime;
    await saveUserLevelData(userData);
    alert('⚡ 더블 경험치가 적용되었습니다! 24시간 동안 모든 경험치가 2배입니다.');
}

async function applyReroll() {
    const today = new Date();
    const todayStr = formatDate(today);
    
    // 기존 일간 퀘스트 삭제
    await dbDelete(`dailyQuests_${todayStr}`);
    
    // 새로운 퀘스트 생성
    await getDailyQuests(today);
    
    alert('🎲 일간 퀘스트가 새로 생성되었습니다!');
    
    // 퀘스트 페이지가 열려있으면 새로고침
    if (document.getElementById('questPage').classList.contains('active')) {
        await renderQuestPage();
    }
}

async function applyCheatDay() {
    const today = formatDate(new Date());
    await dbSet(`cheatDay_${today}`, true);
    alert('🍕 치팅데이가 적용되었습니다! 오늘은 게임시간과 지출에 제한이 없습니다.');
}

async function deleteReward(instanceId) {
    if (!confirm('정말로 이 보상을 삭제하시겠습니까?')) return;
    
    const rewardData = await getUserRewards();
    rewardData.unlockedRewards = rewardData.unlockedRewards.filter(r => r.instanceId !== instanceId);
    
    await saveUserRewards(rewardData);
    await renderEnhancedRewardsList();
}

// 프로필 메뉴 관련 함수들
function showProfileMenu() {
    const menu = document.getElementById('profileMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// 메뉴 외부 클릭 시 닫기
document.addEventListener('click', function(event) {
    const profileWidget = document.getElementById('profileWidget');
    const profileMenu = document.getElementById('profileMenu');
    
    if (!profileWidget.contains(event.target) && !profileMenu.contains(event.target)) {
        profileMenu.style.display = 'none';
    }
});

// 기존 showQuestPage 함수 수정
function showQuestPage() {
    document.getElementById('profileMenu').style.display = 'none';
    showPage('questPage');
    renderQuestPage();
}

// 기존 updateQuestProgress 함수를 찾아서 수정:
async function updateQuestProgress(questType, questId, currentValue, date = new Date()) {
    // === 오늘 날짜가 아니면 퀘스트 진행도 업데이트 안함 ===
    const today = new Date();
    const targetDate = new Date(date);
    
    // 날짜만 비교 (시간 제외)
    today.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);
    
    if (targetDate.getTime() !== today.getTime()) {
        // 오늘이 아닌 날짜를 수정해도 퀘스트 진행도에 반영 안함
        return false;
    }
    
    let questData;
    let saveKey;
    
    switch(questType) {
        case 'daily':
            questData = await getDailyQuests(date);
            saveKey = `dailyQuests_${formatDate(date)}`;
            break;
        case 'weekly':
            const weekStart = getWeekDates(date)[0];
            questData = await getWeeklyQuests(date);
            saveKey = `weeklyQuests_${weekStart}`;
            break;
        case 'monthly':
            const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
            questData = await getMonthlyQuests(date);
            saveKey = `monthlyQuests_${monthKey}`;
            break;
    }
    
    if (!questData) return false;
    
    const quest = questData.quests.find(q => q.id === questId);
    if (!quest) return false;
    
    const oldProgress = quest.progress;
    quest.progress = Math.min(currentValue, quest.maxProgress);
    
    // 퀘스트 완료 체크
    if (!quest.completed && quest.progress >= quest.maxProgress) {
        quest.completed = true;
        questData.completedCount++;
        
        // 경험치 지급
        await addExperience(quest.reward, `${questType} 퀘스트: ${quest.title}`);
        
        // 완료 알림
        showQuestCompleteNotification(quest);
        
        // === 퀘스트 완료 업적 체크 ===
        await checkQuestCompletionAchievements(questType, questData, date);
    }
    
    await dbSet(saveKey, questData);
    
    return quest.completed && oldProgress < quest.maxProgress;
}

// 퀘스트 완료 업적 체크 함수
async function checkQuestCompletionAchievements(questType, questData, date) {
    const unlocked = await dbGet('unlockedAchievements') || [];
    const totalQuests = questData.quests.length;
    const completedQuests = questData.completedCount;
    
    // 모든 퀘스트 완료 시
    if (completedQuests >= totalQuests) {
        
        if (questType === 'daily') {
            // 일일 퀘스트 모두 완료
            if (!unlocked.includes('ACH_DAILY_QUEST_ALL_CLEAR_FIRST')) {
                await unlockAchievement('ACH_DAILY_QUEST_ALL_CLEAR_FIRST');
            }
            
            // 일일 퀘스트 완료 횟수 체크
            const allData = await dbGetAll();
            const allDailyQuests = allData.filter(item => item.key.startsWith('dailyQuests_'));
            const dailyCompletionCount = allDailyQuests.filter(item => 
                item.value.completedCount >= item.value.quests.length
            ).length;
            
            if (!unlocked.includes('ACH_DAILY_QUEST_ALL_CLEAR_50') && dailyCompletionCount >= 50) {
                await unlockAchievement('ACH_DAILY_QUEST_ALL_CLEAR_50');
            } else if (!unlocked.includes('ACH_DAILY_QUEST_ALL_CLEAR_10') && dailyCompletionCount >= 10) {
                await unlockAchievement('ACH_DAILY_QUEST_ALL_CLEAR_10');
            }
        }
        
        else if (questType === 'weekly') {
            // 주간 퀘스트 모두 완료
            if (!unlocked.includes('ACH_WEEKLY_QUEST_ALL_CLEAR_FIRST')) {
                await unlockAchievement('ACH_WEEKLY_QUEST_ALL_CLEAR_FIRST');
            }
            
            // 주간 퀘스트 완료 횟수 체크
            const allData = await dbGetAll();
            const allWeeklyQuests = allData.filter(item => item.key.startsWith('weeklyQuests_'));
            const weeklyCompletionCount = allWeeklyQuests.filter(item => 
                item.value.completedCount >= item.value.quests.length
            ).length;
            
            if (!unlocked.includes('ACH_WEEKLY_QUEST_ALL_CLEAR_5') && weeklyCompletionCount >= 5) {
                await unlockAchievement('ACH_WEEKLY_QUEST_ALL_CLEAR_5');
            }
        }
        
        else if (questType === 'monthly') {
            // 월간 퀘스트 모두 완료
            if (!unlocked.includes('ACH_MONTHLY_QUEST_ALL_CLEAR_FIRST')) {
                await unlockAchievement('ACH_MONTHLY_QUEST_ALL_CLEAR_FIRST');
            }
            
            // 월간 퀘스트 완료 횟수 체크
            const allData = await dbGetAll();
            const allMonthlyQuests = allData.filter(item => item.key.startsWith('monthlyQuests_'));
            const monthlyCompletionCount = allMonthlyQuests.filter(item => 
                item.value.completedCount >= item.value.quests.length
            ).length;
            
            if (!unlocked.includes('ACH_MONTHLY_QUEST_ALL_CLEAR_3') && monthlyCompletionCount >= 3) {
                await unlockAchievement('ACH_MONTHLY_QUEST_ALL_CLEAR_3');
            }
        }
    }
}

// 식단 관련 업적 체크 함수
async function checkFoodRecordAchievements() {
    const unlocked = await dbGet('unlockedAchievements') || [];
    const allData = await dbGetAll();
    
    // 7일 연속 식단 기록 체크
    if (!unlocked.includes('ACH_FOOD_DIARIST_7DAYS')) {
        let consecutiveFoodDays = 0;
        const today = new Date();
        
        for (let i = 0; i < 7; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            const dateStr = formatDate(checkDate);
            
            const hasFoodRecord = allData.some(item => 
                item.key.startsWith('food_') && item.value.date === dateStr
            );
            
            if (hasFoodRecord) {
                consecutiveFoodDays++;
            } else {
                break;
            }
        }
        
        if (consecutiveFoodDays >= 7) {
            await unlockAchievement('ACH_FOOD_DIARIST_7DAYS');
        }
    }
}

// 월말에만 체크하는 업적들 ===
async function checkMonthEndAchievements(date) {
    const unlocked = await dbGet('unlockedAchievements') || [];
    const today = new Date(date);
    const { start, end } = getMonthDateRange(today);
    const allData = await dbGetAll();
    
    // 건강 식단의 달인 (한 달 간식/외식 5회 미만)
    if (!unlocked.includes('ACH_HEALTHY_EATER_MONTH')) {
        const junkFoodKeywords = ['맥도날드', '버거킹', 'kfc', '롯데리아', '햄버거', '버거', '치킨', '피자', 
                                  '과자', '초콜릿', '사탕', '아이스크림', '젤라또', '케이크', '도넛', '떡볶이'];
        
        const junkFoodCount = allData.filter(item => 
            item.key.startsWith('food_') && 
            item.value.date >= start && 
            item.value.date <= end &&
            junkFoodKeywords.some(keyword => 
                item.value.foodName.toLowerCase().includes(keyword.toLowerCase())
            )
        ).length;
        
        if (junkFoodCount < 5) {
            await unlockAchievement('ACH_HEALTHY_EATER_MONTH');
        }
    }
    
    // 무지출의 달 (한 달 총 지출 0원)
    if (!unlocked.includes('ACH_ZERO_SPEND_MONTH')) {
        const expenses = allData.filter(item => 
            item.key.startsWith('expense_') && 
            item.value.date >= start && 
            item.value.date <= end
        );
        const totalSpent = expenses.reduce((sum, item) => sum + item.value.amount, 0);
        
        if (totalSpent === 0) {
            await unlockAchievement('ACH_ZERO_SPEND_MONTH');
        }
    }
    
    // 저축의 왕 (한 달 예산의 50% 미만 지출)
    if (!unlocked.includes('ACH_SAVING_KING')) {
        const budget = await dbGet('monthlyBudget') || 0;
        if (budget > 0) {
            const expenses = allData.filter(item => 
                item.key.startsWith('expense_') && 
                item.value.date >= start && 
                item.value.date <= end
            );
            const totalSpent = expenses.reduce((sum, item) => sum + item.value.amount, 0);
            
            if (totalSpent < budget * 0.5) {
                await unlockAchievement('ACH_SAVING_KING');
            }
        }
    }
    
    // 철의 위장 (한 달 동안 라면 없음)
    if (!unlocked.includes('ACH_NO_RAMEN')) {
        const ramenRecords = allData.filter(item => 
            item.key.startsWith('food_') && 
            item.value.date >= start && 
            item.value.date <= end &&
            item.value.foodName.toLowerCase().includes('라면')
        );
        
        if (ramenRecords.length === 0) {
            await unlockAchievement('ACH_NO_RAMEN');
        }
    }
    
    // 액상과당 안녕 (한 달 동안 라떼 없음)
    if (!unlocked.includes('ACH_NO_LATTE')) {
        const latteRecords = allData.filter(item => 
            item.key.startsWith('food_') && 
            item.value.date >= start && 
            item.value.date <= end &&
            item.value.foodName.toLowerCase().includes('라떼')
        );
        
        if (latteRecords.length === 0) {
            await unlockAchievement('ACH_NO_LATTE');
        }
    }
    
    // 강철 체력 (한 달 운동 20회 이상)
    if (!unlocked.includes('ACH_IRON_BODY')) {
        const exerciseCount = allData.filter(item => 
            item.key.startsWith('day_') && 
            item.value.date >= start && 
            item.value.date <= end &&
            item.value.exercise?.done
        ).length;
        
        if (exerciseCount >= 20) {
            await unlockAchievement('ACH_IRON_BODY');
        }
    }
    
    // 완벽한 한 달 (매일 기상시간 기록)
    if (!unlocked.includes('ACH_PERFECT_MONTH')) {
        const monthDates = getMonthDates(today);
        const recordedDays = allData.filter(item => 
            item.key.startsWith('day_') && 
            monthDates.includes(item.value.date) &&
            item.value.wakeTime
        ).length;
        
        if (recordedDays === monthDates.length) {
            await unlockAchievement('ACH_PERFECT_MONTH');
        }
    }
    
    // 연속 예산 관리 체크 (3개월, 6개월)
    const budget = await dbGet('monthlyBudget') || 0;
    if (budget > 0) {
        const currentExpenses = allData.filter(item => 
            item.key.startsWith('expense_') && 
            item.value.date >= start && 
            item.value.date <= end
        );
        const currentTotal = currentExpenses.reduce((sum, item) => sum + item.value.amount, 0);
        
        if (currentTotal < budget * 0.8) {
            // 3개월 연속 체크
            let consecutiveBudgetMonths = 1; // 이번 달 포함
            
            for (let i = 1; i < 6; i++) {
                const checkDate = new Date(today);
                checkDate.setMonth(checkDate.getMonth() - i);
                const { start: checkStart, end: checkEnd } = getMonthDateRange(checkDate);
                
                const checkExpenses = allData.filter(item => 
                    item.key.startsWith('expense_') && 
                    item.value.date >= checkStart && 
                    item.value.date <= checkEnd
                );
                const checkTotal = checkExpenses.reduce((sum, item) => sum + item.value.amount, 0);
                
                if (checkTotal < budget * 0.8) {
                    consecutiveBudgetMonths++;
                } else {
                    break;
                }
            }
            
            if (!unlocked.includes('ACH_FINANCIAL_FREEDOM') && consecutiveBudgetMonths >= 6) {
                await unlockAchievement('ACH_FINANCIAL_FREEDOM');
            } else if (!unlocked.includes('ACH_BUDGET_MASTER_3MONTH') && consecutiveBudgetMonths >= 3) {
                await unlockAchievement('ACH_BUDGET_MASTER_3MONTH');
            }
        }
    }
}

// 주간 업적 중 특별한 체크가 필요한 것들
async function checkWeekEndAchievements(date) {
    const unlocked = await dbGet('unlockedAchievements') || [];
    const allData = await dbGetAll();
    
    // 디지털 디톡스 (주말 이틀 동안 게임 0분)
    if (!unlocked.includes('ACH_DIGITAL_DETOX')) {
        const today = new Date(date);
        const dayOfWeek = today.getDay();
        
        if (dayOfWeek === 0) { // 일요일인 경우만 체크
            const saturday = new Date(today);
            saturday.setDate(saturday.getDate() - 1);
            
            const saturdayData = await dbGet(`day_${formatDate(saturday)}`);
            const sundayData = await dbGet(`day_${formatDate(today)}`);
            
            const saturdayGameTime = saturdayData?.gameTime || 0;
            const sundayGameTime = sundayData?.gameTime || 0;
            
            if (saturdayGameTime === 0 && sundayGameTime === 0) {
                await unlockAchievement('ACH_DIGITAL_DETOX');
            }
        }
    }
    
    // 현자타임 (7일 연속 게임 0분)
    if (!unlocked.includes('ACH_SAGE_MODE')) {
        let consecutiveNoGameDays = 0;
        
        for (let i = 0; i < 7; i++) {
            const checkDate = new Date(date);
            checkDate.setDate(checkDate.getDate() - i);
            const dayData = await dbGet(`day_${formatDate(checkDate)}`);
            
            if (dayData && (dayData.gameTime === 0 || !dayData.gameTime)) {
                consecutiveNoGameDays++;
            } else {
                break;
            }
        }
        
        if (consecutiveNoGameDays >= 7) {
            await unlockAchievement('ACH_SAGE_MODE');
        }
    }
    
    // 클린 이터 (일주일 간식/외식 3회 미만)
    if (!unlocked.includes('ACH_CLEAN_EATER')) {
        const weekDates = getWeekDates(new Date(date));
        
        const junkFoodKeywords = ['맥도날드', '버거킹', 'kfc', '롯데리아', '햄버거', '버거', '치킨', '피자', 
                                  '과자', '초콜릿', '사탕', '아이스크림', '젤라또', '케이크', '도넛', '떡볶이'];
        
        const junkFoodCount = allData.filter(item => 
            item.key.startsWith('food_') && 
            weekDates.includes(item.value.date) &&
            junkFoodKeywords.some(keyword => 
                item.value.foodName.toLowerCase().includes(keyword.toLowerCase())
            )
        ).length;
        
        if (junkFoodCount < 3) {
            await unlockAchievement('ACH_CLEAN_EATER');
        }
    }
    
    // 완벽한 통제 (부정적 습관 목표 7일 연속 100% 달성)
    if (!unlocked.includes('ACH_PERFECT_CONTROL')) {
        const weekDates = getWeekDates(new Date(date));
        const allGoals = await getPersonalGoals();
        const negativeGoals = allGoals.filter(goal => goal.type === 'negative' && !goal.isCompleted);
        
        if (negativeGoals.length > 0) {
            let perfectWeek = true;
            
            for (const dateStr of weekDates) {
                const dayData = await dbGet(`day_${dateStr}`);
                if (!dayData) {
                    perfectWeek = false;
                    break;
                }
                
                for (const goal of negativeGoals) {
                    const achieved = dayData.personalGoals?.[goal.id] || 0;
                    const usageRatio = achieved / goal.target;
                    const percentage = Math.max(0, (1 - usageRatio) * 100);
                    
                    if (percentage < 100) {
                        perfectWeek = false;
                        break;
                    }
                }
                
                if (!perfectWeek) break;
            }
            
            if (perfectWeek) {
                await unlockAchievement('ACH_PERFECT_CONTROL');
            }
        }
    }
    
    // 올빼미, 아니 독수리 (새벽 5시 이전 3일 연속 기상)
    if (!unlocked.includes('ACH_EARLY_BIRD')) {
        let consecutiveEarlyDays = 0;
        
        for (let i = 0; i < 3; i++) {
            const checkDate = new Date(date);
            checkDate.setDate(checkDate.getDate() - i);
            const dayData = await dbGet(`day_${formatDate(checkDate)}`);
            
            if (dayData?.wakeTime) {
                const wakeMinutes = timeToMinutes(dayData.wakeTime);
                if (wakeMinutes < 300) { // 5시 이전
                    consecutiveEarlyDays++;
                } else {
                    break;
                }
            } else {
                break;
            }
        }
        
        if (consecutiveEarlyDays >= 3) {
            await unlockAchievement('ACH_EARLY_BIRD');
        }
    }
    
    // 규칙적인 취침 (일주일 내내 목표 취침시간 ±15분)
    if (!unlocked.includes('ACH_REGULAR_SLEEP')) {
        const weekDates = getWeekDates(new Date(date));
        let regularSleepWeek = true;
        
        // 목표 취침시간을 1시로 가정 (사용자 설정이 없으면)
        const targetSleepMinutes = 60; // 1:00 AM = 60분
        
        for (const dateStr of weekDates) {
            const dayData = await dbGet(`day_${dateStr}`);
            
            if (dayData?.sleepTime) {
                const sleepMinutes = timeToMinutes(dayData.sleepTime);
                const adjustedSleep = sleepMinutes < 360 ? sleepMinutes + 1440 : sleepMinutes;
                const diff = Math.abs(adjustedSleep - (targetSleepMinutes + 1440));
                
                if (diff > 15) { // ±15분 벗어남
                    regularSleepWeek = false;
                    break;
                }
            } else {
                regularSleepWeek = false;
                break;
            }
        }
        
        if (regularSleepWeek) {
            await unlockAchievement('ACH_REGULAR_SLEEP');
        }
    }
}

// 퀘스트 완료 알림
function showQuestCompleteNotification(quest) {
    // 간단한 토스트 알림
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = `✅ ${quest.title} 완료! (+${quest.reward} EXP)`;
    
    // 애니메이션 CSS 추가
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// 일일 데이터 변경 시 퀘스트 진행도 자동 업데이트
async function checkAndUpdateAllQuests(dayData, date = new Date()) {
    // === 오늘 날짜가 아니면 퀘스트 업데이트 안함 ===
    const today = new Date();
    const targetDate = new Date(date);
    
    today.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);
    
    if (targetDate.getTime() !== today.getTime()) {
        // 오늘이 아닌 날짜를 수정해도 퀘스트에 반영 안함
        return;
    }
    
    const promises = [];
    
    // 입력 즉시 체크되어야 하는 퀘스트들 (오늘 날짜만)
    if (dayData.wakeTime) {
        promises.push(updateQuestProgress('daily', 'attendance', 1, date));
    }
    
    if (dayData.sleepTime) {
        promises.push(updateQuestProgress('daily', 'sleep_time', 1, date));
    }
    
    if (dayData.seatTime) {
        promises.push(updateQuestProgress('daily', 'seat_time', 1, date));
    }
    
    const totalPomodoro = (dayData.pomodoro?.morning || 0) + (dayData.pomodoro?.afternoon || 0) + (dayData.pomodoro?.evening || 0);
    if (totalPomodoro > 0) {
        promises.push(updateQuestProgress('daily', 'pomodoro_3', totalPomodoro, date)); 
    }
    
    if (dayData.writing > 0) {
        promises.push(updateQuestProgress('daily', 'writing_300', dayData.writing, date));
    }
    
    // 운동 시간 입력 즉시 체크 (10분 이상 조건 제거하고 입력만으로 체크)
    if (dayData.exercise?.done || (dayData.exercise?.minutes > 0)) {
        const minutes = dayData.exercise?.minutes || 0;
        promises.push(updateQuestProgress('daily', 'exercise_10min', minutes, date));
    }
    
    if (dayData.comment) {
        promises.push(updateQuestProgress('daily', 'daily_comment', 1, date));
    }
    
    // 개인목표 입력 즉시 체크 (50% 조건 제거하고 입력만으로 체크)
    const goalAverage = await calculatePersonalGoalAverage(dayData, formatDate(date));
    if (goalAverage > 0) { 
        promises.push(updateQuestProgress('daily', 'personal_goal_50', goalAverage, date));
    }
    
    // 식단 기록 체크
    const foodRecordCount = await getDailyFoodRecordCount(date);
    if (foodRecordCount >= 1) { 
        promises.push(updateQuestProgress('daily', 'food_record_1', foodRecordCount, date));
    }
    
    // 목표 시간 기상 체크
    const targetWakeTime = await dbGet('targetWakeTime');
    if (targetWakeTime && dayData.wakeTime) {
        const targetMinutes = timeToMinutes(targetWakeTime);
        const actualMinutes = timeToMinutes(dayData.wakeTime);
        const diff = Math.abs(actualMinutes - targetMinutes);
        if (diff <= 60) { 
            promises.push(updateQuestProgress('daily', 'wake_on_time_1hour', 1, date));
        }
    }
    
    await Promise.all(promises);
    
    // 주간/월간 퀘스트도 업데이트 (오늘만)
    await updateWeeklyQuests(date);
    await updateMonthlyQuests(date);
}

// 일간 종료 시점 퀘스트 체크
async function checkEndOfDayQuests(dayData, date) {
    // === 오늘 날짜가 아니면 종료 시점 퀘스트 체크 안함 ===
    const today = new Date();
    const targetDate = new Date(date);
    
    today.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);
    
    if (targetDate.getTime() !== today.getTime()) {
        return; // 오늘이 아니면 체크 안함
    }
    
    const promises = [];
    
    // 1. 지출 1만원 이하 체크
    const dailyExpenses = await getDailyExpenseTotal(date);
    if (dailyExpenses <= 10000) {
        promises.push(updateQuestProgress('daily', 'expense_under_10k', 1, date));
    }
    
    // 2. 게임시간 60분 이하 체크
    if (dayData.gameTime <= 60) {
        promises.push(updateQuestProgress('daily', 'game_under_60min', 1, date));
    }
    
    // 3. 마이너스 점수 피하기 체크
    if (dayData.score >= 0) {
        promises.push(updateQuestProgress('daily', 'no_negative_score_today', 1, date));
    }
    
    await Promise.all(promises);
}

// 보조 함수들
async function getDailyExpenseTotal(date) {
    const dateStr = formatDate(date);
    const allData = await dbGetAll();
    const expenses = allData.filter(item => 
        item.key.startsWith('expense_') && item.value.date === dateStr
    );
    return expenses.reduce((sum, item) => sum + item.value.amount, 0);
}

async function getDailyFoodRecordCount(date) {
    const dateStr = formatDate(date);
    const allData = await dbGetAll();
    const foodRecords = allData.filter(item => 
        item.key.startsWith('food_') && item.value.date === dateStr
    );
    return foodRecords.length;
}

// 주간 퀘스트 진행도 업데이트
async function updateWeeklyQuests(date) {
    const weekDates = getWeekDates(date);
    const weekStart = weekDates[0];
    
    // 이번 주 전체 데이터 가져오기
    const weekDataPromises = weekDates.map(d => dbGet(`day_${d}`));
    const weekData = await Promise.all(weekDataPromises);
    
    // 지출 데이터 가져오기
    const allData = await dbGetAll();
    const weekExpenses = allData.filter(item => 
        item.key.startsWith('expense_') && 
        weekDates.includes(item.value.date)
    );
    
    // 식단 데이터 가져오기
    const weekFoodRecords = allData.filter(item => 
        item.key.startsWith('food_') && 
        weekDates.includes(item.value.date)
    );
    
    // 1. 주간 출석 6일
    const attendanceCount = weekData.filter(d => d?.wakeTime).length;
    await updateQuestProgress('weekly', 'weekly_attendance_6days', attendanceCount, date);
    
    // 2. 01:00 이전 취침 4회
    const earlySleepCount = weekData.filter(d => {
        if (!d?.sleepTime) return false;
        const sleepMinutes = timeToMinutes(d.sleepTime);
        return sleepMinutes <= 60 || sleepMinutes >= 1440; // 01:00 이전
    }).length;
    await updateQuestProgress('weekly', 'weekly_early_sleep_4times', earlySleepCount, date);
    
    // 5. 주간 우수생 (50점 이상 5일)
    const highScoreDays = weekData.filter(d => d && d.score >= 50).length;
    await updateQuestProgress('weekly', 'weekly_high_score_5days', highScoreDays, date);
    
    // 8. 지출 기록 7일
    const expenseRecordDays = new Set(weekExpenses.map(item => item.value.date)).size;
    await updateQuestProgress('weekly', 'weekly_expense_tracking_7days', expenseRecordDays, date);
    
    // 9. 스트레스 해소 기록 (명상 관련 키워드)
    const stressReliefKeywords = ['명상', '휴식', '산책', '독서', '음악', '영화', '여행', '마사지', '요가', '스트레칭'];
    const hasStressRelief = weekData.some(d => 
        d?.comment && stressReliefKeywords.some(keyword => 
            d.comment.includes(keyword)
        )
    );
    if (hasStressRelief) {
        await updateQuestProgress('weekly', 'weekly_stress_relief_comment', 1, date);
    }
    
    // 10. 모든 시간 기록 5일
    const allTimeInputDays = weekData.filter(d => 
        d?.wakeTime && d?.seatTime && d?.sleepTime
    ).length;
    await updateQuestProgress('weekly', 'weekly_all_time_input_5days', allTimeInputDays, date);

    // 12. 주간 글쓰기 8,000자
    const totalWriting = weekData.reduce((sum, d) => sum + (d?.writing || 0), 0);
    await updateQuestProgress('weekly', 'weekly_writing_8000', totalWriting, date);
    
    // 13. 개인 목표 주평균 70%
    const goalAverages = await Promise.all(weekData.map(async (d, index) => {
        if (!d) return 0;
        return await calculatePersonalGoalAverage(d, weekDates[index]);
    }));
    const weekGoalAverage = goalAverages.reduce((sum, avg) => sum + avg, 0) / goalAverages.length;
    if (weekGoalAverage >= 70) {
        await updateQuestProgress('weekly', 'weekly_personal_goal_avg_70', 1, date);
    }
    
    // 14. 완벽한 아침 3회 (목표시간 ±1시간 내 기상)
    const targetWakeTime = await dbGet('targetWakeTime');
    let perfectMorningCount = 0;
    if (targetWakeTime) {
        const targetMinutes = timeToMinutes(targetWakeTime);
        perfectMorningCount = weekData.filter(d => {
            if (!d?.wakeTime) return false;
            const actualMinutes = timeToMinutes(d.wakeTime);
            const diff = Math.abs(actualMinutes - targetMinutes);
            return diff <= 60; // ±1시간
        }).length;
    }
    await updateQuestProgress('weekly', 'weekly_perfect_morning_3', perfectMorningCount, date);
    
    // 15. 주간 운동 4회
    const exerciseCount = weekData.filter(d => d?.exercise?.done).length;
    await updateQuestProgress('weekly', 'weekly_exercise_4times', exerciseCount, date);
    
    // 16. 주간 뽀모도로 25개
    const totalPomodoro = weekData.reduce((sum, d) => {
        if (!d) return sum;
        return sum + (d.pomodoro?.morning || 0) + (d.pomodoro?.afternoon || 0) + (d.pomodoro?.evening || 0);
    }, 0);
    await updateQuestProgress('weekly', 'weekly_pomodoro_25', totalPomodoro, date);
}

// 주간 종료 시점 퀘스트 체크 (일요일에만 실행)
async function checkEndOfWeekQuests(date) {
    const weekDates = getWeekDates(date);
    const weekDataPromises = weekDates.map(d => dbGet(`day_${d}`));
    const weekData = await Promise.all(weekDataPromises);
    
    const allData = await dbGetAll();
    const weekExpenses = allData.filter(item => 
        item.key.startsWith('expense_') && 
        weekDates.includes(item.value.date)
    );
    const weekFoodRecords = allData.filter(item => 
        item.key.startsWith('food_') && 
        weekDates.includes(item.value.date)
    );
    
    // 1. 주간 지출 10만원 이하
    const totalWeekExpense = weekExpenses.reduce((sum, item) => sum + item.value.amount, 0);
    if (totalWeekExpense <= 100000) {
        await updateQuestProgress('weekly', 'weekly_expense_under_100k', 1, date);
    }
    
    // 2. 주간 게임 3시간 이하
    const totalGameTime = weekData.reduce((sum, d) => sum + (d?.gameTime || 0), 0);
    if (totalGameTime <= 180) {
        await updateQuestProgress('weekly', 'weekly_low_game_total', 1, date);
    }
    
    // 3. 주말 디지털 디톡스
    const weekendGameTime = weekData
        .filter((d, index) => (index === 5 || index === 6) && d)
        .reduce((sum, d) => sum + (d.gameTime || 0), 0);
    if (weekendGameTime === 0) {
        await updateQuestProgress('weekly', 'weekly_no_game_weekend', 1, date);
    }
    
    // 4. 패스트푸드 1회 미만
    const fastfoodKeywords = ['맥도날드', '버거킹', 'kfc', '롯데리아', '햄버거', '버거', '치킨', '피자'];
    const fastfoodCount = weekFoodRecords.filter(item => 
        fastfoodKeywords.some(keyword => 
            item.value.foodName.toLowerCase().includes(keyword.toLowerCase())
        )
    ).length;
    if (fastfoodCount < 1) {
        await updateQuestProgress('weekly', 'weekly_no_fastfood', 1, date);
    }
    
    // 5. 금주 챌린지
    const alcoholKeywords = ['술', '맥주', '소주', '와인', '칵테일', '위스키', '보드카'];
    const hasAlcohol = weekFoodRecords.some(item => 
        alcoholKeywords.some(keyword => 
            item.value.foodName.toLowerCase().includes(keyword.toLowerCase())
        )
    ) || weekData.some(d => 
        d?.comment && alcoholKeywords.some(keyword => 
            d.comment.includes(keyword)
        )
    );
    if (!hasAlcohol) {
        await updateQuestProgress('weekly', 'weekly_no_alcohol', 1, date);
    }
}

// 월간 퀘스트 진행도 업데이트
async function updateMonthlyQuests(date) {
    const monthDates = getMonthDates(date);
    
    // 이번 달 전체 데이터 가져오기
    const monthDataPromises = monthDates.map(d => dbGet(`day_${d}`));
    const monthData = (await Promise.all(monthDataPromises)).filter(d => d);
    
    // 지출 및 식단 데이터 가져오기
    const allData = await dbGetAll();
    const monthExpenses = allData.filter(item => 
        item.key.startsWith('expense_') && 
        monthDates.includes(item.value.date)
    );
    const monthFoodRecords = allData.filter(item => 
        item.key.startsWith('food_') && 
        monthDates.includes(item.value.date)
    );
    
    // 1. 완벽한 한 달 (매일 기상시간 기록 30번)
    const wakeTimeRecordDays = monthData.filter(d => d.wakeTime).length;
    await updateQuestProgress('monthly', 'monthly_perfect_attendance', wakeTimeRecordDays, date);

    // 2. 왕좌의 주인 (착석 시간 기록 20번)
    const seatTimeRecordDays = monthData.filter(d => d.seatTime).length;
    await updateQuestProgress('monthly', 'monthly_consistent_seat_time_input', seatTimeRecordDays, date);
    
    // 3. 월간 피트니스 챔피언 (15회 운동)
    const exerciseCount = monthData.filter(d => d.exercise?.done).length;
    await updateQuestProgress('monthly', 'monthly_exercise_15times', exerciseCount, date);
    
    // 5. 새벽형 인간의 등불 (15회 목표시간 ±30분 내 기상)
    const targetWakeTime = await dbGet('targetWakeTime');
    let earlyBirdCount = 0;
    if (targetWakeTime) {
        const targetMinutes = timeToMinutes(targetWakeTime);
        earlyBirdCount = monthData.filter(d => {
            if (!d.wakeTime) return false;
            const actualMinutes = timeToMinutes(d.wakeTime);
            const diff = Math.abs(actualMinutes - targetMinutes);
            return diff <= 30; // ±30분
        }).length;
    }
    await updateQuestProgress('monthly', 'monthly_early_bird_15times', earlyBirdCount, date);
    
    // 7. 풍화설월 비밀 문서 (8만 자 글쓰기)
    const totalWriting = monthData.reduce((sum, d) => sum + (d.writing || 0), 0);
    await updateQuestProgress('monthly', 'monthly_writing_80k', totalWriting, date);
    
    // 8. 미호크의 명상 시간 (20일 취침 시간 기록)
    const sleepTimeRecordDays = monthData.filter(d => d.sleepTime).length;
    await updateQuestProgress('monthly', 'monthly_consistent_sleep_input', sleepTimeRecordDays, date);
    
    // 9. 월간 우수생 (80점 이상 15일)
    const highScoreDays = monthData.filter(d => d.score >= 80).length;
    await updateQuestProgress('monthly', 'monthly_high_score_15days', highScoreDays, date);
    
    // 10. 디미트리의 이상과 현실 (월평균 70% 개인목표 달성률)
    if (monthData.length > 0) {
        const goalAverages = await Promise.all(monthData.map(async (d) => {
            return await calculatePersonalGoalAverage(d, d.date);
        }));
        const monthGoalAverage = goalAverages.reduce((sum, avg) => sum + avg, 0) / goalAverages.length;
        if (monthGoalAverage >= 70) {
            await updateQuestProgress('monthly', 'monthly_personal_goal_avg_70', 1, date);
        }
    }
}

// 월간 종료 시점 퀘스트 체크 (월말에만 실행)
async function checkEndOfMonthQuests(date) {
    const monthDates = getMonthDates(date);
    const monthDataPromises = monthDates.map(d => dbGet(`day_${d}`));
    const monthData = (await Promise.all(monthDataPromises)).filter(d => d);
    
    const allData = await dbGetAll();
    const monthExpenses = allData.filter(item => 
        item.key.startsWith('expense_') && 
        monthDates.includes(item.value.date)
    );
    
    // 1. 예산 50% 이하
    const budget = await dbGet('monthlyBudget') || 0;
    const totalMonthExpense = monthExpenses.reduce((sum, item) => sum + item.value.amount, 0);
    if (budget > 0 && totalMonthExpense <= budget * 0.5) {
        await updateQuestProgress('monthly', 'monthly_budget_50percent', 1, date);
    }
    
    // 2. 게임 시간 0분
    const totalGameTime = monthData.reduce((sum, d) => sum + (d.gameTime || 0), 0);
    if (totalGameTime === 0) {
        await updateQuestProgress('monthly', 'monthly_no_game_entire_month', 1, date);
    }
}

// 업적 모달 관련 함수들
async function showAchievementsModal() {
    document.getElementById('profileMenu').style.display = 'none';
    document.getElementById('achievementsModal').style.display = 'flex';
    await renderAchievementsList();
}

function closeAchievementsModal() {
    document.getElementById('achievementsModal').style.display = 'none';
}

async function renderAchievementsList() {
    const container = document.getElementById('achievementsList');
    const unlockedAchievements = await dbGet('unlockedAchievements') || [];
    
    let html = '';
    let unlockedCount = 0;
    
    for (const [id, achievement] of Object.entries(ACHIEVEMENTS_LIST)) {
    const isUnlocked = unlockedAchievements.includes(id);
    if (isUnlocked) unlockedCount++;
    
    const statusClass = isUnlocked ? 'unlocked' : 'locked';
    const emoji = isUnlocked ? '🏅' : '🔒';
    const statusText = isUnlocked ? '달성' : '미달성';
    
    // 히든 업적 처리
    const isHidden = id.startsWith('ACH_HIDDEN_') && !isUnlocked;
    const displayName = isHidden ? '숨겨짐' : achievement.name;
    const displayDesc = isHidden ? '설명이 숨겨져 있습니다.' : achievement.desc;
    const hiddenClass = isHidden ? 'hidden' : '';
    
    html += `
        <div class="achievement-item ${statusClass} ${hiddenClass}">
            <div class="achievement-emoji">${emoji}</div>
            <div class="achievement-info">
                <div class="achievement-name">${displayName}</div>
                <div class="achievement-desc">${displayDesc}</div>
            </div>
            <div class="achievement-status ${statusClass}">${statusText}</div>
        </div>
    `;
}
    
    // 진행률 표시
    const totalAchievements = Object.keys(ACHIEVEMENTS_LIST).length;
    const progressText = `달성률: ${unlockedCount}/${totalAchievements} (${Math.round(unlockedCount/totalAchievements*100)}%)`;
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: var(--primary-light); border-radius: 12px; color: var(--primary-color); font-weight: 600;">
            ${progressText}
        </div>
        ${html}
    `;
}

        // Firebase 앱 초기화 및 전역 변수 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCiHL1nkWtAh6xSXLi9V-TqWwmfPLUfX0U",
            authDomain: "routine-tracker-be367.firebaseapp.com",
            projectId: "routine-tracker-be367",
            storageBucket: "routine-tracker-be367.appspot.com",
            messagingSenderId: "687819364391",
            appId: "1:687819364391:web:f30b0660887af52e16d602"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 
        let currentUser = null; 
        let currentUserName = "사용자";
        const EMAILJS_SERVICE_ID = 'service_kjtvf9i';
        const EMAILJS_TEMPLATE_ID = 'template_hq8bm4c';
        const EMAILJS_PUBLIC_KEY = 'irHy1AuEA7_OkkyrC';

// 디바운스 함수: 특정 시간 동안 반복 호출 시 마지막 호출만 실행
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 명언 및 감성 분석 데이터
const SENTIMENT_DATA = {
    positive: {
        keywords: ['좋았다', '기쁘다', '신난다', '뿌듯', '행복', '성공', '만족', '최고', '달성', '즐겁'],
        quotes: [
            { title: "기쁨은 힘이다!", msg: "오늘의 기쁨이 내일의 더 큰 성공을 불러올 것입니다." },
            { title: "끈기가 답이다", msg: "성공은 가장 끈기 있는 사람에게 찾아온다. - 나폴레옹" },
            { title: "최고의 나날", msg: "그 좋은 기운을 계속 이어나가세요. 당신은 무엇이든 할 수 있습니다!" },
            { title: "역사를 쓰다", msg: "당신이 가는 길이 바로 역사가 됩니다. 계속 전진하세요." },
            { title: "성장의 증거", msg: "오늘 느낀 뿌듯함, 그것이 바로 당신이 성장하고 있다는 증거입니다." },
            { title: "믿음의 힘", msg: "스스로를 믿는 것처럼 강력한 동기부여는 없다." },
            { title: "티끌 모아 태산", msg: "작은 성공들이 모여 위대한 성취를 이룹니다." },
            { title: "긍정 에너지", msg: "당신의 긍정적인 에너지가 주변까지 밝게 만들고 있어요." },
            { title: "정상에서 만나요", msg: "계속 그렇게 나아가세요. 정상에서 만납시다!" },
            { title: "더 높은 곳으로", msg: "오늘의 만족에 안주하지 말고, 더 높은 곳을 향해 도전하세요." }
        ]
    },
    negative: {
        keywords: ['우울', '슬프다', '짜증', '분노', '힘들다', '지친다', '최악', '망했다', '실패', '화난'],
        quotes: [
            { title: "새벽이 온다", msg: "가장 어두운 시간은 해 뜨기 바로 직전이다. - 파울로 코엘료" },
            { title: "봄은 온다", msg: "겨울이 오면 봄이 멀지 않으리. - 퍼시 비시 셸리" },
            { title: "강력한 주문", msg: "'나는 할 수 있다.' 이 말은 스스로에게 하는 가장 강력한 주문입니다." },
            { title: "무한한 가능성", msg: "너 자신을 믿어라. 네 안에는 무한한 가능성이 있다. - 간디" },
            { title: "심호흡", msg: "깊은 숨을 쉬고, 천천히 생각하고, 모든 것이 잘 될 것이라고 스스로에게 말하라." },
            { title: "강인함", msg: "당신은 생각보다 훨씬 강한 사람입니다. 포기하지 마세요." },
            { title: "휴식의 필요성", msg: "오늘 하루도 정말 수고 많았어요. 잠시 쉬어가도 괜찮아요." },
            { title: "진정한 영광", msg: "가장 큰 영광은 실패할 때마다 다시 일어나는 데에 있다. - 공자" },
            { title: "살아있다는 증거", msg: "힘든 감정은 약함의 표시가 아니라, 치열하게 살아있다는 증거입니다." },
            { title: "내려놓기", msg: "힘들 때는 잠시 모든 것을 내려놓고 깊게 숨을 쉬어보세요." }
        ]
    }
};

        function formatNumberWithCommas(inputElement) {
            let value = inputElement.value.replace(/[^0-9]/g, '');
            if (value === '') {
                inputElement.value = '';
            } else {
                inputElement.value = parseInt(value, 10).toLocaleString('ko-KR');
            }
        }
        function unformatNumber(formattedValue) {
            if (typeof formattedValue !== 'string') return formattedValue;
            return Number(formattedValue.replace(/,/g, '')) || 0;
        }

        let currentDate = new Date();
        let selectedDate = null;
        let currentModalData = {};
        let currentGoalTab = 'active';
        let newGoalType = 'positive';
        const foodKeywords = [
            '카페', '스타벅스', '컴포즈', '메가', '매머드', '이디야', '할리스', '투썸', '빽다방', '커피빈',
            '베이커리', '빵', '파리바게트', '뚜레쥬르', '던킨', '크로플', '도넛', '크리스피',
            '간식', '주전부리', '디저트', '팝콘', '아이스크림', '젤라또', '과자', '초콜릿', '사탕', '떡볶이', '베스킨',
            '편의점', '마트', '씨유', 'cu', 'gs25', '세븐일레븐', '7eleven',
            '치킨', '피자', '햄버거', '맥도날드', '버거킹', 'kfc', '롯데리아', '라면',
            '음료', '주스', '탄산', '콜라', '사이다', '밀크티', '버블티', '스무디'
        ];
        let currentFoodExpenseData = null;
        let foodManageMode = false;
        const nf = new Intl.NumberFormat('ko-KR');
        const formatCurrency = (value) => `₩${nf.format(value)}`;
    
    // 사용자별로 데이터를 저장하기 위한 경로 생성 함수
    function getUserDataRef() {
    if (!currentUser) throw new Error("로그인한 사용자가 없습니다.");
    return db.collection('users').doc(currentUser.uid).collection('data');
}

async function dbSet(key, value) {
    const sanitizedValue = JSON.parse(JSON.stringify(value, (k, v) => v === undefined ? null : v));
    
    // 1. IndexedDB에 즉시 저장
    await localDB.set(key, sanitizedValue);
    
    // 2. 동기화 큐에 추가
    syncQueue.add(key);
    
    // 3. 백그라운드 Firebase 동기화 (로그인 상태일 때만)
    if (currentUser) {
        setTimeout(() => syncToFirebase(key, sanitizedValue), 0);
    }
}

async function dbGet(key) {
    // IndexedDB에서 먼저 조회 (초고속)
    return await localDB.get(key);
}

async function dbGetAll() {
    // IndexedDB에서 모든 데이터 조회
    return await localDB.getAll();
}

async function dbDelete(key) {
    // 1. IndexedDB에서 삭제
    await localDB.delete(key);
    
    // 2. Firebase에서도 삭제 (로그인 상태일 때)
    if (currentUser) {
        setTimeout(() => deleteFromFirebase(key), 0);
    }
}

    // 앱 데이터 전체 초기화 (주의해서 사용)
    async function dbClear() {
        if (!confirm("정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;
        const snapshot = await getUserDataRef().get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        alert("모든 데이터가 삭제되었습니다.");
        location.reload();
    }

    // 로그인/로그아웃 함수
    async function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // Cross-Origin-Opener-Policy 에러를 방지하기 위한 설정
    provider.setCustomParameters({
        prompt: 'select_account'
    });
    
    try {
        console.log("로그인 시도 중...");
        const result = await auth.signInWithPopup(provider);
        console.log("로그인 성공:", result.user.displayName);
        
        // 팝업 닫기 에러 무시를 위한 지연
        setTimeout(() => {
            console.log("로그인 프로세스 완료");
        }, 100);
        
    } catch (error) {
        console.error("로그인 에러:", error);
        
        // 팝업 관련 에러들은 무시 (실제로는 로그인이 성공할 수 있음)
        if (error.code === 'auth/popup-blocked' || 
            error.code === 'auth/popup-closed-by-user' ||
            error.code === 'auth/cancelled-popup-request') {
            console.log("팝업 관련 에러 - 리디렉션으로 대체");
            try {
                await auth.signInWithRedirect(provider);
            } catch (redirectError) {
                console.error("리디렉션 로그인도 실패:", redirectError);
                alert("로그인에 실패했습니다. 팝업 차단이 되어있다면 해제해주세요.");
            }
        } else {
            // 실제 심각한 에러만 사용자에게 알림
            if (error.code !== 'auth/web-storage-unsupported') {
                alert(`로그인에 실패했습니다: ${error.message}`);
            }
        }
    }
}
    
    async function signOut() {
    if (confirm("로그아웃 하시겠습니까?")) {
        try {
            // 자동 동기화 중단
            stopAutoSync();
            
            // Firebase에서 로그아웃
            await auth.signOut();
            
            // UI 즉시 업데이트
            currentUser = null;
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            // 동기화 상태 업데이트
            updateSyncStatus('💾 로컬 저장 중 (로그인하여 데이터 보호)');
            
            alert('로그아웃되었습니다.');
            
        } catch (error) {
            console.error("로그아웃 에러:", error);
            alert("로그아웃 중 오류가 발생했습니다.");
        }
    }
}

    // Firebase와의 백그라운드 동기화
async function syncToFirebase(key, value) {
    if (!currentUser) return;
    try {
        await getUserDataRef().doc(key).set({ value });
        syncQueue.delete(key);
        updateSyncStatus('✅ 동기화 완료');
    } catch (error) {
        console.error('Firebase 동기화 실패:', error);
        updateSyncStatus('⚠️ 동기화 대기 중');
    }
}

// 자동 동기화 시스템
let autoSyncInterval = null;

function startAutoSync() {
    if (!currentUser || autoSyncInterval) return;
    
    autoSyncInterval = setInterval(async () => {
        if (syncQueue.size > 0) {
            updateSyncStatus('☁️ 자동 백업 중...');
            // 대기 중인 데이터만 동기화
            const pendingKeys = Array.from(syncQueue);
            for (const key of pendingKeys) {
                const data = await localDB.get(key);
                if (data) {
                    await syncToFirebase(key, data);
                }
            }
        }
    }, 300000);
}

function stopAutoSync() { if (autoSyncInterval) { clearInterval(autoSyncInterval); autoSyncInterval = null; } }

async function deleteFromFirebase(key) {
    if (!currentUser) return;
    try {
        await getUserDataRef().doc(key).delete();
    } catch (error) {
        console.error('Firebase 삭제 실패:', error);
    }
}

// 전체 동기화 (수동 백업용)
async function syncAllToFirebase() {
    if (!currentUser) {
        alert('로그인이 필요합니다.');
        return;
    }
    
    if (!confirm('현재 로컬 데이터를 클라우드에 백업하시겠습니까?\n\n※ 클라우드의 기존 데이터가 덮어써집니다.')) {
        return;
    }
    
    try {
        updateSyncStatus('☁️ 클라우드 백업 중...');
        const allData = await localDB.getAll();
        
        let successCount = 0;
        for (const item of allData) {
            await syncToFirebase(item.key, item.value);
            successCount++;
        }
        
        updateSyncStatus(`✅ 백업 완료 (${successCount}개 항목)`);
        setTimeout(() => {
            alert(`클라우드 백업이 완료되었습니다!\n백업된 항목: ${successCount}개`);
        }, 500);
        
    } catch (error) {
        console.error('백업 실패:', error);
        updateSyncStatus('❌ 백업 실패');
        alert('백업 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.');
    }
}

// Firebase에서 데이터 가져오기 (복원용)
async function loadFromFirebase() {
    if (!currentUser) {
        alert('로그인이 필요합니다.');
        return;
    }
    
    if (!confirm('클라우드에서 데이터를 복원하시겠습니까?\n\n⚠️ 현재 로컬 데이터가 모두 삭제되고 클라우드 데이터로 교체됩니다.\n\n이 작업은 되돌릴 수 없습니다.')) {
        return;
    }
    
    try {
        updateSyncStatus('📥 클라우드에서 데이터 로딩 중...');
        
        // 기존 로컬 데이터 삭제
        const existingData = await localDB.getAll();
        for (const item of existingData) {
            await localDB.delete(item.key);
        }
        
        // Firebase에서 데이터 가져오기
        const snapshot = await getUserDataRef().get();
        
        let restoredCount = 0;
        for (const doc of snapshot.docs) {
            await localDB.set(doc.id, doc.data().value);
            restoredCount++;
        }
        
        updateSyncStatus(`✅ 복원 완료 (${restoredCount}개 항목)`);
        
        // 캘린더 새로고침
        await renderCalendar();
        
        setTimeout(() => {
            alert(`클라우드 복원이 완료되었습니다!\n복원된 항목: ${restoredCount}개\n\n캘린더가 업데이트되었습니다.`);
        }, 500);
        
    } catch (error) {
        console.error('복원 실패:', error);
        updateSyncStatus('❌ 복원 실패');
        alert('복원 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.');
    }
}

function updateSyncStatus(message) {
    const statusEl = document.getElementById('syncStatus');
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        
        // 로그인 안된 상태에서는 경고 색상
        if (!currentUser && message.includes('로컬')) {
            statusEl.style.background = 'rgba(255, 243, 205, 0.95)';
            statusEl.style.color = '#b7791f';
            statusEl.style.border = '1px solid #ffd666';
        } else {
            statusEl.style.background = 'rgba(255,255,255,0.9)';
            statusEl.style.color = 'var(--text-color-light)';
            statusEl.style.border = 'none';
        }
        
        // 모든 메시지를 3초 후 숨김 (활성화/로컬저장 메시지도 포함)
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    }
}
        
        function formatDate(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDateForLabel(dateString) { const d = parseDate(dateString); return `${d.getMonth() + 1}/${d.getDate()}`; }
        function parseDate(dateString) { return new Date(dateString + 'T00:00:00'); }
        function timeToMinutes(time) { if (!time) return 0; const [h, m] = time.split(':').map(Number); return h * 60 + m; }
        function getWeekDates(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const mon = new Date(d.setDate(diff)); const week = []; for (let i = 0; i < 7; i++) { const day = new Date(mon); day.setDate(mon.getDate() + i); week.push(formatDate(new Date(day))); } return week; }
        function getMonthDates(date) { const y = date.getFullYear(), m = date.getMonth(); const lastDay = new Date(y, m + 1, 0); const dates = []; for (let d = new Date(y, m, 1); d <= lastDay; d.setDate(d.getDate() + 1)) { dates.push(formatDate(new Date(d))); } return dates; }
        function getMonthDateRange(date) { const year = date.getFullYear(); const month = date.getMonth(); const start = formatDate(new Date(year, month, 1)); const end = formatDate(new Date(year, month + 1, 0)); return { start, end }; }
        async function getPersonalGoals() { return await dbGet('personalGoals') || []; }
        function getEmojiForAchievement(percentage) { if (percentage <= 20) return '😡'; if (percentage <= 40) return '😢'; if (percentage <= 60) return '😐'; if (percentage <= 80) return '😊'; return '🎉'; }
        async function getDayData(date) { return await dbGet(`day_${formatDate(date)}`) || { date: formatDate(date), wakeTime: null, seatTime: null, pomodoro: { morning: 0, afternoon: 0, evening: 0 }, exercise: { done: false, minutes: 0 }, gameTime: 0, writing: 0, sleepTime: null, personalGoals: {}, score: 0, isOffDay: false, comment: "" }; }
        async function saveDayData(date, data) { const dateString = formatDate(date); data.date = dateString; data.score = data.isOffDay ? 0 : await calculateScoreEnhanced(data); await dbSet(`day_${dateString}`, data); 
            await checkAndUpdateAllQuests(data, date); }
        
function adjustPomodoro(inputId, change) {
    const input = document.getElementById(inputId);
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(0, currentValue + change);
    input.value = newValue;
    
    // 점수 업데이트 및 자동 저장
    updateModalScore();
    autoSaveModalData();
}

async function calculatePersonalGoalAverage(data, date) {
    const allGoals = await getPersonalGoals();
    const checkDate = parseDate(date);
    checkDate.setHours(0, 0, 0, 0);
    const applicableGoals = allGoals.filter(goal => {
        const goalDate = new Date(goal.createdAt);
        goalDate.setHours(0, 0, 0, 0);
        return checkDate >= goalDate && !goal.isCompleted;
    });
    if (applicableGoals.length === 0) return 0;
    const personalGoalsData = data.personalGoals || {};
    let totalPercentage = 0;
    applicableGoals.forEach(goal => {
        const achieved = personalGoalsData[goal.id] || 0;
        let percentage = 0;
        if (goal.type === 'negative') {
            const usageRatio = achieved / goal.dailyTarget; // 하루 목표 기준
            percentage = Math.max(0, (1 - usageRatio) * 100);
        } else {
            percentage = Math.min(100, (achieved / goal.dailyTarget) * 100); // 하루 목표 기준
        }
        totalPercentage += percentage;
    });
    return applicableGoals.length > 0 ? Math.round(totalPercentage / applicableGoals.length) : 0;
}

        // calculateScore 함수에 새로운 플래그들 적용
async function calculateScoreEnhanced(data) {
    if (data.isOffDay) return 0;
    
    const today = formatDate(new Date());
    
    // 완전 자유의 날 체크
    const isCompleteFreedomDay = await dbGet(`completeFreedomDay_${today}`);
    if (isCompleteFreedomDay) {
        return 0; // 점수 계산 안함
    }
    
    // 루틴의 왕 데이 체크
    const isRoutineKingDay = await dbGet(`routineKingDay_${today}`);
    
    let score = 0;
    const targetWakeTime = await dbGet('targetWakeTime');
    if (!targetWakeTime || !data.wakeTime) return Math.max(0, (data.bonusPoints || 0));
    
    // 늦잠 허가증 체크
    const sleepInPermit = await dbGet(`sleepInPermit_${today}`) || 0;
    const adjustedTargetTime = timeToMinutes(targetWakeTime) + sleepInPermit;
    
    const actualMinutes = timeToMinutes(data.wakeTime);
    const wakeDiff = actualMinutes - adjustedTargetTime;
    if (wakeDiff < 0) score += 10; 
    else if (wakeDiff <= 30) score += 5; 
    else if (wakeDiff <= 60) score += 3; 
    else if (wakeDiff <= 90) score += 1; 
    else score -= Math.floor((wakeDiff - 120) / 30 + 1) * 2;
    
    // 착석 시간 점수 (기존과 동일)
    if (data.seatTime) { 
        const seatMinutes = timeToMinutes(data.seatTime); 
        const seatDiff = seatMinutes - actualMinutes; 
        if (seatDiff >= 0 && seatDiff <= 60) score += 5; 
        else if (seatDiff >= 0 && seatDiff <= 90) score += 3; 
    }
    
    // 뽀모도로 점수 (기존과 동일)
    const totalPomodoro = (data.pomodoro.morning || 0) + (data.pomodoro.afternoon || 0) + (data.pomodoro.evening || 0);
    score += totalPomodoro * 5;
    
    if (data.pomodoro.morning >= 6) score += 5; 
    if (data.pomodoro.afternoon >= 6) score += 5; 
    if (data.pomodoro.evening >= 4) score += 5;
    
    // 운동 점수 (기존과 동일)
    if (data.exercise.done) { 
        score += 10; 
        score += Math.floor((data.exercise.minutes || 0) / 30) * 5; 
    }
    
    // 게임 시간 페널티 (새로운 플래그들 적용)
    const cheatDayGaming = await dbGet(`cheatDayGaming_${today}`);
    const unlimitedGaming = await dbGet(`unlimitedGaming_${today}`);
    const cheatDay = await dbGet(`cheatDay_${today}`); // 기존 치팅데이
    
    if (!cheatDayGaming && !unlimitedGaming && !cheatDay && data.gameTime > 60) {
        score -= Math.floor((data.gameTime - 60) / 30) * 2;
    }
    
    // 취침 시간 점수 (기존과 동일)
    if (data.sleepTime) { 
        const sleepMinutes = timeToMinutes(data.sleepTime); 
        let adjustedSleep = sleepMinutes < 360 ? sleepMinutes + 1440 : sleepMinutes; 
        if (adjustedSleep >= 1440 && adjustedSleep <= 1470) score += 5; 
        else if (adjustedSleep <= 1500) score += 3; 
        else if (adjustedSleep <= 1560) score += 1; 
        else if (adjustedSleep > 1560) score -= Math.floor((adjustedSleep - 1560) / 30 + 1) * 3; 
    }
    
    score += (data.bonusPoints || 0);
    
    // 골든데이 토큰 체크
    const isGoldenDay = await dbGet(`goldenDay_${today}`);
    if (isGoldenDay && score < 0) {
        score = 0;
    }
    
    // 루틴의 왕 데이에는 최소 점수 보정
    if (isRoutineKingDay && score < 50) {
        score = Math.max(50, score);
    }
    
    return score;
}
        
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    // 인증 컨테이너 숨김/표시
    const authContainer = document.getElementById('authContainer');
    if (authContainer) {
        if (pageId === 'goalSetup' || pageId === 'wakeUpPrompt') {
            authContainer.style.display = 'none';
        } else {
            authContainer.style.display = 'block';
        }
    }
    
    // 프로필 위젯 숨김/표시
    const profileWidget = document.getElementById('profileWidget');
    if (profileWidget) {
        if (pageId === 'goalSetup' || pageId === 'wakeUpPrompt') {
            profileWidget.style.display = 'none';
        } else {
            updateProfileWidget(); 
            profileWidget.style.display = 'block';
        }
    }
    
    // 새로 추가: 페이지별 언어 업데이트
    setTimeout(async () => {
        await updatePageLanguage(pageId);
    }, 100);
}
        async function saveGoalAndContinue() { const targetTime = document.getElementById('targetWakeTime').value; if (!/^\d{2}:\d{2}$/.test(targetTime)) { alert('목표 기상 시간을 HH:MM 형식으로 입력해주세요!'); return; } await dbSet('targetWakeTime', targetTime); await initApp(); }
        async function saveWakeTimeFromPrompt() { 
            const wakeTime = document.getElementById('promptWakeTime').value; 
            if (!/^\d{2}:\d{2}$/.test(wakeTime)) { alert('기상 시간을 HH:MM 형식으로 입력해주세요!'); return; } 
            const today = new Date(); 
            const todayData = await getDayData(today); 
            todayData.wakeTime = wakeTime; 
            await saveDayData(today, todayData); 
            sessionStorage.setItem('promptSkipped', 'true'); 
            showPage('calendarPage'); 
            await renderCalendar(); 
            await triggerDailyQuests();
        }
        async function skipToCalendar() { 
            sessionStorage.setItem('promptSkipped', 'true'); 
            showPage('calendarPage'); 
            await renderCalendar();
            await triggerDailyQuests();
        }
        async function changeMonth(direction) { currentDate.setMonth(currentDate.getMonth() + direction); updateMonthYearDisplay(); await renderCalendar(); }
        async function backToCalendar() { showPage('calendarPage'); await renderCalendar(); }
        async function updateSettings() {
            const targetTime = document.getElementById('settingsWakeTime').value;
            if (targetTime && !/^\d{2}:\d{2}$/.test(targetTime)) { alert('목표 기상 시간을 HH:MM 형식으로 입력해주세요!'); return; }
            await dbSet('targetWakeTime', targetTime);
            const budget = unformatNumber(document.getElementById('monthlyBudgetInput').value);
            if (budget) { await dbSet('monthlyBudget', budget); } else { await dbDelete('monthlyBudget'); }
            const partnerEmail = document.getElementById('partnerEmailInput').value.trim();
            if (partnerEmail) {
                await dbSet('partnerEmail', partnerEmail);
            } else {
                await dbDelete('partnerEmail');
            }
            alert('설정이 저장되었습니다!');
            await backToCalendar();
        }
        async function showSettings() {
            showPage('settingsPage');
            document.getElementById('settingsWakeTime').value = await dbGet('targetWakeTime') || '';
            const budgetSetting = await dbGet('monthlyBudget');
            document.getElementById('monthlyBudgetInput').value = budgetSetting ? budgetSetting.toLocaleString('ko-KR') : '';
            const partnerEmail = await dbGet('partnerEmail');
            document.getElementById('partnerEmailInput').value = partnerEmail || '';
            await renderDdaySettings();
        }
        async function showPersonalGoals() { showPage('personalGoalsPage'); await renderPersonalGoalsList(); }
        async function showMonthlyStats() { showPage('monthlyStatsPage'); await renderMonthlyStats(); }
        async function showBudgetPage() { showPage('budgetPage'); await renderBudgetPage(); }
        async function closeDayModal() { document.getElementById('dayModal').style.display = 'none'; await renderCalendar(); }
        async function navigateModalDate(direction) {
        // 현재 선택된 날짜에서 direction만큼 이동
            const newDate = new Date(selectedDate);
            newDate.setDate(newDate.getDate() + direction);
    
        // 새로운 날짜로 모달 다시 열기
        await openDayModal(newDate);
        }

        async function initApp() {
    // 1. 목표 기상 시간 설정 여부부터 확인
    const targetWakeTime = await dbGet('targetWakeTime');
    if (!targetWakeTime) { 
        showPage('goalSetup'); 
        return; 
    }

    // 2. 기상 시간 입력 최우선 (이건 즉시 처리)
    const today = new Date();
    const todayData = await getDayData(today);
    if (!todayData.wakeTime && today.getHours() >= 6 && !sessionStorage.getItem('promptSkipped')) { 
        document.getElementById('wakeupDate').textContent = today.toLocaleDateString('ko-KR'); 
        showPage('wakeUpPrompt'); 
        return;
    }
    
    // 3. 캘린더 페이지로 이동 후 즉시 렌더링
    showPage('calendarPage');
    
    // 4. 전체 캘린더 렌더링 (데이터 포함)
    await renderCalendar();
    
    // 5. 백그라운드 작업들은 별도로 실행
    setTimeout(async () => {
        await triggerDailyQuests();
    }, 100);
}

// 주간 성과 분석 및 리포트 발송 로직
async function checkWeeklyPerformance() {
    const partnerEmail = await dbGet('partnerEmail');
    if (!partnerEmail) return; // 파트너 이메일이 없으면 실행 안함

    const today = new Date();
    const lastWeekCheckKey = `weeklyReportSent_${getWeekDates(today)[0]}`;
    if (await dbGet(lastWeekCheckKey)) return; // 이미 이번 주에 보냈으면 실행 안함

    const lastWeek = new Date();
    lastWeek.setDate(lastWeek.getDate() - 7);
    const lastWeekDates = getWeekDates(lastWeek);

    let totalScore = 0;
    let validDays = 0;
    let performanceDetails = {
        lateWakeUp: 0,
        totalGameMinutes: 0,
        exerciseCount: 0,
        targetWakeTime: await dbGet('targetWakeTime') || "미설정"
    };

    for (const dateStr of lastWeekDates) {
        const dayData = await getDayData(parseDate(dateStr));
        if (dayData && !dayData.isOffDay && dayData.wakeTime) {
            validDays++;
            totalScore += dayData.score || 0;
            
            if (dayData.wakeTime && performanceDetails.targetWakeTime !== "미설정") {
                const diff = timeToMinutes(dayData.wakeTime) - timeToMinutes(performanceDetails.targetWakeTime);
                if (diff > 0) performanceDetails.lateWakeUp += diff;
            }
            performanceDetails.totalGameMinutes += dayData.gameTime || 0;
            if (dayData.exercise.done) performanceDetails.exerciseCount++;
        }
    }

    if (validDays === 0) return;

    const avgScore = Math.round(totalScore / validDays);

    if (avgScore < 40) {
        if (confirm(`지난주 평균 점수가 ${avgScore}점입니다. 책임 공유 파트너에게 성과 보고서를 보내시겠습니까?`)) {
            const analysisHtml = analyzeWeeklyPerformance(performanceDetails, validDays);
            const weekRange = `${formatDateForLabel(lastWeekDates[0])} ~ ${formatDateForLabel(lastWeekDates[6])}`;
            
            await sendAccountabilityReport(partnerEmail, avgScore, analysisHtml, weekRange);
            await dbSet(lastWeekCheckKey, true); // 발송 완료 기록
        }
    }
}

// 주간 성과를 분석하여 HTML 텍스트를 생성하는 함수
function analyzeWeeklyPerformance(details, validDays) {
    let html = '<ul>';
    if (details.lateWakeUp > 0 && validDays > 0) {
        const avgLateMinutes = Math.round(details.lateWakeUp / validDays);
        html += `<li><strong>기상 시간:</strong> 목표 시간보다 평균 ${avgLateMinutes}분 늦게 일어났습니다. (목표: ${details.targetWakeTime})</li>`;
    }
    if (details.totalGameMinutes > 60 * validDays) { // 하루 평균 1시간 이상 게임 시
        const avgGameMinutes = Math.round(details.totalGameMinutes / validDays);
        html += `<li><strong>게임 시간:</strong> 주간 총 게임 시간이 ${Math.round(details.totalGameMinutes / 60)}시간을 초과했습니다. (하루 평균 ${avgGameMinutes}분)</li>`;
    }
    if (details.exerciseCount < 3) {
        html += `<li><strong>운동:</strong> 주 3회 이상 목표였으나, ${details.exerciseCount}회만 수행했습니다.</li>`;
    }
    if (html === '<ul>') {
        html += '<li>전반적으로 꾸준한 노력이 필요합니다. 작은 목표부터 다시 시작해보세요!</li>';
    }
    html += '</ul>';
    return html;
}

// EmailJS를 사용하여 이메일을 발송하는 함수
async function sendAccountabilityReport(partnerEmail, avgScore, analysisHtml, weekRange) {
    try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
            user_name: currentUserName,
            partner_email: partnerEmail,
            avg_score: avgScore,
            analysis_html: analysisHtml,
            week_range: weekRange
        }, EMAILJS_PUBLIC_KEY);
        alert('파트너에게 보고서가 성공적으로 발송되었습니다.');
        unlockAchievement('ACH_ACCOUNTABILITY'); // 업적 달성
    } catch (error) {
        alert('이메일 발송 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
        console.error('EmailJS Error:', error);
    }
}

async function renderBasicCalendar() {
    updateMonthYearDisplay();
    
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    // 요일 헤더 추가
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    weekdays.forEach(day => {
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header-cell';
        headerCell.textContent = day;
        grid.appendChild(headerCell);
    });
    
    // 달력 셀 생성 (스켈레톤 상태)
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // 이전 달의 빈 셀들
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-cell empty';
        grid.appendChild(emptyCell);
    }
    
    // 현재 달의 셀들 (스켈레톤으로 시작)
    for (let day = 1; day <= daysInMonth; day++) {
        const cellDate = new Date(year, month, day);
        const cell = document.createElement('div');
        cell.className = 'calendar-cell skeleton';
        cell.dataset.date = formatDate(cellDate);
        
        cell.innerHTML = `
            <div class="cell-top-icons"></div>
            <div class="cell-day-number">${day}</div>
            <div class="cell-bottom-info"></div>
        `;
        
        grid.appendChild(cell);
    }
    
    // 로딩 표시
    showLoadingIndicator();
}

async function enhanceCalendarWithData() {
    const allDbData = await dbGetAll();
    const allPersonalGoals = await getPersonalGoals();
    const year = currentDate.getFullYear(), month = currentDate.getMonth();
    const dataMap = new Map(allDbData.map(item => [item.key, item.value]));

    const skeletonCells = document.querySelectorAll('.calendar-cell.skeleton');
    
    skeletonCells.forEach((cell, index) => {
        setTimeout(() => {
            const dateStr = cell.dataset.date;
            const cellDate = parseDate(dateStr);
            
            cell.classList.remove('skeleton');
            
            const topIconsContainer = cell.querySelector('.cell-top-icons');
            const bottomInfoContainer = cell.querySelector('.cell-bottom-info');
            
            const dayData = dataMap.get(`day_${dateStr}`);
            
            if (dayData) {
                // 휴식일 체크를 먼저 수행
    if (dayData.isOffDay) {
        cell.classList.add('off-day');
        cell.querySelector('.cell-day-number').innerHTML += `<div class="off-day-indicator">☕️</div>`;
        topIconsContainer.innerHTML = ''; // 휴식일에는 개인목표 아이콘 표시 안함
    } else {
        // 휴식일이 아닐 때만 개인목표 아이콘 표시
        const applicableGoals = allPersonalGoals.filter(goal => {
            if (goal.isCompleted) return false;
            const goalCreatedDate = new Date(goal.createdAt);
            goalCreatedDate.setHours(0, 0, 0, 0);
            return goalCreatedDate <= cellDate;
        });
        
        if (applicableGoals.length > 0 && dayData.personalGoals) {
            let iconsHtml = '';
            applicableGoals.slice(0, 3).forEach(goal => {
                const achieved = dayData.personalGoals[goal.id] || 0;
                let percentage = 0;
                if (goal.type === 'negative') {
                    const usageRatio = achieved / goal.dailyTarget;
                    percentage = Math.max(0, (1 - usageRatio) * 100);
                } else {
                    percentage = Math.min(100, (achieved / goal.dailyTarget) * 100);  
                }
                iconsHtml += `<span>${getEmojiForAchievement(percentage)}</span>`;
            });
            topIconsContainer.innerHTML = iconsHtml;
        } else {
            topIconsContainer.innerHTML = '';
        }

        if (dayData.wakeTime || dayData.exercise?.done || dayData.sleepTime || (dayData.bonusPoints && dayData.bonusPoints > 0) || Object.keys(dayData.personalGoals || {}).length > 0) {
            cell.classList.add('has-data');
            const score = dayData.score !== undefined ? dayData.score : 0;
            if (score >= 80) cell.classList.add('score-high');
            else if (score >= 40) cell.classList.add('score-medium');
            else if (score >= 1) cell.classList.add('score-low');
            else cell.classList.add('score-negative');
        }
    }
} else {
    topIconsContainer.innerHTML = '';
    bottomInfoContainer.innerHTML = '';
}
            
            if (cellDate.getDay() === 0) {
                const weekDates = getWeekDates(cellDate);
                let weeklyWritingTotal = 0;
                for (const dateStr of weekDates) {
                    const weeklyDayData = dataMap.get(`day_${dateStr}`);
                    if (weeklyDayData) {
                        weeklyWritingTotal += weeklyDayData.writing || 0;
                    }
                }
                if (weeklyWritingTotal > 0) {
                    const bookCount = (weeklyWritingTotal / 100000).toFixed(2);
                    bottomInfoContainer.innerHTML += `<span>📖${bookCount}</span>`;
                }
            }

            cell.addEventListener('click', () => openDayModal(cellDate));
            
        }, index * 30); 
    });
    
    setTimeout(() => {
        hideLoadingIndicator();
    }, skeletonCells.length * 30 + 100);
}

function showLoadingIndicator() {
    const container = document.querySelector('.container');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingIndicator';
    loadingDiv.className = 'loading-indicator';
    loadingDiv.innerHTML = '데이터 로딩 중...';
    container.appendChild(loadingDiv);
}

function hideLoadingIndicator() {
    const loadingDiv = document.getElementById('loadingIndicator');
    if (loadingDiv) {
        loadingDiv.style.opacity = '0';
        setTimeout(() => loadingDiv.remove(), 300);
    }
}

async function runBackgroundTasks() {
    try {
        await renderDdayDisplay();
        await renderSmallBudgetBarEnhanced();
        await checkAndDisplayGameWarning();
        setTimeout(async () => {
            const today = new Date();
            
            if (today.getDay() === 1) {
                await checkWeeklyPerformance();
            }
            if (today.getDate() === 1) {
                await checkForMonthlyBonus();
            }
            await triggerDailyQuests();
            
        }, 1000); 
        
    } catch (error) {
        console.error('백그라운드 작업 오류:', error);
    }
}

async function renderCalendar() {
    // 기본 구조가 없으면 생성
    if (document.querySelectorAll('.calendar-cell').length === 0) {
        await renderBasicCalendar();
    }
    
    // 데이터로 캘린더 향상
    await enhanceCalendarWithData();
    
    // 백그라운드 작업들
    await runBackgroundTasks();
}

        async function renderMonthlyStats() {
            const monthDates = getMonthDates(currentDate);
            document.getElementById('statsMonth').textContent = currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
            
            let totalScore = 0, totalGoalRate = 0, totalWriting = 0, validDays = 0;
            const dataPromises = monthDates.map(date => dbGet(`day_${date}`));
            const monthlyData = (await Promise.all(dataPromises)).filter(d => d);

            for (const dayData of monthlyData) {
                totalWriting += (dayData.writing || 0);
                if (!dayData.isOffDay && (dayData.wakeTime || dayData.exercise.done || dayData.sleepTime || dayData.bonusPoints)) {
                    totalScore += dayData.score || 0;
                    totalGoalRate += await calculatePersonalGoalAverage(dayData, dayData.date);
                    validDays++;
                }
            }
            const avgScore = validDays > 0 ? Math.round(totalScore / validDays) : 0;
            const avgGoalRate = validDays > 0 ? Math.round(totalGoalRate / validDays) : 0;
            document.getElementById('avgScore').textContent = `⭐ ${avgScore}점`;
            document.getElementById('avgGoalRate').textContent = `${getEmojiForAchievement(avgGoalRate)} ${avgGoalRate}%`;
            document.getElementById('writingBooks').textContent = `📖 ${(totalWriting / 100000).toFixed(2)}권`;

            const fameContainer = document.getElementById('hallOfFame');
            const shameContainer = document.getElementById('wallOfShame');
            fameContainer.innerHTML = '';
            shameContainer.innerHTML = '';
            
            if (monthlyData.length > 0) {
                const validDataDays = monthlyData.filter(d => !d.isOffDay);

                if (validDataDays.length > 0) {
                    const bestScoreDay = [...validDataDays].sort((a, b) => (b.score || 0) - (a.score || 0))[0];
                    const worstScoreDay = [...validDataDays].sort((a, b) => (a.score || 0) - (b.score || 0))[0];

                    fameContainer.innerHTML += `<div class="fame-card"><div class="fame-card-title">✨</div><div class="fame-card-value">${bestScoreDay.score}점</div><div class="fame-card-date">최고 점수 (${formatDateForLabel(bestScoreDay.date)})</div></div>`;
                    shameContainer.innerHTML += `<div class="fame-card"><div class="fame-card-title">💀</div><div class="fame-card-value">${worstScoreDay.score}점</div><div class="fame-card-date">최저 점수 (${formatDateForLabel(worstScoreDay.date)})</div></div>`;
                    
                    const pomoKingDay = [...validDataDays].sort((a, b) => {
                        const totalA = (a.pomodoro?.morning || 0) + (a.pomodoro?.afternoon || 0) + (a.pomodoro?.evening || 0);
                        const totalB = (b.pomodoro?.morning || 0) + (b.pomodoro?.afternoon || 0) + (b.pomodoro?.evening || 0);
                        return totalB - totalA;
                    })[0];
                    const totalPomos = (pomoKingDay.pomodoro?.morning || 0) + (pomoKingDay.pomodoro?.afternoon || 0) + (pomoKingDay.pomodoro?.evening || 0);
                    if (totalPomos > 0) {
                        fameContainer.innerHTML += `<div class="fame-card"><div class="fame-card-title">🍅</div><div class="fame-card-value">${totalPomos}개</div><div class="fame-card-date">뽀모도로 킹 (${formatDateForLabel(pomoKingDay.date)})</div></div>`;
                    }

                    const exerciseGodDay = [...validDataDays].sort((a,b) => (b.exercise?.minutes || 0) - (a.exercise?.minutes || 0))[0];
                    if (exerciseGodDay.exercise?.minutes > 0) {
                         fameContainer.innerHTML += `<div class="fame-card"><div class="fame-card-title">💪</div><div class="fame-card-value">${exerciseGodDay.exercise.minutes}분</div><div class="fame-card-date">운동 괴물 (${formatDateForLabel(exerciseGodDay.date)})</div></div>`;
                    }

                    const gameAddictDay = [...validDataDays].sort((a,b) => (b.gameTime || 0) - (a.gameTime || 0))[0];
                    if (gameAddictDay.gameTime > 0) {
                        shameContainer.innerHTML += `<div class="fame-card"><div class="fame-card-title">🎮</div><div class="fame-card-value">${gameAddictDay.gameTime}분</div><div class="fame-card-date">게임 중독 (${formatDateForLabel(gameAddictDay.date)})</div></div>`;
                    }
                }
            }

            if (fameContainer.innerHTML === '') {
                fameContainer.innerHTML = '<p style="text-align:center; color:#999;">이번 달 기록이 부족합니다.</p>';
            }
            if (shameContainer.innerHTML === '') {
                shameContainer.innerHTML = '<p style="text-align:center; color:#999;">이번 달 기록이 부족합니다.</p>';
            }
            
            await renderWeeklyDetails();
        }
        async function renderWeeklyDetails() {
            const container = document.getElementById('weeklyDetails');
            container.innerHTML = '<h3>📅 주간별 요약</h3>';

            const monthDates = getMonthDates(currentDate);
            const mondays = [...new Set(monthDates.map(dateStr => getWeekDates(parseDate(dateStr))[0]))];
            let hasAnyData = false;

            for (const mondayStr of mondays.sort().reverse()) {
                const weekDates = getWeekDates(parseDate(mondayStr));
                const dayDatas = await Promise.all(weekDates.map(dateStr => getDayData(parseDate(dateStr))));
                const isWeekRecorded = dayDatas.some(d => d.wakeTime || d.writing > 0 || d.exercise.done || Object.keys(d.personalGoals).length > 0);

                if (isWeekRecorded) {
                    hasAnyData = true;
                    const validDays = dayDatas.filter(d => d && !d.isOffDay && d.wakeTime);
                    
                    let avgScore = 0;
                    if (validDays.length > 0) { avgScore = Math.round(validDays.reduce((sum, d) => sum + (d.score || 0), 0) / validDays.length); }
                    let avgGoalRate = 0;
                    if (validDays.length > 0) { const goalRates = await Promise.all(validDays.map(d => calculatePersonalGoalAverage(d, d.date))); avgGoalRate = Math.round(goalRates.reduce((sum, rate) => sum + rate, 0) / validDays.length); }
                    const totalWriting = dayDatas.reduce((sum, data) => sum + (data?.writing || 0), 0);
                    const exerciseCount = dayDatas.reduce((sum, data) => sum + (data?.exercise.done ? 1 : 0), 0);

                    container.innerHTML += `<div class="week-card"><div class="week-header"><span>${formatDateForLabel(weekDates[0])} ~ ${formatDateForLabel(weekDates[6])}</span></div><div class="week-stats"><span>⭐ ${avgScore}</span><span>${getEmojiForAchievement(avgGoalRate)} ${avgGoalRate}%</span><span>📖 ${(totalWriting / 100000).toFixed(2)}</span><span>💪 ${exerciseCount}/7</span></div></div>`;
                }
            }
            if (!hasAnyData) { container.innerHTML += '<p style="text-align:center; color:#666; padding: 20px 0;">아직 기록된 주간 데이터가 없습니다.</p>'; }
        }
        
        async function checkAndDisplayGameWarning() { const warningDiv = document.getElementById('gameWarning'); const weekDates = getWeekDates(new Date()); const dataPromises = weekDates.map(dateStr => dbGet(`day_${dateStr}`)); const weekData = await Promise.all(dataPromises); const totalGameTime = weekData.reduce((sum, dayData) => sum + (dayData?.gameTime || 0), 0); if (totalGameTime > 1200) { warningDiv.textContent = `⚠️이번 주 게임 시간이 ${(totalGameTime / 60).toFixed(1)}시간을 넘었습니다. 자기 절제가 필요합니다.`; warningDiv.style.display = 'block'; }  else { warningDiv.style.display = 'none'; } }
        async function checkForMonthlyBonus() { 
            const today = new Date(); 
            const currentMonthKey = `bonusAwarded_${today.getFullYear()}-${today.getMonth()}`; 
            if (await dbGet(currentMonthKey)) return; 

            const prevMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1); 
            const prevMonthDates = getMonthDates(prevMonthDate); 
            const dataPromises = prevMonthDates.map(dateStr => dbGet(`day_${dateStr}`)); 
            const monthlyData = await Promise.all(dataPromises); 
            
            let totalScore = 0, validDays = 0; 
            for (const dayData of monthlyData) { 
                if (dayData && !dayData.isOffDay && dayData.wakeTime) { 
                    totalScore += dayData.score || 0; 
                    validDays++; 
                } 
            } 
            
            if (validDays > 0 && (totalScore / validDays) >= 80) { 
                const firstDayData = await getDayData(new Date(today.getFullYear(), today.getMonth(), 1)); 
                firstDayData.bonusPoints = (firstDayData.bonusPoints || 0) + 30; 
                await saveDayData(new Date(today.getFullYear(), today.getMonth(), 1), firstDayData); 
                setTimeout(async () => { 
                    showFeedbackPopup(100, { class: 'feedback-celebration', emoji: '🏆', title: '월간 보너스 획득!', message: `지난달 평균 ${Math.round(totalScore/validDays)}점을 달성! 이번 달의 시작에 보너스 +30점이 부여됩니다!` }); 
                    await renderCalendar(); 
                }, 1000); 
            }
            
            await checkMonthlyPerformanceAndNotify();
            await checkExerciseAndDietBalance();
            await checkMonthEndAchievements(prevMonthDate);
}

        async function checkExerciseAchievements(date) {
            const today = new Date(date);
            const weekDates = getWeekDates(today);
            const monthDates = getMonthDates(today);

            const weekKey = `weeklyExercisePopup_${weekDates[0]}`;
            if (!(await dbGet(weekKey))) {
                const weekDataPromises = weekDates.map(d => dbGet(`day_${d}`));
                const weekData = await Promise.all(weekDataPromises);
                if (weekData.reduce((c, data) => c + (data?.exercise.done ? 1 : 0), 0) >= 5) {
                    showFeedbackPopup(100, { class: 'feedback-celebration', emoji: '🔥', title: '주 5일 운동 달성!', message: '체지방률 20%... 어쩌면 금방 도달할지도?' });
                    await dbSet(weekKey, true);
                }
            }
    
            const monthKey = `monthlyExercisePopup_${today.getFullYear()}-${today.getMonth()}`;
            if (!(await dbGet(monthKey))) {
                const monthDataPromises = monthDates.map(d => dbGet(`day_${d}`));
                const monthData = await Promise.all(monthDataPromises);
                if (monthData.reduce((c, data) => c + (data?.exercise.done ? 1 : 0), 0) > 20) {
                    showFeedbackPopup(100, { class: 'feedback-celebration', emoji: '🥳', title: '이달의 운동 20회 돌파!', message: '기분이다! 오늘은 치팅데이를 가져도 좋습니다! 수고했어요!' });
                    await dbSet(monthKey, true);
                }
            }
        }
async function showFeedbackPopup(score, customOptions = {}) { 
   const popup = document.getElementById('feedbackPopup'); 
   const content = popup.querySelector('.feedback-content'); 
   const emoji = document.getElementById('feedbackEmoji'); 
   const title = document.getElementById('feedbackTitle'); 
   const message = document.getElementById('feedbackMessage'); 
   
   content.className = 'feedback-content'; 
   let options = {};
   
   // ✨ 특별한 날 체크 (새로 추가)
   const today = formatDate(new Date());
   const isRoutineKingDay = await dbGet(`routineKingDay_${today}`);
   
   // 루틴의 왕 데이면 무조건 긍정적인 메시지로 오버라이드
   if (isRoutineKingDay && Object.keys(customOptions).length === 0) {
       const kingMessages = [
           { class: 'feedback-celebration', emoji: '👑', title: '왕다운 하루였습니다!', message: '역시 루틴의 왕다운 모습이군요! 오늘도 훌륭했습니다!' },
           { class: 'feedback-celebration', emoji: '🏆', title: '왕의 위엄!', message: '완벽하지 않아도 괜찮습니다. 왕에게는 모든 순간이 소중하니까요!' },
           { class: 'feedback-celebration', emoji: '⭐', title: '빛나는 왕관!', message: '오늘 하루도 당신다웠어요. 그것만으로도 충분히 훌륭합니다!' }
       ];
       options = kingMessages[Math.floor(Math.random() * kingMessages.length)];
   }
   // 기존 로직 그대로
   else if (Object.keys(customOptions).length > 0) { 
       options = customOptions; 
   } else if (score >= 80) { 
       options = { class: 'feedback-celebration', emoji: '🎉', title: 'Perfect! 완벽해요!', message: '오늘 정말 잘했어요!' }; 
   } else if (score >= 40) { 
       options = { class: 'feedback-reflection', emoji: '✨', title: '꽤 괜찮아요!', message: '어떤 부분을 개선할 수 있을까요?' }; 
   } else if (score >= 1) { 
       options = { class: 'feedback-encouragement', emoji: '🌱', title: '괜찮아요!', message: '내일은 새로운 기회예요!' }; 
   } else { 
       options = { class: 'feedback-disaster', emoji: '💀', title: '오늘은 재앙이었네요...', message: '이제 올라갈 일만 남았어요!' }; 
   } 
   
   content.classList.add(options.class); 
   emoji.textContent = options.emoji; 
   title.textContent = options.title; 
   message.textContent = options.message; 
   popup.style.display = 'flex'; 
   
   setTimeout(() => { 
       if (popup.style.display === 'flex') closeFeedbackPopup(); 
   }, 6000); 
}
        function closeFeedbackPopup() { const popup = document.getElementById('feedbackPopup'); if(popup) popup.style.display = 'none'; }
        
        async function checkBudgetAndShowPopup() {
            const budget = await dbGet('monthlyBudget');
            if (!budget) return false;
            
            const { start, end } = getMonthDateRange(new Date());
            const allData = await dbGetAll();
            const expenses = allData.filter(item => 
                item.key.startsWith('expense_') && 
                item.value.date >= start && 
                item.value.date <= end
            );
            
            const totalSpent = expenses.reduce((sum, item) => sum + item.value.amount, 0);
            const percentage = (totalSpent / budget) * 100;
            
            const checkKey = `budgetWarning_${new Date().getFullYear()}-${new Date().getMonth()}`;
            const warningStatus = await dbGet(checkKey);

            let popupShown = false;
            
            if (percentage > 100 && warningStatus !== 'black') {
                showFeedbackPopup(0, {
                    class: 'feedback-budget-black', emoji: '💀', title: '예산 초과',
                    message: "계획 없는 소비는 미래의 나에게 빚을 지는 것과 같습니다. 재정 습관을 점검하고, 다음 달에는 반드시 예산 안에서 생활하는 훈련을 해야 합니다."
                });
                await dbSet(checkKey, 'black');
                popupShown = true;
            } else if (percentage > 90 && warningStatus !== 'red' && warningStatus !== 'black') {
                showFeedbackPopup(0, {
                    class: 'feedback-budget-red', emoji: '🚨', title: '지갑 경보!',
                    message: "돈은 버는 것보다 쓰는 게 훨씬 쉽다는 사실, 잊지 마세요. 지금부터의 지출은 신중해야 합니다."
                });
                await dbSet(checkKey, 'red');
                popupShown = true;
            } else if (percentage > 70 && !warningStatus) {
                showFeedbackPopup(0, {
                    class: 'feedback-reflection', emoji: '🤔', title: '예산 70% 도달',
                    message: "예산의 70%를 사용했습니다. 남은 기간 동안 현명한 소비 계획이 필요합니다."
                });
                await dbSet(checkKey, 'yellow');
                popupShown = true;
            }

            return popupShown;
        }

        async function openDayModal(date) {
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) saveStatus.textContent = '';
            selectedDate = date;
            const data = await getDayData(date);
            currentModalData = { ...data };
            
            document.getElementById('modalTitle').textContent = new Date(date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('modalWakeTime').value = data.wakeTime || '';
            document.getElementById('modalSeatTime').value = data.seatTime || '';
            document.getElementById('modalSleepTime').value = data.sleepTime || '';
            document.getElementById('modalMorningPomodoro').value = data.pomodoro?.morning || 0;
            document.getElementById('modalAfternoonPomodoro').value = data.pomodoro?.afternoon || 0;
            document.getElementById('modalEveningPomodoro').value = data.pomodoro?.evening || 0;
            document.getElementById('modalWriting').value = (data.writing || 0).toLocaleString('ko-KR');
            document.getElementById('modalGameTime').value = data.gameTime || 0;
            document.getElementById('modalOffDay').checked = data.isOffDay;
            document.getElementById('modalComment').value = data.comment || '';
            const commentDetails = document.getElementById('commentDetails');
            if (data.comment) {
                commentDetails.open = true;
            } else {
                commentDetails.open = false;
            }
            updateCommentCounter();
            
            toggleExercise(data.exercise.done, false);
            document.getElementById('modalExerciseMinutes').value = data.exercise.minutes || 0;
            
            await renderModalPersonalGoals(data);
            await renderModalExpenses(formatDate(selectedDate));
            await updateModalScore();

            document.getElementById('dayModal').style.display = 'flex';
        }

function toggleExercise(isDone, shouldAutoSave = true) {
    const btnYes = document.getElementById('exerciseBtnYes');
    const btnNo = document.getElementById('exerciseBtnNo');
    const timeGroup = document.getElementById('modalExerciseTimeGroup');
    
    if (isDone) {
        btnYes.classList.add('active');
        btnNo.classList.remove('active');
        timeGroup.style.display = 'block';
    } else {
        btnNo.classList.add('active');
        btnYes.classList.remove('active');
        timeGroup.style.display = 'none';
        document.getElementById('modalExerciseMinutes').value = 0; // 운동 안함 선택 시 시간 초기화
    }
    
    // currentModalData의 exercise 상태를 즉시 업데이트합니다.
    currentModalData.exercise = { 
        ...currentModalData.exercise, 
        done: isDone,
        minutes: isDone ? parseInt(document.getElementById('modalExerciseMinutes').value) || 0 : 0
    };
    
    // 화면의 점수를 업데이트합니다.
    updateModalScore();
    
    // 사용자가 직접 클릭했을 때만 (모달이 처음 열릴 때가 아닐 때) 자동 저장을 호출합니다.
    if (shouldAutoSave) {
        autoSaveModalData();
    }
}

        async function updateModalScore() {
            const scoreEl = document.getElementById('modalScore');
            const isOffDay = document.getElementById('modalOffDay').checked;
            if (isOffDay) { scoreEl.textContent = '휴식'; scoreEl.classList.add('is-off'); return; }
            scoreEl.classList.remove('is-off');
            const data = { 
                wakeTime: document.getElementById('modalWakeTime').value || null, 
                seatTime: document.getElementById('modalSeatTime').value || null, 
                pomodoro: { morning: parseInt(document.getElementById('modalMorningPomodoro').value) || 0, afternoon: parseInt(document.getElementById('modalAfternoonPomodoro').value) || 0, evening: parseInt(document.getElementById('modalEveningPomodoro').value) || 0 }, 
                exercise: { done: document.getElementById('exerciseBtnYes').classList.contains('active'), minutes: parseInt(document.getElementById('modalExerciseMinutes').value) || 0 }, 
                gameTime: parseInt(document.getElementById('modalGameTime').value) || 0, 
                writing: unformatNumber(document.getElementById('modalWriting').value), 
                sleepTime: document.getElementById('modalSleepTime').value || null, 
                bonusPoints: currentModalData.bonusPoints 
            }; 
            scoreEl.textContent = await calculateScoreEnhanced(data); 
        }

function getModalDataForSave() {
    const isOffDay = document.getElementById('modalOffDay').checked;
    
    const mission = currentModalData.mission ? { ...currentModalData.mission } : null;
    if (mission) {
        const missionCompleteCheckbox = document.getElementById('modalMissionComplete');
        if (missionCompleteCheckbox) {
            mission.completed = missionCompleteCheckbox.checked;
        }
    }

    const data = {
        ...currentModalData, 
        wakeTime: document.getElementById('modalWakeTime').value || null, 
        seatTime: document.getElementById('modalSeatTime').value || null, 
        pomodoro: { morning: parseInt(document.getElementById('modalMorningPomodoro').value) || 0, afternoon: parseInt(document.getElementById('modalAfternoonPomodoro').value) || 0, evening: parseInt(document.getElementById('modalEveningPomodoro').value) || 0 }, 
        exercise: { done: document.getElementById('exerciseBtnYes').classList.contains('active'), minutes: parseInt(document.getElementById('modalExerciseMinutes').value) || 0 }, 
        gameTime: parseInt(document.getElementById('modalGameTime').value) || 0, 
        writing: unformatNumber(document.getElementById('modalWriting').value), 
        sleepTime: document.getElementById('modalSleepTime').value || null, 
        isOffDay, 
        mission: mission,
        comment: document.getElementById('modalComment').value.trim() || ""
    };
    return data;
}

// 자동 저장을 위한 디바운싱 함수 (딜레이 0.5초로 단축 및 피드백 추가)
const autoSaveModalData = debounce(async () => {
    if (!selectedDate) return;

    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) saveStatus.textContent = '저장 중...';

    const data = getModalDataForSave();
    
    // 1. 점수 계산 및 데이터 저장
    data.score = await calculateScoreEnhanced(data);
    await dbSet(`day_${formatDate(selectedDate)}`, data);
    
    // 2. 퀘스트 업데이트 로직을 이곳으로 통합합니다.
    await checkAndUpdateAllQuests(data, selectedDate);
    
    // 3. 현재 모달 데이터 업데이트
    currentModalData = { ...data };

    if (saveStatus) {
        setTimeout(() => {
            saveStatus.textContent = '모든 변경사항이 저장되었습니다.';
        }, 300);
    }
}, 500);

// 기존 saveModalData를 대체하는 finalizeDay 함수
async function finalizeDay() {
    const previousData = await getDayData(selectedDate);
    const data = getModalDataForSave();

    // 최종 점수 계산 및 저장
    data.score = await calculateScoreEnhanced(data);
    await dbSet(`day_${formatDate(selectedDate)}`, data);

    // === 종료 시점 퀘스트 체크 추가 ===
    await checkEndOfDayQuests(data, selectedDate);
    
    // 주간 종료 체크 (일요일인 경우)
    const dayOfWeek = selectedDate.getDay();
    if (dayOfWeek === 0) { // 일요일
        await checkEndOfWeekQuests(selectedDate);
        await checkWeekEndAchievements(selectedDate);
    }
    
    // 월간 종료 체크 (월 마지막 날인 경우)
    const nextDay = new Date(selectedDate);
    nextDay.setDate(nextDay.getDate() + 1);
    if (nextDay.getDate() === 1) { // 다음날이 1일이면 오늘이 월말
        await checkEndOfMonthQuests(selectedDate);
    }

    // 업적 및 스트릭 체크
    const allDbData = await dbGetAll();
    await checkAllAchievements(selectedDate, data, previousData, allDbData);
    await checkStreaks(selectedDate, data, allDbData);
    await checkExerciseAchievements(selectedDate);

    // 감성 분석 및 명언 팝업
    const quoteShown = await analyzeSentimentAndShowQuote(selectedDate, data.comment);

    closeDayModal();

    // 예산 관련 팝업 체크
    const budgetPopupShown = await checkBudgetAndShowPopup();

    // 점수 피드백 팝업 (다른 팝업이 떴으면 약간 지연)
    if (!data.isOffDay) {
        const finalScore = data.score;
        const delay = (quoteShown || budgetPopupShown) ? 1000 : 0;
        setTimeout(() => showFeedbackPopup(finalScore), delay);
    }
}

// 감성 분석 및 명언 팝업 함수
async function analyzeSentimentAndShowQuote(date, currentComment) {
    if (!currentComment) return false;

    const analyze = (comment, type) => SENTIMENT_DATA[type].keywords.some(k => comment.includes(k));
    
    const today = new Date(date);
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
    const dayBeforeYesterday = new Date(today); dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);

    const dataYesterday = await getDayData(yesterday);
    const dataDayBefore = await getDayData(dayBeforeYesterday);

    for (const type of ['positive', 'negative']) {
        if (analyze(currentComment, type) && 
            analyze(dataYesterday.comment, type) && 
            analyze(dataDayBefore.comment, type)) {
            
            const quotes = SENTIMENT_DATA[type].quotes;
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            const options = {
                class: type === 'positive' ? 'feedback-celebration' : 'feedback-encouragement',
                emoji: type === 'positive' ? '☀️' : '🌧️',
                title: randomQuote.title,
                message: randomQuote.msg
            };
            showFeedbackPopup(0, options);
            return true; // 팝업 표시됨
        }
    }
    return false; // 팝업 표시 안됨
}

        async function checkForWeeklyReflection(date) {
            const today = new Date(date);
            if (today.getDay() !== 0) return;

            const weekDates = getWeekDates(today);
            const checkKey = `weeklyReflectionChecked_${weekDates[0]}`;
            if (await dbGet(checkKey)) return;

            const dataPromises = weekDates.map(d => getDayData(parseDate(d)));
            const weekData = await Promise.all(dataPromises);
            const validDays = weekData.filter(d => d && !d.isOffDay && d.wakeTime);
            if (validDays.length === 0) return;

            const avgScore = Math.round(validDays.reduce((sum, d) => sum + (d.score || 0), 0) / validDays.length);
            if (avgScore < 25) {
                document.getElementById('reasonModal').style.display = 'flex';
            }
            await dbSet(checkKey, true);
        }
        function closeReasonModal() { document.getElementById('reasonModal').style.display = 'none'; }
        function submitReason() { 
            const reason = document.getElementById('reasonText').value; 
            closeReasonModal(); 
            analyzeReason(reason); 
            document.getElementById('reasonText').value = ''; 
            unlockAchievement('ACH_META_AWARENESS');
        }
        function analyzeReason(reason) {
            const negative = ['게임', '빈둥', '하기 싫어서', '노느라', '유튜브', '넷플릭스', '뒹굴']; 
            const acceptable = ['생리', '회사', '업무', '출간', '프로젝트', '마감', '몸살', '병원', '아파서'];
            let type = 'neutral';
            if (negative.some(k => reason.includes(k))) type = 'negative'; 
            else if (acceptable.some(k => reason.includes(k))) type = 'acceptable';
            let options = {};
            switch (type) {
                case 'negative': options = { class: 'feedback-disaster', emoji: '😡', title: '코치의 따끔한 한마디', message: `"${reason.substring(0, 15)}..." 그건 변명입니다. 시간을 지배하지 못하는 자는 결국 시간의 노예가 될 뿐입니다.` }; break;
                case 'acceptable': options = { class: 'feedback-encouragement', emoji: '👍', title: '이해합니다. 수고했어요.', message: '힘든 상황에서도 기록을 놓지 않은 것만으로도 대단합니다. 잘 추스르고 다음 주에 다시 시작해봅시다.' }; break;
                default: options = { class: 'feedback-reflection', emoji: '🤔', title: '성찰의 시간', message: '솔직한 답변 고맙습니다. 원인을 파악하고 다음 주에 어떻게 개선할지 계획하는 것이 중요합니다.' }; break;
            }
            showFeedbackPopup(0, options);
        }

        async function deleteModalData() { if (!confirm("정말로 이 날의 데이터를 삭제하시겠습니까?")) return; await dbDelete(`day_${formatDate(selectedDate)}`); closeDayModal(); await renderCalendar(); }
    async function renderModalPersonalGoals(data) {
    const allGoals = await getPersonalGoals();
    const goals = allGoals.filter(goal => {
        if (goal.isCompleted) return false;
        const goalCreatedDate = new Date(goal.createdAt);
        goalCreatedDate.setHours(0, 0, 0, 0); 
        return goalCreatedDate <= selectedDate;
    });
    const container = document.getElementById('modalPersonalGoalsList');
    
    if (goals.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; font-size:13px;">진행 중인 개인 목표가 없습니다.</p>';
        return;
    }
    
    const personalGoalsData = data.personalGoals || {};
    container.innerHTML = goals.map(goal => {
        const achieved = personalGoalsData[goal.id] || 0;
        let percentage = 0;
        if (goal.type === 'negative') {
            const usageRatio = achieved / goal.dailyTarget;
            percentage = Math.max(0, (1 - usageRatio) * 100);
        } else {
            percentage = Math.min(100, (achieved / goal.dailyTarget) * 100);
        }
        const emoji = getEmojiForAchievement(percentage);
        
        return `<div class="personal-goal-checkbox">
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size:13px; margin-bottom: 5px;">
                    ${goal.name} ${goal.type === 'negative' ? '(줄이기)' : '(늘리기)'}
                </div>
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ${goal.type === 'negative' ? '목표: ' + goal.dailyTarget + goal.unit + ' 이하' : '목표: ' + goal.dailyTarget + goal.unit}
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button type="button" class="goal-adjust-btn" onclick="adjustPersonalGoal('${goal.id}', -1)" style="width: 28px; height: 28px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; color: #666;">−</button>
                    <input type="number" 
                           id="personalGoal_${goal.id}" 
                           value="${achieved}" 
                           min="0" 
                           style="width: 60px; height: 28px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" 
                           onchange="updatePersonalGoalValue('${goal.id}', this.value)">
                    <button type="button" class="goal-adjust-btn" onclick="adjustPersonalGoal('${goal.id}', 1)" style="width: 28px; height: 28px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; color: #666;">+</button>
                    <span style="font-size: 11px; color: #666;">${goal.unit}</span>
                </div>
            </div>
            <div style="font-size: 16px; margin-left: 8px;">${emoji}</div>
        </div>`;
    }).join('');
}

// 개인 목표 +/- 버튼 조정 함수
function adjustPersonalGoal(goalId, change) {
    const input = document.getElementById(`personalGoal_${goalId}`);
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(0, currentValue + change);
    input.value = newValue;
    
    // 값 업데이트 및 자동 저장
    updatePersonalGoalValue(goalId, newValue);
}

// 개인 목표 값 업데이트 함수
function updatePersonalGoalValue(goalId, value) {
    if (!currentModalData.personalGoals) {
        currentModalData.personalGoals = {};
    }
    currentModalData.personalGoals[goalId] = parseInt(value) || 0;
    
    // 점수 업데이트 및 자동 저장
    updateModalScore();
    autoSaveModalData();
}

async function updatePersonalGoalProgress(goalId, value) { 
    const achieved = Math.max(0, parseInt(value) || 0); 
    currentModalData.personalGoals = currentModalData.personalGoals || {}; 
    currentModalData.personalGoals[goalId] = achieved; 
    const goals = await getPersonalGoals(); 
    const goal = goals.find(g => g.id === goalId); 
    if (!goal) return;
    
    let percentage = 0;
    if (goal.type === 'negative') {
        const usageRatio = achieved / goal.dailyTarget;
        percentage = Math.max(0, (1 - usageRatio) * 100);
    } else {
        percentage = Math.min(100, (achieved / goal.dailyTarget) * 100);
    }
    
    const emoji = getEmojiForAchievement(percentage); 
    const container = document.querySelector(`#goal_${goal.id}`).closest('.personal-goal-checkbox'); 
    container.querySelector('.goal-emoji').textContent = emoji; 
    container.querySelector('span:last-of-type').textContent = `(${Math.round(percentage)}%)`;
    
    autoSaveModalData();
}
        
// 글쓰기 마일스톤 체크 함수
async function checkWritingMilestone(newlyAddedChars) {
    if (!newlyAddedChars || newlyAddedChars <= 0) return;
    let currentProgress = await dbGet('writingMilestoneProgress') || 0;
    currentProgress += newlyAddedChars;
    const MILESTONE_GOAL = 120000;
    if (currentProgress >= MILESTONE_GOAL) {
        showFeedbackPopup(100, {
            class: 'feedback-celebration',
            emoji: '✍️',
            title: '원고 완성!',
            message: '축하합니다! 책 한 권 분량의 글이 완성되었습니다. 당신은 진정한 작가입니다!'
        });
        await dbSet('writingMilestoneProgress', 0);
    } else {
        await dbSet('writingMilestoneProgress', currentProgress);
    }
}

function addWeeklyWritingSummary(cellDate, container, dataMap) {
    const weekDates = getWeekDates(cellDate);
    let weeklyWritingTotal = 0;
    
    for (const dateStr of weekDates) {
        const weeklyDayData = dataMap.get(`day_${dateStr}`);
        if (weeklyDayData) {
            weeklyWritingTotal += weeklyDayData.writing || 0;
        }
    }
    
    if (weeklyWritingTotal > 0) {
        const bookCount = (weeklyWritingTotal / 100000).toFixed(2);
        container.innerHTML += `<span>📖${bookCount}</span>`;
    }
}
        
async function addPersonalGoal() { 
    const name = document.getElementById('newGoalName').value.trim();
    const totalAmount = parseInt(document.getElementById('newGoalTarget').value); 
    const days = parseInt(document.getElementById('newGoalUnit').value);
    const customUnit = document.getElementById('newGoalCustomUnit').value.trim(); // 새로 추가
    
    if (!name || !totalAmount || !days || days <= 0 || !customUnit) {
        return alert('모든 필드를 올바르게 입력해주세요!');
    }
    
    // 하루 목표량 계산
    const dailyTarget = Math.ceil(totalAmount / days);
    
    const goals = await getPersonalGoals(); 
    const newGoal = {
        id: Date.now().toString(), 
        name, 
        totalAmount: totalAmount,
        days: days,
        dailyTarget: dailyTarget,
        unit: customUnit, // 하드코딩 대신 사용자 입력 사용
        createdAt: new Date().toISOString(), 
        isCompleted: false, 
        type: newGoalType,
        deadline: new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString()
    };
    
    goals.push(newGoal);
    await dbSet('personalGoals', goals); 
    
    // 입력 필드 초기화
    document.getElementById('newGoalName').value = ''; 
    document.getElementById('newGoalTarget').value = ''; 
    document.getElementById('newGoalUnit').value = ''; 
    document.getElementById('newGoalCustomUnit').value = ''; // 새 필드 초기화
    
    await renderPersonalGoalsList(); 
}

function toggleGoalType(type) {
    newGoalType = type;
    const positiveBtn = document.getElementById('goalTypePositive');
    const negativeBtn = document.getElementById('goalTypeNegative');
    const targetLabel = document.querySelector('label[for="newGoalTarget"]');
    const unitLabel = document.querySelector('label[for="newGoalUnit"]');

    if (type === 'positive') {
        positiveBtn.classList.add('active');
        negativeBtn.classList.remove('active');
        targetLabel.textContent = '총 목표량';
        unitLabel.textContent = '기간 (일)';
        document.getElementById('newGoalUnit').placeholder = '예: 20';
    } else {
        negativeBtn.classList.add('active');
        positiveBtn.classList.remove('active');
        targetLabel.textContent = '최대 허용량 (총)';
        unitLabel.textContent = '기간 (일)';
        document.getElementById('newGoalUnit').placeholder = '예: 30';
    }
}

        async function deletePersonalGoal(goalId) { if (!confirm('이 목표를 삭제하시겠습니까?')) return; const goals = (await getPersonalGoals()).filter(goal => goal.id !== goalId); await dbSet('personalGoals', goals); await renderPersonalGoalsList(); }
        function switchGoalTab(tabName) { currentGoalTab = tabName; document.querySelectorAll('.goal-tab').forEach(tab => tab.classList.remove('active')); document.querySelector(`.goal-tab[onclick="switchGoalTab('${tabName}')"]`).classList.add('active'); renderPersonalGoalsList(); }
    async function renderPersonalGoalsList() { 
    const allGoals = await getPersonalGoals(); 
    
    // 마감일 체크 및 자동 완료 처리
    const today = new Date();
    let goalsUpdated = false;
    
    for (const goal of allGoals) {
        if (!goal.isCompleted && goal.deadline) {
            const deadlineDate = new Date(goal.deadline);
            if (today >= deadlineDate) {
                goal.isCompleted = true;
                goal.completedAt = deadlineDate.toISOString();
                
                // 성공/실패 판정
                const totalAchieved = await calculateTotalAchieved(goal);
                if (goal.type === 'positive') {
                    goal.success = totalAchieved >= goal.totalAmount;
                } else {
                    goal.success = totalAchieved <= goal.totalAmount;
                }
                goalsUpdated = true;
            }
        }
    }
    
    if (goalsUpdated) {
        await dbSet('personalGoals', allGoals);
    }
    
    const goals = allGoals.filter(goal => currentGoalTab === 'active' ? !goal.isCompleted : goal.isCompleted); 
    const container = document.getElementById('personalGoalsList'); 
    
    if (goals.length === 0) { 
        const emptyMessage = currentGoalTab === 'active' ? '<p>아직 진행 중인 목표가 없습니다.</p><p>아래에서 새 목표를 추가해보세요!</p>' : '<p>완료된 목표가 없습니다.</p><p>목표를 달성하고 완료 표시를 해보세요!</p>'; 
        container.innerHTML = `<div class="empty-goals"><div style="font-size: 48px; margin-bottom: 15px;">🎯</div>${emptyMessage}</div>`; 
        const addGoalSection = document.querySelector('#personalGoalsPage .modal-input-group');
        if (addGoalSection) { addGoalSection.style.display = currentGoalTab === 'completed' ? 'none' : 'block'; }
        return; 
    } 
    
    container.innerHTML = await Promise.all(goals.map(async goal => {
        const totalAchieved = await calculateTotalAchieved(goal);
        const progressPercentage = goal.type === 'positive' 
            ? Math.min(100, (totalAchieved / goal.totalAmount) * 100)
            : Math.max(0, (1 - totalAchieved / goal.totalAmount) * 100);
        
        const daysLeft = goal.deadline ? Math.max(0, Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24))) : 0;
        
        let statusText = '';
        if (goal.isCompleted) {
            const successEmoji = goal.success ? '✅' : '❌';
            const successText = goal.success ? '성공' : '실패';
            statusText = `완료 (${successText} ${successEmoji}) - ${new Date(goal.completedAt).toLocaleDateString('ko-KR')}`;
        } else {
            statusText = `D-${daysLeft} (하루 ${goal.dailyTarget}${goal.unit})`;
        }
        
        const actionButton = currentGoalTab === 'active' ? 
            `<button class="complete-btn" onclick="completePersonalGoal('${goal.id}')">완료</button>` : 
            `<button class="reopen-btn" onclick="reopenPersonalGoal('${goal.id}')">재개</button>`; 
        
        return `<div class="personal-goal-item">
            <div class="personal-goal-header">
                <div class="personal-goal-name">
                    ${goal.name} ${goal.type === 'negative' ? '👎' : '👍'} 
                    (${totalAchieved}/${goal.totalAmount}${goal.unit} - ${Math.round(progressPercentage)}%)
                </div>
                <div class="personal-goal-actions" style="display:flex; gap:5px;">
                    ${currentGoalTab === 'active' ? `<button class="edit-btn" onclick="editPersonalGoal('${goal.id}')">수정</button>` : ''}
                    ${actionButton}
                    <button class="delete-btn" onclick="deletePersonalGoal('${goal.id}')">삭제</button>
                </div>
            </div>
            <small style="color: #666;">${statusText}</small>
        </div>`;
    })).then(results => results.join('')); 
    
    const addGoalSection = document.querySelector('#personalGoalsPage .modal-input-group');
    if (addGoalSection) { addGoalSection.style.display = currentGoalTab === 'completed' ? 'none' : 'block'; }
}

        async function reopenPersonalGoal(goalId) { if (!confirm('이 목표를 다시 진행 중으로 변경하시겠습니까?')) return; const goals = await getPersonalGoals(); const goal = goals.find(g => g.id === goalId); if (goal) { goal.isCompleted = false; delete goal.completedAt; await dbSet('personalGoals', goals); await renderPersonalGoalsList(); } }
        async function editPersonalGoal(goalId) { const goals = await getPersonalGoals(); const goal = goals.find(g => g.id === goalId); if (!goal) return; const newName = prompt('목표 이름을 수정하세요:', goal.name); if (!newName || !newName.trim()) return; const newTarget = prompt('목표량을 수정하세요:', goal.target); if (!newTarget || isNaN(newTarget) || newTarget <= 0) return; const newUnit = prompt('단위를 수정하세요:', goal.unit); if (!newUnit || !newUnit.trim()) return; goal.name = newName.trim(); goal.target = parseInt(newTarget); goal.unit = newUnit.trim(); await dbSet('personalGoals', goals); await renderPersonalGoalsList(); }

        // 목표의 총 달성량을 계산하는 함수
async function calculateTotalAchieved(goal) {
    const allData = await dbGetAll();
    const startDate = new Date(goal.createdAt);
    const endDate = goal.deadline ? new Date(goal.deadline) : new Date();
    
    let totalAchieved = 0;
    
    for (const item of allData) {
        if (item.key.startsWith('day_')) {
            const dayDate = new Date(item.value.date);
            if (dayDate >= startDate && dayDate <= endDate) {
                const dailyAchieved = item.value.personalGoals?.[goal.id] || 0;
                totalAchieved += dailyAchieved;
            }
        }
    }
    
    return totalAchieved;
}

        // 예산 계산 함수 수정 (보너스 예산 포함)
async function renderSmallBudgetBarEnhanced() { 
    const budget = await dbGet('monthlyBudget'); 
    const bonusBudget = await dbGet('currentMonthBonusBudget') || 0;
    const totalBudget = (budget || 0) + bonusBudget;
    
    const budgetContainer = document.getElementById('budgetBarSmall'); 
    const budgetFill = document.getElementById('budgetBarFillSmall'); 
    
    if (!totalBudget) { 
        budgetContainer.style.display = 'none'; 
        return; 
    } 
    
    const { start, end } = getMonthDateRange(currentDate); 
    const allData = await dbGetAll(); 
    const expenses = allData.filter(item => item.key.startsWith('expense_') && item.value.date >= start && item.value.date <= end); 
    const totalSpent = expenses.reduce((sum, item) => sum + item.value.amount, 0); 
    const percentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0; 
    
    let colorClass = 'green'; 
    if (percentage > 100) colorClass = 'black'; 
    else if (percentage > 85) colorClass = 'red'; 
    else if (percentage > 70) colorClass = 'yellow'; 
    
    budgetFill.className = `battery-level ${colorClass}`; 
    budgetFill.style.width = `${Math.min(percentage, 100)}%`; 
    budgetContainer.style.display = 'flex'; 
    
    // 툴팁에 보너스 예산 정보 포함
    let tooltipText = `예산: ${formatCurrency(budget || 0)}`;
    if (bonusBudget > 0) {
        tooltipText += ` + 보너스: ${formatCurrency(bonusBudget)}`;
    }
    tooltipText += ` / 지출: ${formatCurrency(totalSpent)}`;
    budgetContainer.title = tooltipText;
}
        async function renderBudgetBar(containerId = 'budgetDetailBar') { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; const budget = await dbGet('monthlyBudget'); if (!budget) return; const { start, end } = getMonthDateRange(currentDate); const allData = await dbGetAll(); const expenses = allData.filter(item => item.key.startsWith('expense_') && item.value.date >= start && item.value.date <= end); const totalSpent = expenses.reduce((sum, item) => sum + item.value.amount, 0); const percentage = budget > 0 ? (totalSpent / budget) * 100 : 0; let colorClass = 'green'; if (percentage > 100) colorClass = 'black'; else if (percentage > 85) colorClass = 'red'; else if (percentage > 70) colorClass = 'yellow'; container.innerHTML = `<div style="width:100%; height:8px; background:#eee; border-radius:4px; overflow:hidden;"><div style="width:${Math.min(percentage, 100)}%; height:100%; background:var(--${colorClass}-color)"></div></div>`; }
        async function renderBudgetPage() { await renderExpenseList(); }
async function renderExpenseList() {
    const container = document.getElementById('expenseList');
    const { start, end } = getMonthDateRange(currentDate);
    const allData = await dbGetAll();
    const budget = await dbGet('monthlyBudget') || 0;
    const expenses = allData
        .filter(item => item.key.startsWith('expense_') && item.value.date >= start && item.value.date <= end)
        .map(item => ({ ...item.value, id: item.key }))
        .sort((a, b) => a.date.localeCompare(b.date));

    if (expenses.length === 0) {
        container.innerHTML = `<div class="empty-expenses"><p>이번 달 지출 내역이 없습니다.</p></div>`;
        return;
    }

    const totalAmount = expenses.reduce((sum, ex) => sum + ex.amount, 0);
    
    // 영수증 스타일 HTML 생성
    let receiptHTML = `
    <div class="receipt-container">
        <div class="receipt-header">
            <div class="receipt-title">
                <h3>🧾 영수증</h3>
                <div class="budget-info">
                    <span>예산: ${formatCurrency(budget || 0)}</span>
                    <span>잔액: ${formatCurrency((budget || 0) - totalAmount)}</span>
                </div>
            </div>
            <p>${currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' })}</p>
        </div>
`;

    expenses.forEach(ex => {
        const dateObj = new Date(ex.date);
        const formattedDate = `${String(dateObj.getFullYear()).slice(-2)}.${String(dateObj.getMonth() + 1).padStart(2, '0')}.${String(dateObj.getDate()).padStart(2, '0')}`;
        
        receiptHTML += `
            <div class="receipt-item">
                <span class="receipt-date">${formattedDate}</span>
                <span class="receipt-desc">${ex.description}</span>
                <span class="receipt-amount">${formatCurrency(ex.amount)}</span>
            </div>
        `;
    });
    
    receiptHTML += `
            </div>
            <div class="receipt-divider"></div>
            <div class="receipt-total">
                <span>총 지출</span>
                <span>₩${nf.format(totalAmount)}</span>
            </div>
        </div>
    `;

    container.innerHTML = receiptHTML;
}
        async function renderModalExpenses(dateString) { const container = document.getElementById('modalExpenseList'); const allData = await dbGetAll(); const expenses = allData.filter(item => item.key.startsWith('expense_') && item.value.date === dateString).map(item => ({ ...item.value, id: item.key })); if (expenses.length === 0) { container.innerHTML = `<p style="text-align:center; color:#999; font-size:12px; padding:10px 0;">오늘 지출 내역 없음</p>`; } else { container.innerHTML = expenses.map(ex => `<div class="expense-item"><span>${ex.description}</span><div><span style="margin-right:10px;">${formatCurrency(ex.amount)}</span><button class="expense-delete-btn" style="background:var(--danger-color); border:none; color:white; border-radius:50%; width:18px; height:18px; cursor:pointer;" onclick="deleteExpense('${ex.id}', '${dateString}')">×</button></div></div>`).join(''); } const total = expenses.reduce((sum, ex) => sum + ex.amount, 0); document.getElementById('modalTotalExpense').textContent = `오늘 총 지출: ${formatCurrency(total)}`; }
        async function addExpense() { 
            const desc = document.getElementById('expenseDesc').value.trim(); 
            const amount = unformatNumber(document.getElementById('expenseAmount').value); 
            if (!desc || !amount || amount <= 0) return alert('내역과 금액을 올바르게 입력해주세요.'); 
    
            const expenseId = `expense_${Date.now()}`; 
            const expenseData = { date: formatDate(selectedDate), description: desc, amount: amount }; 
            await dbSet(expenseId, expenseData); 
    
            document.getElementById('expenseDesc').value = ''; 
            document.getElementById('expenseAmount').value = ''; 
            await renderModalExpenses(formatDate(selectedDate)); 
            await renderSmallBudgetBarEnhanced(); 
            
            const isFood = foodKeywords.some(keyword => desc.toLowerCase().includes(keyword.toLowerCase()));
            if (isFood) {
                currentFoodExpenseData = { expenseId, expenseData };
                showFoodSuggestion(desc);
            } else {
                await checkBudgetAndShowPopup();
            }
        }
        async function deleteExpense(id, dateString) { 
            if (!confirm('이 지출 내역을 삭제하시겠습니까? 연관된 식단 기록도 함께 삭제됩니다.')) return;
            const allData = await dbGetAll();
            const relatedFoodRecords = allData.filter(item => item.key.startsWith('food_') && item.value.expenseId === id);
            for (const foodRecord of relatedFoodRecords) { await dbDelete(foodRecord.key); }
            await dbDelete(id); 
            await renderModalExpenses(dateString); 
            await renderSmallBudgetBarEnhanced(); 
            if (relatedFoodRecords.length > 0 && document.getElementById('foodPage').classList.contains('active')) {
                await renderFoodRecords();
            }
        }
        
        async function renderDdayDisplay() {
            const ddays = await dbGet('ddayGoals') || [];
            const ddayContainer = document.getElementById('ddayContainer');
            ddayContainer.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            ddays.slice(0, 3).forEach(dday => {
                const targetDate = parseDate(dday.date);
                const diffTime = targetDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let displayString = diffDays === 0 ? `${dday.name} D-Day` : diffDays > 0 ? `${dday.name} D-${diffDays}` : `${dday.name} D+${-diffDays}`;
                const chip = document.createElement('div');
                chip.className = 'dday-chip';
                chip.textContent = displayString;
                chip.style.display = 'block';
                ddayContainer.appendChild(chip);
            });
        }
        async function renderDdaySettings() {
            const ddays = await dbGet('ddayGoals') || [];
            const container = document.getElementById('ddaySettingsList');
            container.innerHTML = '';
            ddays.forEach(dday => {
                container.innerHTML += `<div class="dday-item"><span><strong>${dday.name}</strong> (${dday.date})</span><div class="dday-actions"><button onclick="editDday('${dday.id}')" title="수정">✏️</button><button onclick="deleteDday('${dday.id}')" title="삭제">🗑️</button></div></div>`;
            });
            document.getElementById('addDdayBtn').style.display = ddays.length < 3 ? 'block' : 'none';
        }
        async function addDday() { const ddays = await dbGet('ddayGoals') || []; if (ddays.length >= 3) { alert("D-Day는 최대 3개까지만 설정할 수 있습니다."); return; } const name = prompt("D-Day의 이름을 입력하세요:"); if (!name) return; const date = prompt("날짜를 입력하세요 (YYYY-MM-DD 형식):"); if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) { alert("올바른 날짜 형식이 아닙니다."); return; } ddays.push({ id: Date.now().toString(), name: name, date: date }); await dbSet('ddayGoals', ddays); const unlocked = await dbGet('unlockedAchievements') || []; if (!unlocked.includes('ACH_DDAY_SETTER') && ddays.length === 1) { await unlockAchievement('ACH_DDAY_SETTER'); } await renderDdaySettings(); await renderDdayDisplay(); }
        async function editDday(id) { const ddays = await dbGet('ddayGoals') || []; const dday = ddays.find(d => d.id === id); if (!dday) return; const newName = prompt("새 D-Day 이름을 입력하세요:", dday.name); if (!newName) return; const newDate = prompt("새 날짜를 입력하세요 (YYYY-MM-DD 형식):", dday.date); if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) { alert("올바른 날짜 형식이 아닙니다."); return; } dday.name = newName; dday.date = newDate; await dbSet('ddayGoals', ddays); await renderDdaySettings(); await renderDdayDisplay(); }
        async function deleteDday(id) { if (!confirm("정말로 이 D-Day를 삭제하시겠습니까?")) return; let ddays = await dbGet('ddayGoals') || []; ddays = ddays.filter(d => d.id !== id); await dbSet('ddayGoals', ddays); await renderDdaySettings(); await renderDdayDisplay(); }
        
        async function exportData() { const allData = await dbGetAll(); const exportObject = {}; allData.forEach(item => { exportObject[item.key] = item.value; }); const dataStr = JSON.stringify(exportObject, null, 2); const dataBlob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `routine_data_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); alert('데이터 내보내기가 완료되었습니다.'); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if (!confirm("정말로 데이터를 불러오시겠습니까? 현재 기록이 백업 파일로 덮어쓰여집니다.")) { event.target.value = ''; return; } await dbClear(); for (const key in data) { if (Object.hasOwnProperty.call(data, key)) { await dbSet(key, data[key]); } } alert("데이터를 성공적으로 불러왔습니다! 앱을 다시 시작합니다."); location.reload(); } catch (error) { alert("파일을 읽는 데 실패했습니다."); event.target.value = ''; } }; reader.readAsText(file); }

        function openExcelModal() { document.getElementById('excelExportModal').style.display = 'flex'; }
        function closeExcelModal() { document.getElementById('excelExportModal').style.display = 'none'; }
        function toggleDateInputs(show) { document.getElementById('customDateRange').style.display = show ? 'flex' : 'none'; }
        
        // 오늘의 한마디 기록 보기 페이지를 보여주는 함수
        async function showCommentHistory() { showPage('commentHistoryPage'); await renderCommentHistory(); }

// 오늘의 한마디 글자 수 카운터 및 색상 변경 함수
function updateCommentCounter() {
    const commentInput = document.getElementById('modalComment');
    const counter = document.getElementById('commentCharCounter');
    
    const currentLength = commentInput.value.length;
    const maxLength = commentInput.maxLength;
    counter.textContent = `${currentLength}/${maxLength}`;

    if (currentLength >= maxLength) {
        commentInput.style.borderColor = 'var(--danger-color)';
        counter.style.color = 'var(--danger-color)';
    } else if (currentLength >= 400) {
        commentInput.style.borderColor = 'var(--warning-color)';
        counter.style.color = 'var(--warning-color)';
    } else {
        commentInput.style.borderColor = 'var(--border-color)';
        counter.style.color = 'var(--text-color-light)';
    }
}

// 오늘의 한마디 기록을 렌더링하는 함수
async function renderCommentHistory() {
    const container = document.getElementById('commentHistoryList');
    const allData = await dbGetAll();
    const comments = allData
        .filter(item => item.key.startsWith('day_') && item.value.comment)
        .map(item => item.value)
        .sort((a, b) => b.date.localeCompare(a.date));

    if (comments.length === 0) {
        container.innerHTML = `<div class="empty-comments"><p>아직 기록된 한마디가 없습니다.</p></div>`;
        return;
    }

    container.innerHTML = comments.map(day => {
        const dateObj = parseDate(day.date);
        const formattedDate = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        // HTML Injection을 막기 위해 텍스트를 안전하게 처리
        const safeComment = document.createElement('div');
        safeComment.innerText = day.comment;

        return `
            <div class="comment-item">
                <div class="comment-item-header">${formattedDate}</div>
                <div class="comment-item-body">${safeComment.innerHTML.replace(/\n/g, '<br>')}</div>
            </div>
        `;
    }).join('');
}
        
async function exportToExcel() {
    alert('엑셀 파일을 생성 중입니다. 데이터 양에 따라 시간이 걸릴 수 있습니다.');
    const period = document.querySelector('input[name="period"]:checked').value;
    let startDate, endDate;
    const today = new Date();
    
    switch (period) {
        case 'thisMonth': startDate = new Date(today.getFullYear(), today.getMonth(), 1); endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); break;
        case 'lastMonth': startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1); endDate = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'custom': startDate = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null; endDate = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null; if (!startDate || !endDate) { alert('시작일과 종료일을 모두 선택해주세요.'); return; } endDate.setHours(23, 59, 59, 999); break;
        default: startDate = new Date('1970-01-01'); endDate = new Date('2999-12-31'); break;
    }
    
    const startDateStr = formatDate(startDate);
    const endDateStr = formatDate(endDate);

    const allData = await dbGetAll();
    const routineData = allData.filter(item => item.key.startsWith('day_') && item.value.date >= startDateStr && item.value.date <= endDateStr).map(item => item.value);
    const expenseData = allData.filter(item => item.key.startsWith('expense_') && item.value.date >= startDateStr && item.value.date <= endDateStr).map(item => item.value);

    // '오늘의 한마디' 헤더 추가
    const sheet1Headers = ['날짜 (요일)', '점수', '개인목표(%)', '기상 시간', '착석 시간', '취침 시간', '총 뽀모도로', '운동 여부', '운동 시간(분)', '글쓰기(자)', '게임 시간(분)', '휴식일', '오늘의 한마디', '경고'];
    const sheet1Rows = [sheet1Headers];
    for (const day of routineData.sort((a,b) => a.date.localeCompare(b.date))) {
        const dateObj = parseDate(day.date);
        const dayOfWeek = ['일','월','화','수','목','금','토'][dateObj.getDay()];
        let warnings = [];
        if (!day.isOffDay && day.score < 40) warnings.push('점수 미흡');
        if (day.gameTime > 120) warnings.push('게임 초과');

        // '오늘의 한마디' 데이터 행 추가
        sheet1Rows.push([ 
            `${day.date} (${dayOfWeek})`, 
            day.score, 
            await calculatePersonalGoalAverage(day, day.date) + '%', 
            day.wakeTime || '', 
            day.seatTime || '', 
            day.sleepTime || '', 
            (day.pomodoro?.morning || 0) + (day.pomodoro?.afternoon || 0) + (day.pomodoro?.evening || 0), 
            day.exercise?.done ? 'O' : 'X', 
            day.exercise?.minutes || 0, 
            day.writing || 0, 
            day.gameTime || 0, 
            day.isOffDay ? 'O' : '',
            day.comment || '',
            warnings.join(', ') 
        ]);
    }

    const monthlyBudget = await dbGet('monthlyBudget') || 0;
    const totalSpent = expenseData.reduce((sum, ex) => sum + ex.amount, 0);
    const budgetRate = monthlyBudget > 0 ? ((totalSpent / monthlyBudget) * 100).toFixed(1) + '%' : 'N/A';
    const sheet2Summary = [ ['조회 기간', `${startDateStr} ~ ${endDateStr}`], ['월 설정 예산', `₩${nf.format(monthlyBudget)}`], ['총 지출', `₩${nf.format(totalSpent)}`], ['예산 달성률', budgetRate], [] ];
    const sheet2Headers = ['날짜', '지출 내역', '금액'];
    const sheet2Rows = expenseData.sort((a,b) => a.date.localeCompare(b.date)).map(ex => [ex.date, ex.description, ex.amount]);
    
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(sheet1Rows);
    const ws2 = XLSX.utils.aoa_to_sheet(sheet2Summary);
    XLSX.utils.sheet_add_aoa(ws2, [sheet2Headers, ...sheet2Rows], { origin: 'A6' });
    
    ws1['!cols'] = sheet1Headers.map(h => ({ wch: h.length > 10 ? 20 : 12 }));
    // 오늘의 한마디 컬럼 넓게 설정 (12번 컬럼)
    if (ws1['!cols'][12]) ws1['!cols'][12].wch = 50; 

    ws2['!cols'] = [{wch: 15}, {wch: 30}, {wch: 15}];

    XLSX.utils.book_append_sheet(wb, ws1, '종합 루틴 기록');
    XLSX.utils.book_append_sheet(wb, ws2, '가계부');

    XLSX.writeFile(wb, `루틴트래커_기록_${formatDate(new Date())}.xlsx`);
    closeExcelModal();
    unlockAchievement('ACH_EXCEL_GURU');
}

        let editingFoodRecordId = null; 

        function showFoodSuggestion(expenseDesc) {
            document.getElementById('foodNameInput').value = expenseDesc;
            document.getElementById('foodQuantityInput').value = '1';
            document.getElementById('foodSuggestionModal').style.display = 'flex';
        }
        function closeFoodSuggestion() { document.getElementById('foodSuggestionModal').style.display = 'none'; }
        async function saveFoodRecord() {
            const foodName = document.getElementById('foodNameInput').value.trim();
            const quantity = document.getElementById('foodQuantityInput').value.trim();
            const unit = document.getElementById('foodUnitSelect').value;
            if (!foodName || !quantity) return alert('음식 이름과 양을 입력해주세요!');
            const recordDate = currentFoodExpenseData?.expenseData?.date;
            if (!recordDate) return alert('오류: 식단을 기록할 날짜 정보를 찾을 수 없습니다.');
            
            const foodRecord = {
                id: `food_${Date.now()}`, date: recordDate, time: new Date().toTimeString().slice(0, 5),
                foodName, quantity, unit, expenseId: currentFoodExpenseData?.expenseId || null
            };
            await dbSet(foodRecord.id, foodRecord);
            await checkFoodRecordAchievements();
            const todayData = await getDayData(new Date());
            await checkAndUpdateAllQuests(todayData, new Date());
            closeFoodSuggestion();
            alert('식단이 기록되었습니다! 🍽️');
            if (document.getElementById('foodPage').classList.contains('active')) await renderFoodRecords();
        
            const today = new Date();
            if (today.getDay() === 0) { // 일요일
            await checkWeekEndAchievements(today);
            }
        }

        function getFoodEmoji(foodName) {
            const lowerFoodName = foodName.toLowerCase();
            const emojiKeywordMap = {
                '☕': ['커피', '아메리카노', '라떼', '카푸치노', '에스프레소'], '🥤': ['스무디', '자바칩', '프라푸치노', '프라페', '주스', '에이드', '콜라', '사이다', '탄산'], '🧋': ['버블티', '밀크티'], '🍞': ['빵', '베이글', '토스트'], '🥐': ['크로와상', '베이커리', '파이'], '🍩': ['도넛', '던킨'], '🍕': ['피자'], '🍔': ['햄버거', '버거'], '🍗': ['치킨', '닭강정', '윙'], '🥗': ['샐러드'], '🍦': ['아이스크림', '젤라또', '빙수'], '🍰': ['케이크', '조각케익', '타르트'], '🍙': ['김밥', '주먹밥'], '🍜': ['라면', '국수', '우동'], '🥘': ['마라탕'], '🍝': ['파스타', '스파게티'], '🍢': ['떡볶이', '오뎅', '어묵'], '🍣': ['스시', '초밥', '회'], '🍿': ['스낵', '과자', '팝콘', '감자칩', '버터칩'], '🍹': ['칵테일'], '🍺': ['맥주', '술'], '🍤': ['튀김', '돈까스', '돈가스', '카츠', '탕수육'], '🍚': ['한식', '집밥'], '🍛': ['덮밥', '카레'], '🍫': ['초콜릿'], '🍬': ['캔디'], '🍠': ['간식'], '🍪': ['쿠키']
            };
            let lastMatch = { emoji: '🍽️', position: -1 };
            for (const [emoji, keywords] of Object.entries(emojiKeywordMap)) {
                for (const keyword of keywords) {
                    const currentPosition = lowerFoodName.lastIndexOf(keyword);
                    if (currentPosition > -1 && currentPosition > lastMatch.position) {
                        lastMatch = { emoji: emoji, position: currentPosition };
                    }
                }
            }
            return lastMatch.emoji;
        }

        async function showFoodPage() {
            showPage('foodPage');
            foodManageMode = false;
            const btn = document.getElementById('foodManageBtn');
            btn.textContent = '🔧 관리';
            btn.classList.remove('danger');
            document.getElementById('foodRecordsList').classList.remove('admin-mode');
            await renderFoodRecords();
        }

        async function renderFoodRecords() {
            const container = document.getElementById('foodRecordsList');
            container.innerHTML = '';
            const allData = await dbGetAll();
            const foodRecords = allData.filter(item => item.key.startsWith('food_')).map(item => item.value).sort((a, b) => new Date(`${b.date}T${b.time || '00:00'}`) - new Date(`${a.date}T${a.time || '00:00'}`));

            if (foodRecords.length === 0) {
                container.innerHTML = `<div class="empty-goals" style="margin-top: 20px;"><div style="font-size: 48px; margin-bottom: 15px;">🥗</div><p>아직 기록된 식단이 없습니다.</p><p>위 버튼으로 추가해보세요!</p></div>`;
                return;
            }

            const groupedRecords = foodRecords.reduce((acc, record) => { (acc[record.date] = acc[record.date] || []).push(record); return acc; }, {});
            let finalHtml = '';
            Object.keys(groupedRecords).sort().reverse().forEach(date => {
                const dateObj = parseDate(date);
                const dayOfWeek = ['일','월','화','수','목','금','토'][dateObj.getDay()];
                finalHtml += `<div class="food-date-header"><span>${date} (${dayOfWeek})</span></div>`;
                groupedRecords[date].forEach(record => {
                    finalHtml += `
                        <div class="food-record-item">
                            <div class="food-time">${record.time}</div>
                            <div class="food-emoji">${getFoodEmoji(record.foodName)}</div>
                            <div class="food-name">${record.foodName}</div>
                            <div class="food-quantity">${record.quantity}${record.unit}</div>
                            <div class="food-admin-actions">
                                <button class="edit" onclick="editFoodRecord('${record.id}')">✏️</button>
                                <button class="delete" onclick="deleteFoodRecord('${record.id}')">🗑️</button>
                            </div>
                        </div>`;
                });
            });
            container.innerHTML = finalHtml;
        }

        function showAddFoodModal() {
            editingFoodRecordId = null;
            document.getElementById('manualFoodModalTitle').textContent = '🍽️ 식단 기록 추가';
            const today = new Date();
            document.getElementById('manualFoodDate').value = formatDate(today);
            document.getElementById('manualFoodTime').value = today.toTimeString().slice(0, 5);
            document.getElementById('manualFoodName').value = '';
            document.getElementById('manualFoodQuantity').value = '1';
            document.getElementById('manualFoodUnit').selectedIndex = 0;
            document.getElementById('manualFoodModal').style.display = 'flex';
        }

        async function editFoodRecord(recordId) {
            editingFoodRecordId = recordId;
            const record = await dbGet(recordId);
            if (!record) return alert('기록을 찾을 수 없습니다.');
            document.getElementById('manualFoodModalTitle').textContent = '🍽️ 식단 기록 수정';
            document.getElementById('manualFoodDate').value = record.date;
            document.getElementById('manualFoodTime').value = record.time;
            document.getElementById('manualFoodName').value = record.foodName;
            document.getElementById('manualFoodQuantity').value = record.quantity;
            document.getElementById('manualFoodUnit').value = record.unit;
            document.getElementById('manualFoodModal').style.display = 'flex';
        }

        function closeManualFoodModal() { document.getElementById('manualFoodModal').style.display = 'none'; editingFoodRecordId = null; }
        async function saveManualFoodRecord() {
            const date = document.getElementById('manualFoodDate').value;
            const time = document.getElementById('manualFoodTime').value;
            const foodName = document.getElementById('manualFoodName').value.trim();
            const quantity = document.getElementById('manualFoodQuantity').value.trim();
            const unit = document.getElementById('manualFoodUnit').value;
            if (!date || !time || !foodName || !quantity) return alert('모든 필드를 입력해주세요!');
            
            const dateObject = new Date(date);
            if (dateObject.getDay() === 0) { 
            await checkWeekEndAchievements(dateObject); }

            const recordId = editingFoodRecordId || `food_${Date.now()}`;
            const foodRecord = { id: recordId, date, time, foodName, quantity, unit, expenseId: null };
            
            await dbSet(recordId, foodRecord);
            await checkFoodRecordAchievements();
            const dayDataForQuest = await getDayData(dateObject);
            await checkAndUpdateAllQuests(dayDataForQuest, dateObject);
            closeManualFoodModal();
            alert(`식단이 ${editingFoodRecordId ? '수정' : '기록'}되었습니다! 🍽️`);
            await renderFoodRecords();
        }

        function toggleFoodManageMode() {
    foodManageMode = !foodManageMode;
    const btn = document.getElementById('foodManageBtn');
    const listContainer = document.getElementById('foodRecordsList');
    const lang = LANGUAGE_DATA[currentLanguage];
    
    if (foodManageMode) {
        btn.textContent = lang.manageModeEnd;
        btn.classList.add('danger');
        listContainer.classList.add('admin-mode');
    } else {
        btn.textContent = lang.manageMode;
        btn.classList.remove('danger');
        listContainer.classList.remove('admin-mode');
    }
}

        async function deleteFoodRecord(recordId) {
            if (!confirm('이 식단 기록을 삭제하시겠습니까?')) return;
            await dbDelete(recordId);
            await renderFoodRecords();
        }

        function closeFoodExportModal() { document.getElementById('foodExportModal').style.display = 'none'; }
        async function exportFoodAsImage() {
            const startDateStr = prompt("내보내기 시작 날짜를 입력하세요 (YYYY-MM-DD)", formatDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), 1)));
            if (!startDateStr) return;
            const endDateStr = prompt("내보내기 종료 날짜를 입력하세요 (YYYY-MM-DD)", formatDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0)));
            if (!endDateStr) return;
            
            const allData = await dbGetAll();
            const foodRecords = allData
                .filter(item => item.key.startsWith('food_') && item.value.date >= startDateStr && item.value.date <= endDateStr)
                .map(item => item.value)
                .sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`));

            if (foodRecords.length === 0) {
                alert("해당 기간에 기록된 식단이 없습니다.");
                return;
            }
            const previewContainer = document.getElementById('foodExportPreview');
            const groupedRecords = foodRecords.reduce((acc, record) => {
                (acc[record.date] = acc[record.date] || []).push(record);
                return acc;
            }, {});

            // 기존 html 생성 부분을 모두 삭제하고 아래로 교체
        let html = `
        <div class="food-receipt-header">
            <div class="food-receipt-title">
                <h3>🍽️ 나의 식단 기록</h3>
            </div>
            <p>${startDateStr} ~ ${endDateStr}</p>
        </div>
        <div class="food-receipt-divider"></div>
        <div class="food-receipt-items">`;

        Object.keys(groupedRecords).sort().forEach(date => {
            const dateObj = parseDate(date);
            const dayOfWeek = ['일','월','화','수','목','금','토'][dateObj.getDay()];
            html += `<div class="food-receipt-date-header">${date} (${dayOfWeek})</div>`;
            groupedRecords[date].forEach(record => {
                html += `
                    <div class="food-receipt-item">
                        <span class="food-receipt-time">${record.time}</span>
                        <span class="food-receipt-desc">${getFoodEmoji(record.foodName)} ${record.foodName}</span>
                        <span class="food-receipt-quantity">${record.quantity}${record.unit}</span>
                    </div>`;
            });
        });

        html += `</div>`;
        previewContainer.innerHTML = html;
        document.getElementById('foodExportModal').style.display = 'flex';
        }

        // =======================================================================
        // 퀘스트 & 레벨 시스템
        // =======================================================================

        let currentQuestTab = 'daily';

        // 퀘스트 페이지 표시
        function showQuestPage() { document.getElementById('profileMenu').style.display = 'none'; showPage('questPage'); renderQuestPage(); }

        // 퀘스트 페이지로 이동 (모달에서)
        function openQuestPage() { closeDailyQuestModal(); showQuestPage(); }

        // 퀘스트 탭 전환
        function switchQuestTab(tabName) {
            currentQuestTab = tabName;
            
            // 탭 버튼 활성화 상태 변경
            document.querySelectorAll('.quest-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.quest-tab[onclick="switchQuestTab('${tabName}')"]`).classList.add('active');
            
            // 탭 컨텐츠 표시/숨김
            document.querySelectorAll('.quest-tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}QuestTab`).style.display = 'block';
            
            // 해당 탭 퀘스트 렌더링
            renderQuestTab(tabName);
        }

        // 퀘스트 페이지 렌더링
        async function renderQuestPage() { await updateProfileWidget(); switchQuestTab(currentQuestTab); }

        // 각 탭의 퀘스트 렌더링
        async function renderQuestTab(tabName) {
            const container = document.getElementById(`${tabName}QuestList`);
            
            switch(tabName) {
                case 'daily':
                    await renderDailyQuests(container);
                    break;
                case 'weekly':
                    await renderWeeklyQuests(container);
                    break;
                case 'monthly':
                    await renderMonthlyQuests(container);
                    break;
            }
        }

// 일간 퀘스트 렌더링 (실제 데이터)
async function renderDailyQuests(container) {
    const today = new Date();
    const questData = await getDailyQuests(today);
    
    let html = '';
    
    for (const quest of questData.quests) {
        const progressPercentage = quest.maxProgress > 0 ? (quest.progress / quest.maxProgress) * 100 : 0;
        const completedClass = quest.completed ? 'completed' : '';
        
        html += `
            <div class="quest-item ${completedClass}">
                <div class="quest-header">
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-reward">+${quest.reward} EXP</div>
                </div>
                <div class="quest-desc">${quest.desc}</div>
                <div class="quest-progress">
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width: ${Math.min(progressPercentage, 100)}%"></div>
                    </div>
                    <div class="quest-progress-text">${quest.progress}/${quest.maxProgress}</div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        // 주간 퀘스트 렌더링 (실제 데이터)
async function renderWeeklyQuests(container) {
    const today = new Date();
    const questData = await getWeeklyQuests(today);
    
    let html = '';
    
    for (const quest of questData.quests) {
        const progressPercentage = quest.maxProgress > 0 ? (quest.progress / quest.maxProgress) * 100 : 0;
        const completedClass = quest.completed ? 'completed' : '';
        
        // 진행도 텍스트 포맷팅
        let progressText = `${quest.progress}/${quest.maxProgress}`;
        if (quest.id === 'weekly_writing_8000') {
            progressText = `${quest.progress.toLocaleString()}/${quest.maxProgress.toLocaleString()}자`;
        } else if (quest.id === 'weekly_pomodoro_25') {
            progressText = `${quest.progress}/${quest.maxProgress}개`;
        } else if (quest.id === 'weekly_exercise_4times') {
            progressText = `${quest.progress}/${quest.maxProgress}회`;
        } else if (quest.id === 'weekly_expense_under_100k') {
            progressText = quest.completed ? '완료' : '진행중';
        } else if (quest.id === 'weekly_personal_goal_avg_70') {
            progressText = quest.completed ? '달성' : '미달성';
        }
        
        html += `
            <div class="quest-item ${completedClass}">
                <div class="quest-header">
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-reward">+${quest.reward} EXP</div>
                </div>
                <div class="quest-desc">${quest.desc}</div>
                <div class="quest-progress">
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width: ${Math.min(progressPercentage, 100)}%"></div>
                    </div>
                    <div class="quest-progress-text">${progressText}</div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        // 월간 퀘스트 렌더링 (실제 데이터)
async function renderMonthlyQuests(container) {
    const today = new Date();
    const questData = await getMonthlyQuests(today);
    
    let html = '';
    
    for (const quest of questData.quests) {
        const progressPercentage = quest.maxProgress > 0 ? (quest.progress / quest.maxProgress) * 100 : 0;
        const completedClass = quest.completed ? 'completed' : '';
        
        // 진행도 텍스트 포맷팅
        let progressText = `${quest.progress}/${quest.maxProgress}`;
        if (quest.id === 'monthly_writing_80k') {
            progressText = `${quest.progress.toLocaleString()}/${quest.maxProgress.toLocaleString()}자`;
        } else if (quest.id === 'monthly_exercise_15times') {
            progressText = `${quest.progress}/${quest.maxProgress}회`;
        } else if (quest.id === 'monthly_perfect_attendance') {
            progressText = `${quest.progress}/${quest.maxProgress}일`;
        } else if (quest.id === 'monthly_consistent_seat_time_input') {
            progressText = `${quest.progress}/${quest.maxProgress}일`;
        } else if (quest.id === 'monthly_consistent_sleep_input') {
            progressText = `${quest.progress}/${quest.maxProgress}일`;
        } else if (quest.id === 'monthly_early_bird_15times') {
            progressText = `${quest.progress}/${quest.maxProgress}일`;
        } else if (quest.id === 'monthly_high_score_15days') {
            progressText = `${quest.progress}/${quest.maxProgress}일`;
        } else if (quest.id === 'monthly_budget_50percent' || quest.id === 'monthly_no_game_entire_month' || quest.id === 'monthly_personal_goal_avg_70') {
            progressText = quest.completed ? '달성' : '미달성';
        }
        
        html += `
            <div class="quest-item ${completedClass}">
                <div class="quest-header">
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-reward">+${quest.reward} EXP</div>
                </div>
                <div class="quest-desc">${quest.desc}</div>
                <div class="quest-progress">
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width: ${Math.min(progressPercentage, 100)}%"></div>
                    </div>
                    <div class="quest-progress-text">${progressText}</div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// 프로필 위젯 업데이트 (실제 데이터)
async function updateProfileWidget() {
    const userData = await getUserLevelData();
    const profileInfo = getProfileInfo(userData.level);
    
    const expPercentage = userData.maxExp > 0 ? (userData.currentExp / userData.maxExp) * 100 : 0;
    
    document.getElementById('profileLevel').textContent = `Lv.${userData.level}`;
    document.getElementById('profileTitle').textContent = profileInfo.title;
    document.getElementById('profileEmoji').textContent = profileInfo.emoji;
    document.getElementById('expBar').style.width = `${expPercentage}%`;
    document.getElementById('expText').textContent = `${userData.currentExp}/${userData.maxExp}`;
    
    // 서브타이틀이 있으면 툴팁으로 표시
    if (profileInfo.subtitle) {
        const titleElement = document.getElementById('profileTitle');
        titleElement.title = profileInfo.subtitle;
        titleElement.style.cursor = 'help';
    }
}

        // 일간 퀘스트 모달 표시
        function showDailyQuestModal() {
            document.getElementById('dailyQuestModal').style.display = 'flex';
            renderDailyQuests(document.getElementById('dailyQuestModalList'));
        }

        // 일간 퀘스트 모달 닫기
        async function closeDailyQuestModal(declined = false) {
            if (declined) {
            const todayStr = formatDate(new Date());
            await dbSet(`questDeclined_${todayStr}`, true);
        }
        document.getElementById('dailyQuestModal').style.display = 'none';
        }

        // 기존 미션 관련 함수들을 퀘스트로 대체
        async function triggerDailyQuests() {
            const todayStr = formatDate(new Date());
            const questDeclinedToday = await dbGet(`questDeclined_${todayStr}`);
            
            if (questDeclinedToday) return;

            // 30% 확률로 일간 퀘스트 모달 표시
            if (Math.random() < 0.3) {
                setTimeout(() => {
                    showDailyQuestModal();
                }, 2000); // 2초 후에 표시
            }
        }

        // 월말 보너스 예산 초기화
async function resetMonthlyBonusBudget() {
    const today = new Date();
    if (today.getDate() === 1) {
        await dbDelete('currentMonthBonusBudget');
    }
}

// 앱 초기화 시 특별한 날 체크
async function initEnhancedApp() { await loadUserSettings(); 
    await checkRoutineKingDay();
    await checkCompleteFreedomDay();
    await resetMonthlyBonusBudget();
    
    // 기존 initApp 로직 실행
    await initApp();
}

        // =======================================================================
        // 게임 시스템 로직
        // =======================================================================

        const ACHIEVEMENTS_LIST = {
            'ACH_FIRST_STEP': { name: "첫걸음", desc: "첫 루틴 데이터를 성공적으로 저장했습니다." },
            'ACH_CONSISTENCY_7': { name: "성실의 증표 (브론즈)", desc: "7일 연속으로 데이터를 기록했습니다." },
            'ACH_CONSISTENCY_30': { name: "성실의 증표 (실버)", desc: "30일 연속으로 데이터를 기록했습니다." },
            'ACH_CONSISTENCY_100': { name: "성실의 증표 (골드)", desc: "100일 연속으로 데이터를 기록했습니다." },
            'ACH_PERFECT_MONTH': { name: "월간 개근상", desc: "한 달의 모든 날에 데이터를 기록했습니다." },
            'ACH_100TH_RECORD': { name: "100번째 기록", desc: "통산 100번째 날의 데이터를 기록했습니다." },
            'ACH_FIRST_SEAT': { name: "첫 착석 기록", desc: "첫 착석 시간을 성공적으로 기록했습니다." },
            'ACH_PUNCTUAL_SEATER_5': { name: "아침 착석 습관 (브론즈)", desc: "5일 연속으로 오전 9시까지 착석 시간을 기록했습니다." },
            'ACH_PUNCTUAL_SEATER_30': { name: "아침 착석 습관 (실버)", desc: "30일 연속으로 오전 9시까지 착석 시간을 기록했습니다." },
            'ACH_TOTAL_PUNCTUAL_SEATER_100': { name: "착석 습관의 왕", desc: "누적 100일 동안 오전 9시까지 착석 시간을 기록했습니다." },
            'ACH_TOTAL_PUNCTUAL_SEATER_365': { name: "착석의 신", desc: "누적 365일 동안 오전 9시까지 착석 시간을 기록했습니다." },
            'ACH_POMO_10': { name: "뽀모도로 입문자", desc: "통산 뽀모도로 10개를 달성했습니다." },
            'ACH_POMO_50': { name: "뽀모도로 초급자", desc: "통산 뽀모도로 50개를 달성했습니다." },
            'ACH_POMO_120': { name: "뽀모도로 중급자", desc: "통산 뽀모도로 120개를 달성했습니다." },
            'ACH_POMO_200': { name: "뽀모도로 숙련자", desc: "통산 뽀모도로 200개를 달성했습니다." },
            'ACH_POMO_320': { name: "뽀모도로 상급자", desc: "통산 뽀모도로 320개를 달성했습니다." },
            'ACH_POMO_500': { name: "뽀모도로 전문가", desc: "통산 뽀모도로 500개를 달성했습니다." },
            'ACH_POMO_GOD': { name: "집중의 화신", desc: "하루에 뽀모도로 15개 이상을 기록했습니다." },
            'ACH_WRITER_1': { name: "신인 작가", desc: "글쓰기 누적 12만 자를 달성했습니다." },
            'ACH_WRITER_5': { name: "떠오르는 신인 작가", desc: "글쓰기 누적 60만 자를 달성했습니다." },
            'ACH_WRITER_10': { name: "위대한 작가", desc: "글쓰기 누적 120만 자를 달성했습니다." },
            'ACH_WRITER_20': { name: "유명 작가", desc: "글쓰기 누적 240만 자를 달성했습니다." },
            'ACH_WRITER_50': { name: "베스트셀러 작가", desc: "글쓰기 누적 600만 자를 달성했습니다." },
            'ACH_WRITING_GOD': { name: "일필휘지", desc: "하루에 글쓰기 10,000자 이상을 기록했습니다." },
            'ACH_DIGITAL_DETOX': { name: "디지털 디톡스", desc: "주말(토, 일) 이틀 동안 게임 시간 총 0분을 기록했습니다." },
            'ACH_SAGE_MODE': { name: "현자타임", desc: "7일 연속으로 게임 시간 총 0분을 기록했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_FIRST': { name: "첫 번째 완벽한 하루", desc: "하루 동안 모든 개인 목표를 100% 달성했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_5': { name: "목표 달성의 기쁨", desc: "개인 목표 100% 달성을 5일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_10': { name: "의지의 힘", desc: "개인 목표 100% 달성을 10일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_20': { name: "자기관리의 달인", desc: "개인 목표 100% 달성을 20일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_50': { name: "목표 지향적 인간", desc: "개인 목표 100% 달성을 50일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_100': { name: "백전백승", desc: "개인 목표 100% 달성을 100일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_150': { name: "목표 달성 마스터", desc: "개인 목표 100% 달성을 150일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_200': { name: "완벽주의자", desc: "개인 목표 100% 달성을 200일 성공했습니다." },
            'ACH_PERSONAL_GOAL_PERFECT_365': { name: "목표 달성의 신", desc: "개인 목표 100% 달성을 365일 성공했습니다." },
            'ACH_PERSONAL_GOAL_STREAK_3': { name: "작심삼일도 세 번이면 습관이다", desc: "3일 연속으로 모든 개인 목표를 100% 달성했습니다." },
            'ACH_PERSONAL_GOAL_STREAK_7': { name: "완벽한 일주일", desc: "7일 연속으로 모든 개인 목표를 100% 달성했습니다." },
            'ACH_PERSONAL_GOAL_STREAK_10': { name: "열정의 10일", desc: "10일 연속으로 모든 개인 목표를 100% 달성했습니다." },
            'ACH_GOAL_COMPLETER_5': { name: "목표 달성의 기쁨", desc: "개인 목표 5개 이상을 '완료'로 표시했습니다." },
            'ACH_BAD_HABIT_SLAYER_3': { name: "나쁜 습관 파괴자", desc: "부정적 습관 목표 3개 이상을 '완료'로 표시했습니다." },
            'ACH_PERFECT_CONTROL': { name: "완벽한 통제", desc: "'부정적 습관' 목표를 7일 연속으로 100% 달성했습니다." },
            'ACH_EARLY_BIRD': { name: "올빼미, 아니 독수리", desc: "새벽 5시 이전에 3일 연속 기상했습니다." },
            'ACH_PUNCTUAL_WAKER': { name: "칼 기상 마스터", desc: "7일 연속으로 목표 기상 시간 ±15분 내에 기상했습니다." },
            'ACH_REGULAR_SLEEP': { name: "규칙적인 취침", desc: "일주일 내내 목표 취침 시간(±15분) 내로 기록했습니다." },
            'ACH_EARLY_WAKER_COUNT_50': { name: "아침형 인간", desc: "목표 기상 시간 30분 이내 기상 누적 50회" },
            'ACH_EARLY_WAKER_COUNT_100': { name: "새벽 이슬의 친구", desc: "목표 기상 시간 30분 이내 기상 누적 100회" },
            'ACH_NIGHT_GUARDIAN_STREAK': { name: "밤의 수호자", desc: "7일 연속으로 밤 1시 이전에 취침했습니다." },
            'ACH_SAVING_KING': { name: "저축의 왕", desc: "한 달 동안 설정한 예산의 50% 미만으로 지출했습니다." },
            'ACH_ZERO_SPEND_MONTH': { name: "무지출의 달", desc: "한 달 동안 총 지출 0원을 기록했습니다." },
            'ACH_BUDGET_MASTER_3MONTH': { name: "예산 지배자", desc: "3개월 연속으로 월 예산의 80% 미만으로 지출했습니다." },
            'ACH_FINANCIAL_FREEDOM': { name: "재정적 자유", desc: "6개월 연속으로 월 예산의 80% 미만으로 지출했습니다." },
            'ACH_FIRST_WORKOUT': { name: "운동의 시작", desc: "첫 운동 기록을 달성했습니다." },
            'ACH_IRON_BODY': { name: "강철 체력", desc: "한 달 동안 운동 20회 이상을 달성했습니다." },
            'ACH_EXERCISE_JOURNEY_1': { name: "운동 여정의 시작", desc: "누적 운동 시간 500분을 달성했습니다." },
            'ACH_EXERCISE_JOURNEY_2': { name: "건강한 생활", desc: "누적 운동 시간 1,500분을 달성했습니다." },
            'ACH_EXERCISE_JOURNEY_3': { name: "철인 3종 준비", desc: "누적 운동 시간 5,000분을 달성했습니다." },
            'ACH_EXERCISE_JOURNEY_4': { name: "스포츠맨의 혼", desc: "누적 운동 시간 10,000분을 달성했습니다." },
            'ACH_DDAY_SETTER': { name: "미래 계획가", desc: "D-Day 목표를 처음으로 설정했습니다." },
            'ACH_NO_RAMEN': { name: "철의 위장", desc: "한 달 동안 식단에 '라면' 키워드가 기록되지 않았습니다." },
            'ACH_NO_LATTE': { name: "액상과당 안녕", desc: "한 달 동안 식단에 '라떼' 키워드가 기록되지 않았습니다." },
            'ACH_FOOD_DIARIST_7DAYS': { name: "꼼꼼한 식단 기록가", desc: "7일 연속으로 식단을 기록했습니다." },
            'ACH_HEALTHY_EATER_MONTH': { name: "건강 식단의 달인", desc: "한 달 동안 간식/외식 기록을 5회 미만으로 유지했습니다." },
            'ACH_DAILY_QUEST_ALL_CLEAR_FIRST': { name: "일일 퀘스트 완수", desc: "첫 일일 퀘스트를 모두 완료했습니다." },
            'ACH_DAILY_QUEST_ALL_CLEAR_10': { name: "일일 퀘스트 마스터", desc: "일일 퀘스트를 10회 모두 완료했습니다." },
            'ACH_DAILY_QUEST_ALL_CLEAR_50': { name: "일일 퀘스트 그랜드 마스터", desc: "일일 퀘스트를 50회 모두 완료했습니다." },
            'ACH_WEEKLY_QUEST_ALL_CLEAR_FIRST': { name: "주간 퀘스트 완수", desc: "첫 주간 퀘스트를 모두 완료했습니다." },
            'ACH_WEEKLY_QUEST_ALL_CLEAR_5': { name: "주간 퀘스트 마스터", desc: "주간 퀘스트를 5회 모두 완료했습니다." },
            'ACH_MONTHLY_QUEST_ALL_CLEAR_FIRST': { name: "월간 퀘스트 완수", desc: "첫 월간 퀘스트를 모두 완료했습니다." },
            'ACH_MONTHLY_QUEST_ALL_CLEAR_3': { name: "월간 퀘스트 마스터", desc: "월간 퀘스트를 3회 모두 완료했습니다." },
            'ACH_CLEAN_EATER': { name: "클린 이터", desc: "일주일 동안 간식/외식 기록이 3회 미만입니다." },
            'ACH_TOTAL_SCORE_1000': { name: "루틴 마니아", desc: "누적 루틴 점수 1,000점을 달성했습니다." },
            'ACH_TOTAL_SCORE_5000': { name: "루틴 전문가", desc: "누적 루틴 점수 5,000점을 달성했습니다." },
            'ACH_TOTAL_SCORE_10000': { name: "루틴의 달인", desc: "누적 루틴 점수 10,000점을 달성했습니다." },
            'ACH_TOTAL_SCORE_50000': { name: "루틴의 신", desc: "누적 루틴 점수 50,000점을 달성했습니다." },
            'ACH_TOTAL_SCORE_100000': { name: "루틴 세계관 창조자", desc: "누적 루틴 점수 100,000점을 달성했습니다." },
            'ACH_STREAK_3': { name: "불타는 3일", desc: "3일 연속으로 80점 이상을 달성했습니다! 이 기세 그대로!" },
            'ACH_STREAK_7': { name: "인간 승리의 7일", desc: "일주일 내내 80점 이상을 달성했습니다. 당신은 이미 승리자입니다." },
            'ACH_STREAK_14': { name: "습관 형성기", desc: "2주 연속 80점 이상 달성! 이제 완벽한 당신의 루틴입니다." },
            'ACH_TOTAL_RECORD_200': { name: "기록의 연대기", desc: "총 200일의 루틴 데이터를 기록했습니다." },
            'ACH_TOTAL_RECORD_365': { name: "1년의 루틴", desc: "총 365일의 루틴 데이터를 기록했습니다." },
            'ACH_TOTAL_RECORD_500': { name: "루틴 탐험가", desc: "총 500일의 루틴 데이터를 기록했습니다." },
            'ACH_CONSISTENCY_180': { name: "불타는 루틴", desc: "180일 연속으로 루틴 데이터를 기록했습니다." },
            'ACH_CONSISTENCY_365': { name: "루틴과 함께한 1년", desc: "365일 연속으로 루틴 데이터를 기록했습니다." },
            'ACH_NEW_YEAR': { name: "새해 다짐", desc: "1월 1일에 데이터를 기록했습니다." },
            'ACH_XMAS': { name: "나 홀로 성실하게", desc: "12월 25일에 데이터를 기록했습니다." },
            'ACH_MIDNIGHT_CODER': { name: "자정의 기록자", desc: "밤 12시 00분에 정확히 데이터를 저장했습니다." },
            'ACH_INDOMITABLE_WILL': { name: "불굴의 의지", desc: "마이너스였던 점수를 그날 다시 수정하여 플러스로 만들었습니다." },
            'ACH_META_AWARENESS': { name: "메타인지", desc: "'주간 성찰' 기능을 처음으로 사용했습니다." },
            'ACH_ACCOUNTABILITY': { name: "약속은 지킨다", desc: "'책임 공유' 기능을 처음으로 성공적으로 사용했습니다." },
            'ACH_EXCEL_GURU': { name: "엑셀 좀 만져본 놈", desc: "'엑셀 내보내기' 기능을 처음 사용했습니다." },
            //히든업적들
            'ACH_HIDDEN_LEGEND_GACHA': { name: "레전드 보물 사냥꾼", desc: "가챠에서 레전드 등급 보상을 처음으로 획득했습니다." },
            'ACH_HIDDEN_LUCKY_DRAW': { name: "행운의 숫자", desc: "하루 지출 내역 금액이 정확히 ₩777원인 경우 달성됩니다. (천 원, 만 원 단위는 무관)" },
            'ACH_HIDDEN_PERFECT_DAY': { name: "완전무결의 날", desc: "하루 루틴 점수 120점(최대 점수)을 달성했습니다." },
            'ACH_HIDDEN_SECRET_HOUR': { name: "비밀의 새벽", desc: "정확히 새벽 3시 33분(AM 03:33)에 취침 시간을 기록한 경우 달성됩니다." },
            'ACH_HIDDEN_EASTER_EGG': { name: "이스터 에그", desc: "하루 동안 총 뽀모도로 개수를 정확히 16개로 기록하면 달성됩니다." },
        };

        async function unlockAchievement(id) {
            const unlocked = await dbGet('unlockedAchievements') || [];
            if (unlocked.includes(id)) return;

            const achievement = ACHIEVEMENTS_LIST[id];
            if (!achievement) return;

            showFeedbackPopup(100, {
                class: 'feedback-celebration',
                emoji: '🏅',
                title: `업적 달성! [${achievement.name}]`,
                message: achievement.desc
            });

            unlocked.push(id);
            await dbSet('unlockedAchievements', unlocked);
        }

        async function checkAllAchievements(currentDate, todayData, previousData, allDbData) {
            const unlocked = await dbGet('unlockedAchievements') || [];
            
            const totalDayRecords = allDbData.filter(item => item.key.startsWith('day_')).length;
            if (!unlocked.includes('ACH_FIRST_STEP') && totalDayRecords === 1) await unlockAchievement('ACH_FIRST_STEP');
            if (!unlocked.includes('ACH_100TH_RECORD') && totalDayRecords >= 100) await unlockAchievement('ACH_100TH_RECORD');
            
            if (todayData.pomodoro.morning + todayData.pomodoro.afternoon + todayData.pomodoro.evening >= 15) await unlockAchievement('ACH_POMO_GOD');
            if (todayData.writing >= 10000) await unlockAchievement('ACH_WRITING_GOD');
            
            const today = new Date(currentDate);
            if (today.getMonth() === 0 && today.getDate() === 1) await unlockAchievement('ACH_NEW_YEAR');
            if (today.getMonth() === 11 && today.getDate() === 25) await unlockAchievement('ACH_XMAS');

            let consecutiveDays = 0;
            for (let i = 0; i < 101; i++) {
                const d = new Date(currentDate);
                d.setDate(d.getDate() - i);
                if (allDbData.some(item => item.key === `day_${formatDate(d)}`)) consecutiveDays++;
                else break;
            }
            if (consecutiveDays >= 100) await unlockAchievement('ACH_CONSISTENCY_100');
            else if (consecutiveDays >= 30) await unlockAchievement('ACH_CONSISTENCY_30');
            else if (consecutiveDays >= 7) await unlockAchievement('ACH_CONSISTENCY_7');

            const allDayData = allDbData.filter(i => i.key.startsWith('day_')).map(i=>i.value);
            const totalPomos = allDayData.reduce((sum, day) => sum + (day.pomodoro?.morning || 0) + (day.pomodoro?.afternoon || 0) + (day.pomodoro?.evening || 0), 0);
            if (totalPomos >= 500) await unlockAchievement('ACH_POMO_500');
            else if (totalPomos >= 320) await unlockAchievement('ACH_POMO_320');
            else if (totalPomos >= 200) await unlockAchievement('ACH_POMO_200');
            else if (totalPomos >= 120) await unlockAchievement('ACH_POMO_120');
            else if (totalPomos >= 50) await unlockAchievement('ACH_POMO_50');
            else if (totalPomos >= 10) await unlockAchievement('ACH_POMO_10');
            
            const totalWriting = allDayData.reduce((sum, day) => sum + (day.writing || 0), 0);
            if (totalWriting >= 6000000) await unlockAchievement('ACH_WRITER_50');
            else if (totalWriting >= 2400000) await unlockAchievement('ACH_WRITER_20');
            else if (totalWriting >= 1200000) await unlockAchievement('ACH_WRITER_10');
            else if (totalWriting >= 600000) await unlockAchievement('ACH_WRITER_5');
            else if (totalWriting >= 120000) await unlockAchievement('ACH_WRITER_1');

            if (previousData && previousData.score < 0 && todayData.score >= 0) await unlockAchievement('ACH_INDOMITABLE_WILL');
            if (todayData.exercise.done && !allDayData.some(d => d.date < todayData.date && d.exercise.done)) await unlockAchievement('ACH_FIRST_WORKOUT');

            // === 새로 추가되는 업적 체크 ===
    
    // 첫 착석 기록
    if (!unlocked.includes('ACH_FIRST_SEAT') && todayData.seatTime && !allDbData.some(item => 
        item.key.startsWith('day_') && item.value.date < todayData.date && item.value.seatTime
    )) {
        await unlockAchievement('ACH_FIRST_SEAT');
    }
    
    // 히든 업적: 행운의 숫자 (777원)
    if (!unlocked.includes('ACH_HIDDEN_LUCKY_DRAW')) {
        const todayExpenses = allDbData.filter(item => 
            item.key.startsWith('expense_') && item.value.date === formatDate(currentDate)
        );
        if (todayExpenses.some(item => String(item.value.amount).includes('777'))) {
            await unlockAchievement('ACH_HIDDEN_LUCKY_DRAW');
        }
    }
    
    // 히든 업적: 완전무결의 날 (120점)
    if (!unlocked.includes('ACH_HIDDEN_PERFECT_DAY') && todayData.score >= 120) {
        await unlockAchievement('ACH_HIDDEN_PERFECT_DAY');
    }
    
    // 히든 업적: 비밀의 새벽 (3:33)
    if (!unlocked.includes('ACH_HIDDEN_SECRET_HOUR') && todayData.sleepTime === '03:33') {
        await unlockAchievement('ACH_HIDDEN_SECRET_HOUR');
    }
    
    // 히든 업적: 이스터 에그 (뽀모도로 16개)
    if (!unlocked.includes('ACH_HIDDEN_EASTER_EGG')) {
    const todayTotalPomos = (todayData.pomodoro?.morning || 0) + (todayData.pomodoro?.afternoon || 0) + (todayData.pomodoro?.evening || 0);
    if (todayTotalPomos === 16) {
        await unlockAchievement('ACH_HIDDEN_EASTER_EGG');
    }

    await checkPersonalGoalAchievements(currentDate, todayData, allDbData);
}
    
    // 누적 루틴 점수 체크
    const totalScore = allDbData.filter(item => item.key.startsWith('day_')).reduce((sum, item) => sum + (item.value.score || 0), 0);
    if (!unlocked.includes('ACH_TOTAL_SCORE_100000') && totalScore >= 100000) await unlockAchievement('ACH_TOTAL_SCORE_100000');
    else if (!unlocked.includes('ACH_TOTAL_SCORE_50000') && totalScore >= 50000) await unlockAchievement('ACH_TOTAL_SCORE_50000');
    else if (!unlocked.includes('ACH_TOTAL_SCORE_10000') && totalScore >= 10000) await unlockAchievement('ACH_TOTAL_SCORE_10000');
    else if (!unlocked.includes('ACH_TOTAL_SCORE_5000') && totalScore >= 5000) await unlockAchievement('ACH_TOTAL_SCORE_5000');
    else if (!unlocked.includes('ACH_TOTAL_SCORE_1000') && totalScore >= 1000) await unlockAchievement('ACH_TOTAL_SCORE_1000');
    
    // 총 기록 일수 확장
    if (!unlocked.includes('ACH_TOTAL_RECORD_500') && totalDayRecords >= 500) await unlockAchievement('ACH_TOTAL_RECORD_500');
    else if (!unlocked.includes('ACH_TOTAL_RECORD_365') && totalDayRecords >= 365) await unlockAchievement('ACH_TOTAL_RECORD_365');
    else if (!unlocked.includes('ACH_TOTAL_RECORD_200') && totalDayRecords >= 200) await unlockAchievement('ACH_TOTAL_RECORD_200');
    
    // 연속 기록 일수 확장 (기존 consecutiveDays 사용)
    if (!unlocked.includes('ACH_CONSISTENCY_365') && consecutiveDays >= 365) await unlockAchievement('ACH_CONSISTENCY_365');
    else if (!unlocked.includes('ACH_CONSISTENCY_180') && consecutiveDays >= 180) await unlockAchievement('ACH_CONSISTENCY_180');

// 칼 기상 마스터 (7일 연속 ±15분)
if (!unlocked.includes('ACH_PUNCTUAL_WAKER')) {
    const targetWakeTime = await dbGet('targetWakeTime');
    if (targetWakeTime) {
        let consecutivePunctualDays = 0;
        const targetMinutes = timeToMinutes(targetWakeTime);
        
        for (let i = 0; i < 7; i++) {
            const checkDate = new Date(currentDate);
            checkDate.setDate(checkDate.getDate() - i);
            const dayData = await dbGet(`day_${formatDate(checkDate)}`);
            
            if (dayData?.wakeTime) {
                const actualMinutes = timeToMinutes(dayData.wakeTime);
                const diff = Math.abs(actualMinutes - targetMinutes);
                if (diff <= 15) {
                    consecutivePunctualDays++;
                } else {
                    break;
                }
            } else {
                break;
            }
        }
        
        if (consecutivePunctualDays >= 7) {
            await unlockAchievement('ACH_PUNCTUAL_WAKER');
        }
    }
}

// 밤의 수호자 (7일 연속 1시 이전 취침)
if (!unlocked.includes('ACH_NIGHT_GUARDIAN_STREAK')) {
    let consecutiveEarlySleep = 0;
    
    for (let i = 0; i < 7; i++) {
        const checkDate = new Date(currentDate);
        checkDate.setDate(checkDate.getDate() - i);
        const dayData = await dbGet(`day_${formatDate(checkDate)}`);
        
        if (dayData?.sleepTime) {
            const sleepMinutes = timeToMinutes(dayData.sleepTime);
            if (sleepMinutes <= 60 || sleepMinutes >= 1440) { // 1시 이전
                consecutiveEarlySleep++;
            } else {
                break;
            }
        } else {
            break;
        }
    }
    
    if (consecutiveEarlySleep >= 7) {
        await unlockAchievement('ACH_NIGHT_GUARDIAN_STREAK');
    }
}

// 목표 기상시간 누적 횟수 체크
const targetWakeTime = await dbGet('targetWakeTime');
if (targetWakeTime) {
    const targetMinutes = timeToMinutes(targetWakeTime);
    const punctualWakeCount = allDbData.filter(item => {
        if (!item.key.startsWith('day_') || !item.value.wakeTime) return false;
        const actualMinutes = timeToMinutes(item.value.wakeTime);
        const diff = Math.abs(actualMinutes - targetMinutes);
        return diff <= 30; // ±30분
    }).length;
    
    if (!unlocked.includes('ACH_EARLY_WAKER_COUNT_100') && punctualWakeCount >= 100) {
        await unlockAchievement('ACH_EARLY_WAKER_COUNT_100');
    } else if (!unlocked.includes('ACH_EARLY_WAKER_COUNT_50') && punctualWakeCount >= 50) {
        await unlockAchievement('ACH_EARLY_WAKER_COUNT_50');
    }
}

// 오전 9시 착석 습관 체크
const morningSeats = allDbData.filter(item => {
    if (!item.key.startsWith('day_') || !item.value.seatTime) return false;
    const seatMinutes = timeToMinutes(item.value.seatTime);
    return seatMinutes <= 540; // 9시 = 540분
});

if (!unlocked.includes('ACH_TOTAL_PUNCTUAL_SEATER_365') && morningSeats.length >= 365) {
    await unlockAchievement('ACH_TOTAL_PUNCTUAL_SEATER_365');
} else if (!unlocked.includes('ACH_TOTAL_PUNCTUAL_SEATER_100') && morningSeats.length >= 100) {
    await unlockAchievement('ACH_TOTAL_PUNCTUAL_SEATER_100');
}

// 연속 오전 9시 착석 체크
if (!unlocked.includes('ACH_PUNCTUAL_SEATER_30')) {
    let consecutiveMorningSeats = 0;
    
    for (let i = 0; i < 30; i++) {
        const checkDate = new Date(currentDate);
        checkDate.setDate(checkDate.getDate() - i);
        const dayData = await dbGet(`day_${formatDate(checkDate)}`);
        
        if (dayData?.seatTime) {
            const seatMinutes = timeToMinutes(dayData.seatTime);
            if (seatMinutes <= 540) { // 9시 이전
                consecutiveMorningSeats++;
            } else {
                break;
            }
        } else {
            break;
        }
    }
    
    if (consecutiveMorningSeats >= 30) {
        await unlockAchievement('ACH_PUNCTUAL_SEATER_30');
    } else if (!unlocked.includes('ACH_PUNCTUAL_SEATER_5') && consecutiveMorningSeats >= 5) {
        await unlockAchievement('ACH_PUNCTUAL_SEATER_5');
    }
}

// === 운동 관련 누적 업적 ===

// 누적 운동 시간 체크
const totalExerciseMinutes = allDbData.filter(item => item.key.startsWith('day_')).reduce((sum, item) => {
    return sum + (item.value.exercise?.minutes || 0);
}, 0);

if (!unlocked.includes('ACH_EXERCISE_JOURNEY_4') && totalExerciseMinutes >= 10000) {
    await unlockAchievement('ACH_EXERCISE_JOURNEY_4');
} else if (!unlocked.includes('ACH_EXERCISE_JOURNEY_3') && totalExerciseMinutes >= 5000) {
    await unlockAchievement('ACH_EXERCISE_JOURNEY_3');
} else if (!unlocked.includes('ACH_EXERCISE_JOURNEY_2') && totalExerciseMinutes >= 1500) {
    await unlockAchievement('ACH_EXERCISE_JOURNEY_2');
} else if (!unlocked.includes('ACH_EXERCISE_JOURNEY_1') && totalExerciseMinutes >= 500) {
    await unlockAchievement('ACH_EXERCISE_JOURNEY_1');
}

}
        
        async function checkStreaks(currentDate, todayData, allDbData) {
            const allDayData = allDbData.filter(i => i.key.startsWith('day_')).map(i => i.value).sort((a,b) => b.date.localeCompare(a.date));

            if (todayData.score >= 80) {
                let scoreStreakCount = 0;
                for (const day of allDayData) {
                    if (new Date(day.date) > new Date(currentDate)) continue;
                    if (day.score >= 80) scoreStreakCount++;
                    else break;
                }

                let bonusPoints = 0;
                let streakPopup = null;
                if (scoreStreakCount === 14) { bonusPoints = 15; await unlockAchievement('ACH_STREAK_14'); } 
                else if (scoreStreakCount === 7) { bonusPoints = 10; await unlockAchievement('ACH_STREAK_7'); } 
                else if (scoreStreakCount === 3) { bonusPoints = 5; await unlockAchievement('ACH_STREAK_3'); } 
                else if (scoreStreakCount > 1 && scoreStreakCount % 5 === 0) {
                     streakPopup = { class: 'feedback-celebration', emoji: '🔥', title: `${scoreStreakCount}일 연속 달성!`, message: '멈추지 마세요! 이 불꽃을 계속 이어나가세요!' };
                }

                if (bonusPoints > 0) {
                    todayData.bonusPoints = (todayData.bonusPoints || 0) + bonusPoints;
                    streakPopup = { class: 'feedback-celebration', emoji: '💰', title: '스트릭 보너스!', message: `${scoreStreakCount}일 연속 달성을 축하합니다! 보너스 ${bonusPoints}점을 획득했습니다!` };
                }
                
                if (streakPopup) setTimeout(() => showFeedbackPopup(100, streakPopup), 500);

            } else {
                let yesterdayStreakCount = 0;
                const yesterday = new Date(currentDate);
                yesterday.setDate(yesterday.getDate() - 1);

                for (const day of allDayData) {
                    if (new Date(day.date) > yesterday) continue;
                    if (day.score >= 80) yesterdayStreakCount++;
                    else break;
                }
                
                if (yesterdayStreakCount >= 3) {
                    setTimeout(() => {
                        showFeedbackPopup(0, { class: 'feedback-disaster', emoji: '💀', title: '연속 기록이 깨졌습니다', message: `${yesterdayStreakCount}일간의 노력이 물거품이 되었습니다. 100-1=0이라는 것을 기억하세요.` });
                    }, 1000);
                }
            }
        }

        async function checkMonthlyPerformanceAndNotify() {
            const today = new Date();
            const prevMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const prevMonthDates = getMonthDates(prevMonthDate);
            const dataPromises = prevMonthDates.map(dateStr => dbGet(`day_${dateStr}`));
            const monthlyData = (await Promise.all(dataPromises)).filter(d => d);

            let totalScore = 0, validDays = 0;
            for (const dayData of monthlyData) {
                if (dayData && !dayData.isOffDay && dayData.wakeTime) {
                    totalScore += dayData.score || 0;
                    validDays++;
                }
            }
            if (validDays === 0) return;
            const avgScore = Math.round(totalScore / validDays);

            if (avgScore < 0) {
                const monthString = `${prevMonthDate.getFullYear()}년 ${prevMonthDate.getMonth() + 1}월`;
                const messageText = `[루틴 트래커 보고] 안녕하세요. 제가 ${monthString} 동안 기록한 루틴 평균 점수가 ${avgScore}점(만점 120점 기준)으로, 목표에 미치지 못했습니다. 다음 달에는 더 노력할 수 있도록 옆에서 지켜봐 주세요!`;
                if (navigator.share) {
                    try {
                        await navigator.share({ title: '월간 루틴 보고', text: messageText });
                        showFeedbackPopup(0, { class: 'feedback-encouragement', emoji: '🤝', title: '공유 완료!', message: '책임감 있는 모습, 멋집니다! 다음 달은 분명 더 나을 거예요.' });
                        unlockAchievement('ACH_ACCOUNTABILITY');
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            showFeedbackPopup(0, { class: 'feedback-warning', emoji: '😠', title: '회피는 답이 아닙니다', message: '가장 어려운 것은 현실을 마주하는 용기입니다. 회피하지 마세요. 다시 시도해서 약속을 지키세요.' });
                        } else {
                            alert("메시지 공유 중 오류가 발생했습니다: " + err.message);
                        }
                    }
                } else {
                    alert("공유 기능을 사용할 수 없는 환경입니다.");
                    const fallbackMessage = "아래 메시지를 복사하여 책임 파트너에게 직접 전송해주세요.\n\n" + messageText;
                    prompt("메시지 복사하기 (Ctrl+C)", fallbackMessage);
                }
            }
        }

        async function checkExerciseAndDietBalance() {
            const today = new Date();
            const prevMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const { start, end } = getMonthDateRange(prevMonthDate);
            const allData = await dbGetAll();

            const exerciseCount = allData.filter(item => item.key.startsWith('day_') && item.value.date >= start && item.value.date <= end && item.value.exercise?.done).length;
            
            const foodRecords = allData.filter(item => item.key.startsWith('food_') && item.value.date >= start && item.value.date <= end);
            let keywordMatchCount = 0;
            foodRecords.forEach(record => {
                const hasKeyword = foodKeywords.some(keyword => record.value.foodName.toLowerCase().includes(keyword.toLowerCase()));
                if (hasKeyword) keywordMatchCount++;
            });

            if (exerciseCount <= 5 && keywordMatchCount >= 30) {
                const monthString = `${prevMonthDate.getFullYear()}년 ${prevMonthDate.getMonth() + 1}월`;
                const messageText = `[건강 적신호 보고] 안녕하세요. 제가 ${monthString} 동안 운동은 ${exerciseCount}일 했지만, 간식/외식은 ${keywordMatchCount}회 기록되었습니다. 건강한 습관을 만들 수 있도록 따끔한 조언 부탁드립니다!`;
                if (navigator.share) {
                    try {
                        await navigator.share({ title: '월간 건강 습관 보고', text: messageText });
                        showFeedbackPopup(0, { class: 'feedback-encouragement', emoji: '🤝', title: '공유 완료!', message: '자신의 상태를 직시하는 용기가 더 건강한 내일을 만듭니다.' });
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            showFeedbackPopup(0, { class: 'feedback-disaster', emoji: '☠️', title: '팩트폭행이 아픈가요?', message: '몸은 거짓말을 하지 않습니다. 외면하지 말고, 더 나은 선택을 하세요.' });
                        }
                    }
                } else {
                    alert("공유 기능을 사용할 수 없는 환경입니다.");
                    const fallbackMessage = "아래 메시지를 복사하여 책임 파트너에게 직접 전송해주세요.\n\n" + messageText;
                    prompt("메시지 복사하기 (Ctrl+C)", fallbackMessage);
                }
            }
        }

        // 개인 목표 100% 달성 여부를 체크하는 함수
async function checkPersonalGoalPerfectDay(dayData, date) {
    const allGoals = await getPersonalGoals();
    const checkDate = parseDate(date);
    checkDate.setHours(0, 0, 0, 0);
    
    // 해당 날짜에 적용되는 목표들 필터링
    const applicableGoals = allGoals.filter(goal => {
        if (goal.isCompleted) return false;
        const goalDate = new Date(goal.createdAt);
        goalDate.setHours(0, 0, 0, 0);
        return checkDate >= goalDate;
    });
    
    // 적용 가능한 목표가 없으면 false
    if (applicableGoals.length === 0) return false;
    
    const personalGoalsData = dayData.personalGoals || {};
    
    // 모든 목표가 100% 달성되었는지 체크
    for (const goal of applicableGoals) {
        const achieved = personalGoalsData[goal.id] || 0;
        let percentage = 0;
        
        if (goal.type === 'negative') {
            const usageRatio = achieved / goal.target;
            percentage = Math.max(0, (1 - usageRatio) * 100);
        } else {
            percentage = Math.min(100, (achieved / goal.target) * 100);
        }
        
        if (percentage < 100) {
            return false; // 하나라도 100% 미달성이면 false
        }
    }
    
    return true; // 모든 목표가 100% 달성
}

// 개인 목표 관련 업적들을 체크하는 함수
async function checkPersonalGoalAchievements(currentDate, todayData, allDbData) {
    const unlocked = await dbGet('unlockedAchievements') || [];
    
    // 오늘 개인 목표 100% 달성 여부 체크
    const todayIsPerfect = await checkPersonalGoalPerfectDay(todayData, formatDate(currentDate));
    
    if (todayIsPerfect) {
        // === 누적 업적 체크 ===
        
        // 모든 100% 달성 날짜 계산
        const perfectDays = [];
        for (const item of allDbData) {
            if (item.key.startsWith('day_')) {
                const isPerfect = await checkPersonalGoalPerfectDay(item.value, item.value.date);
                if (isPerfect) {
                    perfectDays.push(item.value.date);
                }
            }
        }
        
        const perfectDayCount = perfectDays.length;
        
        // 첫 번째 완벽한 하루
        if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_FIRST') && perfectDayCount === 1) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_FIRST');
        }
        
        // 누적 업적들 체크
        if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_365') && perfectDayCount >= 365) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_365');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_200') && perfectDayCount >= 200) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_200');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_150') && perfectDayCount >= 150) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_150');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_100') && perfectDayCount >= 100) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_100');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_50') && perfectDayCount >= 50) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_50');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_20') && perfectDayCount >= 20) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_20');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_10') && perfectDayCount >= 10) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_10');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_PERFECT_5') && perfectDayCount >= 5) {
            await unlockAchievement('ACH_PERSONAL_GOAL_PERFECT_5');
        }
        
        // === 연속 업적 체크 ===
        
        // 현재 날짜부터 거슬러 올라가며 연속 일수 계산
        let consecutivePerfectDays = 0;
        const today = new Date(currentDate);
        
        for (let i = 0; i < 20; i++) { // 최대 20일까지 체크 (10일 연속이 최대이므로)
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            const dateStr = formatDate(checkDate);
            
            const dayData = await dbGet(`day_${dateStr}`);
            if (dayData) {
                const isPerfect = await checkPersonalGoalPerfectDay(dayData, dateStr);
                if (isPerfect) {
                    consecutivePerfectDays++;
                } else {
                    break; // 연속이 끊어짐
                }
            } else {
                break; // 데이터가 없으면 연속 끊어짐
            }
        }
        
        // 연속 업적들 체크
        if (!unlocked.includes('ACH_PERSONAL_GOAL_STREAK_10') && consecutivePerfectDays >= 10) {
            await unlockAchievement('ACH_PERSONAL_GOAL_STREAK_10');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_STREAK_7') && consecutivePerfectDays >= 7) {
            await unlockAchievement('ACH_PERSONAL_GOAL_STREAK_7');
        } else if (!unlocked.includes('ACH_PERSONAL_GOAL_STREAK_3') && consecutivePerfectDays >= 3) {
            await unlockAchievement('ACH_PERSONAL_GOAL_STREAK_3');
        }
    }
}

// 비밀 개발자 도구 관련 변수
let titleClickCount = 0;
let titleClickTimer = null;
let devToolsVisible = false;

// 개발자 도구 토글 함수 (숨기기/보이기)
function toggleDevTools() {
    const devTools = document.getElementById('devTools');
    if (devTools) {
        devToolsVisible = !devToolsVisible;
        devTools.style.display = devToolsVisible ? 'block' : 'none';
        
        if (devToolsVisible) {
            devTools.style.animation = 'fadeIn 0.5s ease';
            console.log('🔧 시크릿 개발자 도구가 활성화되었습니다!');
        } else {
            console.log('👻 개발자 도구가 숨겨졌습니다.');
        }
    }
}

// 비밀 클릭 감지 설정
function setupSecretDevTools() {
    // 모든 페이지의 h1 제목에 이벤트 추가
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'H1' || e.target.closest('h1')) {
            titleClickCount++;
            
            // 기존 타이머 취소
            if (titleClickTimer) clearTimeout(titleClickTimer);
            
            // 2초 후 카운트 리셋
            titleClickTimer = setTimeout(() => {
                titleClickCount = 0;
            }, 2000);
            
            // 5번 클릭하면 개발자 도구 토글
            if (titleClickCount >= 5) {
                toggleDevTools();
                titleClickCount = 0;
                
                // 성공 사운드 효과 (콘솔)
                console.log('🎉 시크릿 코드 발동!');
            } else if (titleClickCount >= 3) {
                // 3번째부터 힌트
                console.log(`👀 ${titleClickCount}/5 - 계속 클릭해보세요...`);
            }
        }
    });
}

// 테마 CSS 데이터 (라이트 테마는 기본 HTML CSS 사용)
const THEME_STYLES = {
    dark: `
        @font-face {
        font-family: 'KBIZHanmaumMyungjo';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --bg-color: #1a1a1a;
        --primary-color: #5ba3f5;
        --primary-dark: #4a8cd9;
        --primary-light: #2a3441;
        --text-color: #e8e8e8;
        --text-color-light: #a0a0a0;
        --border-color: #333333;
        --container-bg: #2d2d2d;
        --danger-color: #ff6b6b;
        --warning-color: #ffa726;
        --success-color: #66bb6a;
        --neutral-color: #78909c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'KBIZHanmaumMyungjo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 20px; color: var(--text-color); }
    button, input, select, textarea { font-family: inherit; }
    .container { 
        background: var(--container-bg); 
        border-radius: 20px; 
        padding: 50px 30px 100px 30px; /* 첫 번째 값(50px)이 상단 패딩 */
        width: 100%; 
        max-width: 500px; 
        margin: 0 auto; 
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        border: 1px solid var(--border-color);
    }
    .header { text-align: center; margin-bottom: 25px; position: relative; }
    .header h1 { color: var(--text-color); font-size: 26px; font-weight: 700; margin-bottom: 8px; }
    .header p { color: var(--text-color-light); font-size: 14px; }
    #gameWarning { background: #3a3a1a; color: #e6d700; border: 1px solid #5c5c1a; border-radius: 8px; padding: 10px; font-size: 14px; font-weight: 500; margin-bottom: 20px; display: none; }
    .page { display: none; }
    .page.active { display: block; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-nav { background: none; border: none; font-size: 24px; color: var(--text-color-light); cursor: pointer; padding: 10px; border-radius: 50%; transition: background 0.3s ease; }
    .month-nav:hover { background: var(--bg-color); }
    .month-year { font-size: 20px; font-weight: 700; color: var(--text-color); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
    .calendar-header-cell { text-align: center; padding: 10px 5px; font-weight: 600; color: var(--text-color-light); font-size: 12px; }
    .calendar-cell { aspect-ratio: 1; display: grid; grid-template-rows: 1fr auto 1fr; padding: 2px; align-items: center; justify-items: center; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); transition: all 0.2s ease; position: relative }
    .cell-top-icons { grid-row: 1; display: flex; justify-content: center; gap: 2px; font-size: 9px; width: 100%; height: 100%; align-items: center; }
    .cell-day-number { grid-row: 2; font-weight: 500; }
    .calendar-cell.today .cell-day-number { font-weight: 700; }
    .cell-bottom-info { grid-row: 3; font-size: 8px; font-weight: 600; color: var(--text-color-light); width: 100%; text-align: left; padding-right: 4px; align-self: end; padding-bottom: 2px; }

    .calendar-cell.has-data .cell-bottom-info { color: rgba(255, 255, 255, 0.8); }
    .calendar-cell.off-day { background: #3a3a3a; color: var(--neutral-color); }
    .off-day-indicator { position: absolute; top: 4px; right: 4px; font-size: 10px; }
    .calendar-cell:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
    .calendar-cell.other-month { color: #555; background: var(--bg-color); border-color: var(--border-color); pointer-events: none; }
    .calendar-cell.today { border-color: var(--primary-color); font-weight: 700; color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
    .calendar-cell.has-data { color: white; border: none; font-weight: bold; }
    .calendar-cell.score-high { background: var(--success-color); }
    .calendar-cell.score-medium { background: var(--warning-color); }
    .calendar-cell.score-low { background: var(--danger-color); }
    .calendar-cell.score-negative { background: #455a64; }
    .score-indicator { position: absolute; bottom: 4px; right: 4px; font-size: 9px; background: rgba(0,0,0,0.5); color: white; padding: 1px 4px; border-radius: 4px; font-weight: 700; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'KBIZHanmaumMyungjo', sans-serif; background: var(--container-bg); color: var(--text-color); }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
    .main-actions { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); }
    .btn:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .main-actions .btn { flex: 1; }
    .btn.secondary { background: var(--neutral-color); }
    .btn.secondary:hover { background: #546e7a; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: var(--container-bg); padding: 0; border-radius: 16px; width: 90%; max-width: 800px; max-height: 95vh; overflow-y: auto; box-shadow: 0 16px 48px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
    #dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); background: var(--container-bg); border-top-left-radius: 16px; border-top-right-radius: 16px; }
    #dayModal .modal-body { padding: 25px; background: var(--container-bg); }
    .modal-layout { display: block; }
    @media (min-width: 768px) { .modal-layout { display: block; } }
    .modal-side-column { display: flex; flex-direction: column; }
    .modal-input-group { background: var(--bg-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
    .modal-input-group h4 { font-size: 16px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
    .modal-input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
    
    #commentDetails summary { font-weight: 600; color: var(--text-color); cursor: pointer; padding: 10px; border-radius: 8px; background-color: var(--bg-color); border: 1px solid var(--border-color); list-style: none; position: relative; padding-left: 30px; }
    #commentDetails summary::-webkit-details-marker { display: none; }
    #commentDetails summary::before { content: '▶'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 10px; transition: transform 0.2s; }
    #commentDetails[open] > summary::before { transform: translateY(-50%) rotate(90deg); }

    #dayModal .form-group { margin-bottom: 0; }
    #dayModal .form-group label { font-size: 13px; margin-bottom: 6px; }
    #dayModal .form-group input { padding: 10px; font-size: 16px; }
    #dayModal .modal-input-group,
    #dayModal .score-display-card { margin-bottom: 5px; }
    #dayModal .modal-layout > div:last-child { margin-bottom: 0; }
    .modal-header { display: flex; justify-content: center; align-items: center; position: relative; gap: 20px; }
    .modal-title { flex: none; text-align: center; margin: 0; color: var(--text-color); }
    .date-nav-btn { background: none; border: none; font-size: 24px; color: var(--text-color-light); cursor: pointer; padding: 10px; border-radius: 50%; transition: all 0.2s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .date-nav-btn:hover { background: var(--bg-color); color: var(--text-color); }
    .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-color-light); line-height: 1; position: absolute; right: 0; top: 50%; transform: translateY(-50%); }
    .score-display-card { background: var(--bg-color); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-color); }
    .score-display-card .score { font-size: 40px; font-weight: 700; color: var(--primary-color); line-height: 1; }
    .score-display-card .score.is-off { color: var(--neutral-color); }
    .score-display-card div:last-child { font-size: 14px; color: var(--text-color-light); margin-top: 5px; }
    .exercise-toggle-group { margin-bottom: 15px; }
    .exercise-toggle-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .exercise-toggle-btns { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .exercise-toggle-btn { flex: 1; padding: 10px; border: none; background: var(--container-bg); cursor: pointer; font-weight: 600; transition: all 0.2s ease; font-size: 14px; color: var(--text-color); }
    .exercise-toggle-btn.active { background: var(--success-color); color: #fff; }
    .legend { display: flex; justify-content: center; flex-wrap: wrap; margin: 20px 0 0; font-size: 12px; gap: 15px; }
    .legend-item { display: flex; align-items: center; gap: 5px; color: var(--text-color); }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    .goal-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .goal-tab { padding: 8px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; color: var(--text-color); }
    .goal-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .goal-type-toggle { display: flex; gap: 5px; margin-bottom: 15px; }
    .goal-type-toggle button { flex: 1; padding: 8px; font-size: 14px; border: 1px solid var(--border-color); background: var(--bg-color); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; color: var(--text-color); }
    .goal-type-toggle button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    #personalGoalsPage .header { text-align: left; }
    .dday-header-container { height: auto; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-start; position: absolute; top: 10px; left: 10px; right: 10px; z-index: 10; pointer-events: none; }
    .dday-chip { background: var(--primary-light); backdrop-filter: blur(5px); color: var(--primary-color); padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 11px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3); pointer-events: all; border: 1px solid var(--border-color); }
    .battery { display: none; width: 30px; height: 14px; border: 1.5px solid var(--text-color-light); border-radius: 4px; position: relative; padding: 1.5px; }
    .battery::after { content: ''; position: absolute; top: 50%; right: -4px; transform: translateY(-50%); width: 2px; height: 6px; background: var(--text-color-light); border-radius: 0 1px 1px 0; }
    .battery-level { height: 100%; border-radius: 2px; transition: width 0.3s ease; }
    .battery-level.green { background: var(--success-color); } .battery-level.yellow { background: var(--warning-color); } .battery-level.red { background: var(--danger-color); } .battery-level.black { background: var(--text-color); }
    .budget-summary { display: flex; gap: 10px; margin-bottom: 20px; }
    .budget-card { flex: 1; background: var(--primary-light); color: var(--primary-color); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
    .budget-card-title { font-size: 12px; opacity: 0.9; margin-bottom: 8px; font-weight: 600; }
    .budget-card-value { font-size: 22px; font-weight: 700; }
    #budgetPage .header p { font-size: 16px; font-weight: 600; color: var(--text-color); }
    .personal-goals-section { background: var(--bg-color); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
    #modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
    .personal-goal-checkbox { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--container-bg); border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); }
    .personal-goal-item { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
    .personal-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .personal-goal-name { font-weight: 600; color: var(--text-color); }
    .personal-goal-actions button { padding: 5px 10px; border-radius: 6px; font-size: 12px; border: none; cursor: pointer; color: white; }
    .edit-btn { background: var(--warning-color); }
    .delete-btn { background: var(--danger-color); }
    .complete-btn { background: var(--success-color); }
    .reopen-btn { background: var(--primary-color); }
    .empty-goals { text-align: center; color: var(--text-color-light); padding: 40px 20px; background: var(--bg-color); border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color); }
    .budget-settings, .dday-settings { margin-bottom: 30px; }
    .budget-input, .dday-actions { display: flex; gap: 10px; align-items: center; }
    .dday-item { background: var(--bg-color); border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); }
    .budget-input button { padding: 12px 20px; background: var(--success-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .wakeup-prompt { background: var(--primary-light); color: var(--primary-color); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .monthly-summary { display: flex; justify-content: space-around; gap: 15px; margin-bottom: 30px; }
    .summary-card { flex-basis: 30%; background: var(--primary-light); color: var(--primary-color); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--border-color); }
    .summary-title { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 600; }
    .summary-value { font-size: 24px; font-weight: 700; }
    .week-card { background: var(--bg-color); border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); }
    .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 600; color: var(--text-color); }
    .week-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; font-size: 22px; font-weight: 600; color: var(--text-color); }
    .empty-expenses { text-align: center; color: var(--text-color-light); padding: 40px 20px; }
    .feedback-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 2000; animation: fadeIn 0.3s ease; justify-content: center; align-items: center; }
    .feedback-content { position: relative; background: var(--container-bg); padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: popIn 0.5s ease; border: 1px solid var(--border-color); }
    .feedback-emoji { font-size: 60px; margin-bottom: 20px; display: block; }
    .feedback-title { font-size: 24px; font-weight: 700; margin-bottom: 15px; color: var(--text-color); }
    .feedback-message { font-size: 16px; color: var(--text-color-light); line-height: 1.5; margin-bottom: 25px; }
    .feedback-celebration .feedback-title, .feedback-celebration .feedback-message, .feedback-reflection .feedback-title, .feedback-reflection .feedback-message, .feedback-disaster .feedback-title, .feedback-disaster .feedback-message, .feedback-encouragement .feedback-title, .feedback-encouragement .feedback-message, .feedback-warning .feedback-title, .feedback-warning .feedback-message { color: rgba(255,255,255,0.95); }
    .feedback-celebration { background: linear-gradient(135deg, #2ecc71, #28b463); } .feedback-reflection { background: linear-gradient(135deg, #f39c12, #e67e22); } .feedback-disaster { background: linear-gradient(135deg, #455a64, #37474f); } .feedback-encouragement { background: linear-gradient(135deg, #3498db, #2980b9); } .feedback-warning { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    .feedback-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 0 10px; }
    .feedback-btn:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }
    .feedback-budget-red { background: linear-gradient(135deg, #e74c3c, #c0392b) !important; }
    .feedback-budget-black { background: linear-gradient(135deg, #455a64, #37474f) !important; }
    .expense-input-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    .expense-input-row input { flex: 1; padding: 12px; font-size: 14px; border-radius: 8px; background: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); }
    .expense-input-row button { flex-shrink: 0; width: 44px; height: 44px; border-radius: 12px; background: var(--primary-color); border: none; color: white; font-weight: bold; cursor: pointer; font-size: 24px; line-height: 44px; transition: background 0.2s ease; }
    .expense-input-row button:hover { background: var(--primary-dark); }
    .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 14px; color: var(--text-color); }
    .dday-settings h4 { margin-bottom: 15px; color: var(--text-color); }
    .dday-item .dday-actions { display: flex; gap: 5px; }
    .dday-item .dday-actions button { background: none; border: 1px solid var(--border-color); width: 30px; height: 30px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.2s ease; color: var(--text-color-light); }
    .dday-item .dday-actions button:hover { background: var(--bg-color); color: var(--text-color); transform: scale(1.1); }
    .excel-option-item { display: flex; align-items: center; padding: 8px 0; cursor: pointer; color: var(--text-color); }
    .excel-option-item input[type="radio"] { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--primary-color); }
    .excel-option-item label { font-size: 16px; }
    #customDateRange { display: flex; gap: 10px; align-items: center; margin-top: 10px; margin-bottom: 20px; }
    #customDateRange input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); flex: 1; font-family: inherit; background: var(--container-bg); color: var(--text-color); }

    .number-input-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.number-input-group input {
    border: none;
    text-align: center;
    flex: 1;
    padding: 10px 5px;
    background: var(--container-bg);
    color: var(--text-color);
}

.number-input-group input:focus { box-shadow: none; border: none; }

.number-btn {
    width: 32px;
    height: 42px;
    border: none;
    background: var(--bg-color);
    color: var(--text-color);
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.number-btn:hover { background: var(--primary-light); }
.number-btn:active { background: var(--primary-color); color: white; }

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* --- 식단 관련 스타일 (기능+디자인) --- */
    .food-page-actions { display: flex; gap: 10px; margin-bottom: 10px; }
    .food-page-actions .btn.secondary.danger { background-color: var(--danger-color); color: white; }
    .food-date-header { display: flex; align-items: center; text-align: center; margin: 30px 0 10px; color: var(--text-color-light); }
    .food-date-header::before, .food-date-header::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
    .food-date-header span { padding: 0 15px; font-size: 13px; font-weight: 600; }
    .food-record-item { display: grid; grid-template-columns: 50px 30px 1fr auto; gap: 15px; align-items: center; padding: 14px 5px; border-bottom: 1px solid var(--border-color); position: relative; }
    .food-record-item .food-admin-actions { position: absolute; right: 0px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .food-records.admin-mode .food-record-item .food-admin-actions { opacity: 1; pointer-events: auto; }
    .food-admin-actions button { background: none; border: 1px solid var(--border-color); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 13px; transition: background-color 0.2s; }
    .food-admin-actions button.edit { color: var(--warning-color); }
    .food-admin-actions button.delete { color: var(--danger-color); }
    .food-admin-actions button:hover { background-color: var(--bg-color); }
    
#foodExportModal .modal-content {
    max-width: 90vw;
    background: var(--container-bg);
    padding: 0;
}
#foodExportPreview {
    background: var(--container-bg);
    border-radius: 8px;
    padding: 0;
    margin: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    font-family: 'Courier New', monospace;
    border: 1px solid var(--border-color);
}
.food-receipt-header {
    padding: 15px 20px 10px;
    background: var(--primary-light);
}
.food-receipt-title {
    display: block;
    text-align: center;
    margin-bottom: 5px;
}
.food-receipt-title h3 {
    margin: 0;
    font-size: 16px;
    color: var(--primary-color);
    font-weight: 700;
}
.food-receipt-header p {
    margin: 0;
    font-size: 12px;
    color: var(--text-color-light);
    text-align: center;
}
.food-receipt-divider {
    height: 1px;
    background: repeating-linear-gradient(
        to right,
        var(--border-color) 0px,
        var(--border-color) 3px,
        transparent 3px,
        transparent 6px
    );
    margin: 0 15px;
}
.food-receipt-items {
    padding: 15px 20px 10px;
}
.food-receipt-date-header {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 13px;
    margin: 15px 0 8px 0;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--border-color);
}
.food-receipt-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 13px;
    line-height: 1.3;
}
.food-receipt-time {
    color: var(--text-color-light);
    font-size: 11px;
    min-width: 45px;
    margin-right: 10px;
}
.food-receipt-desc {
    flex: 1;
    font-weight: 600;
    color: var(--text-color);
    margin-right: 10px;
}
.food-receipt-quantity {
    font-weight: 700;
    color: var(--text-color);
    font-size: 13px;
    text-align: right;
    min-width: 60px;
}
#foodExportModal .close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.3);
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-size: 20px;
    color: var(--text-color);
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}

#foodExportModal .close-btn:hover {
    background: rgba(0, 0, 0, 0.5);
}

@media (max-width: 767px) {
    #foodExportModal.modal-overlay {
        background: var(--bg-color);    
        backdrop-filter: none; 
    }
    
    #foodExportModal .modal-content {
        max-width: 100vw;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        border-radius: 0;
        box-shadow: none; 
        background: var(--bg-color);
    }
    
    #foodExportPreview {
        margin: 0; 
        border-radius: 0; 
        box-shadow: none;  
        height: calc(100vh - 50px); 
        overflow-y: auto;
        background: var(--container-bg);
        border: none;
    }
    
    #foodExportModal .close-btn {
        position: fixed;   
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 22px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 1000;
    }
    
    #foodExportModal .modal-content > div:last-child {
        position: fixed;        
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--container-bg);
        padding: 15px;
        border-top: 1px solid var(--border-color);
    }
}

    .food-modal { max-width: 420px; background-color: var(--container-bg); overflow: hidden; }
    .food-modal .modal-header { padding: 15px 20px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
    .food-modal .modal-header h2 { font-size: 18px; color: var(--text-color); }
    .food-modal .modal-body { padding: 20px; background: var(--container-bg); }
    .food-modal .form-group { margin-bottom: 15px; }
    .food-modal .form-group label { font-size: 13px; margin-bottom: 6px; }
    .food-modal .form-group input, .food-modal .form-group select { padding: 10px; font-size: 15px; }
    .food-modal .quantity-input { display: flex; gap: 8px; }
    .food-modal .quantity-input select { width: 90px; }
    .food-modal .food-modal-actions { margin-top: 20px; display: flex; gap: 10px; }
    .food-modal .food-modal-actions .btn { flex: 1; padding: 12px; }

    .fame-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
    .fame-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; }
    .fame-card-title { font-size: 18px; margin-bottom: 8px; color: var(--text-color); }
    .fame-card-value { font-size: 20px; font-weight: 700; color: var(--primary-color); }
    .fame-card-date { font-size: 12px; color: var(--text-color-light); margin-top: 4px; }
    #wallOfShame .fame-card-value { color: var(--danger-color); }

    #modalCommentSection { margin-top: 20px; }
    #modalComment { width: 100%; margin-top: 15px; height: 80px; resize: vertical; font-size: 16px; }
    #modalPersonalGoalsList input[type="number"] { font-size: 16px; }
    .comment-history-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
    .comment-item { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px 20px; margin-bottom: 12px; }
    .comment-item-header { font-size: 13px; color: var(--text-color-light); font-weight: 600; margin-bottom: 10px; }
    .comment-item-body { font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; color: var(--text-color); }
    .empty-comments { text-align: center; color: var(--text-color-light); padding: 50px 20px; background: var(--bg-color); border-radius: 12px; border: 1px solid var(--border-color); }
    
.receipt-container {
    background: var(--container-bg);
    border-radius: 8px;
    padding: 0;
    margin-top: 0; /* 위쪽 바깥 여백을 0으로 만듭니다. */
    margin-bottom: 20px; /* 아래쪽 여백은 유지합니다. */
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    font-family: 'Courier New', monospace;
    max-width: 100%;
    overflow: hidden;
    border: 1px solid var(--border-color);
}
.receipt-header { padding: 15px 20px 10px; background: var(--primary-light); }
.receipt-title { display: block; text-align: center; margin-bottom: 5px; position: relative; }
.receipt-title h3 { margin: 0; font-size: 16px; color: var(--primary-color); font-weight: 700; }
.budget-info { display: flex; flex-direction: column; gap: 3px; font-size: 11px; color: var(--text-color); font-weight: 600; text-align: right; position: absolute;
    top: -5px;
    right: -8px;
}
.receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
.receipt-divider { height: 1px; background: repeating-linear-gradient(to right, var(--border-color) 0px, var(--border-color) 3px, transparent 3px, transparent 6px); margin: 0 15px; }
.receipt-items { padding: 15px 20px 10px; }
.receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; font-size: 13px; line-height: 1.3; }
.receipt-date { color: var(--text-color-light); font-size: 11px; min-width: 60px; margin-right: 15px; }
.receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 15px; }
.receipt-amount { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 70px; }
.receipt-total { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg-color); font-weight: 700; font-size: 16px; font-family: 'Courier New', monospace; color: var(--primary-color); }

.calendar-cell.skeleton {
    background: #2a2a2a;
    border: 1px solid #404040;
    position: relative;
    overflow: hidden;
}

.calendar-cell.skeleton::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 2s infinite;
}

.calendar-cell.skeleton .cell-day-number {
    color: #505050;
    background: transparent;
}

.calendar-cell.skeleton .cell-top-icons,
.calendar-cell.skeleton .cell-bottom-info {
    background: transparent;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.loading-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-color-light);
    font-size: 12px;
    z-index: 10;
    background: rgba(45, 45, 45, 0.9);
    padding: 5px 10px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    border: 1px solid var(--border-color);
}

#dailyQuestModal .modal-header {
    padding-top: 25px;
    padding-bottom: 15px;
}

    .quest-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .quest-tab { padding: 8px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; color: var(--text-color); }
    .quest-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .quest-list { display: flex; flex-direction: column; gap: 10px; }
    .quest-item { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; transition: all 0.2s ease; }
    .quest-item:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .quest-item.completed { background: var(--success-color); color: white; border-color: var(--success-color); }
    .quest-item.completed .quest-reward { color: rgba(255,255,255,0.9); }
    .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quest-title { font-weight: 600; font-size: 14px; color: var(--text-color); }
    .quest-item.completed .quest-title { color: white; }
    .quest-reward { font-size: 12px; color: var(--primary-color); font-weight: 600; }
    .quest-desc { font-size: 13px; color: var(--text-color-light); margin-bottom: 10px; }
    .quest-item.completed .quest-desc { color: rgba(255,255,255,0.8); }
    .quest-progress { display: flex; justify-content: space-between; align-items: center; }
    .quest-progress-bar { flex: 1; height: 6px; background: var(--bg-color); border-radius: 3px; margin-right: 10px; overflow: hidden; }
    .quest-progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s ease; }
    .quest-progress-text { font-size: 11px; color: var(--text-color-light); min-width: 40px; text-align: right; }
    .quest-item.completed .quest-progress-bar { background: rgba(255,255,255,0.3); }
    .quest-item.completed .quest-progress-fill { background: rgba(255,255,255,0.8); }
    .quest-item.completed .quest-progress-text { color: rgba(255,255,255,0.9); }

    #rewardsModal .modal-header { padding: 30px 25px 20px 25px; border-bottom: 1px solid var(--border-color); background: var(--container-bg); border-top-left-radius: 16px; border-top-right-radius: 16px; }
    .rewards-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
    .reward-item { background: var(--bg-color); border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
    .reward-item:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .reward-item.bronze { border-color: #CD7F32; background: linear-gradient(135deg, #3a2f1a, #2d251a); }
    .reward-item.silver { border-color: #C0C0C0; background: linear-gradient(135deg, #3a3a3f, #2e2e33); }
    .reward-item.gold { border-color: #FFD700; background: linear-gradient(135deg, #4a3d1a, #3d321a); }
    .reward-item.legend { border-color: #9400D3; background: linear-gradient(135deg, #3a1a4a, #2d1a3d); }
    .reward-item.used { opacity: 0.5; filter: grayscale(50%); }
    .reward-info { flex: 1; }
    .reward-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; color: var(--text-color); }
    .reward-desc { font-size: 13px; color: var(--text-color-light); }
    .reward-tier { font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; display: inline-block; }
    .reward-tier.bronze { background: #CD7F32; color: white; }
    .reward-tier.silver { background: #C0C0C0; color: white; }
    .reward-tier.gold { background: #FFD700; color: #333; }
    .reward-tier.legend { background: #9400D3; color: white; }
    .reward-actions { display: flex; gap: 8px; }
    .reward-btn { padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .reward-btn.use { background: var(--success-color); color: white; }
    .reward-btn.use:hover { background: #27ae60; }
    .reward-btn.delete { background: var(--danger-color); color: white; }
    .reward-btn.delete:hover { background: #c0392b; }
    .reward-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .empty-rewards { text-align: center; padding: 40px 20px; color: var(--text-color-light); }

    .profile-menu-item:hover { background: var(--primary-light); color: var(--primary-color); }
    
    #profileWidget:hover { transform: translateY(-2px); }
    #profileWidget { transition: transform 0.2s ease; }

    .achievements-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
    .achievement-item { background: var(--bg-color); border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; transition: all 0.2s ease; }
    .achievement-item.unlocked { border-color: var(--success-color); background: linear-gradient(135deg, #1a3d1a, #1a2f1a); }
    .achievement-item.locked { opacity: 0.6; }
    .achievement-emoji { font-size: 24px; min-width: 40px; text-align: center; }
    .achievement-info { flex: 1; }
    .achievement-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; color: var(--text-color); }
    .achievement-desc { font-size: 13px; color: var(--text-color-light); }
    .achievement-status { font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
    .achievement-status.unlocked { background: var(--success-color); color: white; }
    .achievement-status.locked { background: var(--border-color); color: var(--text-color-light); }
    .achievement-item.hidden { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); color: #a0a0a0; border-color: #404040; }
    .achievement-item.hidden .achievement-desc { color: #707070; font-style: italic; }

    @media (max-width: 767px) {
        .modal-content {
            padding: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            max-height: 100vh;
            background: var(--container-bg);
        }
        .food-modal {
            width: 90%;
            height: auto;
            border-radius: 16px;
            max-height: 90vh;
        }
        .food-modal .modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }
        #dayModal .modal-body {
            padding: 20px 15px;
        }
        .modal-input-group {
            padding: 15px;
        }
        .modal-input-group h4 {
            font-size: 15px;
        }
        #dayModal .form-group label {
            font-size: 13px;
        }

        #dayModal .modal-input-row {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .exercise-toggle-btns {
            max-width: 180px;
        }
        .score-display-card, .personal-goals-section {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 15px;
        }
        .score-display-card .score {
            font-size: 36px;
        }

        #modalTotalExpense {
            text-align: left !important;
        }
        .expense-item {
            font-size: 13px;
            word-break: break-all;
        }
        .expense-item span:first-child {
            flex-grow: 1;
            margin-right: 10px;
        }
        .expense-item > div {
            flex-shrink: 0;
        }
        
        .modal-actions-container {
            padding: 0 15px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modal-actions-container .btn.delete {
            order: 2;
            background-color: transparent;
            color: var(--text-color-light);
            font-size: 14px;
            font-weight: normal;
            padding: 8px;
            box-shadow: none;
            margin-top: 10px;
            max-width: 150px;
        }
        .modal-actions-container .btn.delete:hover {
            background-color: transparent;
            color: var(--danger-color);
        }
        .modal-actions-container .btn.save {
            order: 1;
        }

        #budgetPage .budget-summary {
            flex-wrap: wrap;
        }
        #budgetPage .budget-summary .budget-card:first-child {
            flex-basis: 100%;
        }
        #budgetPage .budget-card-value {
            font-size: 20px;
        }
        #dayModal .expense-input-row {
            flex-direction: column;
            gap: 10px;
        }
        #dayModal .expense-input-row input,
        #dayModal .expense-input-row button {
            width: 100%;
        }
        .dday-header-container {
            top: 8px;
            left: 3px;
            right: 3px;
        }
        .container {
            padding: 40px 20px 95px 20px;
        }
        .dday-chip {
            font-size: 10px;
            padding: 3px 8px;
        }
        .battery {
            width: 25px;
            height: 12px;
        }
        
        .receipt-item {
            font-size: 12px;
        }
    
        .receipt-date {
            min-width: 50px;
            margin-right: 10px;
            font-size: 10px;
        }
    
        .receipt-desc {
            margin-right: 10px;
        }
    
        .receipt-amount {
            min-width: 60px;
            font-size: 12px;
        }
    
        .budget-info {
            flex-direction: column;
            gap: 2px;
            font-size: 10px;
            text-align: right;
        }
    }
    `,
    
    excel: `
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap');
        @font-face { font-family: 'KBIZHanmaumMyungjo'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff'); font-weight: normal; font-style: normal; }
:root {
    --bg-color: #f8f9fa;
    --primary-color: #217346;
    --primary-dark: #0f5132;
    --primary-light: #e0f5e9;
    --text-color: #323130;
    --text-color-light: #605e5c;
    --border-color: #d1d1d1;
    --container-bg: #ffffff;
    --danger-color: #d13438;
    --warning-color: #ff8c00;
    --success-color: #107c10;
    --neutral-color: #8a8886;
}
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif; background: var(--bg-color); min-height: 100vh; padding: 20px; color: var(--text-color); line-height: 1.4; }
        button, input, select, textarea { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif; }
        .container { 
    background: var(--container-bg);
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 8px에서 0으로 변경 */
    padding: 32px 24px 100px 24px; 
    width: 100%; 
    max-width: 500px; 
    margin: 0 auto; 
    box-shadow: 
        0 1.6px 3.6px 0 rgba(0, 0, 0, 0.132), 
        0 0.3px 0.9px 0 rgba(0, 0, 0, 0.108);
    position: relative;
}
        .header { text-align: center; margin-bottom: 24px; position: relative; padding: 16px; border-bottom: 1px solid var(--border-color); background: linear-gradient(180deg, var(--container-bg) 0%, #fafbfc 100%); }
        .header h1 { color: var(--text-color); font-size: 20px; font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; }
        .header p { color: var(--text-color-light); font-size: 13px; font-weight: 400; }
        #gameWarning { background: #fff4e5; color: #8a5a08; border: 1px solid #ffb900; border-radius: 4px; padding: 8px 12px; font-size: 12px; font-weight: 400; margin-bottom: 16px; display: none; border-left: 4px solid var(--warning-color); }
        .page { display: none; }
        .page.active { display: block; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 8px 0; }
        .month-nav { 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    font-size: 14px; 
    color: var(--text-color); 
    cursor: pointer; 
    padding: 8px 12px; 
    border-radius: 0; /* 4px에서 0으로 변경 */
    transition: all 0.15s ease;
    font-family: 'Segoe UI', sans-serif;
    font-weight: 400;
}
        .month-nav:hover { background: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); }
.month-year { font-size: 16px; font-weight: 600; color: var(--text-color); }
.calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 1px; 
    margin-bottom: 16px; 
    border: 1px solid var(--border-color);
    background: var(--border-color);
    border-radius: 0; /* 4px에서 0으로 변경 */
    overflow: hidden;
}
.calendar-header-cell { 
    text-align: center; 
    padding: 12px 4px; 
    font-weight: 600; 
    color: var(--text-color); 
    font-size: 11px; 
    background: #f3f2f1;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 0; /* 모든 라운딩 제거 */
}
.calendar-cell { 
    aspect-ratio: 1; 
    display: grid; 
    grid-template-rows: 1fr auto 1fr; 
    padding: 4px; 
    align-items: center; 
    justify-items: center;
    background: var(--container-bg);
    transition: all 0.15s ease;
    cursor: pointer;
    position: relative;
    border-radius: 0; /* 모든 라운딩 제거 */
}
.cell-top-icons { grid-row: 1; display: flex; justify-content: center; gap: 2px; font-size: 8px; width: 100%; height: 100%; align-items: center; }
.cell-day-number { grid-row: 2; font-weight: 400; font-size: 12px; color: var(--text-color); }
.calendar-cell.today .cell-day-number { font-weight: 600; color: var(--primary-color); }
.cell-bottom-info { grid-row: 3; font-size: 7px; font-weight: 400; color: var(--text-color-light); width: 100%; text-align: left; padding-right: 2px; align-self: end; padding-bottom: 2px; }
.calendar-cell.has-data .cell-bottom-info { color: rgba(255, 255, 255, 0.9); }
.calendar-cell.off-day { background: #f3f2f1; color: var(--neutral-color); }
.off-day-indicator { position: absolute; top: 2px; right: 2px; font-size: 8px; }
.calendar-cell:hover { background: var(--primary-light); transform: none; }
.calendar-cell.other-month { color: #c8c6c4; background: #faf9f8; pointer-events: none; }
.calendar-cell.today { background: var(--primary-light); border: 2px solid var(--primary-color); }
.calendar-cell.has-data { color: white; font-weight: 500; }
.calendar-cell.score-high { background: var(--success-color); }
.calendar-cell.score-medium { background: var(--warning-color); }
.calendar-cell.score-low { background: var(--danger-color); }
.calendar-cell.score-negative { background: #605e5c; }
.score-indicator { position: absolute; bottom: 2px; right: 2px; font-size: 7px; background: rgba(0,0,0,0.6); color: white; padding: 1px 3px; border-radius: 2px; font-weight: 500; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 4px; font-size: 13px; }
.form-group input, .form-group textarea, .form-group select { 
    width: 100%; 
    padding: 8px 12px; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    font-size: 14px; 
    transition: all 0.15s ease; 
    font-family: 'Segoe UI', sans-serif;
    background: var(--container-bg);
    color: var(--text-color);
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 1px var(--primary-color); }
.main-actions { display: flex; gap: 8px; margin-bottom: 8px; }
.btn { 
    width: 100%; 
    padding: 10px 16px; 
    background: var(--primary-color);
    color: white; 
    border: 1px solid var(--primary-color);
    border-radius: 0; /* 4px에서 0으로 변경 */
    font-size: 14px; 
    font-weight: 500; 
    cursor: pointer; 
    transition: all 0.15s ease; 
    font-family: 'Segoe UI', sans-serif;
}
.btn:hover { background: var(--primary-dark); border-color: var(--primary-dark); transform: none; }
.btn:active { transform: scale(0.98); }
.main-actions .btn { flex: 1; }
.btn.secondary { background: var(--container-bg); color: var(--text-color); border-color: var(--border-color); }
.btn.secondary:hover { background: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 1000; align-items: center; justify-content: center; }
.modal-content { 
    background: var(--container-bg); 
    padding: 0; 
    border-radius: 0; /* 8px에서 0으로 변경 */
    width: 90%; 
    max-width: 800px; 
    max-height: 95vh; 
    overflow-y: auto; 
    box-shadow: 
        0 25.6px 57.6px 0 rgba(0, 0, 0, 0.22), 
        0 4.8px 14.4px 0 rgba(0, 0, 0, 0.18);
}
#dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); background: #fafbfc; }
#dayModal .modal-body { padding: 20px; }
.modal-layout { display: block; }
@media (min-width: 768px) { .modal-layout { display: block; } }
.modal-side-column { display: flex; flex-direction: column; }
.modal-input-group { 
    background: var(--container-bg); 
    padding: 16px; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    margin-bottom: 12px;
}
.modal-input-group h4 { font-size: 14px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); color: var(--text-color); font-weight: 600; }
.modal-input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
#commentDetails summary { 
    font-weight: 500; 
    color: var(--text-color); 
    cursor: pointer; 
    padding: 8px 12px; 
    border-radius: 0; /* 4px에서 0으로 변경 */
    background-color: var(--primary-light); 
    border: 1px solid var(--primary-color); 
    list-style: none; 
    position: relative; 
    font-size: 13px;
}
#commentDetails summary::-webkit-details-marker { display: none; }
#commentDetails summary::before { content: '▶'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 10px; transition: transform 0.2s; }
#commentDetails[open] > summary::before { transform: translateY(-50%) rotate(90deg); }
#dayModal .form-group { margin-bottom: 12px; }
#dayModal .form-group label { font-size: 12px; margin-bottom: 4px; }
#dayModal .form-group input { padding: 6px 8px; font-size: 13px; }
#dayModal .modal-input-group,
#dayModal .score-display-card { margin-bottom: 12px; }
#dayModal .modal-layout > div:last-child { margin-bottom: 0; }
.modal-header { display: flex; justify-content: center; align-items: center; position: relative; gap: 16px; }
.modal-title { flex: none; text-align: center; margin: 0; font-size: 16px; color: var(--text-color); font-weight: 600; }
.date-nav-btn { background: var(--container-bg); border: 1px solid var(--border-color); font-size: 14px; color: var(--text-color); cursor: pointer; padding: 6px 10px; border-radius: 4px; transition: all 0.15s ease; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; }
.date-nav-btn:hover { background: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); }
.close-btn { background: var(--container-bg); border: 1px solid var(--border-color); font-size: 16px; cursor: pointer; color: var(--text-color); line-height: 1; position: absolute; right: 0; top: 50%;  transform: translateY(-50%); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-family: 'Segoe UI', sans-serif; transition: all 0.15s ease; }
.close-btn:hover { background: #fdebee; border-color: var(--danger-color); color: var(--danger-color); }
.score-display-card { 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 12px에서 0으로 변경 */
    padding: 20px; 
    text-align: center; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.score-display-card .score { font-size: 36px; font-weight: 600; color: var(--primary-color); line-height: 1; }
.score-display-card .score.is-off { color: var(--neutral-color); }
.score-display-card div:last-child { font-size: 13px; color: var(--text-color-light); margin-top: 4px; font-weight: 500; }
.exercise-toggle-group { margin-bottom: 12px; }
.exercise-toggle-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 6px; font-size: 13px; }
.exercise-toggle-btns { 
    display: flex; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 8px에서 0으로 변경 */
    overflow: hidden; 
}
.exercise-toggle-btn { 
    flex: 1; 
    padding: 8px 12px; 
    border: none; 
    background: var(--container-bg); 
    cursor: pointer; 
    font-weight: 500; 
    transition: all 0.15s ease; 
    font-size: 13px;
    color: var(--text-color);
    font-family: 'Segoe UI', sans-serif;
    border-radius: 0; /* 모든 라운딩 제거 */
}
.exercise-toggle-btn.active { background: var(--success-color); color: white; }
.legend { display: flex; justify-content: center; flex-wrap: wrap; margin: 16px 0 0; font-size: 11px; gap: 12px; }
.legend-item { display: flex; align-items: center; gap: 4px; }
.legend-color { width: 10px; height: 10px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); }
.goal-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.goal-tab { padding: 6px 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s ease; color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
.goal-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
.goal-type-toggle { display: flex; gap: 4px; margin-bottom: 12px; }
.goal-type-toggle button { flex: 1; padding: 6px 12px; font-size: 12px; border: 1px solid var(--border-color); background: var(--container-bg); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.15s ease; color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
.goal-type-toggle button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
#personalGoalsPage .header { text-align: left; }
.dday-header-container { height: auto; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: flex-start; position: absolute; top: 8px; left: 8px; right: 8px; z-index: 10; pointer-events: none; }
.dday-chip { background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 12px; font-weight: 500; font-size: 10px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); pointer-events: all; }
.battery { display: none; width: 28px; height: 12px; border: 1px solid var(--border-color); border-radius: 2px; position: relative; padding: 1px; background: var(--container-bg); }
.battery::after { content: ''; position: absolute; top: 50%; right: -3px; transform: translateY(-50%); width: 2px; height: 6px; background: var(--border-color); border-radius: 0 1px 1px 0; }
.battery-level { height: 100%; border-radius: 1px; transition: width 0.3s ease; }
.battery-level.green { background: var(--success-color); } 
.battery-level.yellow { background: var(--warning-color); } 
.battery-level.red { background: var(--danger-color); } 
.battery-level.black { background: var(--text-color); }
.budget-summary { display: flex; gap: 8px; margin-bottom: 16px; }
.budget-card { 
    flex: 1; 
    background: var(--primary-light); 
    color: var(--primary-color); 
    padding: 15px; 
    border-radius: 0; /* 12px에서 0으로 변경 */
    text-align: center; 
    border: 1px solid var(--primary-color);
}
.budget-card-title { font-size: 11px; margin-bottom: 4px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.budget-card-value { font-size: 18px; font-weight: 600; }
#budgetPage .header p { font-size: 14px; font-weight: 500; color: var(--text-color); }
.personal-goals-section { background: var(--container-bg); padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; }
#modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
.personal-goal-checkbox { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 8px; 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    margin-bottom: 8px; 
}
.personal-goal-item { 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    padding: 12px; 
    margin-bottom: 8px; 
}
.personal-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.personal-goal-name { font-weight: 500; }
.personal-goal-actions button { 
    padding: 4px 8px; 
    border-radius: 0; /* 4px에서 0으로 변경 */
    font-size: 11px; 
    border: 1px solid; 
    cursor: pointer; 
    color: white;
    font-family: 'Segoe UI', sans-serif;
    font-weight: 500;
    margin-left: 4px;
}
.edit-btn { background: var(--warning-color); border-color: var(--warning-color); }
.delete-btn { background: var(--danger-color); border-color: var(--danger-color); }
.complete-btn { background: var(--success-color); border-color: var(--success-color); }
.reopen-btn { background: var(--primary-color); border-color: var(--primary-color); }
.empty-goals { 
    text-align: center; 
    color: var(--text-color-light); 
    padding: 32px 16px; 
    background: #fafbfc; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    margin-top: 16px; 
}
.budget-settings, .dday-settings { margin-bottom: 24px; }
.budget-input, .dday-actions { display: flex; gap: 8px; align-items: center; }
.dday-item { 
    background: #fafbfc; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    padding: 10px 12px; 
    margin-bottom: 8px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
.budget-input button { padding: 8px 16px; background: var(--success-color); color: white; border: 1px solid var(--success-color); border-radius: 4px; font-weight: 500; cursor: pointer; font-family: 'Segoe UI', sans-serif; font-size: 13px; }
.wakeup-prompt { background: var(--primary-light); color: var(--primary-color); padding: 16px; border: 1px solid var(--primary-color); border-radius: 4px; text-align: center; margin-bottom: 16px; }
.monthly-summary { display: flex; justify-content: space-around; gap: 12px; margin-bottom: 24px; }
.summary-card { 
    flex-basis: 30%; 
    background: var(--primary-light); 
    color: var(--primary-color); 
    padding: 16px; 
    border-radius: 0; /* 15px에서 0으로 변경 */
    text-align: center; 
    border: 1px solid var(--primary-color);
}
.summary-title { font-size: 11px; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.summary-value { font-size: 20px; font-weight: 600; }
.week-card { 
    background: var(--container-bg); 
    border-radius: 0; /* 15px에서 0으로 변경 */
    padding: 16px; 
    margin-bottom: 12px; 
    border: 1px solid var(--border-color);
}
.week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 500; }
.week-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; font-size: 18px; font-weight: 500; }
.empty-expenses { text-align: center; color: var(--text-color-light); padding: 32px 16px; }
.feedback-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 2000; animation: fadeIn 0.3s ease; justify-content: center; align-items: center; }
.feedback-content { position: relative; background: var(--container-bg); padding: 24px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 25.6px 57.6px 0 rgba(0, 0, 0, 0.22), 0 4.8px 14.4px 0 rgba(0, 0, 0, 0.18); animation: popIn 0.5s ease; }
.feedback-emoji { font-size: 48px; margin-bottom: 16px; display: block; }
.feedback-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--text-color); }
.feedback-message { font-size: 14px; color: var(--text-color-light); line-height: 1.5; margin-bottom: 20px; }
.feedback-celebration .feedback-title, 
.feedback-celebration .feedback-message, 
.feedback-reflection .feedback-title, 
.feedback-reflection .feedback-message, 
.feedback-disaster .feedback-title, 
.feedback-disaster .feedback-message, 
.feedback-encouragement .feedback-title, 
.feedback-encouragement .feedback-message, 
.feedback-warning .feedback-title, 
.feedback-warning .feedback-message { color: white; }
.feedback-celebration { background: linear-gradient(135deg, var(--success-color), #0e7b0e); }
.feedback-reflection { background: linear-gradient(135deg, var(--warning-color), #e67700); }
.feedback-disaster { background: linear-gradient(135deg, #605e5c, #484644); }
.feedback-encouragement { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
.feedback-warning { background: linear-gradient(135deg, var(--danger-color), #b92e32); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.feedback-btn { background: rgba(255,255,255,0.9); color: var(--text-color); border: 1px solid rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; margin: 0 4px; font-family: 'Segoe UI', sans-serif; }
.feedback-btn:hover { background: white; transform: translateY(-1px); }
.feedback-budget-red { background: linear-gradient(135deg, var(--danger-color), #b92e32) !important; }
.feedback-budget-black { background: linear-gradient(135deg, #605e5c, #484644) !important; }
.expense-input-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.expense-input-row input { flex: 1; padding: 6px 8px; font-size: 13px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
.expense-input-row button { flex-shrink: 0; width: 32px; height: 32px; border-radius: 4px; background: var(--primary-color); border: 1px solid var(--primary-color); color: white; font-weight: 500; cursor: pointer; font-size: 16px; transition: all 0.15s ease; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; }
.expense-input-row button:hover { background: var(--primary-dark); border-color: var(--primary-dark); }
.expense-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 13px; border-bottom: 1px solid #f3f2f1; }
.dday-settings h4 { margin-bottom: 12px; }
.dday-item .dday-actions { display: flex; gap: 4px; }
.dday-item .dday-actions button { background: var(--container-bg); border: 1px solid var(--border-color); width: 24px; height: 24px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.15s ease; color: var(--text-color-light); font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; }
.dday-item .dday-actions button:hover { background: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); }
.excel-option-item { display: flex; align-items: center; padding: 6px 0; cursor: pointer; }
.excel-option-item input[type="radio"] { width: 16px; height: 16px; margin-right: 8px; }
.excel-option-item label { font-size: 13px; font-family: 'Segoe UI', sans-serif; }
#customDateRange { display: flex; gap: 8px; align-items: center; margin-top: 8px; margin-bottom: 16px; }
#customDateRange input[type="date"] { padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border-color); flex: 1; font-family: 'Segoe UI', sans-serif; background: var(--container-bg); color: var(--text-color); font-size: 13px; }
.number-input-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color);
    border-radius: 0; /* 4px에서 0으로 변경 */
    overflow: hidden;
    background: var(--container-bg);
}
.number-input-group input { border: none; text-align: center; flex: 1; padding: 6px 4px; background: var(--container-bg); color: var(--text-color); font-size: 13px; }
.number-input-group input:focus { box-shadow: none; border: none; }
.number-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: #f3f2f1;
    color: var(--text-color);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Segoe UI', sans-serif;
    border-radius: 0; /* 모든 라운딩 제거 */
}
.number-btn:hover { background: var(--primary-light); color: var(--primary-color); }
.number-btn:active { background: var(--primary-color); color: white; }
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.food-page-actions { display: flex; gap: 8px; margin-bottom: 8px; }
.food-page-actions .btn.secondary.danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
.food-date-header { display: flex; align-items: center; text-align: center; margin: 24px 0 8px; color: var(--text-color-light); }
.food-date-header::before, .food-date-header::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
.food-date-header span { padding: 0 12px; font-size: 12px; font-weight: 500; }
.food-record-item { display: grid; grid-template-columns: 50px 30px 1fr auto; gap: 12px; align-items: center; padding: 12px 4px; border-bottom: 1px solid #f3f2f1; position: relative; }
.food-record-item .food-admin-actions { position: absolute; right: 0px; top: 50%; transform: translateY(-50%); display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
.food-records.admin-mode .food-record-item .food-admin-actions { opacity: 1; pointer-events: auto; }
.food-admin-actions button { background: var(--container-bg); border: 1px solid var(--border-color); width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 11px; transition: all 0.15s ease; font-family: 'Segoe UI', sans-serif; }
.food-admin-actions button.edit { color: var(--warning-color); }
.food-admin-actions button.delete { color: var(--danger-color); }
.food-admin-actions button:hover { background-color: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); }
#foodExportModal .modal-content { max-width: 90vw; background: var(--container-bg); padding: 0; }
#foodExportPreview { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 0; margin: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: 'Segoe UI', sans-serif; }
.food-receipt-header { padding: 12px 16px 8px; background: #f3f2f1; border-bottom: 1px solid var(--border-color); }
.food-receipt-title { display: block; text-align: center; margin-bottom: 4px; }
.food-receipt-title h3 { margin: 0; font-size: 14px; color: var(--text-color); font-weight: 600; }
.food-receipt-header p { margin: 0; font-size: 11px; color: var(--text-color-light); text-align: center; }
.food-receipt-divider { height: 1px; background: var(--border-color); margin: 0 12px; }
.food-receipt-items { padding: 12px 16px 8px; }
.food-receipt-date-header { font-weight: 600; color: var(--text-color); font-size: 12px; margin: 12px 0 6px 0; padding-bottom: 4px; border-bottom: 1px solid #f3f2f1; }
.food-receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 11px; line-height: 1.3; }
.food-receipt-time { color: var(--text-color-light); font-size: 10px; min-width: 40px; margin-right: 8px; }
.food-receipt-desc { flex: 1; font-weight: 500; color: var(--text-color); margin-right: 8px; }
.food-receipt-quantity { font-weight: 500; color: var(--text-color); font-size: 11px; text-align: right; min-width: 50px; }
#foodExportModal .close-btn { position: absolute; top: 12px; right: 12px; background: var(--container-bg); border: 1px solid var(--border-color); width: 28px; height: 28px; border-radius: 4px; font-size: 14px; color: var(--text-color); cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; font-family: 'Segoe UI', sans-serif; }
#foodExportModal .close-btn:hover { background: #fdebee; border-color: var(--danger-color); color: var(--danger-color); }
.food-modal { max-width: 420px; background-color: var(--container-bg); overflow: hidden; }
.food-modal .modal-header { padding: 12px 16px; background-color: #f3f2f1; border-bottom: 1px solid var(--border-color); }
.food-modal .modal-header h2 { font-size: 16px; font-weight: 600; }
.food-modal .modal-body { padding: 16px; }
.food-modal .form-group { margin-bottom: 12px; }
.food-modal .form-group label { font-size: 12px; margin-bottom: 4px; }
.food-modal .form-group input, .food-modal .form-group select { padding: 6px 8px; font-size: 13px; }
.food-modal .quantity-input { display: flex; gap: 6px; }
.food-modal .quantity-input select { width: 90px; }
.food-modal .food-modal-actions { margin-top: 16px; display: flex; gap: 8px; }
.food-modal .food-modal-actions .btn { flex: 1; padding: 8px 12px; }
.fame-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; }
.fame-card { 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    padding: 12px; 
    text-align: center; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.fame-card-title { font-size: 16px; margin-bottom: 6px; }
.fame-card-value { font-size: 16px; font-weight: 600; color: var(--primary-color); }
.fame-card-date { font-size: 10px; color: var(--text-color-light); margin-top: 3px; }
#wallOfShame .fame-card-value { color: var(--danger-color); }
#modalCommentSection { margin-top: 16px; }
#modalComment { width: 100%; margin-top: 12px; height: 70px; resize: vertical; font-size: 13px; }
#modalPersonalGoalsList input[type="number"] { font-size: 13px; }
.comment-history-list { max-height: 450px; overflow-y: auto; padding-right: 4px; }
.comment-item { 
    background: var(--container-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
    padding: 12px 16px; 
    margin-bottom: 8px; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.comment-item-header { font-size: 11px; color: var(--text-color-light); font-weight: 500; margin-bottom: 8px; }
.comment-item-body { font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.empty-comments { 
    text-align: center; 
    color: var(--text-color-light); 
    padding: 40px 16px; 
    background: #fafbfc; 
    border: 1px solid var(--border-color); 
    border-radius: 0; /* 4px에서 0으로 변경 */
}
.receipt-container {
    background: var(--container-bg);
    border: 1px solid var(--border-color);
    border-radius: 0; /* 4px에서 0으로 변경 */
    padding: 0;
    margin-top: 0;
    margin-bottom: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', sans-serif;
    max-width: 100%;
    overflow: hidden;
}
.receipt-header { padding: 12px 16px 8px; background: #f3f2f1; border-bottom: 1px solid var(--border-color); }
.receipt-title { display: block; text-align: center; margin-bottom: 4px; position: relative; }
.receipt-title h3 { margin: 0; font-size: 14px; color: var(--text-color); font-weight: 600; }
.budget-info { display: flex; flex-direction: column; gap: 2px; font-size: 9px; color: var(--text-color-light); font-weight: 500; text-align: right; position: absolute; top: -4px; right: -6px; }
.receipt-header p { margin: 0; font-size: 11px; color: var(--text-color-light); text-align: center; }
.receipt-divider { height: 1px; background: var(--border-color); margin: 0 12px; }
.receipt-items { padding: 12px 16px 8px; }
.receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 6px; font-size: 11px; line-height: 1.3; }
.receipt-date { color: var(--text-color-light); font-size: 10px; min-width: 55px; margin-right: 12px; }
.receipt-desc { flex: 1; font-weight: 500; color: var(--text-color); margin-right: 12px; }
.receipt-amount { font-weight: 600; color: var(--text-color); font-size: 11px; text-align: right; min-width: 60px; }
.receipt-total { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f3f2f1; font-weight: 600; font-size: 13px; font-family: 'Segoe UI', sans-serif; color: var(--text-color); border-top: 1px solid var(--border-color); }
.calendar-cell.skeleton { background: #f8f9fa; border: 1px solid #e9ecef; position: relative; overflow: hidden; }
.calendar-cell.skeleton::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); animation: shimmer 1.5s infinite; }
.calendar-cell.skeleton .cell-day-number { color: #ced4da; background: transparent; }
.calendar-cell.skeleton .cell-top-icons,
.calendar-cell.skeleton .cell-bottom-info { background: transparent; }
@keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
.loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-color-light); font-size: 11px; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
#dailyQuestModal .modal-header { padding-top: 20px; padding-bottom: 12px; }
.quest-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.quest-tab { padding: 6px 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.15s ease; color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
.quest-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
.quest-list { display: flex; flex-direction: column; gap: 8px; }
.quest-item { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 12px; transition: all 0.15s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.quest-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: var(--primary-color); }
.quest-item.completed { background: var(--success-color); color: white; border-color: var(--success-color); }
.quest-item.completed .quest-reward { color: rgba(255, 255, 255, 0.9); }
.quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.quest-title { font-weight: 500; font-size: 13px; }
.quest-reward { font-size: 11px; color: var(--primary-color); font-weight: 500; }
.quest-desc { font-size: 12px; color: var(--text-color-light); margin-bottom: 8px; line-height: 1.4; }
.quest-progress { display: flex; justify-content: space-between; align-items: center; }
.quest-progress-bar { flex: 1; height: 6px; background: #f3f2f1; border: 1px solid var(--border-color); border-radius: 3px; margin-right: 8px; overflow: hidden; }
.quest-progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s ease; border-radius: 2px; }
.quest-progress-text { font-size: 10px; color: var(--text-color-light); min-width: 35px; text-align: right; }
.quest-item.completed .quest-progress-bar { background: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.3); }
.quest-item.completed .quest-progress-fill { background: rgba(255, 255, 255, 0.8); }
.quest-item.completed .quest-progress-text { color: rgba(255, 255, 255, 0.9); }
#rewardsModal .modal-header { padding: 20px 20px 16px 20px; border-bottom: 1px solid var(--border-color); background: var(--container-bg); }
.rewards-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
.reward-item { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.15s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.reward-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: var(--primary-color); }
.reward-item.bronze { border-color: #CD7F32; background: #fef9f3; }
.reward-item.silver { border-color: #C0C0C0; background: #f8f9fa; }
.reward-item.gold { border-color: #FFD700; background: #fffdf0; }
.reward-item.legend { border-color: #9400D3; background: #faf5ff; }
.reward-item.used { opacity: 0.6; filter: grayscale(30%); }
.reward-info { flex: 1; }
.reward-name { font-weight: 500; font-size: 13px; margin-bottom: 3px; }
.reward-desc { font-size: 11px; color: var(--text-color-light); line-height: 1.4; }
.reward-tier { font-size: 9px; font-weight: 500; padding: 2px 6px; border-radius: 2px; margin-bottom: 3px; display: inline-block; border: 1px solid; text-transform: uppercase; letter-spacing: 0.5px; }
.reward-tier.bronze { background: #CD7F32; color: white; border-color: #A0522D; }
.reward-tier.silver { background: #C0C0C0; color: var(--text-color); border-color: #808080; }
.reward-tier.gold { background: #FFD700; color: var(--text-color); border-color: #FFA500; }
.reward-tier.legend { background: #9400D3; color: white; border-color: #4B0082; }
.reward-actions { display: flex; gap: 6px; }
.reward-btn { padding: 4px 10px; border: 1px solid; border-radius: 4px; font-size: 10px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; font-family: 'Segoe UI', sans-serif; }
.reward-btn.use { background: var(--success-color); color: white; border-color: var(--success-color); }
.reward-btn.use:hover { background: #0e7b0e; border-color: #0e7b0e; }
.reward-btn.delete { background: var(--danger-color); color: white; border-color: var(--danger-color); }
.reward-btn.delete:hover { background: #b92e32; border-color: #b92e32; }
.reward-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.empty-rewards { text-align: center; padding: 32px 16px; color: var(--text-color-light); }
.profile-menu-item:hover { background: var(--primary-light); color: var(--primary-color); }
#profileWidget:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
#profileWidget { transition: all 0.15s ease; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-width: 120px; }
#expBar { background: linear-gradient(90deg, var(--primary-color), var(--success-color)); height: 4px; border-radius: 2px; }
.achievements-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
.achievement-item { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 12px; display: flex; align-items: center; gap: 12px; transition: all 0.15s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.achievement-item.unlocked { border-color: var(--success-color); background: #f1f8e9; }
.achievement-item.locked { opacity: 0.6; }
.achievement-emoji { font-size: 20px; min-width: 40px; text-align: center; }
.achievement-info { flex: 1; }
.achievement-name { font-weight: 500; font-size: 13px; margin-bottom: 3px; }
.achievement-desc { font-size: 11px; color: var(--text-color-light); line-height: 1.4; }
.achievement-status { font-size: 10px; font-weight: 500; padding: 3px 6px; border-radius: 2px; border: 1px solid; text-transform: uppercase; letter-spacing: 0.5px; }
.achievement-status.unlocked { background: var(--success-color); color: white; border-color: var(--success-color); }
.achievement-status.locked { background: #f3f2f1; color: var(--text-color-light); border-color: var(--border-color); }
.achievement-item.hidden { background: #f8f9fa; color: var(--text-color-light); border-color: var(--border-color); }
.achievement-item.hidden .achievement-desc { color: var(--text-color-light); font-style: italic; }

@media (max-width: 767px) {
    body { font-size: 12px; padding: 12px; }
    .container { padding: 24px 12px 80px 12px; }
    .header h1 { font-size: 18px; }
    .header p { font-size: 12px; }
    .btn { font-size: 13px; padding: 8px 12px; }
    .form-group label { font-size: 12px; }
    .form-group input, .form-group textarea, .form-group select { font-size: 13px; padding: 6px 8px; }
    .modal-content { padding: 0; width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
    .food-modal { width: 90%; height: auto; border-radius: 4px; max-height: 90vh; }
    .food-modal .modal-body { overflow-y: auto; max-height: calc(90vh - 120px); }
    #dayModal .modal-body { padding: 16px 12px; }
    .modal-input-group { padding: 12px; }
    .modal-input-group h4 { font-size: 13px; }
    #dayModal .form-group label { font-size: 11px; }
    #dayModal .modal-input-row { grid-template-columns: 1fr; gap: 12px; }
    .exercise-toggle-btns { max-width: 200px; }
    .score-display-card, .personal-goals-section { width: 100%; max-width: none; margin: 0; padding: 12px; }
    .score-display-card .score { font-size: 28px; }
    #modalTotalExpense { text-align: left !important; }
    .expense-item { font-size: 12px; word-break: break-all; }
    .expense-item span:first-child { flex-grow: 1; margin-right: 8px; }
    .expense-item > div { flex-shrink: 0; }
    .modal-actions-container { padding: 0 12px 16px; display: flex; flex-direction: column; align-items: center; }
    .modal-actions-container .btn.delete { order: 2; background-color: transparent; color: var(--text-color-light); font-size: 11px; font-weight: 500; padding: 6px; box-shadow: none; margin-top: 8px; max-width: 150px; border: none; }
    .modal-actions-container .btn.delete:hover { background-color: transparent; color: var(--danger-color); }
    .modal-actions-container .btn.save { order: 1; }
    #budgetPage .budget-summary { flex-wrap: wrap; }
    #budgetPage .budget-summary .budget-card:first-child { flex-basis: 100%; }
    #budgetPage .budget-card-value { font-size: 16px; }
    #dayModal .expense-input-row { flex-direction: column; gap: 8px; }
    #dayModal .expense-input-row input,
    #dayModal .expense-input-row button { width: 100%; }
    .dday-header-container { top: 6px; left: 2px; right: 2px; }
    .dday-chip { font-size: 9px; padding: 3px 6px; }
    .battery { width: 24px; height: 10px; }
    .receipt-item { font-size: 10px; }
    .receipt-date { min-width: 40px; margin-right: 6px; font-size: 9px; }
    .receipt-desc { margin-right: 6px; }
    .receipt-amount { min-width: 45px; font-size: 10px; }
    .budget-info { flex-direction: column; gap: 1px; font-size: 8px; text-align: right; }
    .modal-title { font-size: 14px; }
    .quest-title { font-size: 12px; }
    .quest-desc { font-size: 11px; }
    .quest-reward { font-size: 10px; }
    .quest-progress-text { font-size: 9px; }
    .reward-name { font-size: 12px; }
    .reward-desc { font-size: 10px; }
    .achievement-name { font-size: 12px; }
    .achievement-desc { font-size: 10px; }
}
    `,
    
    sakura: `
    @font-face {
        font-family: 'KBIZHanmaumMyungjo';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --bg-color: #fefbfc;
        --primary-color: #f4a6cd;
        --primary-dark: #e991c0;
        --primary-light: #fdf3f7;
        --text-color: #5a4250;
        --text-color-light: #a08d97;
        --border-color: #f2e6ea;
        --container-bg: #ffffff;
        --danger-color: #f0a8c1;
        --warning-color: #f5c2a3;
        --success-color: #c8e4c2;
        --neutral-color: #d4c4cc;
        --sakura-accent: #f8eef2;
        --sakura-soft: #fcf7f9;
        --sakura-deep: #e67db3;
        --sakura-petal: #ffeef5;
        --sakura-bloom: #ffe4f0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    @keyframes sakuraPetals {
        0% {
            transform: translateY(-100vh) rotate(0deg);
            opacity: 0.8;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 0.7;
        }
        100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    @keyframes sakuraPetalsFloat {
        0%, 100% { transform: translateX(0px) rotate(0deg); }
        25% { transform: translateX(10px) rotate(90deg); }
        50% { transform: translateX(-5px) rotate(180deg); }
        75% { transform: translateX(8px) rotate(270deg); }
    }

    body { 
        font-family: 'KBIZHanmaumMyungjo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        background: linear-gradient(135deg, #fefbfc 0%, #fdf3f7 50%, #fcf0f4 100%);
        min-height: 100vh; 
        padding: 20px; 
        color: var(--text-color); 
        position: relative;
        overflow-x: hidden;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(circle at 15% 25%, rgba(244, 166, 205, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 85% 75%, rgba(253, 243, 247, 0.12) 0%, transparent 50%),
            radial-gradient(circle at 45% 40%, rgba(252, 240, 244, 0.06) 0%, transparent 50%),
            radial-gradient(circle at 70% 20%, rgba(255, 238, 245, 0.1) 0%, transparent 40%);
        pointer-events: none;
        z-index: -1;
    }

    /* 떨어지는 꽃잎 효과 - 뒤쪽에 배치 */
    body::after {
        content: '🌸 🌸 🌸 🌸 🌸 🌸 🌸 🌸 🌸 🌸';
        position: fixed;
        top: -50px;
        left: 0;
        width: 100%;
        font-size: 12px;
        line-height: 1;
        animation: sakuraPetals 15s infinite linear;
        pointer-events: none;
        z-index: -2;
        opacity: 0.4;
        letter-spacing: 80px;
        animation-delay: -5s;
    }

    .container::before {
        content: '🌸 🌸 🌸 🌸 🌸';
        position: fixed;
        top: -30px;
        left: 20%;
        width: 60%;
        font-size: 10px;
        animation: sakuraPetals 20s infinite linear;
        pointer-events: none;
        z-index: -2;
        opacity: 0.3;
        letter-spacing: 100px;
        animation-delay: -10s;
    }
    
    button, input, select, textarea { font-family: inherit; }
    .container { 
        background: rgba(255, 255, 255, 0.95); 
        border-radius: 24px; 
        padding: 50px 30px 100px 30px;
        width: 100%; 
        max-width: 500px; 
        margin: 0 auto; 
        box-shadow: 
            0 20px 60px rgba(244, 166, 205, 0.15), 
            0 8px 25px rgba(253, 243, 247, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        border: 1px solid rgba(248, 238, 242, 0.6);
        backdrop-filter: blur(10px);
    }
    .header { text-align: center; margin-bottom: 25px; position: relative; }
    .header h1 { 
        color: var(--primary-color); 
        font-size: 26px; 
        font-weight: 700; 
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .header p { color: var(--text-color-light); font-size: 14px; }
    #gameWarning { 
        background: linear-gradient(135deg, var(--sakura-petal), var(--sakura-bloom)); 
        color: var(--sakura-deep); 
        border: 1px solid rgba(246, 189, 213, 0.3); 
        border-radius: 18px; 
        padding: 15px; 
        font-size: 14px; 
        font-weight: 500; 
        margin-bottom: 20px; 
        display: none;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .page { display: none; }
    .page.active { display: block; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-nav { 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.8)); 
        border: 1px solid rgba(248, 238, 242, 0.4); 
        font-size: 22px; 
        color: var(--primary-color); 
        cursor: pointer; 
        padding: 12px; 
        border-radius: 16px; 
        transition: all 0.4s ease; 
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .month-nav:hover { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--sakura-deep);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
    }
    .month-year { 
        font-size: 20px; 
        font-weight: 700; 
        color: var(--primary-color);
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.1);
    }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px; }
    .calendar-header-cell { text-align: center; padding: 10px 5px; font-weight: 600; color: var(--text-color-light); font-size: 12px; }
    .calendar-cell { 
        aspect-ratio: 1; 
        display: grid; 
        grid-template-rows: 1fr auto 1fr; 
        padding: 3px; 
        align-items: center; 
        justify-items: center;
        border-radius: 16px;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.7);
        position: relative;
    }
    .cell-top-icons { grid-row: 1; display: flex; justify-content: center; gap: 2px; font-size: 9px; width: 100%; height: 100%; align-items: center; }
    .cell-day-number { grid-row: 2; font-weight: 500; color: var(--text-color); }
    .calendar-cell.today .cell-day-number { font-weight: 700; }
    .cell-bottom-info { grid-row: 3; font-size: 8px; font-weight: 600; color: var(--text-color-light); width: 100%; text-align: left; padding-right: 4px; align-self: end; padding-bottom: 3px; }

    .calendar-cell.has-data .cell-bottom-info { color: rgba(255, 255, 255, 0.9); }
    .calendar-cell.off-day { 
        background: linear-gradient(135deg, #f8f0f2, #f2e6ea); 
        color: var(--neutral-color); 
        border-radius: 14px; 
    }
    .off-day-indicator { position: absolute; top: 4px; right: 4px; font-size: 10px; }
    .calendar-cell:hover { 
        transform: translateY(-3px) scale(1.02); 
        box-shadow: 0 8px 25px rgba(244, 166, 205, 0.2);
        background: rgba(253, 243, 247, 0.9);
    }
    .calendar-cell.other-month { 
        color: #e4d2d8; 
        background: rgba(252, 247, 249, 0.5); 
        border-color: transparent; 
        pointer-events: none; 
        border-radius: 12px; 
    }
    .calendar-cell.today { 
        border: 2px solid var(--primary-color); 
        font-weight: 700; 
        color: var(--primary-color); 
        box-shadow: 
            0 0 0 3px rgba(244, 166, 205, 0.2),
            0 4px 15px rgba(244, 166, 205, 0.3);
        background: linear-gradient(135deg, rgba(253, 243, 247, 0.9), rgba(255, 255, 255, 0.95));
        animation: sakuraPetalsFloat 4s ease-in-out infinite;
    }
    .calendar-cell.has-data { color: white; border: none; font-weight: bold; }
    .calendar-cell.score-high { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        box-shadow: 0 4px 12px rgba(200, 228, 194, 0.3);
    }
    .calendar-cell.score-medium { 
        background: linear-gradient(135deg, var(--warning-color), #f0b392); 
        box-shadow: 0 4px 12px rgba(245, 194, 163, 0.3);
    }
    .calendar-cell.score-low { 
        background: linear-gradient(135deg, var(--danger-color), #eca0b5); 
        box-shadow: 0 4px 12px rgba(240, 168, 193, 0.3);
    }
    .calendar-cell.score-negative { 
        background: linear-gradient(135deg, #d4c4cc, #c4b0bc); 
        box-shadow: 0 4px 12px rgba(212, 196, 204, 0.3);
    }
    .score-indicator { 
        position: absolute; 
        bottom: 4px; 
        right: 4px; 
        font-size: 9px; 
        background: rgba(0,0,0,0.2); 
        color: white; 
        padding: 2px 5px; 
        border-radius: 8px; 
        font-weight: 700; 
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { 
        display: block; 
        color: var(--text-color); 
        font-weight: 600; 
        margin-bottom: 10px; 
        font-size: 14px; 
    }
    .form-group input, .form-group textarea, .form-group select { 
        width: 100%; 
        padding: 16px; 
        border: 1px solid var(--border-color); 
        border-radius: 18px; 
        font-size: 16px; 
        transition: all 0.3s ease; 
        font-family: 'KBIZHanmaumMyungjo', sans-serif;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(253, 247, 249, 0.8));
        box-shadow: inset 0 2px 4px rgba(244, 166, 205, 0.05);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
        outline: none; 
        border-color: var(--primary-color); 
        box-shadow: 
            0 0 0 4px rgba(244, 166, 205, 0.15), 
            0 4px 12px rgba(244, 166, 205, 0.1),
            inset 0 2px 4px rgba(244, 166, 205, 0.05);
        background: linear-gradient(135deg, #ffffff, rgba(253, 243, 247, 0.9));
    }
    .main-actions { display: flex; gap: 15px; margin-bottom: 10px; }
    .btn { 
        width: 100%; 
        padding: 18px; 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        color: white; 
        border: none; 
        border-radius: 20px; 
        font-size: 16px; 
        font-weight: 700; 
        cursor: pointer; 
        transition: all 0.4s ease; 
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.3),
            0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
    }
    .btn:hover::before {
        left: 100%;
    }
    .btn:hover { 
        background: linear-gradient(135deg, var(--primary-dark), var(--sakura-deep)); 
        transform: translateY(-3px); 
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.4),
            0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .btn:active { 
        transform: translateY(-1px); 
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.4),
            0 2px 4px rgba(0, 0, 0, 0.1); 
    }
    .main-actions .btn { flex: 1; }
    .btn.secondary { 
        background: linear-gradient(135deg, var(--neutral-color), #c4b0bc); 
        box-shadow: 0 6px 20px rgba(212, 196, 204, 0.3);
    }
    .btn.secondary:hover { 
        background: linear-gradient(135deg, #c4b0bc, #b8a2b0); 
        box-shadow: 0 10px 30px rgba(212, 196, 204, 0.4);
    }
    .modal-overlay { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(90, 66, 80, 0.3); 
        backdrop-filter: blur(12px); 
        z-index: 1000; 
        align-items: center; 
        justify-content: center; 
    }
    .modal-content { 
        background: rgba(255, 255, 255, 0.98); 
        padding: 0; 
        border-radius: 24px; 
        width: 90%; 
        max-width: 800px; 
        max-height: 95vh; 
        overflow-y: auto; 
        box-shadow: 
            0 25px 80px rgba(244, 166, 205, 0.25), 
            0 10px 40px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(248, 238, 242, 0.6);
        backdrop-filter: blur(20px);
    }
    #dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { 
        padding: 25px 30px; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.8); 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        border-top-left-radius: 24px; 
        border-top-right-radius: 24px; 
        position: relative;
    }
    #dayModal .modal-header::before {
        content: '🌸 ✨ 🌸';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 14px;
        opacity: 0.6;
        animation: sakuraPetalsFloat 3s ease-in-out infinite;
    }
    #dayModal .modal-body { padding: 30px; }
    .modal-layout { display: block; }
    @media (min-width: 768px) { .modal-layout { display: block; } }
    .modal-side-column { display: flex; flex-direction: column; }
    .modal-input-group { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-soft)); 
        padding: 22px; 
        border-radius: 18px; 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        box-shadow: 
            0 4px 15px rgba(244, 166, 205, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .modal-input-group h4 { 
        font-size: 16px; 
        margin-bottom: 18px; 
        padding-bottom: 12px; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.6); 
        color: var(--primary-color); 
        font-weight: 700;
    }
    .modal-input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
    
    #commentDetails summary { 
        font-weight: 600; 
        color: var(--text-color); 
        cursor: pointer; 
        padding: 15px; 
        border-radius: 16px; 
        background: linear-gradient(135deg, var(--sakura-petal), rgba(255, 255, 255, 0.9)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        list-style: none; 
        position: relative; 
        padding-left: 45px; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    #commentDetails summary:hover {
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal));
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
    }
    #commentDetails summary::-webkit-details-marker { display: none; }
    #commentDetails summary::before { 
        content: '🌸'; 
        position: absolute; 
        left: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        font-size: 14px; 
        transition: transform 0.4s ease; 
        animation: sakuraPetalsFloat 2s ease-in-out infinite;
    }
    #commentDetails[open] > summary::before { 
        transform: translateY(-50%) rotate(180deg); 
        content: '🌺';
    }

    #dayModal .form-group { margin-bottom: 0; }
    #dayModal .form-group label { font-size: 13px; margin-bottom: 8px; }
    #dayModal .form-group input { padding: 12px; font-size: 16px; }
    #dayModal .modal-input-group,
    #dayModal .score-display-card { margin-bottom: 8px; }
    #dayModal .modal-layout > div:last-child { margin-bottom: 0; }
    .modal-header { display: flex; justify-content: center; align-items: center; position: relative; gap: 25px; }
    .modal-title { 
        flex: none; 
        text-align: center; 
        margin: 0; 
        color: var(--primary-color);
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }

    .date-nav-btn { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft)); 
        border: 1px solid rgba(248, 238, 242, 0.6); 
        font-size: 24px; 
        color: var(--primary-color); 
        cursor: pointer; 
        padding: 12px; 
        border-radius: 14px; 
        transition: all 0.3s ease; 
        width: 44px; 
        height: 44px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .date-nav-btn:hover { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--sakura-deep);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
    }
    .close-btn { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft)); 
        border: 1px solid rgba(248, 238, 242, 0.6); 
        font-size: 24px; 
        cursor: pointer; 
        color: var(--primary-color); 
        line-height: 1; 
        position: absolute; 
        right: 0; 
        top: 50%; 
        transform: translateY(-50%);
        transition: all 0.3s ease;
        border-radius: 12px;
        padding: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .close-btn:hover {
        color: var(--sakura-deep);
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal));
        transform: translateY(-50%) scale(1.05);
    }
    .score-display-card { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border-radius: 20px; 
        padding: 25px; 
        text-align: center; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .score-display-card .score { 
        font-size: 40px; 
        font-weight: 700; 
        color: var(--primary-color); 
        line-height: 1;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .score-display-card .score.is-off { color: var(--neutral-color); }
    .score-display-card div:last-child { font-size: 14px; color: var(--text-color-light); margin-top: 8px; }
    .exercise-toggle-group { margin-bottom: 18px; }
    .exercise-toggle-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 10px; font-size: 14px; }
    .exercise-toggle-btns { 
        display: flex; 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 16px; 
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .exercise-toggle-btn { 
        flex: 1; 
        padding: 14px; 
        border: none; 
        background: rgba(255, 255, 255, 0.9); 
        cursor: pointer; 
        font-weight: 600; 
        transition: all 0.3s ease; 
        font-size: 14px; 
        color: var(--text-color);
    }
    .exercise-toggle-btn.active { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        color: #fff;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .legend { display: flex; justify-content: center; flex-wrap: wrap; margin: 20px 0 0; font-size: 12px; gap: 18px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 14px; height: 14px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .goal-tabs { display: flex; gap: 12px; margin-bottom: 20px; }
    .goal-tab { 
        padding: 12px 20px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 16px; 
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 600; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .goal-tab.active { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        color: white; 
        border-color: var(--primary-color);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.3);
    }
    .goal-type-toggle { display: flex; gap: 8px; margin-bottom: 15px; }
    .goal-type-toggle button { 
        flex: 1; 
        padding: 12px; 
        font-size: 14px; 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border-radius: 14px; 
        cursor: pointer; 
        font-weight: 600; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .goal-type-toggle button.active { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        color: white; 
        border-color: var(--primary-color);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.3);
    }
    #personalGoalsPage .header { text-align: left; }
    .dday-header-container { 
        height: auto; 
        margin-bottom: 5px; 
        display: flex; 
        justify-content: space-between; 
        align-items: flex-start; 
        position: absolute; 
        top: 15px; 
        left: 15px; 
        right: 15px; 
        z-index: 10; 
        pointer-events: none; 
    }
    .dday-chip { 
        background: linear-gradient(135deg, var(--sakura-bloom), rgba(255, 238, 245, 0.95)); 
        backdrop-filter: blur(12px); 
        color: var(--primary-color); 
        padding: 8px 14px; 
        border-radius: 18px; 
        font-weight: 700; 
        font-size: 11px; 
        display: none; 
        box-shadow: 
            0 4px 15px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8); 
        pointer-events: all; 
        border: 1px solid rgba(248, 238, 242, 0.6); 
        animation: sakuraPetalsFloat 3s ease-in-out infinite;
    }
    .battery { 
        display: none; 
        width: 32px; 
        height: 16px; 
        border: 2px solid var(--text-color-light); 
        border-radius: 8px; 
        position: relative; 
        padding: 2px;
        background: rgba(255, 255, 255, 0.9);
    }
    .battery::after { 
        content: ''; 
        position: absolute; 
        top: 50%; 
        right: -5px; 
        transform: translateY(-50%); 
        width: 3px; 
        height: 8px; 
        background: var(--text-color-light); 
        border-radius: 0 3px 3px 0; 
    }
    .battery-level { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
    .battery-level.green { background: linear-gradient(90deg, var(--success-color), #b8dbb2); } 
    .battery-level.yellow { background: linear-gradient(90deg, var(--warning-color), #f0b392); } 
    .battery-level.red { background: linear-gradient(90deg, var(--danger-color), #eca0b5); } 
    .battery-level.black { background: linear-gradient(90deg, var(--text-color), #6d5660); }
    .budget-summary { display: flex; gap: 15px; margin-bottom: 25px; }
    .budget-card { 
        flex: 1; 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--primary-color); 
        padding: 20px; 
        border-radius: 18px; 
        text-align: center;
        border: 1px solid rgba(248, 238, 242, 0.6);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .budget-card-title { font-size: 12px; opacity: 0.9; margin-bottom: 10px; font-weight: 600; }
    .budget-card-value { 
        font-size: 22px; 
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    #budgetPage .header p { font-size: 16px; font-weight: 600; color: var(--text-color); }
    .personal-goals-section { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        padding: 20px; 
        border-radius: 18px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    #modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
    .personal-goal-checkbox { 
        display: flex; 
        align-items: center; 
        gap: 14px; 
        padding: 14px; 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft)); 
        border-radius: 14px; 
        margin-bottom: 12px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.08);
    }
    .personal-goal-checkbox:hover {
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal));
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.15);
    }
    .personal-goal-item { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px; 
        margin-bottom: 15px;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
    }
    .personal-goal-item:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .personal-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .personal-goal-name { font-weight: 600; color: var(--text-color); }
    .personal-goal-actions button { 
        padding: 8px 14px; 
        border-radius: 12px; 
        font-size: 12px; 
        border: none; 
        cursor: pointer; 
        color: white; 
        transition: all 0.3s ease;
        font-weight: 600;
    }
    .edit-btn { 
        background: linear-gradient(135deg, var(--warning-color), #f0b392);
        box-shadow: 0 4px 12px rgba(245, 194, 163, 0.3);
    }
    .delete-btn { 
        background: linear-gradient(135deg, var(--danger-color), #eca0b5);
        box-shadow: 0 4px 12px rgba(240, 168, 193, 0.3);
    }
    .complete-btn { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2);
        box-shadow: 0 4px 12px rgba(200, 228, 194, 0.3);
    }
    .reopen-btn { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.3);
    }
    .personal-goal-actions button:hover {
        transform: translateY(-1px);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.4),
            0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .empty-goals { 
        text-align: center; 
        color: var(--text-color-light); 
        padding: 50px 25px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border-radius: 18px; 
        margin-top: 25px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 0 4px 15px rgba(244, 166, 205, 0.1);
    }
    .budget-settings, .dday-settings { margin-bottom: 35px; }
    .budget-input, .dday-actions { display: flex; gap: 15px; align-items: center; }
    .dday-item { 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border-radius: 16px; 
        padding: 18px 20px; 
        margin-bottom: 15px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border: 1px solid rgba(248, 238, 242, 0.8);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.08);
    }
    .dday-item:hover {
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal));
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.15);
    }
    .budget-input button { 
        padding: 16px 24px; 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        color: white; 
        border: none; 
        border-radius: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(200, 228, 194, 0.3);
    }
    .budget-input button:hover {
        background: linear-gradient(135deg, #b8dbb2, #a8ccb0);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(200, 228, 194, 0.4);
    }
    .wakeup-prompt { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--primary-color); 
        padding: 25px; 
        border-radius: 20px; 
        text-align: center; 
        margin-bottom: 25px;
        border: 1px solid rgba(248, 238, 242, 0.6);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
    }
    .wakeup-prompt::before {
        content: '🌸';
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 20px;
        opacity: 0.6;
        animation: sakuraPetalsFloat 4s ease-in-out infinite;
    }
    .monthly-summary { display: flex; justify-content: space-around; gap: 18px; margin-bottom: 35px; }
    .summary-card { 
        flex-basis: 30%; 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--primary-color); 
        padding: 25px; 
        border-radius: 20px; 
        text-align: center;
        border: 1px solid rgba(248, 238, 242, 0.6);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .summary-title { font-size: 14px; opacity: 0.9; margin-bottom: 12px; font-weight: 600; }
    .summary-value { 
        font-size: 24px; 
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .week-card { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border-radius: 20px; 
        padding: 25px; 
        margin-bottom: 18px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
    }
    .week-card:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .week-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 18px; 
        font-weight: 600; 
        color: var(--text-color); 
    }
    .week-stats { 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        text-align: center; 
        font-size: 22px; 
        font-weight: 600; 
    }
    .empty-expenses { text-align: center; color: var(--text-color-light); padding: 50px 25px; }
    .feedback-popup { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(90, 66, 80, 0.3); 
        display: none; 
        z-index: 2000; 
        animation: fadeIn 0.3s ease; 
        justify-content: center; 
        align-items: center; 
        backdrop-filter: blur(12px); 
    }
    .feedback-content { 
        position: relative; 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), var(--sakura-petal)); 
        padding: 45px; 
        border-radius: 24px; 
        width: 90%; 
        max-width: 420px; 
        text-align: center; 
        box-shadow: 
            0 25px 80px rgba(244, 166, 205, 0.3), 
            0 10px 40px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8); 
        animation: popIn 0.5s ease;
        border: 1px solid rgba(248, 238, 242, 0.6);
        backdrop-filter: blur(20px);
    }
    .feedback-emoji { font-size: 65px; margin-bottom: 25px; display: block; }
    .feedback-title { font-size: 24px; font-weight: 700; margin-bottom: 18px; color: var(--text-color); }
    .feedback-message { font-size: 16px; color: var(--text-color-light); line-height: 1.6; margin-bottom: 30px; }
    .feedback-celebration .feedback-title, .feedback-celebration .feedback-message, 
    .feedback-reflection .feedback-title, .feedback-reflection .feedback-message, 
    .feedback-disaster .feedback-title, .feedback-disaster .feedback-message, 
    .feedback-encouragement .feedback-title, .feedback-encouragement .feedback-message, 
    .feedback-warning .feedback-title, .feedback-warning .feedback-message { 
        color: rgba(255,255,255,0.95); 
    }
    .feedback-celebration { 
        background: linear-gradient(135deg, #c8e4c2, #b8dbb2); 
    } 
    .feedback-reflection { 
        background: linear-gradient(135deg, #f5c2a3, #f0b392); 
    } 
    .feedback-disaster { 
        background: linear-gradient(135deg, #d4c4cc, #c4b0bc); 
    } 
    .feedback-encouragement { 
        background: linear-gradient(135deg, #f4a6cd, #e991c0); 
    } 
    .feedback-warning { 
        background: linear-gradient(135deg, #f0a8c1, #eca0b5); 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { 
        from { opacity: 0; transform: scale(0.8); } 
        to { opacity: 1; transform: scale(1); } 
    }
    .feedback-btn { 
        background: rgba(255,255,255,0.25); 
        color: white; 
        border: 2px solid rgba(255,255,255,0.4); 
        padding: 14px 32px; 
        border-radius: 24px; 
        font-size: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        margin: 0 12px; 
    }
    .feedback-btn:hover { 
        background: rgba(255,255,255,0.35); 
        border-color: rgba(255,255,255,0.6); 
        transform: translateY(-2px); 
    }
    .feedback-budget-red { 
        background: linear-gradient(135deg, #f0a8c1, #eca0b5) !important; 
    }
    .feedback-budget-black { 
        background: linear-gradient(135deg, #d4c4cc, #c4b0bc) !important; 
    }
    .expense-input-row { display: flex; gap: 15px; align-items: center; margin-top: 12px; }
    .expense-input-row input { 
        flex: 1; 
        padding: 14px; 
        font-size: 14px; 
        border-radius: 14px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft));
    }
    .expense-input-row button { 
        flex-shrink: 0; 
        width: 48px; 
        height: 48px; 
        border-radius: 16px; 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        border: none; 
        color: white; 
        font-weight: bold; 
        cursor: pointer; 
        font-size: 24px; 
        line-height: 48px; 
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.3);
    }
    .expense-input-row button:hover { 
        background: linear-gradient(135deg, var(--primary-dark), var(--sakura-deep)); 
        transform: scale(1.05); 
        box-shadow: 0 8px 25px rgba(244, 166, 205, 0.4);
    }
    .expense-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 0; 
        font-size: 14px; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.6); 
    }
    .expense-item:last-child { border-bottom: none; }
    .dday-settings h4 { margin-bottom: 18px; color: var(--primary-color); font-weight: 700; }
    .dday-item .dday-actions { display: flex; gap: 8px; }
    .dday-item .dday-actions button { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        width: 36px; 
        height: 36px; 
        border-radius: 12px; 
        font-size: 16px; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .dday-item .dday-actions button:hover { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--sakura-deep); 
        border-color: var(--primary-color);
        transform: scale(1.1); 
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
    }
    .excel-option-item { 
        display: flex; 
        align-items: center; 
        padding: 12px 0; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        border-radius: 12px; 
    }
    .excel-option-item:hover { 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
    }
    .excel-option-item input[type="radio"] { 
        width: 20px; 
        height: 20px; 
        margin-right: 14px; 
        accent-color: var(--primary-color); 
    }
    .excel-option-item label { font-size: 16px; }
    #customDateRange { display: flex; gap: 15px; align-items: center; margin-top: 12px; margin-bottom: 25px; }
    #customDateRange input[type="date"] { 
        padding: 14px; 
        border-radius: 14px; 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        flex: 1; 
        font-family: inherit;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft));
        transition: all 0.3s ease;
    }
    #customDateRange input[type="date"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(244, 166, 205, 0.15);
        background: linear-gradient(135deg, #ffffff, rgba(253, 243, 247, 0.9));
    }

    .number-input-group {
        display: flex;
        align-items: center;
        border: 1px solid rgba(248, 238, 242, 0.8);
        border-radius: 16px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft));
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.08);
    }
    .number-input-group:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(244, 166, 205, 0.15);
        background: linear-gradient(135deg, #ffffff, rgba(253, 243, 247, 0.9));
    }

    .number-input-group input {
        border: none;
        text-align: center;
        flex: 1;
        padding: 14px 10px;
        background: transparent;
        font-size: 16px;
        color: var(--text-color);
    }

    .number-input-group input:focus { box-shadow: none; border: none; outline: none; }

    .number-btn {
        width: 40px;
        height: 48px;
        border: none;
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9));
        color: var(--primary-color);
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .number-btn:hover { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--sakura-deep); 
    }
    .number-btn:active { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        color: white; 
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .food-page-actions { display: flex; gap: 15px; margin-bottom: 12px; }
    .food-page-actions .btn.secondary.danger { 
        background: linear-gradient(135deg, var(--danger-color), #eca0b5); 
        color: white;
        box-shadow: 0 6px 20px rgba(240, 168, 193, 0.3);
    }
    .food-date-header { 
        display: flex; 
        align-items: center; 
        text-align: center; 
        margin: 35px 0 12px; 
        color: var(--text-color-light); 
    }
    .food-date-header::before, .food-date-header::after { 
        content: ''; 
        flex: 1; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.8); 
    }
    .food-date-header span { padding: 0 18px; font-size: 13px; font-weight: 600; }
    .food-record-item { 
        display: grid; 
        grid-template-columns: 50px 30px 1fr auto; 
        gap: 18px; 
        align-items: center; 
        padding: 18px 10px; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.6); 
        position: relative;
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    .food-record-item:hover {
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9));
        margin: 0 -10px;
        padding: 18px 20px;
        box-shadow: 0 4px 15px rgba(244, 166, 205, 0.1);
    }
    .food-record-item .food-admin-actions { 
        position: absolute; 
        right: 10px; 
        top: 50%; 
        transform: translateY(-50%); 
        display: flex; 
        gap: 8px; 
        opacity: 0; 
        transition: opacity 0.3s; 
        pointer-events: none; 
    }
    .food-records.admin-mode .food-record-item .food-admin-actions { opacity: 1; pointer-events: auto; }
    .food-admin-actions button { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-soft)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        width: 32px; 
        height: 32px; 
        border-radius: 12px; 
        cursor: pointer; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        font-size: 13px; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .food-admin-actions button.edit { color: var(--warning-color); }
    .food-admin-actions button.delete { color: var(--danger-color); }
    .food-admin-actions button:hover { 
        background: linear-gradient(135deg, #ffffff, var(--sakura-bloom)); 
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
    }
    
    #foodExportModal .modal-content { max-width: 90vw; background: white; padding: 0; }
    #foodExportPreview {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), var(--sakura-soft));
        border-radius: 18px;
        padding: 0;
        margin: 25px;
        box-shadow: 0 8px 25px rgba(244, 166, 205, 0.2);
        font-family: 'Courier New', monospace;
        border: 1px solid rgba(248, 238, 242, 0.8);
    }
    .food-receipt-header { 
        padding: 22px 25px 15px; 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
    }
    .food-receipt-title { display: block; text-align: center; margin-bottom: 8px; }
    .food-receipt-title h3 { 
        margin: 0; 
        font-size: 16px; 
        color: var(--primary-color); 
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .food-receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
    .food-receipt-divider {
        height: 1px;
        background: repeating-linear-gradient(
            to right,
            rgba(248, 238, 242, 0.8) 0px,
            rgba(248, 238, 242, 0.8) 3px,
            transparent 3px,
            transparent 6px
        );
        margin: 0 22px;
    }
    .food-receipt-items { padding: 22px 25px 15px; }
    .food-receipt-date-header { 
        font-weight: 700; 
        color: var(--primary-color); 
        font-size: 13px; 
        margin: 18px 0 10px 0; 
        padding-bottom: 8px; 
        border-bottom: 1px dashed rgba(248, 238, 242, 0.8); 
    }
    .food-receipt-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 6px 0; 
        font-size: 13px; 
        line-height: 1.5; 
    }
    .food-receipt-time { color: var(--text-color-light); font-size: 11px; min-width: 45px; margin-right: 15px; }
    .food-receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 15px; }
    .food-receipt-quantity { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 60px; }
    #foodExportModal .close-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        background: linear-gradient(135deg, rgba(244, 166, 205, 0.15), rgba(255, 238, 245, 0.9));
        border: 1px solid rgba(248, 238, 242, 0.8);
        width: 40px;
        height: 40px;
        border-radius: 14px;
        font-size: 20px;
        color: var(--primary-color);
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.15);
    }

    #foodExportModal .close-btn:hover { 
        background: linear-gradient(135deg, rgba(244, 166, 205, 0.25), var(--sakura-bloom)); 
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.25);
    }

    @media (max-width: 767px) { 
        #foodExportModal.modal-overlay { background: white; backdrop-filter: none; }
        
        #foodExportModal .modal-content { 
            max-width: 100vw; 
            width: 100vw; 
            height: 100vh; 
            margin: 0; 
            padding: 0; 
            border-radius: 0; 
            box-shadow: none; 
        }
        #foodExportPreview { 
            margin: 0; 
            border-radius: 0; 
            box-shadow: none; 
            height: calc(100vh - 50px); 
            overflow-y: auto; 
            border: none; 
        }
        
        #foodExportModal .close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            font-size: 22px;
            background: linear-gradient(135deg, rgba(244, 166, 205, 0.9), var(--primary-color));
            color: white;
            z-index: 1000;
        }
        
        #foodExportModal .modal-content > div:last-child {
            position: fixed; 
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), var(--sakura-soft));
            padding: 18px;
            border-top: 1px solid rgba(248, 238, 242, 0.8);
        }
    }

    .food-modal { max-width: 420px; background-color: white; overflow: hidden; }
    .food-modal .modal-header { 
        padding: 22px 25px; 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        border-bottom: 1px solid rgba(248, 238, 242, 0.8); 
    }
    .food-modal .modal-header h2 { 
        font-size: 18px; 
        color: var(--primary-color);
        font-weight: 700;
    }
    .food-modal .modal-body { padding: 25px; }
    .food-modal .form-group { margin-bottom: 18px; }
    .food-modal .form-group label { font-size: 13px; margin-bottom: 10px; }
    .food-modal .form-group input, .food-modal .form-group select { 
        padding: 14px; 
        font-size: 15px; 
        border-radius: 14px; 
    }
    .food-modal .quantity-input { display: flex; gap: 12px; }
    .food-modal .quantity-input select { width: 90px; }
    .food-modal .food-modal-actions { margin-top: 25px; display: flex; gap: 15px; }
    .food-modal .food-modal-actions .btn { flex: 1; padding: 16px; }

    .fame-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; }
    .fame-card { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px; 
        text-align: center;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
    }
    .fame-card:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .fame-card-title { font-size: 18px; margin-bottom: 10px; color: var(--text-color); }
    .fame-card-value { 
        font-size: 20px; 
        font-weight: 700; 
        color: var(--primary-color);
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .fame-card-date { font-size: 12px; color: var(--text-color-light); margin-top: 8px; }
    #wallOfShame .fame-card-value { color: var(--danger-color); }

    #modalCommentSection { margin-top: 25px; }
    #modalComment { 
        width: 100%; 
        margin-top: 18px; 
        height: 80px; 
        resize: vertical; 
        font-size: 16px;
        border-radius: 14px;
        border: 1px solid rgba(248, 238, 242, 0.8);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), var(--sakura-soft));
        transition: all 0.3s ease;
        padding: 14px;
    }
    #modalComment:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(244, 166, 205, 0.15);
        background: linear-gradient(135deg, #ffffff, rgba(253, 243, 247, 0.9));
    }
    #modalPersonalGoalsList input[type="number"] { font-size: 16px; }

    .comment-history-list { max-height: 450px; overflow-y: auto; padding-right: 8px; }
    .comment-item { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px 25px; 
        margin-bottom: 15px;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
    }
    .comment-item:hover {
        transform: translateY(-2px);
        box-shadow: 
            0 8px 25px rgba(244, 166, 205, 0.18),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .comment-item-header { 
        font-size: 13px; 
        color: var(--text-color-light); 
        font-weight: 600; 
        margin-bottom: 12px; 
    }
    .comment-item-body { 
        font-size: 15px; 
        line-height: 1.7; 
        white-space: pre-wrap; 
        word-break: break-word; 
        color: var(--text-color); 
    }
    .empty-comments { 
        text-align: center; 
        color: var(--text-color-light); 
        padding: 60px 25px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border-radius: 18px; 
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 0 4px 15px rgba(244, 166, 205, 0.1);
    }
    
    .receipt-container {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), var(--sakura-soft));
        border-radius: 18px;
        padding: 0;
        margin-top: 0; 
        margin-bottom: 25px; 
        box-shadow: 0 8px 25px rgba(244, 166, 205, 0.2);
        font-family: 'Courier New', monospace;
        max-width: 100%;
        overflow: hidden;
        border: 1px solid rgba(248, 238, 242, 0.8);
    }
    .receipt-header { 
        padding: 20px 25px 12px; 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
    }
    .receipt-title { display: block; text-align: center; margin-bottom: 8px; position: relative; }
    .receipt-title h3 { 
        margin: 0; 
        font-size: 16px; 
        color: var(--primary-color); 
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .budget-info { 
        display: flex; 
        flex-direction: column; 
        gap: 5px; 
        font-size: 11px; 
        color: var(--text-color); 
        font-weight: 600; 
        text-align: right; 
        position: absolute; 
        top: -5px; 
        right: -8px; 
    }
    .receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
    .receipt-divider { 
        height: 1px; 
        background: repeating-linear-gradient(
            to right, 
            rgba(248, 238, 242, 0.8) 0px, 
            rgba(248, 238, 242, 0.8) 3px, 
            transparent 3px, 
            transparent 6px
        ); 
        margin: 0 22px; 
    }
    .receipt-items { padding: 20px 25px 12px; }
    .receipt-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 6px 12px; 
        font-size: 13px; 
        line-height: 1.5; 
        transition: all 0.2s ease; 
        border-radius: 8px; 
    }
    .receipt-item:hover { 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
    }
    .receipt-date { color: var(--text-color-light); font-size: 11px; min-width: 60px; margin-right: 18px; }
    .receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 18px; }
    .receipt-amount { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 70px; }
    .receipt-total { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 20px 25px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        font-weight: 700; 
        font-size: 16px; 
        font-family: 'Courier New', monospace; 
        color: var(--primary-color); 
    }

    .calendar-cell.skeleton { 
        background: linear-gradient(135deg, #fafafa, #f5f5f5); 
        border: 1px solid #f0f0f0; 
        position: relative; 
        overflow: hidden;
        border-radius: 12px;
    }
    .calendar-cell.skeleton::before { 
        content: ''; 
        position: absolute; 
        top: 0; 
        left: -100%; 
        width: 100%; 
        height: 100%; 
        background: linear-gradient(90deg, transparent, rgba(244, 166, 205, 0.15), transparent); 
        animation: shimmer 2s infinite; 
    }
    .calendar-cell.skeleton .cell-day-number { color: #d0d0d0; background: transparent; }
    .calendar-cell.skeleton .cell-top-icons,
    .calendar-cell.skeleton .cell-bottom-info { background: transparent; }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }

    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-color-light);
        font-size: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.98);
        padding: 10px 15px;
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.2);
        border: 1px solid rgba(248, 238, 242, 0.8);
    }

    #dailyQuestModal .modal-header { padding-top: 32px; padding-bottom: 22px; }
    .quest-tabs { display: flex; gap: 15px; margin-bottom: 25px; }
    .quest-tab { 
        padding: 12px 22px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 16px; 
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 600; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(244, 166, 205, 0.1);
    }
    .quest-tab.active { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
        color: white; 
        border-color: var(--primary-color);
        box-shadow: 0 6px 20px rgba(244, 166, 205, 0.3);
    }
    .quest-list { display: flex; flex-direction: column; gap: 15px; }
    .quest-item { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 1px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px; 
        transition: all 0.3s ease;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .quest-item:hover { 
        transform: translateY(-3px); 
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8); 
    }
    .quest-item.completed { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        color: white; 
        border-color: var(--success-color);
        box-shadow: 0 6px 20px rgba(200, 228, 194, 0.3);
    }
    .quest-item.completed .quest-reward { color: rgba(255,255,255,0.9); }
    .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .quest-title { font-weight: 600; font-size: 14px; }
    .quest-reward { font-size: 12px; color: var(--primary-color); font-weight: 600; }
    .quest-desc { font-size: 13px; color: var(--text-color-light); margin-bottom: 15px; }
    .quest-progress { display: flex; justify-content: space-between; align-items: center; }
    .quest-progress-bar { 
        flex: 1; 
        height: 10px; 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9)); 
        border-radius: 6px; 
        margin-right: 15px; 
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(244, 166, 205, 0.1);
    }
    .quest-progress-fill { 
        height: 100%; 
        background: linear-gradient(90deg, var(--primary-color), var(--primary-dark)); 
        transition: width 0.3s ease; 
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(244, 166, 205, 0.2);
    }
    .quest-progress-text { font-size: 11px; color: var(--text-color-light); min-width: 40px; text-align: right; }
    .quest-item.completed .quest-progress-bar { background: rgba(255,255,255,0.3); }
    .quest-item.completed .quest-progress-fill { background: rgba(255,255,255,0.8); }
    .quest-item.completed .quest-progress-text { color: rgba(255,255,255,0.9); }

    #rewardsModal .modal-header { 
        padding: 35px 32px 25px 32px; 
        border-bottom: 1px solid rgba(248, 238, 242, 0.8); 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        border-top-left-radius: 24px; 
        border-top-right-radius: 24px; 
    }
    .rewards-list { display: flex; flex-direction: column; gap: 18px; max-height: 400px; overflow-y: auto; }
    .reward-item { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 2px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: all 0.3s ease;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .reward-item:hover { 
        transform: translateY(-3px); 
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8); 
    }
    .reward-item.bronze { 
        border-color: #CD7F32; 
        background: linear-gradient(135deg, #FFF8DC, #F5F5DC); 
    }
    .reward-item.silver { 
        border-color: #C0C0C0; 
        background: linear-gradient(135deg, #F8F8FF, #E6E6FA); 
    }
    .reward-item.gold { 
        border-color: #FFD700; 
        background: linear-gradient(135deg, #FFFACD, #FFEFD5); 
    }
    .reward-item.legend { 
        border-color: #9400D3; 
        background: linear-gradient(135deg, #F8F0FF, #E6E6FA); 
    }
    .reward-item.used { opacity: 0.5; filter: grayscale(50%); }
    .reward-info { flex: 1; }
    .reward-name { font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--text-color); }
    .reward-desc { font-size: 13px; color: var(--text-color-light); }
    .reward-tier { 
        font-size: 11px; 
        font-weight: 600; 
        padding: 4px 10px; 
        border-radius: 8px; 
        margin-bottom: 8px; 
        display: inline-block; 
    }
    .reward-tier.bronze { background: #CD7F32; color: white; }
    .reward-tier.silver { background: #C0C0C0; color: white; }
    .reward-tier.gold { background: #FFD700; color: #333; }
    .reward-tier.legend { background: #9400D3; color: white; }
    .reward-actions { display: flex; gap: 12px; }
    .reward-btn { 
        padding: 12px 16px; 
        border: none; 
        border-radius: 12px; 
        font-size: 12px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease; 
    }
    .reward-btn.use { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        color: white;
        box-shadow: 0 4px 12px rgba(200, 228, 194, 0.3);
    }
    .reward-btn.use:hover { 
        background: linear-gradient(135deg, #b8dbb2, #a8ccb0); 
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(200, 228, 194, 0.4);
    }
    .reward-btn.delete { 
        background: linear-gradient(135deg, var(--danger-color), #eca0b5); 
        color: white;
        box-shadow: 0 4px 12px rgba(240, 168, 193, 0.3);
    }
    .reward-btn.delete:hover { 
        background: linear-gradient(135deg, #eca0b5, #e395aa); 
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(240, 168, 193, 0.4);
    }
    .reward-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .empty-rewards { 
        text-align: center; 
        padding: 50px 25px; 
        color: var(--text-color-light); 
        background: linear-gradient(135deg, var(--sakura-soft), rgba(255, 255, 255, 0.9));
        border-radius: 18px;
        border: 1px solid rgba(248, 238, 242, 0.8);
        box-shadow: 0 4px 15px rgba(244, 166, 205, 0.1);
    }

    .profile-menu-item:hover { 
        background: linear-gradient(135deg, var(--sakura-bloom), var(--sakura-petal)); 
        color: var(--primary-color); 
        border-radius: 12px;
    }
    
    #profileWidget:hover { transform: translateY(-3px); }
    #profileWidget { 
        transition: all 0.3s ease; 
        border-radius: 16px;
        padding: 6px;
    }

    .achievements-list { display: flex; flex-direction: column; gap: 18px; max-height: 400px; overflow-y: auto; }
    .achievement-item { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), var(--sakura-petal)); 
        border: 2px solid rgba(248, 238, 242, 0.8); 
        border-radius: 18px; 
        padding: 20px; 
        display: flex; 
        align-items: center; 
        gap: 20px; 
        transition: all 0.3s ease;
        box-shadow: 
            0 6px 20px rgba(244, 166, 205, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .achievement-item:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 10px 30px rgba(244, 166, 205, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .achievement-item.unlocked { 
        border-color: var(--success-color); 
        background: linear-gradient(135deg, #f8fff8, #e8f5e8); 
    }
    .achievement-item.locked { opacity: 0.6; }
    .achievement-emoji { font-size: 28px; min-width: 45px; text-align: center; }
    .achievement-info { flex: 1; }
    .achievement-name { font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--text-color); }
    .achievement-desc { font-size: 13px; color: var(--text-color-light); }
    .achievement-status { 
        font-size: 12px; 
        font-weight: 600; 
        padding: 6px 12px; 
        border-radius: 12px; 
    }
    .achievement-status.unlocked { 
        background: linear-gradient(135deg, var(--success-color), #b8dbb2); 
        color: white; 
    }
    .achievement-status.locked { 
        background: rgba(248, 238, 242, 0.8); 
        color: var(--text-color-light); 
    }
    .achievement-item.hidden { 
        background: linear-gradient(135deg, #d4c4cc, #c4b0bc); 
        color: #f8f0f2; 
        border-color: #c4b0bc; 
    }
    .achievement-item.hidden .achievement-desc { 
        color: #e4d2d8; 
        font-style: italic; 
    }

    @media (max-width: 767px) {
        body {
            padding: 15px;
        }
        .modal-content { 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            border-radius: 0; 
            max-height: 100vh; 
        }
        .food-modal { 
            width: 90%; 
            height: auto; 
            border-radius: 20px; 
            max-height: 90vh; 
        }
        .food-modal .modal-body { 
            overflow-y: auto; 
            max-height: calc(90vh - 120px); 
        }
        #dayModal .modal-body { padding: 20px 18px; }
        .modal-input-group { padding: 18px; }
        .modal-input-group h4 { font-size: 15px; }
        #dayModal .form-group label { font-size: 13px; }
        #dayModal .modal-input-row { grid-template-columns: 1fr; gap: 15px; }
        .exercise-toggle-btns { max-width: 180px; }
        .score-display-card, .personal-goals-section { 
            width: 100%; 
            max-width: none; 
            margin: 0; 
            padding: 18px; 
        }
        .score-display-card .score { font-size: 36px; }

        #modalTotalExpense { text-align: left !important; }
        .expense-item { font-size: 13px; word-break: break-all; }
        .expense-item span:first-child { flex-grow: 1; margin-right: 10px; }
        .expense-item > div { flex-shrink: 0; }
        
        .modal-actions-container { 
            padding: 0 18px 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .modal-actions-container .btn.delete {
            order: 2;
            background-color: transparent;
            color: var(--text-color-light);
            font-size: 14px;
            font-weight: normal;
            padding: 10px;
            box-shadow: none;
            margin-top: 12px;
            max-width: 150px;
        }
        .modal-actions-container .btn.delete:hover { 
            background-color: transparent; 
            color: var(--danger-color); 
        }
        .modal-actions-container .btn.save { order: 1; }

        #budgetPage .budget-summary { flex-wrap: wrap; }
        #budgetPage .budget-summary .budget-card:first-child { flex-basis: 100%; }
        #budgetPage .budget-card-value { font-size: 20px; }
        #dayModal .expense-input-row { flex-direction: column; gap: 12px; }
        #dayModal .expense-input-row input,
        #dayModal .expense-input-row button { width: 100%; }
        .dday-header-container { top: 10px; left: 6px; right: 6px; }
        .container { padding: 40px 22px 100px 22px; }
        .dday-chip { font-size: 10px; padding: 4px 10px; }
        .battery { width: 28px; height: 14px; }
        .receipt-item { font-size: 12px; }
        .receipt-date { min-width: 50px; margin-right: 12px; font-size: 10px; }
        .receipt-desc { margin-right: 12px; }
        .receipt-amount { min-width: 60px; font-size: 12px; }
        .budget-info { 
            flex-direction: column; 
            gap: 3px; 
            font-size: 10px; 
            text-align: right; 
        }
        .calendar-grid { gap: 6px; }
        .main-actions { gap: 12px; }
        .btn { padding: 16px; }
    }
    `,
    
    paperbook: `
       @font-face {
        font-family: 'KBIZHanmaumMyungjo';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@400;600;700&display=swap');

    :root {
        --bg-color: #f5f3f0;
        --primary-color: #8b4513;
        --primary-dark: #654321;
        --primary-light: #f4f1ec;
        --text-color: #2d2520;
        --text-color-light: #6b5b54;
        --border-color: #d4c4b0;
        --container-bg: #fefdfb;
        --danger-color: #b85450;
        --warning-color: #c9963d;
        --success-color: #6b8e5a;
        --neutral-color: #8d7b68;
        --paper-shadow: rgba(139, 69, 19, 0.15);
        --ink-color: #1a1a1a;
        --vintage-gold: #d4af37;
        --aged-paper: #f9f7f4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Crimson Text', 'KBIZHanmaumMyungjo', Georgia, serif; 
        background: linear-gradient(45deg, #f5f3f0 0%, #ede8e0 50%, #f5f3f0 100%);
        background-attachment: fixed;
        min-height: 100vh; 
        padding: 20px; 
        color: var(--text-color);
        position: relative;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(139, 69, 19, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(180, 140, 70, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(139, 69, 19, 0.02) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
    }
    
    button, input, select, textarea { font-family: inherit; }
    
    .container { 
        background: var(--container-bg);
        border-radius: 0;
        padding: 60px 40px 120px 40px;
        width: 100%; 
        max-width: 520px; 
        margin: 0 auto; 
        box-shadow: 
            0 0 0 1px var(--border-color),
            0 5px 15px var(--paper-shadow),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        border: 3px solid var(--border-color);
        background: 
            linear-gradient(90deg, transparent 0%, transparent 48px, rgba(139, 69, 19, 0.1) 48px, rgba(139, 69, 19, 0.1) 50px, transparent 50px),
            var(--container-bg);
    }
    
    .container::before {
        content: '';
        position: absolute;
        left: 48px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(220, 53, 69, 0.3);
        z-index: 1;
    }
    
    .container::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            repeating-linear-gradient(
                transparent,
                transparent 24px,
                rgba(139, 69, 19, 0.05) 24px,
                rgba(139, 69, 19, 0.05) 25px
            );
        pointer-events: none;
        z-index: 1;
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 30px; 
        position: relative;
        z-index: 2;
        padding: 20px 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 40px;
    }
    
    .header h1 { 
        font-family: 'Playfair Display', serif;
        color: var(--text-color); 
        font-size: 32px; 
        font-weight: 700; 
        margin-bottom: 8px;
        text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
        letter-spacing: 1px;
    }
    
    .header p { 
        color: var(--text-color-light); 
        font-size: 16px;
        font-style: italic;
        letter-spacing: 0.5px;
    }
    
    #gameWarning { 
        background: var(--aged-paper);
        color: var(--warning-color); 
        border: 2px solid var(--warning-color);
        border-radius: 0;
        padding: 15px; 
        font-size: 14px; 
        font-weight: 600; 
        margin-bottom: 25px; 
        display: none;
        box-shadow: inset 0 0 10px rgba(201, 150, 61, 0.1);
        z-index: 2;
        position: relative;
    }
    
    .page { display: none; z-index: 2; position: relative; }
    .page.active { display: block; }
    
    .calendar-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 25px;
        padding: 0 10px;
    }
    
    .month-nav { 
        background: none; 
        border: 2px solid var(--border-color);
        font-size: 20px; 
        color: var(--text-color); 
        cursor: pointer; 
        padding: 8px 12px; 
        border-radius: 0;
        transition: all 0.3s ease;
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .month-nav:hover { 
        background: var(--primary-light);
        transform: translateY(-1px);
        box-shadow: 3px 3px 6px var(--paper-shadow);
    }
    
    .month-year { 
        font-family: 'Playfair Display', serif;
        font-size: 24px; 
        font-weight: 700;
        color: var(--text-color);
        text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
    }
    
    .calendar-grid { 
        display: grid; 
        grid-template-columns: repeat(7, 1fr); 
        gap: 2px; 
        margin-bottom: 25px;
        border: 2px solid var(--border-color);
        background: var(--border-color);
    }
    
    .calendar-header-cell { 
        text-align: center; 
        padding: 12px 5px; 
        font-weight: 600; 
        color: var(--text-color); 
        font-size: 13px;
        background: var(--primary-light);
        font-family: 'Playfair Display', serif;
    }
    
    .calendar-cell { 
        aspect-ratio: 1; 
        display: grid; 
        grid-template-rows: 1fr auto 1fr; 
        padding: 4px; 
        align-items: center; 
        justify-items: center;
        background: var(--container-bg);
        color: var(--text-color);
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        position: relative;
    }
    
    .calendar-cell::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            repeating-linear-gradient(
                45deg,
                transparent,
                transparent 1px,
                rgba(139, 69, 19, 0.02) 1px,
                rgba(139, 69, 19, 0.02) 2px
            );
        pointer-events: none;
    }
    
    .cell-top-icons { 
        grid-row: 1; 
        display: flex; 
        justify-content: center; 
        gap: 2px; 
        font-size: 10px; 
        width: 100%; 
        height: 100%; 
        align-items: center; 
    }
    
    .cell-day-number { 
        grid-row: 2; 
        font-weight: 600;
        font-family: 'Playfair Display', serif;
        font-size: 14px;
    }
    
    .calendar-cell.today .cell-day-number { font-weight: 700; }
    
    .cell-bottom-info { 
        grid-row: 3; 
        font-size: 8px; 
        font-weight: 600; 
        color: var(--text-color-light); 
        width: 100%; 
        text-align: left; 
        padding-right: 4px; 
        align-self: end; 
        padding-bottom: 2px; 
    }

    .calendar-cell.has-data .cell-bottom-info { color: rgba(254, 253, 251, 0.9); }
    
    .calendar-cell.off-day { 
        background: #ede8e0; 
        color: var(--neutral-color);
        position: relative;
    }
    
    .calendar-cell.off-day::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(45deg);
        width: 1px;
        height: 80%;
        background: var(--neutral-color);
        opacity: 0.3;
    }
    
    .off-day-indicator { position: absolute; top: 4px; right: 4px; font-size: 10px; }
    
    .calendar-cell:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 8px var(--paper-shadow);
        background: var(--aged-paper);
    }
    
    .calendar-cell.other-month { 
        color: #bbb; 
        background: #f0ede8; 
        pointer-events: none; 
    }
    
    .calendar-cell.today { 
        background: var(--primary-light);
        font-weight: 700; 
        color: var(--primary-color); 
        box-shadow: inset 0 0 0 2px var(--primary-color);
    }
    
    .calendar-cell.has-data { color: white; font-weight: bold; }
    .calendar-cell.score-high { background: var(--success-color); }
    .calendar-cell.score-medium { background: var(--warning-color); }
    .calendar-cell.score-low { background: var(--danger-color); }
    .calendar-cell.score-negative { background: var(--neutral-color); }
    
    .score-indicator { 
        position: absolute; 
        bottom: 4px; 
        right: 4px; 
        font-size: 9px; 
        background: rgba(0,0,0,0.3); 
        color: white; 
        padding: 1px 4px; 
        border-radius: 0;
        font-weight: 700; 
    }
    
    .form-group { 
        margin-bottom: 25px;
        z-index: 2;
        position: relative;
    }
    
    .form-group label { 
        display: block; 
        color: var(--text-color); 
        font-weight: 600; 
        margin-bottom: 8px; 
        font-size: 15px;
        font-family: 'Playfair Display', serif;
    }
    
    .form-group input, .form-group textarea, .form-group select { 
        width: 100%; 
        padding: 12px 15px; 
        border: 2px solid var(--border-color);
        border-radius: 0;
        font-size: 16px; 
        transition: all 0.3s ease; 
        font-family: 'Crimson Text', serif;
        background: var(--container-bg);
        color: var(--text-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
        outline: none; 
        border-color: var(--primary-color); 
        box-shadow: 
            inset 2px 2px 4px rgba(139, 69, 19, 0.05),
            0 0 0 3px rgba(139, 69, 19, 0.1);
        background: var(--aged-paper);
    }
    
    .main-actions { 
        display: flex; 
        gap: 15px; 
        margin-bottom: 15px;
        z-index: 2;
        position: relative;
    }
    
    .btn { 
        width: 100%; 
        padding: 15px 20px; 
        background-color: var(--primary-color); 
        color: white; 
        border: 2px solid var(--primary-dark);
        border-radius: 0;
        font-size: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        box-shadow: 3px 3px 6px var(--paper-shadow);
        font-family: 'Playfair Display', serif;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .btn:hover { 
        background-color: var(--primary-dark); 
        transform: translateY(-2px); 
        box-shadow: 4px 4px 8px var(--paper-shadow);
    }
    
    .btn:active { 
        transform: translateY(0); 
        box-shadow: 2px 2px 4px var(--paper-shadow); 
    }
    
    .main-actions .btn { flex: 1; }
    
    .btn.secondary { 
        background: var(--neutral-color);
        border-color: #6b5b54;
    }
    
    .btn.secondary:hover { background: #6b5b54; }
    
    .modal-overlay { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(45, 37, 32, 0.7);
        backdrop-filter: blur(2px);
        z-index: 1000; 
        align-items: center; 
        justify-content: center; 
    }
    
    .modal-content { 
        background: var(--container-bg);
        padding: 0; 
        border-radius: 0;
        width: 90%; 
        max-width: 800px; 
        max-height: 95vh; 
        overflow-y: auto; 
        box-shadow: 
            0 0 0 3px var(--border-color),
            0 10px 30px var(--paper-shadow);
        border: 3px solid var(--border-color);
    }
    
    #dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { 
        padding: 25px 30px; 
        border-bottom: 2px solid var(--border-color); 
        background: var(--primary-light);
    }
    
    #dayModal .modal-body { 
        padding: 30px;
        background: var(--container-bg);
    }
    
    .modal-layout { display: block; }
    
    @media (min-width: 768px) { .modal-layout { display: block; } }
    
    .modal-side-column { display: flex; flex-direction: column; }
    
    .modal-input-group { 
        background: var(--aged-paper);
        padding: 20px; 
        border-radius: 0;
        border: 2px solid var(--border-color);
        margin-bottom: 20px;
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .modal-input-group h4 { 
        font-size: 18px; 
        margin-bottom: 15px; 
        padding-bottom: 10px; 
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
        font-weight: 600;
    }
    
    .modal-input-row { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
        gap: 15px; 
    }
    
    #commentDetails summary { 
        font-weight: 600; 
        color: var(--text-color); 
        cursor: pointer; 
        padding: 12px 15px; 
        border-radius: 0;
        background-color: var(--aged-paper);
        border: 2px solid var(--border-color);
        list-style: none; 
        position: relative; 
        padding-left: 35px;
        font-family: 'Playfair Display', serif;
    }
    
    #commentDetails summary::-webkit-details-marker { display: none; }
    
    #commentDetails summary::before { 
        content: '►'; 
        position: absolute; 
        left: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        font-size: 12px; 
        transition: transform 0.3s; 
        color: var(--primary-color);
    }
    
    #commentDetails[open] > summary::before { transform: translateY(-50%) rotate(90deg); }

    #dayModal .form-group { margin-bottom: 0; }
    #dayModal .form-group label { font-size: 14px; margin-bottom: 6px; }
    #dayModal .form-group input { padding: 10px; font-size: 16px; }
    #dayModal .modal-input-group,
    #dayModal .score-display-card { margin-bottom: 5px; }
    #dayModal .modal-layout > div:last-child { margin-bottom: 0; }
    
    .modal-header { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        position: relative; 
        gap: 20px; 
    }
    
    .modal-title { 
        flex: none; 
        text-align: center; 
        margin: 0;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
        font-size: 20px;
        font-weight: 600;
    }
    
    .date-nav-btn { 
        background: none; 
        border: 2px solid var(--border-color);
        font-size: 20px; 
        color: var(--text-color); 
        cursor: pointer; 
        padding: 8px 12px; 
        border-radius: 0;
        transition: all 0.2s ease; 
        width: 40px; 
        height: 40px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-family: 'Playfair Display', serif;
    }
    
    .date-nav-btn:hover { 
        background: var(--aged-paper);
        transform: translateY(-1px);
    }
    
    .close-btn { 
        background: none; 
        border: 2px solid var(--border-color);
        font-size: 24px; 
        cursor: pointer; 
        color: var(--text-color); 
        line-height: 1; 
        position: absolute; 
        right: 0; 
        top: 50%; 
        transform: translateY(-50%);
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
    }
    
    .close-btn:hover {
        background: var(--aged-paper);
    }
    
    .score-display-card { 
        background: var(--aged-paper);
        border-radius: 0;
        padding: 25px; 
        text-align: center; 
        border: 2px solid var(--border-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .score-display-card .score { 
        font-size: 42px; 
        font-weight: 700; 
        color: var(--primary-color); 
        line-height: 1;
        font-family: 'Playfair Display', serif;
        text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
    }
    
    .score-display-card .score.is-off { color: var(--neutral-color); }
    
    .score-display-card div:last-child { 
        font-size: 14px; 
        color: var(--text-color-light); 
        margin-top: 8px;
        font-style: italic;
    }
    
    .exercise-toggle-group { margin-bottom: 15px; }
    
    .exercise-toggle-group label { 
        display: block; 
        color: var(--text-color); 
        font-weight: 600; 
        margin-bottom: 8px; 
        font-size: 14px;
        font-family: 'Playfair Display', serif;
    }
    
    .exercise-toggle-btns { 
        display: flex; 
        border: 2px solid var(--border-color);
        border-radius: 0;
        overflow: hidden; 
    }
    
    .exercise-toggle-btn { 
        flex: 1; 
        padding: 10px; 
        border: none; 
        background: var(--container-bg);
        cursor: pointer; 
        font-weight: 600; 
        transition: all 0.2s ease; 
        font-size: 14px;
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }
    
    .exercise-toggle-btn.active { 
        background: var(--success-color); 
        color: #fff; 
    }
    
    .legend { 
        display: flex; 
        justify-content: center; 
        flex-wrap: wrap; 
        margin: 25px 0 0; 
        font-size: 12px; 
        gap: 15px; 
    }
    
    .legend-item { 
        display: flex; 
        align-items: center; 
        gap: 5px;
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }
    
    .legend-color { 
        width: 12px; 
        height: 12px; 
        border-radius: 0;
        border: 1px solid var(--border-color);
    }
    
    .goal-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    
    .goal-tab { 
        padding: 10px 18px; 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 600; 
        transition: all 0.3s ease;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .goal-tab.active { 
        background: var(--primary-color); 
        color: white; 
        border-color: var(--primary-dark); 
    }
    
    .goal-type-toggle { display: flex; gap: 5px; margin-bottom: 15px; }
    
    .goal-type-toggle button { 
        flex: 1; 
        padding: 10px; 
        font-size: 14px; 
        border: 2px solid var(--border-color);
        background: var(--aged-paper);
        border-radius: 0;
        cursor: pointer; 
        font-weight: 600; 
        transition: all 0.2s ease;
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }
    
    .goal-type-toggle button.active { 
        background: var(--primary-color); 
        color: white; 
        border-color: var(--primary-dark); 
    }
    
    #personalGoalsPage .header { text-align: left; }
    
    .dday-header-container { 
        height: auto; 
        margin-bottom: 5px; 
        display: flex; 
        justify-content: space-between; 
        align-items: flex-start; 
        position: absolute; 
        top: 15px; 
        left: 15px; 
        right: 15px; 
        z-index: 10; 
        pointer-events: none; 
    }
    
    .dday-chip { 
        background: var(--vintage-gold);
        color: var(--text-color);
        padding: 6px 12px; 
        border-radius: 0;
        font-weight: 700; 
        font-size: 11px; 
        display: none; 
        box-shadow: 2px 2px 4px var(--paper-shadow);
        pointer-events: all; 
        border: 2px solid var(--primary-dark);
        font-family: 'Playfair Display', serif;
    }
    
    .battery { 
        display: none; 
        width: 30px; 
        height: 14px; 
        border: 2px solid var(--text-color-light);
        border-radius: 0;
        position: relative; 
        padding: 1.5px; 
    }
    
    .battery::after { 
        content: ''; 
        position: absolute; 
        top: 50%; 
        right: -4px; 
        transform: translateY(-50%); 
        width: 2px; 
        height: 6px; 
        background: var(--text-color-light);
        border-radius: 0;
    }
    
    .battery-level { height: 100%; border-radius: 0; transition: width 0.3s ease; }
    .battery-level.green { background: var(--success-color); } 
    .battery-level.yellow { background: var(--warning-color); } 
    .battery-level.red { background: var(--danger-color); } 
    .battery-level.black { background: var(--text-color); }
    
    .budget-summary { display: flex; gap: 15px; margin-bottom: 25px; }
    
    .budget-card { 
        flex: 1; 
        background: var(--aged-paper);
        color: var(--primary-color); 
        padding: 20px; 
        border-radius: 0;
        text-align: center;
        border: 2px solid var(--border-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .budget-card-title { 
        font-size: 13px; 
        opacity: 0.9; 
        margin-bottom: 10px; 
        font-weight: 600;
        font-family: 'Playfair Display', serif;
    }
    
    .budget-card-value { 
        font-size: 24px; 
        font-weight: 700;
        font-family: 'Playfair Display', serif;
    }
    
    #budgetPage .header p { 
        font-size: 16px; 
        font-weight: 600; 
        color: var(--text-color); 
    }
    
    .personal-goals-section { 
        background: var(--aged-paper);
        padding: 20px; 
        border-radius: 0;
        border: 2px solid var(--border-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    #modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
    
    .personal-goal-checkbox { 
        display: flex; 
        align-items: center; 
        gap: 10px;
        padding: 12px; 
        background: var(--container-bg);
        border-radius: 0;
        margin-bottom: 10px; 
        border: 2px solid var(--border-color);
    }
    
    .personal-goal-item { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px; 
        margin-bottom: 12px;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .personal-goal-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px; 
    }
    
    .personal-goal-name { 
        font-weight: 600;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .personal-goal-actions button { 
        padding: 6px 12px; 
        border-radius: 0;
        font-size: 12px; 
        border: 2px solid;
        cursor: pointer; 
        color: white;
        font-weight: 600;
        margin-left: 5px;
        font-family: 'Crimson Text', serif;
    }
    
    .edit-btn { 
        background: var(--warning-color);
        border-color: #b8852d;
    }
    
    .delete-btn { 
        background: var(--danger-color);
        border-color: #9d3f3c;
    }
    
    .complete-btn { 
        background: var(--success-color);
        border-color: #5a7849;
    }
    
    .reopen-btn { 
        background: var(--primary-color);
        border-color: var(--primary-dark);
    }
    
    .empty-goals { 
        text-align: center; 
        color: var(--text-color-light); 
        padding: 50px 25px; 
        background: var(--aged-paper);
        border-radius: 0;
        margin-top: 25px; 
        border: 2px dashed var(--border-color);
        font-style: italic;
    }
    
    .budget-settings, .dday-settings { margin-bottom: 35px; }
    
    .budget-input, .dday-actions { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
    }
    
    .dday-item { 
        background: var(--aged-paper);
        border-radius: 0;
        padding: 15px 18px; 
        margin-bottom: 12px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border: 2px solid var(--border-color);
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .budget-input button { 
        padding: 12px 20px; 
        background: var(--success-color); 
        color: white; 
        border: 2px solid #5a7849;
        border-radius: 0;
        font-weight: 600; 
        cursor: pointer;
        font-family: 'Playfair Display', serif;
    }
    
    .wakeup-prompt { 
        background: var(--aged-paper);
        color: var(--primary-color); 
        padding: 25px; 
        border-radius: 0;
        text-align: center; 
        margin-bottom: 25px;
        border: 2px solid var(--border-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .monthly-summary { 
        display: flex; 
        justify-content: space-around; 
        gap: 18px; 
        margin-bottom: 35px; 
    }
    
    .summary-card { 
        flex-basis: 30%; 
        background: var(--aged-paper);
        color: var(--primary-color); 
        padding: 25px; 
        border-radius: 0;
        text-align: center;
        border: 2px solid var(--border-color);
        box-shadow: inset 2px 2px 4px rgba(139, 69, 19, 0.05);
    }
    
    .summary-title { 
        font-size: 14px; 
        opacity: 0.9; 
        margin-bottom: 12px; 
        font-weight: 600;
        font-family: 'Playfair Display', serif;
    }
    
    .summary-value { 
        font-size: 26px; 
        font-weight: 700;
        font-family: 'Playfair Display', serif;
    }
    
    .week-card { 
        background: var(--aged-paper);
        border-radius: 0;
        padding: 25px; 
        margin-bottom: 18px; 
        border: 2px solid var(--border-color);
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .week-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 18px; 
        font-weight: 600;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .week-stats { 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        text-align: center; 
        font-size: 24px; 
        font-weight: 600;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .empty-expenses { 
        text-align: center; 
        color: var(--text-color-light); 
        padding: 50px 25px;
        font-style: italic;
    }
    
    .feedback-popup { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(45, 37, 32, 0.8);
        display: none; 
        z-index: 2000; 
        animation: fadeIn 0.3s ease; 
        justify-content: center; 
        align-items: center; 
    }
    
    .feedback-content { 
        position: relative; 
        background: var(--container-bg);
        padding: 45px; 
        border-radius: 0;
        width: 90%; 
        max-width: 420px; 
        text-align: center; 
        box-shadow: 
            0 0 0 3px var(--border-color),
            0 15px 40px var(--paper-shadow);
        animation: popIn 0.5s ease;
        border: 3px solid var(--border-color);
    }
    
    .feedback-emoji { font-size: 70px; margin-bottom: 25px; display: block; }
    
    .feedback-title { 
        font-size: 26px; 
        font-weight: 700; 
        margin-bottom: 18px; 
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .feedback-message { 
        font-size: 16px; 
        color: var(--text-color-light); 
        line-height: 1.6; 
        margin-bottom: 30px;
        font-family: 'Crimson Text', serif;
    }
    
    .feedback-celebration .feedback-title, 
    .feedback-celebration .feedback-message, 
    .feedback-reflection .feedback-title, 
    .feedback-reflection .feedback-message, 
    .feedback-disaster .feedback-title, 
    .feedback-disaster .feedback-message, 
    .feedback-encouragement .feedback-title, 
    .feedback-encouragement .feedback-message, 
    .feedback-warning .feedback-title, 
    .feedback-warning .feedback-message { 
        color: rgba(254, 253, 251, 0.95); 
    }
    
    .feedback-celebration { background: linear-gradient(135deg, #6b8e5a, #5a7849); } 
    .feedback-reflection { background: linear-gradient(135deg, #c9963d, #b8852d); } 
    .feedback-disaster { background: linear-gradient(135deg, #8d7b68, #6b5b54); } 
    .feedback-encouragement { background: linear-gradient(135deg, #8b4513, #654321); } 
    .feedback-warning { background: linear-gradient(135deg, #b85450, #9d3f3c); }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    
    .feedback-btn { 
        background: rgba(254, 253, 251, 0.2); 
        color: white; 
        border: 2px solid rgba(254, 253, 251, 0.4);
        padding: 12px 25px; 
        border-radius: 0;
        font-size: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        margin: 0 8px;
        font-family: 'Playfair Display', serif;
    }
    
    .feedback-btn:hover { 
        background: rgba(254, 253, 251, 0.3); 
        border-color: rgba(254, 253, 251, 0.6); 
        transform: translateY(-2px); 
    }
    
    .feedback-budget-red { background: linear-gradient(135deg, #b85450, #9d3f3c) !important; }
    .feedback-budget-black { background: linear-gradient(135deg, #8d7b68, #6b5b54) !important; }
    
    .expense-input-row { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
        margin-top: 12px; 
    }
    
    .expense-input-row input { 
        flex: 1; 
        padding: 12px; 
        font-size: 14px; 
        border-radius: 0;
        background: var(--container-bg);
        color: var(--text-color);
        border: 2px solid var(--border-color);
    }
    
    .expense-input-row button { 
        flex-shrink: 0; 
        width: 48px; 
        height: 48px; 
        border-radius: 0;
        background: var(--primary-color); 
        border: 2px solid var(--primary-dark);
        color: white; 
        font-weight: bold; 
        cursor: pointer; 
        font-size: 24px; 
        line-height: 48px; 
        transition: background 0.2s ease; 
    }
    
    .expense-input-row button:hover { background: var(--primary-dark); }
    
    .expense-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 8px 0; 
        font-size: 14px;
        color: var(--text-color);
        border-bottom: 1px dotted var(--border-color);
    }
    
    .dday-settings h4 { 
        margin-bottom: 18px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
        font-size: 18px;
    }
    
    .dday-item .dday-actions { display: flex; gap: 8px; }
    
    .dday-item .dday-actions button { 
        background: none; 
        border: 2px solid var(--border-color);
        width: 32px; 
        height: 32px; 
        border-radius: 0;
        font-size: 16px; 
        cursor: pointer; 
        transition: all 0.2s ease; 
        color: var(--text-color-light); 
    }
    
    .dday-item .dday-actions button:hover { 
        background: var(--aged-paper);
        color: var(--text-color); 
        transform: scale(1.05); 
    }
    
    .excel-option-item { 
        display: flex; 
        align-items: center; 
        padding: 10px 0; 
        cursor: pointer;
        color: var(--text-color);
    }
    
    .excel-option-item input[type="radio"] { 
        width: 20px; 
        height: 20px; 
        margin-right: 15px;
        accent-color: var(--primary-color);
    }
    
    .excel-option-item label { 
        font-size: 16px;
        font-family: 'Crimson Text', serif;
    }
    
    #customDateRange { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
        margin-top: 12px; 
        margin-bottom: 25px; 
    }
    
    #customDateRange input[type="date"] { 
        padding: 10px; 
        border-radius: 0;
        border: 2px solid var(--border-color);
        flex: 1; 
        font-family: inherit;
        background: var(--container-bg);
        color: var(--text-color);
    }

    .number-input-group {
        display: flex;
        align-items: center;
        border: 2px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
    }

    .number-input-group input {
        border: none;
        text-align: center;
        flex: 1;
        padding: 10px 5px;
        background: var(--container-bg);
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }

    .number-input-group input:focus {
        box-shadow: none;
        border: none;
    }

    .number-btn {
        width: 36px;
        height: 42px;
        border: none;
        background: var(--aged-paper);
        color: var(--text-color);
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Playfair Display', serif;
    }

    .number-btn:hover { background: var(--primary-light); }
    .number-btn:active { background: var(--primary-color); color: white; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .food-page-actions { display: flex; gap: 12px; margin-bottom: 12px; }
    .food-page-actions .btn.secondary.danger { background-color: var(--danger-color); color: white; }
    
    .food-date-header { 
        display: flex; 
        align-items: center; 
        text-align: center; 
        margin: 35px 0 15px; 
        color: var(--text-color-light); 
    }
    
    .food-date-header::before, .food-date-header::after { 
        content: ''; 
        flex: 1; 
        border-bottom: 1px solid var(--border-color); 
    }
    
    .food-date-header span { 
        padding: 0 18px; 
        font-size: 14px; 
        font-weight: 600;
        font-family: 'Playfair Display', serif;
    }
    
    .food-record-item { 
        display: grid; 
        grid-template-columns: 50px 30px 1fr auto; 
        gap: 18px; 
        align-items: center; 
        padding: 16px 8px; 
        border-bottom: 1px dotted var(--border-color);
        position: relative; 
    }
    
    .food-record-item .food-admin-actions { 
        position: absolute; 
        right: 0px; 
        top: 50%; 
        transform: translateY(-50%); 
        display: flex; 
        gap: 6px; 
        opacity: 0; 
        transition: opacity 0.2s; 
        pointer-events: none; 
    }
    
    .food-records.admin-mode .food-record-item .food-admin-actions { 
        opacity: 1; 
        pointer-events: auto; 
    }
    
    .food-admin-actions button { 
        background: none; 
        border: 2px solid var(--border-color);
        width: 30px; 
        height: 30px; 
        border-radius: 0;
        cursor: pointer; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        font-size: 13px; 
        transition: background-color 0.2s; 
    }
    
    .food-admin-actions button.edit { color: var(--warning-color); }
    .food-admin-actions button.delete { color: var(--danger-color); }
    .food-admin-actions button:hover { background-color: var(--aged-paper); }
    
    /* 식단 내보내기를 영수증 스타일로 */
    #foodExportModal .modal-content {
        max-width: 90vw;
        background: var(--container-bg);
        padding: 0;
    }
    
    #foodExportPreview {
        background: var(--container-bg);
        border-radius: 0;
        padding: 0;
        margin: 25px;
        box-shadow: 
            0 0 0 2px var(--border-color),
            0 6px 18px var(--paper-shadow);
        font-family: 'Courier New', monospace;
        border: 2px solid var(--border-color);
    }
    
    .food-receipt-header {
        padding: 18px 25px 12px;
        background: var(--primary-light);
    }
    
    .food-receipt-title {
        display: block;
        text-align: center;
        margin-bottom: 8px;
    }
    
    .food-receipt-title h3 {
        margin: 0;
        font-size: 18px;
        color: var(--primary-color);
        font-weight: 700;
        font-family: 'Playfair Display', serif;
    }
    
    .food-receipt-header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-color-light);
        text-align: center;
        font-style: italic;
    }
    
    .food-receipt-divider {
        height: 2px;
        background: repeating-linear-gradient(
            to right,
            var(--border-color) 0px,
            var(--border-color) 4px,
            transparent 4px,
            transparent 8px
        );
        margin: 0 18px;
    }
    
    .food-receipt-items {
        padding: 18px 25px 12px;
    }
    
    .food-receipt-date-header {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 14px;
        margin: 18px 0 10px 0;
        padding-bottom: 6px;
        border-bottom: 1px dashed var(--border-color);
        font-family: 'Playfair Display', serif;
    }
    
    .food-receipt-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .food-receipt-time {
        color: var(--text-color-light);
        font-size: 12px;
        min-width: 50px;
        margin-right: 12px;
    }
    
    .food-receipt-desc {
        flex: 1;
        font-weight: 600;
        color: var(--text-color);
        margin-right: 12px;
    }
    
    .food-receipt-quantity {
        font-weight: 700;
        color: var(--text-color);
        font-size: 14px;
        text-align: right;
        min-width: 65px;
    }
    
    #foodExportModal .close-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(139, 69, 19, 0.1);
        border: 2px solid var(--border-color);
        width: 38px;
        height: 38px;
        border-radius: 0;
        font-size: 20px;
        color: var(--text-color);
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    #foodExportModal .close-btn:hover {
        background: rgba(139, 69, 19, 0.2);
    }

    @media (max-width: 767px) {
        /* 모바일에서 배경 오버레이 숨기기 */
        #foodExportModal.modal-overlay {
            background: var(--bg-color);
            backdrop-filter: none;
        }
        
        #foodExportModal .modal-content {
            max-width: 100vw;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            background: var(--bg-color);
        }
        
        #foodExportPreview {
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            height: calc(100vh - 60px);
            overflow-y: auto;
            background: var(--container-bg);
            border: none;
        }
        
        /* 닫기 버튼 */
        #foodExportModal .close-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            width: 42px;
            height: 42px;
            font-size: 22px;
            background: rgba(139, 69, 19, 0.8);
            color: white;
            z-index: 1000;
        }
        
        /* 안내 텍스트 */
        #foodExportModal .modal-content > div:last-child {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--container-bg);
            padding: 18px;
            border-top: 2px solid var(--border-color);
        }
    }

    /* [컴팩트 모달] 식단 추가/수정 모달 전용 스타일 */
    .food-modal { 
        max-width: 440px; 
        background-color: var(--container-bg);
        overflow: hidden; 
    }
    
    .food-modal .modal-header { 
        padding: 18px 25px; 
        background-color: var(--aged-paper);
        border-bottom: 2px solid var(--border-color); 
    }
    
    .food-modal .modal-header h2 { 
        font-size: 20px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .food-modal .modal-body { 
        padding: 25px;
        background: var(--container-bg);
    }
    
    .food-modal .form-group { margin-bottom: 18px; }
    .food-modal .form-group label { font-size: 14px; margin-bottom: 8px; }
    .food-modal .form-group input, .food-modal .form-group select { padding: 12px; font-size: 15px; }
    .food-modal .quantity-input { display: flex; gap: 10px; }
    .food-modal .quantity-input select { width: 95px; }
    .food-modal .food-modal-actions { margin-top: 25px; display: flex; gap: 12px; }
    .food-modal .food-modal-actions .btn { flex: 1; padding: 14px; }

    .fame-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 12px; 
    }
    
    .fame-card { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px; 
        text-align: center;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .fame-card-title { 
        font-size: 20px; 
        margin-bottom: 10px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .fame-card-value { 
        font-size: 22px; 
        font-weight: 700; 
        color: var(--primary-color);
        font-family: 'Playfair Display', serif;
    }
    
    .fame-card-date { 
        font-size: 12px; 
        color: var(--text-color-light); 
        margin-top: 6px;
        font-style: italic;
    }
    
    /* 반성의 벽 카드는 다른 색상으로 */
    #wallOfShame .fame-card-value { color: var(--danger-color); }

    /* 오늘의 한마디 스타일 */
    #modalCommentSection { margin-top: 25px; }
    #modalComment { 
        width: 100%; 
        margin-top: 18px; 
        height: 90px; 
        resize: vertical; 
        font-size: 16px; 
    }
    
    #modalPersonalGoalsList input[type="number"] { font-size: 16px; }
    
    /* 오늘의 한마디 기록 페이지 스타일 */
    .comment-history-list { 
        max-height: 480px; 
        overflow-y: auto; 
        padding-right: 8px; 
    }
    
    .comment-item { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px 25px; 
        margin-bottom: 15px;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .comment-item-header { 
        font-size: 14px; 
        color: var(--text-color-light); 
        font-weight: 600; 
        margin-bottom: 12px;
        font-family: 'Playfair Display', serif;
    }
    
    .comment-item-body { 
        font-size: 16px; 
        line-height: 1.8; 
        white-space: pre-wrap; 
        word-break: break-word;
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }
    
    .empty-comments { 
        text-align: center; 
        color: var(--text-color-light); 
        padding: 60px 25px; 
        background: var(--aged-paper);
        border-radius: 0;
        border: 2px dashed var(--border-color);
        font-style: italic;
    }
    
    /* 영수증 스타일 */
    .receipt-container {
        background: var(--container-bg);
        border-radius: 0;
        padding: 0;
        margin-top: 0;
        margin-bottom: 25px;
        box-shadow: 
            0 0 0 2px var(--border-color),
            0 6px 18px var(--paper-shadow);
        font-family: 'Courier New', monospace;
        max-width: 100%;
        overflow: hidden;
        border: 2px solid var(--border-color);
    }
    
    .receipt-header { 
        padding: 18px 25px 12px; 
        background: var(--primary-light); 
    }
    
    .receipt-title { 
        display: block; 
        text-align: center; 
        margin-bottom: 8px; 
        position: relative; 
    }
    
    .receipt-title h3 { 
        margin: 0; 
        font-size: 18px; 
        color: var(--primary-color); 
        font-weight: 700;
        font-family: 'Playfair Display', serif;
    }
    
    .budget-info { 
        display: flex; 
        flex-direction: column; 
        gap: 4px; 
        font-size: 12px; 
        color: var(--text-color); 
        font-weight: 600; 
        text-align: right; 
        position: absolute;
        top: -6px;
        right: -10px;
    }
    
    .receipt-header p { 
        margin: 0; 
        font-size: 13px; 
        color: var(--text-color-light); 
        text-align: center;
        font-style: italic;
    }
    
    .receipt-divider { 
        height: 2px; 
        background: repeating-linear-gradient(
            to right, 
            var(--border-color) 0px, 
            var(--border-color) 4px, 
            transparent 4px, 
            transparent 8px
        ); 
        margin: 0 18px; 
    }
    
    .receipt-items { padding: 18px 25px 12px; }
    
    .receipt-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 5px 10px; 
        font-size: 14px; 
        line-height: 1.4; 
    }
    
    .receipt-date { 
        color: var(--text-color-light); 
        font-size: 12px; 
        min-width: 65px; 
        margin-right: 18px; 
    }
    
    .receipt-desc { 
        flex: 1; 
        font-weight: 600; 
        color: var(--text-color); 
        margin-right: 18px; 
    }
    
    .receipt-amount { 
        font-weight: 700; 
        color: var(--text-color); 
        font-size: 14px; 
        text-align: right; 
        min-width: 75px; 
    }
    
    .receipt-total { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 18px 25px; 
        background: var(--aged-paper);
        font-weight: 700; 
        font-size: 18px; 
        font-family: 'Playfair Display', serif;
        color: var(--primary-color); 
        border-top: 2px solid var(--border-color);
    }

    /* 깔끔한 스켈레톤 UI */
    .calendar-cell.skeleton {
        background: #ede8e0;
        border: 1px solid #d4c4b0;
        position: relative;
        overflow: hidden;
    }

    .calendar-cell.skeleton::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(139, 69, 19, 0.1), transparent);
        animation: shimmer 2s infinite;
    }

    .calendar-cell.skeleton .cell-day-number {
        color: #c4b4a0;
        background: transparent;
    }

    .calendar-cell.skeleton .cell-top-icons,
    .calendar-cell.skeleton .cell-bottom-info {
        background: transparent;
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* 로딩 상태 표시 */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-color-light);
        font-size: 12px;
        z-index: 10;
        background: rgba(254, 253, 251, 0.95);
        padding: 8px 15px;
        border-radius: 0;
        box-shadow: 
            0 0 0 2px var(--border-color),
            0 4px 12px var(--paper-shadow);
        border: 2px solid var(--border-color);
        font-family: 'Crimson Text', serif;
        font-style: italic;
    }

    #dailyQuestModal .modal-header {
        padding-top: 30px;
        padding-bottom: 18px;
    }
    
    /* 퀘스트 페이지 스타일 */
    .quest-tabs { display: flex; gap: 12px; margin-bottom: 25px; }
    
    .quest-tab { 
        padding: 12px 20px; 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 600; 
        transition: all 0.3s ease;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .quest-tab.active { 
        background: var(--primary-color); 
        color: white; 
        border-color: var(--primary-dark); 
    }
    
    .quest-list { display: flex; flex-direction: column; gap: 12px; }
    
    .quest-item { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px; 
        transition: all 0.2s ease;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .quest-item:hover { 
        transform: translateY(-2px); 
        box-shadow: 4px 4px 8px var(--paper-shadow); 
    }
    
    .quest-item.completed { 
        background: var(--success-color); 
        color: white; 
        border-color: #5a7849; 
    }
    
    .quest-item.completed .quest-reward { color: rgba(255,255,255,0.9); }
    
    .quest-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
    }
    
    .quest-title { 
        font-weight: 600; 
        font-size: 15px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .quest-item.completed .quest-title { color: white; }
    
    .quest-reward { 
        font-size: 12px; 
        color: var(--primary-color); 
        font-weight: 600;
        font-family: 'Crimson Text', serif;
    }
    
    .quest-desc { 
        font-size: 13px; 
        color: var(--text-color-light); 
        margin-bottom: 12px;
        font-family: 'Crimson Text', serif;
        font-style: italic;
    }
    
    .quest-item.completed .quest-desc { color: rgba(255,255,255,0.8); }
    
    .quest-progress { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    
    .quest-progress-bar { 
        flex: 1; 
        height: 8px; 
        background: var(--container-bg);
        border-radius: 0;
        margin-right: 12px; 
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .quest-progress-fill { 
        height: 100%; 
        background: var(--primary-color); 
        transition: width 0.3s ease; 
    }
    
    .quest-progress-text { 
        font-size: 11px; 
        color: var(--text-color-light); 
        min-width: 45px; 
        text-align: right;
        font-family: 'Crimson Text', serif;
    }
    
    .quest-item.completed .quest-progress-bar { 
        background: rgba(255,255,255,0.3);
        border-color: rgba(255,255,255,0.5);
    }
    
    .quest-item.completed .quest-progress-fill { background: rgba(255,255,255,0.8); }
    .quest-item.completed .quest-progress-text { color: rgba(255,255,255,0.9); }

    /* 보상 시스템 스타일 */
    #rewardsModal .modal-header { 
        padding: 35px 30px 25px 30px; 
        border-bottom: 2px solid var(--border-color); 
        background: var(--container-bg);
    }
    
    .rewards-list { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
        max-height: 420px; 
        overflow-y: auto; 
    }
    
    .reward-item { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: all 0.2s ease;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .reward-item:hover { 
        transform: translateY(-2px); 
        box-shadow: 4px 4px 8px var(--paper-shadow); 
    }
    
    .reward-item.bronze { 
        border-color: #CD7F32; 
        background: linear-gradient(135deg, #f9f6f0, #f4f0e8); 
    }
    
    .reward-item.silver { 
        border-color: #C0C0C0; 
        background: linear-gradient(135deg, #f8f8f9, #f0f0f2); 
    }
    
    .reward-item.gold { 
        border-color: #FFD700; 
        background: linear-gradient(135deg, #fffcf0, #fdf8e8); 
    }
    
    .reward-item.legend { 
        border-color: #9400D3; 
        background: linear-gradient(135deg, #f8f4ff, #f0e8ff); 
    }
    
    .reward-item.used { 
        opacity: 0.6; 
        filter: grayscale(30%); 
    }
    
    .reward-info { flex: 1; }
    
    .reward-name { 
        font-weight: 600; 
        font-size: 16px; 
        margin-bottom: 6px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .reward-desc { 
        font-size: 13px; 
        color: var(--text-color-light);
        font-family: 'Crimson Text', serif;
        font-style: italic;
    }
    
    .reward-tier { 
        font-size: 11px; 
        font-weight: 600; 
        padding: 3px 8px; 
        border-radius: 0;
        margin-bottom: 6px; 
        display: inline-block;
        font-family: 'Playfair Display', serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .reward-tier.bronze { background: #CD7F32; color: white; }
    .reward-tier.silver { background: #C0C0C0; color: white; }
    .reward-tier.gold { background: #FFD700; color: #333; }
    .reward-tier.legend { background: #9400D3; color: white; }
    
    .reward-actions { display: flex; gap: 10px; }
    
    .reward-btn { 
        padding: 10px 15px; 
        border: 2px solid;
        border-radius: 0;
        font-size: 12px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.2s ease;
        font-family: 'Playfair Display', serif;
        text-transform: uppercase;
    }
    
    .reward-btn.use { 
        background: var(--success-color); 
        color: white;
        border-color: #5a7849;
    }
    
    .reward-btn.use:hover { background: #5a7849; }
    
    .reward-btn.delete { 
        background: var(--danger-color); 
        color: white;
        border-color: #9d3f3c;
    }
    
    .reward-btn.delete:hover { background: #9d3f3c; }
    
    .reward-btn:disabled { 
        opacity: 0.5; 
        cursor: not-allowed; 
    }
    
    .empty-rewards { 
        text-align: center; 
        padding: 50px 25px; 
        color: var(--text-color-light);
        font-style: italic;
        font-family: 'Crimson Text', serif;
    }

    /* 프로필 메뉴 스타일 */
    .profile-menu-item:hover { 
        background: var(--primary-light); 
        color: var(--primary-color); 
    }
    
    /* 프로필 위젯 호버 효과 */
    #profileWidget:hover { transform: translateY(-2px); }
    #profileWidget { transition: transform 0.2s ease; }

    .achievements-list { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
        max-height: 420px; 
        overflow-y: auto; 
    }
    
    .achievement-item { 
        background: var(--aged-paper);
        border: 2px solid var(--border-color);
        border-radius: 0;
        padding: 18px; 
        display: flex; 
        align-items: center; 
        gap: 18px; 
        transition: all 0.2s ease;
        box-shadow: 2px 2px 4px var(--paper-shadow);
    }
    
    .achievement-item.unlocked { 
        border-color: var(--success-color); 
        background: linear-gradient(135deg, #f4f8f2, #eef5ec); 
    }
    
    .achievement-item.locked { opacity: 0.6; }
    
    .achievement-emoji { font-size: 28px; min-width: 45px; text-align: center; }
    
    .achievement-info { flex: 1; }
    
    .achievement-name { 
        font-weight: 600; 
        font-size: 16px; 
        margin-bottom: 6px;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
    }
    
    .achievement-desc { 
        font-size: 13px; 
        color: var(--text-color-light);
        font-family: 'Crimson Text', serif;
        font-style: italic;
    }
    
    .achievement-status { 
        font-size: 12px; 
        font-weight: 600; 
        padding: 5px 10px; 
        border-radius: 0;
        font-family: 'Playfair Display', serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .achievement-status.unlocked { 
        background: var(--success-color); 
        color: white; 
    }
    
    .achievement-status.locked { 
        background: var(--border-color); 
        color: var(--text-color-light); 
    }
    
    .achievement-item.hidden { 
        background: linear-gradient(135deg, #ede8e0, #e5ddd0); 
        color: #8d7b68; 
        border-color: #c4b4a0; 
    }
    
    .achievement-item.hidden .achievement-desc { 
        color: #a09080; 
        font-style: italic; 
    }

    @media (max-width: 767px) {
        body {
            padding: 15px;
        }
        
        .container {
            padding: 45px 25px 100px 25px;
            border-width: 2px;
        }
        
        .container::before {
            left: 35px;
        }
        
        .container {
            background: 
                linear-gradient(90deg, transparent 0%, transparent 35px, rgba(139, 69, 19, 0.1) 35px, rgba(139, 69, 19, 0.1) 37px, transparent 37px),
                var(--container-bg);
        }
        
        .header h1 {
            font-size: 28px;
        }
        
        .modal-content {
            padding: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            max-height: 100vh;
            background: var(--container-bg);
            border-width: 0;
        }
        
        .food-modal {
            width: 90%;
            height: auto;
            border-radius: 0;
            max-height: 90vh;
            border: 2px solid var(--border-color);
        }
        
        .food-modal .modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        #dayModal .modal-body {
            padding: 25px 18px;
        }
        
        .modal-input-group {
            padding: 18px;
        }
        
        .modal-input-group h4 {
            font-size: 16px;
        }
        
        #dayModal .form-group label {
            font-size: 14px;
        }

        #dayModal .modal-input-row {
            grid-template-columns: 1fr;
            gap: 18px;
        }

        .exercise-toggle-btns {
            max-width: 200px;
        }
        
        .score-display-card, .personal-goals-section {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 18px;
        }
        
        .score-display-card .score {
            font-size: 38px;
        }

        #modalTotalExpense {
            text-align: left !important;
        }
        
        .expense-item {
            font-size: 14px;
            word-break: break-all;
        }
        
        .expense-item span:first-child {
            flex-grow: 1;
            margin-right: 12px;
        }
        
        .expense-item > div {
            flex-shrink: 0;
        }
        
        .modal-actions-container {
            padding: 0 18px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .modal-actions-container .btn.delete {
            order: 2;
            background-color: transparent;
            color: var(--text-color-light);
            font-size: 14px;
            font-weight: normal;
            padding: 10px;
            box-shadow: none;
            margin-top: 12px;
            max-width: 160px;
            border: 1px solid var(--border-color);
        }
        
        .modal-actions-container .btn.delete:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        .modal-actions-container .btn.save {
            order: 1;
        }

        #budgetPage .budget-summary {
            flex-wrap: wrap;
        }
        
        #budgetPage .budget-summary .budget-card:first-child {
            flex-basis: 100%;
        }
        
        #budgetPage .budget-card-value {
            font-size: 22px;
        }
        
        #dayModal .expense-input-row {
            flex-direction: column;
            gap: 12px;
        }
        
        #dayModal .expense-input-row input,
        #dayModal .expense-input-row button {
            width: 100%;
        }
        
        .dday-header-container {
            top: 10px;
            left: 5px;
            right: 5px;
        }
        
        .dday-chip {
            font-size: 10px;
            padding: 4px 10px;
        }
        
        .battery {
            width: 28px;
            height: 13px;
        }
        
        .receipt-item {
            font-size: 13px;
        }
    
        .receipt-date {
            min-width: 55px;
            margin-right: 12px;
            font-size: 11px;
        }
    
        .receipt-desc {
            margin-right: 12px;
        }
    
        .receipt-amount {
            min-width: 65px;
            font-size: 13px;
        }
    
        .budget-info {
            flex-direction: column;
            gap: 3px;
            font-size: 11px;
            text-align: right;
        }
        
        .calendar-grid {
            gap: 1px;
        }
        
        .month-nav {
            font-size: 18px;
            padding: 6px 10px;
        }
        
        .month-year {
            font-size: 22px;
        }
        
        .btn {
            font-size: 15px;
            padding: 14px 18px;
        }
    }
    `,

    nature: `
    @font-face {
        font-family: 'KBIZHanmaumMyungjo';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    :root {
        --bg-color: #7a9e7a;
        --primary-color: #5c7c5c;
        --primary-dark: #4a6b4a;
        --primary-light: #e8f0e8;
        --text-color: #2d3d2d;
        --text-color-light: #6b8a6b;
        --border-color: #8db08d;
        --container-bg: #f8fdf8;
        --danger-color: #a0644c;
        --warning-color: #b8935e;
        --success-color: #6b9b4f;
        --neutral-color: #7a8f7a;
        --wood-color: #8b7355;
        --stone-color: #8a8a7a;
        --flower-pink: #d4a5a5;
        --flower-yellow: #e8d98c;
        --leaf-green: #8fbf8f;
        --moss-green: #6f9f6f;
    }

    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
    }

    body { 
        font-family: 'KBIZHanmaumMyungjo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        background: var(--bg-color);
        min-height: 100vh; 
        padding: 20px; 
        color: var(--text-color);
        position: relative;
        overflow-x: hidden;
    }

    /* 자연스러운 잔디 텍스처 효과 */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 15% 20%, rgba(111, 159, 111, 0.3) 2px, transparent 2px),
            radial-gradient(circle at 80% 30%, rgba(143, 191, 143, 0.2) 1px, transparent 1px),
            radial-gradient(circle at 45% 70%, rgba(107, 142, 107, 0.3) 1.5px, transparent 1.5px),
            radial-gradient(circle at 70% 80%, rgba(139, 175, 139, 0.2) 1px, transparent 1px);
        background-size: 120px 80px, 200px 100px, 150px 120px, 180px 90px;
        animation: grassSway 15s ease-in-out infinite;
        pointer-events: none;
        z-index: 1;
    }

    @keyframes grassSway {
        0%, 100% { transform: translateX(0px); }
        50% { transform: translateX(3px); }
    }

    /* 작은 곤충과 나비 효과 */
    body::after {
        content: '';
        position: fixed;
        top: -50px;
        left: -50px;
        width: calc(100% + 100px);
        height: calc(100% + 100px);
        background-image: 
            radial-gradient(1px 1px at 20px 30px, var(--flower-pink), transparent),
            radial-gradient(1px 1px at 90px 60px, var(--flower-yellow), transparent),
            radial-gradient(0.5px 0.5px at 150px 40px, var(--text-color), transparent),
            radial-gradient(0.5px 0.5px at 200px 90px, var(--text-color), transparent);
        background-repeat: repeat;
        background-size: 300px 200px;
        animation: natureDrift 25s linear infinite;
        pointer-events: none;
        z-index: 1;
        opacity: 0.7;
    }

    @keyframes natureDrift {
        0% { transform: translate(0px, 0px); }
        25% { transform: translate(15px, -10px); }
        50% { transform: translate(-8px, -20px); }
        75% { transform: translate(20px, -30px); }
        100% { transform: translate(0px, -40px); }
    }

    button, input, select, textarea { font-family: inherit; }

    .container { 
    background: var(--container-bg); 
    border-radius: 20px; 
    padding: 50px 30px 100px 30px;
    width: 100%; 
    max-width: 500px; 
    margin: 0 auto; 
    box-shadow: 0 8px 32px rgba(45, 61, 45, 0.2);
    position: relative;
    z-index: 2;
    border: 2px solid var(--moss-green);
    animation: containerBreath 8s ease-in-out infinite;
}

    @keyframes containerBreath {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-2px); }
    }

    .header { 
        text-align: center; 
        margin-bottom: 25px; 
        position: relative; 
    }

    .header h1 { 
        color: var(--text-color); 
        font-size: 26px; 
        font-weight: 700; 
        margin-bottom: 8px;
    }

    .header p { 
        color: var(--text-color-light); 
        font-size: 14px; 
    }

    #gameWarning { 
        background: var(--flower-yellow); 
        color: var(--wood-color); 
        border: 2px solid var(--wood-color); 
        border-radius: 12px; 
        padding: 12px; 
        font-size: 14px; 
        font-weight: 500; 
        margin-bottom: 20px; 
        display: none;
    }

    .page { display: none; }
    .page.active { display: block; }

    .calendar-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
    }

    .month-nav { 
        background: var(--stone-color); 
        border: 2px solid var(--text-color); 
        font-size: 24px; 
        color: var(--container-bg); 
        cursor: pointer; 
        padding: 12px; 
        border-radius: 50%; 
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .month-nav:hover { 
        background: var(--wood-color);
        transform: scale(1.1);
    }

    .month-year { 
        font-size: 20px; 
        font-weight: 700;
        color: var(--text-color);
    }

    .calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 2px; /* 4px에서 2px로 변경 */
    margin-bottom: 20px; 
}

    .calendar-header-cell { 
        text-align: center; 
        padding: 10px 5px; 
        font-weight: 600; 
        color: var(--text-color-light); 
        font-size: 12px; 
    }

    .calendar-cell { 
    aspect-ratio: 1; 
    display: grid; 
    grid-template-rows: 1fr auto 1fr; 
    padding: 2px; 
    align-items: center; 
    justify-items: center;
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
    border: 1px solid var(--moss-green); 
    background: var(--leaf-green);
}

    .cell-top-icons { 
        grid-row: 1; 
        display: flex; 
        justify-content: center; 
        gap: 2px; 
        font-size: 9px; 
        width: 100%; 
        height: 100%; 
        align-items: center; 
    }

    .cell-day-number { 
        grid-row: 2; 
        font-weight: 600;
        color: var(--text-color);
        font-size: 14px;
    }

    .calendar-cell.today .cell-day-number { 
        font-weight: 700; 
        color: var(--container-bg);
    }

    .cell-bottom-info { 
        grid-row: 3; 
        font-size: 8px; 
        font-weight: 600; 
        color: var(--text-color-light); 
        width: 100%; 
        text-align: left; 
        padding-right: 4px; 
        align-self: end; 
        padding-bottom: 2px; 
    }

    .calendar-cell.has-data .cell-bottom-info { 
        color: var(--container-bg); 
    }

    .calendar-cell.off-day { 
        background: var(--stone-color); 
        color: var(--container-bg); 
        border-color: var(--neutral-color);
    }

    .off-day-indicator { 
        position: absolute; 
        top: 4px; 
        right: 4px; 
        font-size: 10px; 
    }

    .calendar-cell:hover { 
        transform: translateY(-2px) scale(1.05); 
        box-shadow: 0 4px 16px rgba(45, 61, 45, 0.3);
        border-color: var(--primary-color);
    }

    .calendar-cell.other-month { 
        color: var(--neutral-color); 
        background: var(--bg-color); 
        border-color: var(--bg-color); 
        pointer-events: none; 
        opacity: 0.5;
    }

    .calendar-cell.today { 
        border-color: var(--wood-color); 
        font-weight: 700; 
        background: var(--wood-color);
        box-shadow: 0 0 0 3px var(--flower-yellow);
        animation: todayGlow 3s ease-in-out infinite;
    }

    @keyframes todayGlow {
        0%, 100% { box-shadow: 0 0 0 3px var(--flower-yellow); }
        50% { box-shadow: 0 0 0 5px var(--flower-pink); }
    }

    .calendar-cell.has-data { 
        color: var(--container-bg); 
        border-color: var(--text-color); 
        font-weight: bold; 
    }

    .calendar-cell.score-high { 
        background: var(--success-color);
    }

    .calendar-cell.score-medium { 
        background: var(--warning-color);
    }

    .calendar-cell.score-low { 
        background: var(--danger-color);
    }

    .calendar-cell.score-negative { 
        background: var(--stone-color);
    }

    .score-indicator { 
        position: absolute; 
        bottom: 4px; 
        right: 4px; 
        font-size: 9px; 
        background: var(--text-color); 
        color: var(--container-bg); 
        padding: 1px 4px; 
        border-radius: 4px; 
        font-weight: 700; 
    }

    .form-group { 
        margin-bottom: 20px; 
    }

    .form-group label { 
        display: block; 
        color: var(--text-color); 
        font-weight: 600; 
        margin-bottom: 8px; 
        font-size: 14px; 
    }

    .form-group input, .form-group textarea, .form-group select { 
        width: 100%; 
        padding: 14px; 
        border: 2px solid var(--moss-green); 
        border-radius: 8px; 
        font-size: 16px; 
        transition: all 0.3s ease; 
        font-family: 'KBIZHanmaumMyungjo', sans-serif;
        background: var(--container-bg);
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
        outline: none; 
        border-color: var(--primary-color); 
        box-shadow: 0 0 0 3px var(--leaf-green);
        transform: translateY(-1px);
    }

    .main-actions { 
        display: flex; 
        gap: 12px; 
        margin-bottom: 10px; 
    }

    .btn { 
        width: 100%; 
        padding: 16px; 
        background: var(--wood-color); 
        color: var(--container-bg); 
        border: 2px solid var(--text-color); 
        border-radius: 10px; 
        font-size: 16px; 
        font-weight: 700; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        box-shadow: 0 4px 0 var(--text-color);
        position: relative;
    }

    .btn:hover { 
        background: var(--stone-color); 
        transform: translateY(-2px); 
        box-shadow: 0 6px 0 var(--text-color);
    }

    .btn:active { 
        transform: translateY(2px); 
        box-shadow: 0 2px 0 var(--text-color); 
    }

    .main-actions .btn { flex: 1; }

    .btn.secondary { 
        background: var(--stone-color); 
    }

    .btn.secondary:hover { 
        background: var(--neutral-color); 
    }

    .modal-overlay { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(45, 61, 45, 0.8); 
        z-index: 1000; 
        align-items: center; 
        justify-content: center; 
    }

    .modal-content { 
        background: var(--container-bg); 
        padding: 0; 
        border-radius: 16px; 
        width: 90%; 
        max-width: 800px; 
        max-height: 95vh; 
        overflow-y: auto; 
        box-shadow: 0 16px 48px rgba(45, 61, 45, 0.4);
        border: 3px solid var(--moss-green);
        animation: modalBounce 0.5s ease-out;
    }

    @keyframes modalBounce {
        0% {
            opacity: 0;
            transform: scale(0.8) translateY(50px);
        }
        60% {
            transform: scale(1.05) translateY(-10px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    #dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { 
        padding: 20px 25px; 
        border-bottom: 2px solid var(--moss-green); 
        background: var(--leaf-green); 
        border-top-left-radius: 13px; 
        border-top-right-radius: 13px; 
    }

    #dayModal .modal-body { 
        padding: 25px; 
    }

    .modal-layout { 
        display: block; 
    }

    @media (min-width: 768px) { 
        .modal-layout { 
            display: block; 
        } 
    }

    .modal-side-column { 
        display: flex; 
        flex-direction: column; 
    }

    .modal-input-group { 
        background: var(--container-bg); 
        padding: 20px; 
        border-radius: 12px; 
        border: 2px solid var(--moss-green); 
    }

    .modal-input-group h4 { 
        font-size: 16px; 
        margin-bottom: 15px; 
        padding-bottom: 10px; 
        border-bottom: 1px solid var(--moss-green); 
        color: var(--text-color);
    }

    .modal-input-row { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
        gap: 15px; 
    }

    #commentDetails summary { 
        font-weight: 600; 
        color: var(--text-color); 
        cursor: pointer; 
        padding: 12px; 
        border-radius: 8px; 
        background: var(--leaf-green); 
        border: 2px solid var(--moss-green); 
        list-style: none; 
        position: relative; 
        padding-left: 35px;
        transition: all 0.3s ease;
    }

    #commentDetails summary:hover {
        background: var(--moss-green);
        color: var(--container-bg);
    }

    #commentDetails summary::-webkit-details-marker { 
        display: none; 
    }

    #commentDetails summary::before { 
        content: '🌱'; 
        position: absolute; 
        left: 12px; 
        top: 50%; 
        transform: translateY(-50%); 
        font-size: 12px; 
        transition: transform 0.3s ease; 
    }

    #commentDetails[open] > summary::before { 
        transform: translateY(-50%) rotate(90deg); 
    }

    .legend { 
        display: flex; 
        justify-content: center; 
        flex-wrap: wrap; 
        margin: 20px 0 0; 
        font-size: 12px; 
        gap: 15px; 
    }

    .legend-item { 
        display: flex; 
        align-items: center; 
        gap: 8px;
        padding: 6px 12px;
        background: var(--leaf-green);
        border-radius: 16px;
        border: 2px solid var(--moss-green);
    }

    .legend-color { 
        width: 14px; 
        height: 14px; 
        border-radius: 50%; 
        border: 2px solid var(--text-color);
    }

    .calendar-cell.skeleton { 
        background: var(--neutral-color); 
        border: 2px solid var(--moss-green); 
        position: relative; 
        overflow: hidden; 
        opacity: 0.7;
    }

    .calendar-cell.skeleton::before { 
        content: ''; 
        position: absolute; 
        top: 0; 
        left: -100%; 
        width: 100%; 
        height: 100%; 
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); 
        animation: shimmer 2s infinite ease-in-out; 
    }

    @keyframes shimmer { 
        0% { left: -100%; } 
        100% { left: 100%; } 
    }

    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-color);
        font-size: 12px;
        z-index: 10;
        background: var(--flower-yellow);
        padding: 8px 16px;
        border-radius: 16px;
        border: 2px solid var(--wood-color);
        font-weight: 600;
    }

    /* 나머지 기본 스타일들 */
    #dayModal .form-group { margin-bottom: 0; }
    #dayModal .form-group label { font-size: 13px; margin-bottom: 6px; }
    #dayModal .form-group input { padding: 10px; font-size: 16px; }
    #dayModal .modal-input-group, #dayModal .score-display-card { margin-bottom: 5px; }
    #dayModal .modal-layout > div:last-child { margin-bottom: 0; }
    
    .modal-header { display: flex; justify-content: center; align-items: center; position: relative; gap: 20px; }
    .modal-title { flex: none; text-align: center; margin: 0; color: var(--text-color); font-weight: 700; }
    
    .date-nav-btn { background: var(--stone-color); border: 2px solid var(--text-color); font-size: 24px; color: var(--container-bg); cursor: pointer; padding: 10px; border-radius: 50%; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .date-nav-btn:hover { background: var(--wood-color); transform: scale(1.1); }
    
    .close-btn { background: var(--danger-color); border: 2px solid var(--text-color); font-size: 28px; cursor: pointer; color: var(--container-bg); line-height: 1; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .close-btn:hover { background: var(--stone-color); }
    
    .score-display-card { background: var(--container-bg); border-radius: 12px; padding: 20px; text-align: center; border: 2px solid var(--moss-green); }
    .score-display-card .score { font-size: 40px; font-weight: 700; color: var(--primary-color); line-height: 1; }
    .score-display-card .score.is-off { color: var(--neutral-color); }
    .score-display-card div:last-child { font-size: 14px; color: var(--text-color-light); margin-top: 5px; }
    
    .exercise-toggle-group { margin-bottom: 15px; }
    .exercise-toggle-group label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .exercise-toggle-btns { display: flex; border: 2px solid var(--moss-green); border-radius: 8px; overflow: hidden; }
    .exercise-toggle-btn { flex: 1; padding: 12px; border: none; background: var(--container-bg); cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 14px; color: var(--text-color); }
    .exercise-toggle-btn.active { background: var(--success-color); color: var(--container-bg); }
    
    .goal-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .goal-tab { padding: 10px 18px; background: var(--leaf-green); border: 2px solid var(--moss-green); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; color: var(--text-color); }
    .goal-tab.active { background: var(--wood-color); color: var(--container-bg); border-color: var(--text-color); }
    .goal-tab:hover:not(.active) { background: var(--moss-green); color: var(--container-bg); }
    
    .goal-type-toggle { display: flex; gap: 6px; margin-bottom: 15px; }
    .goal-type-toggle button { flex: 1; padding: 10px; font-size: 14px; border: 2px solid var(--moss-green); background: var(--leaf-green); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; color: var(--text-color); }
    .goal-type-toggle button.active { background: var(--wood-color); color: var(--container-bg); border-color: var(--text-color); }
    
    #personalGoalsPage .header { text-align: left; }
    
    .dday-header-container { height: auto; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-start; position: absolute; top: 10px; left: 10px; right: 10px; z-index: 10; pointer-events: none; }
    
    .dday-chip { background: var(--flower-yellow); color: var(--wood-color); padding: 6px 12px; border-radius: 12px; font-weight: 700; font-size: 11px; display: none; pointer-events: all; border: 2px solid var(--wood-color); }
    
    .battery { display: none; width: 32px; height: 16px; border: 2px solid var(--text-color); border-radius: 4px; position: relative; padding: 2px; background: var(--container-bg); }
    .battery::after { content: ''; position: absolute; top: 50%; right: -6px; transform: translateY(-50%); width: 3px; height: 8px; background: var(--text-color); border-radius: 0 2px 2px 0; }
    .battery-level { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
    .battery-level.green { background: var(--success-color); } 
    .battery-level.yellow { background: var(--warning-color); } 
    .battery-level.red { background: var(--danger-color); } 
    .battery-level.black { background: var(--text-color); }
    
    .budget-summary { display: flex; gap: 12px; margin-bottom: 20px; }
    .budget-card { flex: 1; background: var(--leaf-green); color: var(--text-color); padding: 18px; border-radius: 12px; text-align: center; border: 2px solid var(--moss-green); }
    .budget-card-title { font-size: 13px; opacity: 0.9; margin-bottom: 10px; font-weight: 600; }
    .budget-card-value { font-size: 22px; font-weight: 700; }
    
    #budgetPage .header p { font-size: 16px; font-weight: 600; color: var(--text-color); }
    
    .personal-goals-section { background: var(--container-bg); padding: 18px; border-radius: 12px; border: 2px solid var(--moss-green); }
    
    #modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }
    
    .personal-goal-checkbox { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--container-bg); border-radius: 8px; margin-bottom: 10px; border: 2px solid var(--moss-green); transition: all 0.3s ease; }
    .personal-goal-checkbox:hover { background: var(--leaf-green); }
    
    .personal-goal-item { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px; margin-bottom: 12px; transition: all 0.3s ease; }
    .personal-goal-item:hover { transform: translateY(-2px); background: var(--leaf-green); }
    
    .personal-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .personal-goal-name { font-weight: 600; color: var(--text-color); }
    .personal-goal-actions button { padding: 6px 12px; border-radius: 6px; font-size: 12px; border: 2px solid var(--text-color); cursor: pointer; color: var(--container-bg); transition: all 0.3s ease; font-weight: 600; }
    .edit-btn { background: var(--warning-color); }
    .delete-btn { background: var(--danger-color); }
    .complete-btn { background: var(--success-color); }
    .reopen-btn { background: var(--primary-color); }
    
    .empty-goals { text-align: center; color: var(--text-color-light); padding: 40px 20px; background: var(--leaf-green); border-radius: 12px; margin-top: 20px; border: 2px solid var(--moss-green); }
    
    .budget-settings, .dday-settings { margin-bottom: 30px; }
    .budget-input, .dday-actions { display: flex; gap: 12px; align-items: center; }
    
    .dday-item { background: var(--leaf-green); border-radius: 12px; padding: 15px 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--moss-green); transition: all 0.3s ease; }
    .dday-item:hover { background: var(--moss-green); color: var(--container-bg); }
    
    .budget-input button { padding: 14px 24px; background: var(--success-color); color: var(--container-bg); border: 2px solid var(--text-color); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 0 var(--text-color); }
    .budget-input button:hover { background: var(--wood-color); transform: translateY(-1px); box-shadow: 0 4px 0 var(--text-color); }
    
    .wakeup-prompt { background: var(--flower-pink); color: var(--text-color); padding: 24px; border-radius: 16px; text-align: center; margin-bottom: 20px; border: 2px solid var(--wood-color); }
    
    .monthly-summary { display: flex; justify-content: space-around; gap: 15px; margin-bottom: 30px; }
    .summary-card { flex-basis: 30%; background: var(--leaf-green); color: var(--text-color); padding: 24px; border-radius: 16px; text-align: center; border: 2px solid var(--moss-green); }
    .summary-title { font-size: 14px; opacity: 0.9; margin-bottom: 12px; font-weight: 600; }
    .summary-value { font-size: 24px; font-weight: 700; }
    
    .week-card { background: var(--container-bg); border-radius: 16px; padding: 24px; margin-bottom: 18px; border: 2px solid var(--moss-green); }
    .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; font-weight: 600; color: var(--text-color); }
    .week-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; font-size: 22px; font-weight: 600; color: var(--text-color); }
    
    .empty-expenses { text-align: center; color: var(--text-color-light); padding: 40px 20px; }
    
    .feedback-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 61, 45, 0.8); display: none; z-index: 2000; animation: fadeIn 0.3s ease; justify-content: center; align-items: center; }
    .feedback-content { position: relative; background: var(--container-bg); padding: 48px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(45, 61, 45, 0.5); animation: popIn 0.5s ease; border: 3px solid var(--moss-green); }
    .feedback-emoji { font-size: 60px; margin-bottom: 24px; display: block; }
    .feedback-title { font-size: 24px; font-weight: 700; margin-bottom: 18px; color: var(--text-color); }
    .feedback-message { font-size: 16px; color: var(--text-color-light); line-height: 1.6; margin-bottom: 28px; }
    
    .feedback-celebration .feedback-content { background: var(--success-color); }
    .feedback-celebration .feedback-title, .feedback-celebration .feedback-message { color: var(--container-bg); }
    .feedback-reflection .feedback-content { background: var(--warning-color); }
    .feedback-reflection .feedback-title, .feedback-reflection .feedback-message { color: var(--container-bg); }
    .feedback-disaster .feedback-content { background: var(--stone-color); }
    .feedback-disaster .feedback-title, .feedback-disaster .feedback-message { color: var(--container-bg); }
    .feedback-encouragement .feedback-content { background: var(--primary-color); }
    .feedback-encouragement .feedback-title, .feedback-encouragement .feedback-message { color: var(--container-bg); }
    .feedback-warning .feedback-content { background: var(--danger-color); }
    .feedback-warning .feedback-title, .feedback-warning .feedback-message { color: var(--container-bg); }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    
    .feedback-btn { background: var(--wood-color); color: var(--container-bg); border: 2px solid var(--text-color); padding: 14px 32px; border-radius: 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 0 12px; box-shadow: 0 3px 0 var(--text-color); }
    .feedback-btn:hover { background: var(--stone-color); transform: translateY(-2px); box-shadow: 0 5px 0 var(--text-color); }
    
    .feedback-budget-red .feedback-content { background: var(--danger-color) !important; }
    .feedback-budget-black .feedback-content { background: var(--stone-color) !important; }
    
    .expense-input-row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
    .expense-input-row input { flex: 1; padding: 14px; font-size: 14px; border-radius: 8px; border: 2px solid var(--moss-green); background: var(--container-bg); }
    .expense-input-row button { flex-shrink: 0; width: 48px; height: 48px; border-radius: 10px; background: var(--wood-color); border: 2px solid var(--text-color); color: var(--container-bg); font-weight: bold; cursor: pointer; font-size: 24px; line-height: 48px; transition: all 0.3s ease; box-shadow: 0 3px 0 var(--text-color); }
    .expense-input-row button:hover { background: var(--stone-color); transform: translateY(-1px); box-shadow: 0 4px 0 var(--text-color); }
    
    .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 14px; border-bottom: 1px solid var(--moss-green); color: var(--text-color); }
    
    .dday-settings h4 { margin-bottom: 18px; color: var(--text-color); font-weight: 600; }
    .dday-item .dday-actions { display: flex; gap: 8px; }
    .dday-item .dday-actions button { background: var(--stone-color); border: 2px solid var(--text-color); width: 34px; height: 34px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.3s ease; color: var(--container-bg); font-weight: bold; }
    .dday-item .dday-actions button:hover { background: var(--wood-color); transform: scale(1.1); }
    
    .excel-option-item { display: flex; align-items: center; padding: 10px 0; cursor: pointer; transition: all 0.3s ease; border-radius: 8px; }
    .excel-option-item:hover { background: var(--leaf-green); }
    .excel-option-item input[type="radio"] { width: 20px; height: 20px; margin-right: 14px; }
    .excel-option-item label { font-size: 16px; color: var(--text-color); }
    
    #customDateRange { display: flex; gap: 12px; align-items: center; margin-top: 12px; margin-bottom: 20px; }
    #customDateRange input[type="date"] { padding: 12px; border-radius: 8px; border: 2px solid var(--moss-green); flex: 1; font-family: inherit; background: var(--container-bg); }

    .number-input-group {
        display: flex;
        align-items: center;
        border: 2px solid var(--moss-green);
        border-radius: 8px;
        overflow: hidden;
        background: var(--container-bg);
    }

    .number-input-group input {
        border: none;
        text-align: center;
        flex: 1;
        padding: 12px 8px;
        background: transparent;
        font-weight: 600;
        color: var(--text-color);
    }

    .number-input-group input:focus { box-shadow: none; border: none; }

    .number-btn {
        width: 36px;
        height: 46px;
        border: none;
        background: var(--stone-color);
        color: var(--container-bg);
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .number-btn:hover { 
        background: var(--wood-color); 
        transform: scale(1.05);
    }
    .number-btn:active { 
        background: var(--primary-color); 
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .food-page-actions { display: flex; gap: 12px; margin-bottom: 12px; }
    .food-page-actions .btn.secondary.danger { background: var(--danger-color); color: var(--container-bg); }
    
    .food-date-header { display: flex; align-items: center; text-align: center; margin: 30px 0 12px; color: var(--text-color-light); }
    .food-date-header::before, .food-date-header::after { content: ''; flex: 1; border-bottom: 2px solid var(--moss-green); }
    .food-date-header span { padding: 0 18px; font-size: 13px; font-weight: 600; }
    
    .food-record-item { display: grid; grid-template-columns: 50px 30px 1fr auto; gap: 18px; align-items: center; padding: 16px 8px; border-bottom: 1px solid var(--moss-green); position: relative; transition: all 0.3s ease; }
    .food-record-item:hover { background: var(--leaf-green); border-radius: 8px; }
    
    .food-record-item .food-admin-actions { position: absolute; right: 0px; top: 50%; transform: translateY(-50%); display: flex; gap: 6px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .food-records.admin-mode .food-record-item .food-admin-actions { opacity: 1; pointer-events: auto; }
    
    .food-admin-actions button { background: var(--stone-color); border: 2px solid var(--text-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 14px; transition: all 0.3s ease; color: var(--container-bg); font-weight: bold; }
    .food-admin-actions button.edit { background: var(--warning-color); }
    .food-admin-actions button.delete { background: var(--danger-color); }
    .food-admin-actions button:hover { transform: scale(1.1); }
    
    #foodExportModal .modal-content { max-width: 90vw; background: var(--container-bg); padding: 0; border: 3px solid var(--moss-green); }
    #foodExportPreview {
        background: var(--container-bg);
        border-radius: 12px;
        padding: 0;
        margin: 24px;
        box-shadow: 0 8px 24px rgba(45, 61, 45, 0.3);
        font-family: 'Courier New', monospace;
        border: 2px solid var(--moss-green);
    }
    
    .food-receipt-header { padding: 18px 24px 12px; background: var(--leaf-green); }
    .food-receipt-title { display: block; text-align: center; margin-bottom: 6px; }
    .food-receipt-title h3 { margin: 0; font-size: 16px; color: var(--text-color); font-weight: 700; }
    .food-receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
    
    .food-receipt-divider {
        height: 2px;
        background: repeating-linear-gradient(
            to right,
            var(--moss-green) 0px,
            var(--moss-green) 3px,
            transparent 3px,
            transparent 6px
        );
        margin: 0 18px;
    }
    
    .food-receipt-items { padding: 18px 24px 12px; }
    .food-receipt-date-header { font-weight: 700; color: var(--primary-color); font-size: 13px; margin: 18px 0 10px 0; padding-bottom: 6px; border-bottom: 1px dashed var(--moss-green); }
    .food-receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 13px; line-height: 1.4; color: var(--text-color); }
    .food-receipt-time { color: var(--text-color-light); font-size: 11px; min-width: 48px; margin-right: 12px; }
    .food-receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 12px; }
    .food-receipt-quantity { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 65px; }
    
    #foodExportModal .close-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        background: var(--danger-color);
        border: 2px solid var(--text-color);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        font-size: 20px;
        color: var(--container-bg);
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    #foodExportModal .close-btn:hover { 
        background: var(--stone-color); 
        transform: scale(1.1);
    }

    .food-modal { max-width: 420px; background: var(--container-bg); overflow: hidden; border: 3px solid var(--moss-green); }
    .food-modal .modal-header { padding: 18px 24px; background: var(--leaf-green); border-bottom: 2px solid var(--moss-green); }
    .food-modal .modal-header h2 { font-size: 18px; color: var(--text-color); }
    .food-modal .modal-body { padding: 24px; }
    .food-modal .form-group { margin-bottom: 18px; }
    .food-modal .form-group label { font-size: 13px; margin-bottom: 8px; color: var(--text-color); }
    .food-modal .form-group input, .food-modal .form-group select { padding: 12px; font-size: 15px; border-radius: 8px; border: 2px solid var(--moss-green); background: var(--container-bg); }
    .food-modal .quantity-input { display: flex; gap: 10px; }
    .food-modal .quantity-input select { width: 95px; }
    .food-modal .food-modal-actions { margin-top: 24px; display: flex; gap: 12px; }
    .food-modal .food-modal-actions .btn { flex: 1; padding: 14px; border-radius: 8px; }

    .fame-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
    .fame-card { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px; text-align: center; transition: all 0.3s ease; }
    .fame-card:hover { transform: translateY(-2px); background: var(--leaf-green); }
    .fame-card-title { font-size: 18px; margin-bottom: 10px; color: var(--text-color); }
    .fame-card-value { font-size: 20px; font-weight: 700; color: var(--primary-color); }
    .fame-card-date { font-size: 12px; color: var(--text-color-light); margin-top: 6px; }
    #wallOfShame .fame-card-value { color: var(--danger-color); }

    #modalCommentSection { margin-top: 24px; }
    #modalComment { width: 100%; margin-top: 18px; height: 85px; resize: vertical; font-size: 16px; border-radius: 8px; border: 2px solid var(--moss-green); background: var(--container-bg); padding: 14px; color: var(--text-color); }
    #modalPersonalGoalsList input[type="number"] { font-size: 16px; }

    .comment-history-list { max-height: 450px; overflow-y: auto; padding-right: 8px; }
    .comment-item { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px 24px; margin-bottom: 15px; transition: all 0.3s ease; }
    .comment-item:hover { background: var(--leaf-green); }
    .comment-item-header { font-size: 13px; color: var(--text-color-light); font-weight: 600; margin-bottom: 12px; }
    .comment-item-body { font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; color: var(--text-color); }
    .empty-comments { text-align: center; color: var(--text-color-light); padding: 50px 20px; background: var(--leaf-green); border-radius: 12px; border: 2px solid var(--moss-green); }
    
    .receipt-container {
        background: var(--container-bg);
        border-radius: 12px;
        padding: 0;
        margin-top: 0; 
        margin-bottom: 24px; 
        box-shadow: 0 8px 24px rgba(45, 61, 45, 0.3);
        font-family: 'Courier New', monospace;
        max-width: 100%;
        overflow: hidden;
        border: 2px solid var(--moss-green);
    }
    
    .receipt-header { padding: 18px 24px 12px; background: var(--leaf-green); }
    .receipt-title { display: block; text-align: center; margin-bottom: 6px; position: relative; }
    .receipt-title h3 { margin: 0; font-size: 16px; color: var(--text-color); font-weight: 700; }
    .budget-info { display: flex; flex-direction: column; gap: 4px; font-size: 11px; color: var(--text-color); font-weight: 600; text-align: right; position: absolute; top: -6px; right: -10px; }
    .receipt-header p { margin: 0; font-size: 12px; color: var(--text-color-light); text-align: center; }
    
    .receipt-divider { 
        height: 2px; 
        background: repeating-linear-gradient(
            to right, 
            var(--moss-green) 0px, 
            var(--moss-green) 3px, 
            transparent 3px, 
            transparent 6px
        ); 
        margin: 0 18px; 
    }
    
    .receipt-items { padding: 18px 24px 12px; }
    .receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; font-size: 13px; line-height: 1.4; transition: all 0.2s ease; color: var(--text-color); }
    .receipt-item:hover { background: var(--leaf-green); border-radius: 6px; }
    .receipt-date { color: var(--text-color-light); font-size: 11px; min-width: 65px; margin-right: 18px; }
    .receipt-desc { flex: 1; font-weight: 600; color: var(--text-color); margin-right: 18px; }
    .receipt-amount { font-weight: 700; color: var(--text-color); font-size: 13px; text-align: right; min-width: 75px; }
    .receipt-total { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; background: var(--moss-green); font-weight: 700; font-size: 16px; font-family: 'Courier New', monospace; color: var(--container-bg); }

    #dailyQuestModal .modal-header { padding-top: 30px; padding-bottom: 18px; }
    
    /* 퀘스트 페이지 스타일 */
    .quest-tabs { display: flex; gap: 12px; margin-bottom: 24px; }
    .quest-tab { padding: 10px 20px; background: var(--leaf-green); border: 2px solid var(--moss-green); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; color: var(--text-color); }
    .quest-tab.active { background: var(--wood-color); color: var(--container-bg); border-color: var(--text-color); }
    .quest-tab:hover:not(.active) { background: var(--moss-green); color: var(--container-bg); }
    
    .quest-list { display: flex; flex-direction: column; gap: 12px; }
    .quest-item { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px; transition: all 0.3s ease; }
    .quest-item:hover { transform: translateY(-2px); background: var(--leaf-green); }
    .quest-item.completed { background: var(--success-color); color: var(--container-bg); border-color: var(--text-color); }
    .quest-item.completed .quest-reward { color: var(--container-bg); }
    
    .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .quest-title { font-weight: 600; font-size: 14px; color: var(--text-color); }
    .quest-item.completed .quest-title { color: var(--container-bg); }
    .quest-reward { font-size: 12px; color: var(--primary-color); font-weight: 600; }
    
    .quest-desc { font-size: 13px; color: var(--text-color-light); margin-bottom: 12px; }
    .quest-item.completed .quest-desc { color: var(--container-bg); opacity: 0.9; }
    
    .quest-progress { display: flex; justify-content: space-between; align-items: center; }
    .quest-progress-bar { flex: 1; height: 8px; background: var(--leaf-green); border: 1px solid var(--moss-green); border-radius: 4px; margin-right: 12px; overflow: hidden; }
    .quest-progress-fill { height: 100%; background: var(--wood-color); transition: width 0.4s ease; border-radius: 3px; }
    .quest-progress-text { font-size: 11px; color: var(--text-color-light); min-width: 45px; text-align: right; font-weight: 600; }
    
    .quest-item.completed .quest-progress-bar { background: var(--container-bg); opacity: 0.7; }
    .quest-item.completed .quest-progress-fill { background: var(--container-bg); }
    .quest-item.completed .quest-progress-text { color: var(--container-bg); opacity: 0.9; }

    /* 보상 시스템 스타일 */
    #rewardsModal .modal-header { padding: 36px 30px 24px 30px; border-bottom: 2px solid var(--moss-green); background: var(--leaf-green); border-top-left-radius: 13px; border-top-right-radius: 13px; }
    
    .rewards-list { display: flex; flex-direction: column; gap: 15px; max-height: 400px; overflow-y: auto; }
    .reward-item { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
    .reward-item:hover { transform: translateY(-2px); background: var(--leaf-green); }
    
    .reward-item.bronze { border-color: #CD7F32; background: var(--flower-yellow); }
    .reward-item.silver { border-color: #C0C0C0; background: var(--stone-color); color: var(--container-bg); }
    .reward-item.gold { border-color: #FFD700; background: var(--flower-yellow); }
    .reward-item.legend { border-color: #9400D3; background: var(--flower-pink); }
    .reward-item.used { opacity: 0.6; transform: none !important; }
    
    .reward-info { flex: 1; }
    .reward-name { font-weight: 600; font-size: 16px; margin-bottom: 6px; color: var(--text-color); }
    .reward-desc { font-size: 13px; color: var(--text-color-light); }
    .reward-tier { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 6px; margin-bottom: 6px; display: inline-block; }
    .reward-tier.bronze { background: #CD7F32; color: white; }
    .reward-tier.silver { background: #C0C0C0; color: white; }
    .reward-tier.gold { background: #FFD700; color: #333; }
    .reward-tier.legend { background: #9400D3; color: white; }
    
    .reward-actions { display: flex; gap: 10px; }
    .reward-btn { padding: 10px 14px; border: 2px solid var(--text-color); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .reward-btn.use { background: var(--success-color); color: var(--container-bg); }
    .reward-btn.use:hover { background: var(--wood-color); }
    .reward-btn.delete { background: var(--danger-color); color: var(--container-bg); }
    .reward-btn.delete:hover { background: var(--stone-color); }
    .reward-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    
    .empty-rewards { text-align: center; padding: 40px 20px; color: var(--text-color-light); }

    /* 프로필 메뉴 스타일 */
    .profile-menu-item:hover { background: var(--leaf-green); color: var(--text-color); border-radius: 8px; }
    
    #profileWidget:hover { transform: translateY(-2px); }
    #profileWidget { transition: all 0.3s ease; }

    .achievements-list { display: flex; flex-direction: column; gap: 15px; max-height: 400px; overflow-y: auto; }
    .achievement-item { background: var(--container-bg); border: 2px solid var(--moss-green); border-radius: 12px; padding: 18px; display: flex; align-items: center; gap: 18px; transition: all 0.3s ease; }
    .achievement-item.unlocked { border-color: var(--success-color); background: var(--leaf-green); }
    .achievement-item.unlocked:hover { transform: translateY(-2px); background: var(--moss-green); color: var(--container-bg); }
    .achievement-item.locked { opacity: 0.6; }
    
    .achievement-emoji { font-size: 28px; min-width: 45px; text-align: center; }
    .achievement-info { flex: 1; }
    .achievement-name { font-weight: 600; font-size: 16px; margin-bottom: 6px; color: var(--text-color); }
    .achievement-desc { font-size: 13px; color: var(--text-color-light); }
    .achievement-status { font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 6px; border: 1px solid var(--text-color); }
    .achievement-status.unlocked { background: var(--success-color); color: var(--container-bg); }
    .achievement-status.locked { background: var(--stone-color); color: var(--container-bg); }
    
    .achievement-item.hidden { background: var(--stone-color); color: var(--container-bg); border-color: var(--text-color); }
    .achievement-item.hidden .achievement-desc { color: var(--container-bg); opacity: 0.8; font-style: italic; }

    /* 모바일 반응형 스타일 */
    @media (max-width: 767px) {
        .modal-content { padding: 0; width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
        .food-modal { width: 90%; height: auto; border-radius: 16px; max-height: 90vh; }
        .food-modal .modal-body { overflow-y: auto; max-height: calc(90vh - 140px); }
        
        #dayModal .modal-body { padding: 20px 18px; }
        .modal-input-group { padding: 18px; }
        .modal-input-group h4 { font-size: 15px; }
        #dayModal .form-group label { font-size: 13px; }
        #dayModal .modal-input-row { grid-template-columns: 1fr; gap: 18px; }
        .exercise-toggle-btns { max-width: 200px; }
        .score-display-card, .personal-goals-section { width: 100%; max-width: none; margin: 0; padding: 18px; }
        .score-display-card .score { font-size: 36px; }

        #modalTotalExpense { text-align: left !important; }
        .expense-item { font-size: 13px; word-break: break-all; }
        .expense-item span:first-child { flex-grow: 1; margin-right: 12px; }
        .expense-item > div { flex-shrink: 0; }
        
        .modal-actions-container { padding: 0 18px 24px; display: flex; flex-direction: column; align-items: center; }
        .modal-actions-container .btn.delete {
            order: 2;
            background-color: transparent;
            color: var(--text-color-light);
            font-size: 14px;
            font-weight: normal;
            padding: 10px;
            box-shadow: none;
            margin-top: 12px;
            max-width: 160px;
        }
        .modal-actions-container .btn.delete:hover { background-color: transparent; color: var(--danger-color); }
        .modal-actions-container .btn.save { order: 1; }

        #budgetPage .budget-summary { flex-wrap: wrap; }
        #budgetPage .budget-summary .budget-card:first-child { flex-basis: 100%; }
        #budgetPage .budget-card-value { font-size: 20px; }
        #dayModal .expense-input-row { flex-direction: column; gap: 12px; }
        #dayModal .expense-input-row input,
        #dayModal .expense-input-row button { width: 100%; }
        
        .dday-header-container { top: 10px; left: 5px; right: 5px; }
        .container { padding: 40px 16px 100px 16px; max-width: 100%; margin: 0 10px; animation-duration: 12s; }
        .calendar-grid { gap: 1px; padding: 8px; }
        .calendar-cell { border: 1px solid var(--moss-green); padding: 1px; min-height: 40px; }
        .cell-day-number { font-size: 13px; }
        .cell-top-icons { font-size: 8px; }
        .cell-bottom-info { font-size: 7px; }
        .dday-chip { font-size: 10px; padding: 4px 10px; }
        .battery { width: 28px; height: 14px; }
        
        .receipt-item { font-size: 12px; }
        .receipt-date { min-width: 55px; margin-right: 12px; font-size: 10px; }
        .receipt-desc { margin-right: 12px; }
        .receipt-amount { min-width: 65px; font-size: 12px; }
        .budget-info { flex-direction: column; gap: 2px; font-size: 10px; text-align: right; }

        #foodExportModal.modal-overlay { background: var(--bg-color); }
        
        #foodExportModal .modal-content { max-width: 100vw; width: 100vw; height: 100vh; margin: 0; padding: 0; border-radius: 0; box-shadow: none; }
        #foodExportPreview { margin: 0; border-radius: 0; box-shadow: none; height: calc(100vh - 60px); overflow-y: auto; }
        
        #foodExportModal .close-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            width: 44px;
            height: 44px;
            font-size: 22px;
            background: var(--danger-color);
            z-index: 1000;
        }
        
        #foodExportModal .modal-content > div:last-child {
            position: fixed; 
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--container-bg);
            padding: 18px;
            border-top: 2px solid var(--moss-green);
        }
        
        /* 자연 효과는 모바일에서 성능을 위해 줄임 */
        body::before, body::after {
            animation-duration: 25s;
        }
        
        .calendar-cell:hover {
            transform: translateY(-1px) scale(1.02);
        }
    }
    `,

    military: `
    @font-face {
    font-family: 'KBIZHanmaumMyungjo';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/KBIZHanmaumMyungjo.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

:root {
    --bg-color: #2c3e42;
    --primary-color: #4a6741;
    --primary-dark: #3a5233;
    --primary-light: #e8ede7;
    --text-color: #1a2b1f;
    --text-color-light: #556b5d;
    --border-color: #3d4f45;
    --container-bg: #f4f6f3;
    --danger-color: #8b4513;
    --warning-color: #b8860b;
    --success-color: #4a6741;
    --neutral-color: #6b7b73;
    --scope-green: #3d5c3a;
    --military-accent: #8b9d83;
    --tactical-border: #2a3d32;
}

/* ===== 기본 설정 ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: 'KBIZHanmaumMyungjo', 'Courier New', monospace; 
    background: linear-gradient(135deg, var(--bg-color) 0%, #243832 50%, var(--bg-color) 100%);
    background-attachment: fixed;
    min-height: 100vh; 
    padding: 20px; 
    color: var(--text-color);
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(74, 103, 65, 0.03) 2px, transparent 2px),
        radial-gradient(circle at 75% 75%, rgba(74, 103, 65, 0.03) 2px, transparent 2px);
    background-size: 40px 40px;
    z-index: -1;
    pointer-events: none;
}

button, input, select, textarea { font-family: inherit; }

/* ===== 컨테이너 ===== */
.container { 
    background: var(--container-bg); 
    border: 3px solid var(--tactical-border);
    border-radius: 15px; 
    padding: 50px 30px 100px 30px;
    width: 100%; 
    max-width: 500px; 
    margin: 0 auto; 
    box-shadow: 
        0 0 0 1px rgba(74, 103, 65, 0.2),
        0 8px 32px rgba(26, 43, 31, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: relative;
    backdrop-filter: blur(5px);
}

.container::before {
    content: '';
    position: absolute;
    top: 8px; left: 8px; right: 8px; bottom: 8px;
    border: 1px dashed rgba(74, 103, 65, 0.3);
    border-radius: 8px;
    pointer-events: none;
}

/* ===== 헤더 (총격 효과) ===== */
.header { 
    text-align: center; 
    margin-bottom: 25px; 
    position: relative;
    padding: 20px 15px;
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.05), rgba(61, 92, 58, 0.05));
    border: 2px solid var(--tactical-border);
    clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px));
}

.header::before {
    content: '';
    position: absolute; top: 8px; right: 25px;
    width: 6px; height: 6px;
    background: var(--text-color);
    border-radius: 50%;
    box-shadow: 
        -15px 12px 0 -1px var(--text-color),
        -8px 25px 0 -2px var(--text-color),
        12px 8px 0 -1px var(--text-color);
    opacity: 0.3;
}

.header::after {
    content: '';
    position: absolute; top: 10px; right: 27px;
    width: 20px; height: 1px;
    background: linear-gradient(45deg, transparent 40%, var(--text-color) 50%, transparent 60%);
    opacity: 0.2;
    transform: rotate(15deg);
}

.header h1 { 
    color: var(--text-color); 
    font-size: 26px; font-weight: 700; 
    margin-bottom: 8px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    letter-spacing: 1px;
    font-family: 'Courier New', monospace;
    text-transform: uppercase;
}

.header p { 
    color: var(--text-color-light); 
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* ===== 페이지 ===== */
#gameWarning { 
    background: linear-gradient(135deg, #f4f1e8, #ede6d3); 
    color: var(--warning-color); 
    border: 2px solid var(--warning-color); 
    border-radius: 8px; 
    padding: 12px; 
    font-size: 14px; font-weight: 600; 
    margin-bottom: 20px; 
    display: none;
    box-shadow: 0 2px 8px rgba(184, 134, 11, 0.2);
}

.page { display: none; }
.page.active { display: block; }

/* ===== 캘린더 헤더 ===== */
.calendar-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 20px;
    padding: 10px 0;
    border-bottom: 2px solid var(--tactical-border);
}

.month-nav { 
    background: linear-gradient(135deg, var(--military-accent), var(--scope-green)); 
    border: 2px solid var(--tactical-border); 
    font-size: 20px; color: white; 
    cursor: pointer; 
    padding: 8px 12px; 
    transition: all 0.3s ease; 
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
}

.month-nav:hover { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark));
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.month-year { 
    font-size: 20px; font-weight: 700;
    color: var(--text-color);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    letter-spacing: 1px;
}

/* ===== 캘린더 그리드 ===== */
.calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 2px; /* 3px에서 2px로 변경 */
    margin-bottom: 20px;
    padding: 10px;
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
    border-radius: 10px;
    border: 1px solid var(--tactical-border);
}

.calendar-header-cell { 
    text-align: center; 
    padding: 12px 5px; 
    font-weight: 700; 
    color: var(--scope-green); 
    font-size: 12px;
    background: linear-gradient(135deg, var(--primary-light), #e0e8df);
    border: 1px solid var(--tactical-border);
    border-radius: 4px;
    text-shadow: 0 1px 1px rgba(255,255,255,0.5);
}

/* ===== 캘린더 셀 (각진 디자인) ===== */
.calendar-cell { 
    aspect-ratio: 1; 
    display: grid; 
    grid-template-rows: 1fr auto 1fr; 
    padding: 3px; 
    align-items: center; 
    justify-items: center; 
    position: relative;
    background: linear-gradient(135deg, #f8faf7, #f0f4ef);
    border: 1px solid var(--border-color); /* 2px에서 1px로 변경 */
    cursor: pointer;
    transition: all 0.2s ease;
    clip-path: polygon(0 0, calc(100% - 4px) 0, 100% 4px, 100% 100%, 4px 100%, 0 calc(100% - 4px));
}

.cell-top-icons { 
    grid-row: 1; 
    display: flex; 
    justify-content: center; 
    gap: 2px; 
    font-size: 9px; 
    width: 100%; height: 100%; 
    align-items: center; 
}

.cell-day-number { 
    grid-row: 2; 
    font-weight: 600;
    color: var(--text-color);
    text-shadow: 
        0 1px 0 rgba(255,255,255,0.7),
        0 -1px 0 rgba(0,0,0,0.1);
}

.cell-bottom-info { 
    grid-row: 3; 
    font-size: 8px; font-weight: 700; 
    color: var(--text-color-light); 
    width: 100%; 
    text-align: left; 
    padding-right: 4px; 
    align-self: end; 
    padding-bottom: 2px; 
}

.calendar-cell:hover { 
    transform: translateY(-2px) scale(1.02); 
    box-shadow: 0 4px 12px rgba(74, 103, 65, 0.3);
    border-color: var(--scope-green);
    background: linear-gradient(135deg, #ffffff, #f8faf7);
}

.calendar-cell.other-month { 
    color: #bbb; 
    background: linear-gradient(135deg, #e8e8e8, #ddd); 
    border-color: #ccc; 
    pointer-events: none; 
}

.calendar-cell.off-day { 
    background: linear-gradient(135deg, #d4d8d3, #c8cdc7); 
    color: var(--neutral-color);
    border-color: var(--neutral-color);
}

.off-day-indicator { 
    position: absolute; top: 3px; right: 3px; 
    font-size: 8px;
    color: var(--scope-green);
    font-weight: bold;
}

/* ===== 오늘 날짜 (스코프 조준점) ===== */
.calendar-cell.today { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark));
    border: 3px solid var(--tactical-border);
    color: white;
    position: relative;
    overflow: visible;
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
}

.calendar-cell.today::before {
    content: '';
    position: absolute; top: 50%; left: 50%;
    width: 80%; height: 2px;
    background: rgba(255, 255, 255, 0.7);
    transform: translate(-50%, -50%);
    z-index: 1;
}

.calendar-cell.today::after {
    content: '';
    position: absolute; top: 50%; left: 50%;
    width: 2px; height: 80%;
    background: rgba(255, 255, 255, 0.7);
    transform: translate(-50%, -50%);
    z-index: 1;
}

.calendar-cell.today .cell-day-number {
    position: relative; z-index: 2;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    width: 24px; height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255, 255, 255, 0.5);
    color: white; font-weight: 800;
    text-shadow: 
        0 1px 0 rgba(0,0,0,0.5),
        0 -1px 0 rgba(255,255,255,0.2),
        inset 0 1px 2px rgba(0,0,0,0.3);
}

/* ===== 점수별 색상 ===== */
.calendar-cell.has-data { 
    color: white; 
    border: 2px solid var(--tactical-border); 
    font-weight: bold; 
}

.calendar-cell.has-data .cell-bottom-info { color: rgba(255, 255, 255, 0.9); }

.calendar-cell.score-high { 
    background: linear-gradient(135deg, var(--success-color), #5a7a51);
    box-shadow: 0 0 8px rgba(74, 103, 65, 0.4);
}

.calendar-cell.score-medium { 
    background: linear-gradient(135deg, var(--warning-color), #c7941c);
    box-shadow: 0 0 8px rgba(184, 134, 11, 0.4);
}

.calendar-cell.score-low { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a);
    box-shadow: 0 0 8px rgba(139, 69, 19, 0.4);
}

.calendar-cell.score-negative { 
    background: linear-gradient(135deg, #34495e, #2c3e50);
    box-shadow: 0 0 8px rgba(52, 73, 94, 0.4);
}

.score-indicator { 
    position: absolute; bottom: 2px; right: 2px; 
    font-size: 8px; 
    background: rgba(0,0,0,0.6); 
    color: white; 
    padding: 1px 3px; 
    border-radius: 3px; 
    font-weight: 800;
    border: 1px solid rgba(255,255,255,0.2);
}

/* ===== 폼 요소 ===== */
.form-group { margin-bottom: 20px; }

.form-group label { 
    display: block; 
    color: var(--text-color); 
    font-weight: 700; 
    margin-bottom: 8px; 
    font-size: 14px;
    text-shadow: 0 1px 1px rgba(255,255,255,0.5);
}

.form-group input, .form-group textarea, .form-group select { 
    width: 100%; 
    padding: 12px; 
    border: 2px solid var(--border-color); 
    font-size: 16px; 
    transition: all 0.3s ease; 
    font-family: 'KBIZHanmaumMyungjo', sans-serif;
    background: linear-gradient(135deg, #ffffff, #f8faf7);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    clip-path: polygon(0 0, calc(100% - 4px) 0, 100% 4px, 100% 100%, 4px 100%, 0 calc(100% - 4px));
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
    outline: none; 
    border-color: var(--scope-green); 
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.05),
        0 0 0 3px rgba(74, 103, 65, 0.2);
    background: white;
}

/* ===== 군번줄 스타일 버튼 ===== */
.btn { 
    width: 100%; 
    padding: 15px 20px; 
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white; 
    border: none;
    font-size: 16px; font-weight: 700; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    box-shadow: 
        0 3px 8px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.1);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'Courier New', monospace;
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
    border-left: 3px dotted rgba(0,0,0,0.2);
    border-right: 3px dotted rgba(0,0,0,0.2);
    margin: 0 5px;
}

.btn::before {
    content: '';
    position: absolute; left: -6px; top: 50%;
    transform: translateY(-50%);
    width: 12px; height: 12px;
    background: var(--bg-color);
    border-radius: 50%;
    box-shadow: 
        inset 0 0 3px rgba(0,0,0,0.3),
        calc(100% + 12px) 0 0 0 var(--bg-color);
}

.btn::after {
    content: '';
    position: absolute; right: -6px; top: 50%;
    transform: translateY(-50%);
    width: 12px; height: 12px;
    background: var(--bg-color);
    border-radius: 50%;
    box-shadow: inset 0 0 3px rgba(0,0,0,0.3);
}

.btn:hover { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-color));
    transform: translateY(-2px); 
    box-shadow: 
        0 6px 16px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.2);
}

.btn:active { 
    transform: translateY(0); 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
}

.main-actions { display: flex; gap: 12px; margin-bottom: 10px; }
.main-actions .btn { flex: 1; }

.btn.secondary { 
    background: linear-gradient(135deg, var(--neutral-color), #5a6a62);
    border-color: var(--neutral-color);
}

.btn.secondary:hover { 
    background: linear-gradient(135deg, #5a6a62, var(--neutral-color));
}

/* ===== 모달 기본 ===== */
.modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(44, 62, 66, 0.8); 
    backdrop-filter: blur(6px); 
    z-index: 1000; 
    align-items: center; 
    justify-content: center; 
}

/* ===== 데이 모달 (군번줄 스타일) ===== */
.modal-content { 
    background: linear-gradient(135deg, #c0c0c0, #d3d3d3) !important;
    padding: 0; 
    border: 3px solid var(--tactical-border) !important;
    width: 90%; max-width: 800px; 
    max-height: 95vh; 
    overflow-y: auto; 
    box-shadow: 
        0 0 0 1px rgba(74, 103, 65, 0.3),
        0 20px 60px rgba(26, 43, 31, 0.5) !important;
    position: relative;
    clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px)) !important;
    border-left: 4px dotted rgba(74, 103, 65, 0.4) !important;
    border-right: 4px dotted rgba(74, 103, 65, 0.4) !important;
}

.modal-content::before {
    content: '' !important;
    position: absolute !important;
    left: -8px !important; top: 0 !important; bottom: 0 !important;
    width: 16px !important;
    background-image: 
        radial-gradient(circle at center, var(--bg-color) 40%, transparent 41%),
        radial-gradient(circle at center, rgba(0,0,0,0.2) 35%, transparent 36%) !important;
    background-size: 16px 40px !important;
    background-repeat: repeat-y !important;
    background-position: 0 0 !important;
    z-index: 10 !important;
}

.modal-content::after {
    content: '' !important;
    position: absolute !important;
    right: -8px !important; top: 0 !important; bottom: 0 !important;
    width: 16px !important;
    background-image: 
        radial-gradient(circle at center, var(--bg-color) 40%, transparent 41%),
        radial-gradient(circle at center, rgba(0,0,0,0.2) 35%, transparent 36%) !important;
    background-size: 16px 40px !important;
    background-repeat: repeat-y !important;
    background-position: 0 0 !important;
    z-index: 10 !important;
}

/* ===== 모달 헤더 & 바디 ===== */
#dayModal .modal-header, #excelExportModal .modal-header, .food-modal-content .modal-header { 
    padding: 20px 25px !important; 
    border-bottom: 2px solid var(--tactical-border) !important; 
    background: linear-gradient(135deg, #a8a8a8, #b8b8b8) !important;
    position: relative !important;
    z-index: 2 !important;
}

#dayModal .modal-body { 
    padding: 25px !important; 
    position: relative !important; 
    z-index: 2 !important;
    background: transparent !important;
}

.modal-layout { display: block; }
.modal-side-column { display: flex; flex-direction: column; }

.modal-input-group { 
    background: linear-gradient(135deg, #ffffff, #f8faf7) !important; 
    padding: 20px; 
    border: 2px solid var(--border-color);
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.05),
        0 2px 8px rgba(0,0,0,0.1);
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

.modal-input-group h4 { 
    font-size: 16px; 
    margin-bottom: 15px; 
    padding-bottom: 10px; 
    border-bottom: 2px solid var(--tactical-border);
    color: var(--scope-green);
    font-weight: 700;
}

.modal-input-row { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 15px; 
}

.modal-header { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    position: relative; 
    gap: 20px; 
}

.modal-title { flex: none; text-align: center; margin: 0; color: var(--scope-green); }

/* ===== 모달 내비게이션 버튼 ===== */
.date-nav-btn { 
    background: linear-gradient(135deg, var(--military-accent), var(--scope-green)); 
    border: 2px solid var(--tactical-border); 
    font-size: 20px; color: white; 
    cursor: pointer; 
    padding: 8px; 
    transition: all 0.3s ease; 
    width: 40px; height: 40px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-weight: bold;
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
}

.date-nav-btn:hover { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark));
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.close-btn { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a); 
    border: 2px solid var(--tactical-border); 
    font-size: 20px; 
    cursor: pointer; 
    color: white; 
    line-height: 1; 
    position: absolute; 
    right: 0; top: 50%; 
    transform: translateY(-50%);
    width: 35px; height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
}

.close-btn:hover {
    background: linear-gradient(135deg, #a0541a, var(--danger-color));
    transform: translateY(-50%) scale(1.1);
}

/* ===== 점수 디스플레이 카드 (음각 효과) ===== */
.score-display-card { 
    background: linear-gradient(135deg, #ffffff, #f8faf7) !important; 
    padding: 20px; 
    text-align: center; 
    border: 2px solid var(--tactical-border);
    box-shadow: 
        0 4px 12px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.5);
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

.score-display-card .score { 
    font-size: 40px; 
    font-weight: 800; 
    color: var(--scope-green); 
    line-height: 1;
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 5px rgba(0,0,0,0.5));
    -webkit-background-clip: text;
    background-clip: text;
    position: relative;
}

.score-display-card .score.is-off { color: var(--neutral-color); }

.score-display-card div:last-child { 
    font-size: 14px; 
    color: var(--text-color-light); 
    margin-top: 5px;
    font-weight: 600;
}

/* ===== 운동 토글 ===== */
.exercise-toggle-group { margin-bottom: 15px; }

.exercise-toggle-group label { 
    display: block; 
    color: var(--text-color); 
    font-weight: 700; 
    margin-bottom: 8px; 
    font-size: 14px; 
}

.exercise-toggle-btns { 
    display: flex; 
    border: 2px solid var(--tactical-border); 
    overflow: hidden;
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

.exercise-toggle-btn { 
    flex: 1; 
    padding: 12px; 
    border: none; 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    cursor: pointer; 
    font-weight: 700; 
    transition: all 0.3s ease; 
    font-size: 14px;
    border-right: 1px solid var(--tactical-border);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.exercise-toggle-btn:last-child { border-right: none; }

.exercise-toggle-btn.active { 
    background: linear-gradient(135deg, var(--success-color), #5a7a51); 
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ===== 개인 목표 섹션 ===== */
.personal-goals-section { 
    background: linear-gradient(135deg, #ffffff, #f8faf7) !important; 
    padding: 18px; 
    border: 2px solid var(--tactical-border);
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.05),
        0 2px 8px rgba(0,0,0,0.1);
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

#modalPersonalGoalsList { max-height: 150px; overflow-y: auto; }

.personal-goal-checkbox { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 12px; 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border-radius: 10px; 
    margin-bottom: 10px; 
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
}

.personal-goal-checkbox:hover {
    border-color: var(--scope-green);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

/* ===== 숫자 입력 그룹 (음각 효과) ===== */
.number-input-group { 
    display: flex; 
    align-items: center; 
    border: 2px solid var(--border-color); 
    border-radius: 8px; 
    overflow: hidden;
    background: linear-gradient(135deg, #ffffff, #f8faf7);
}

.number-input-group input { 
    border: none; 
    text-align: center; 
    flex: 1; 
    padding: 12px 8px; 
    background: transparent;
    font-weight: 700;
    color: var(--text-color);
    font-size: 18px;
    text-shadow: 
        0 1px 0 rgba(255,255,255,0.8),
        0 -1px 0 rgba(0,0,0,0.1);
}

.number-input-group input:focus { 
    box-shadow: none; 
    border: none; 
    outline: none;
}

.number-btn {
    width: 36px; height: 48px;
    border: none;
    background: linear-gradient(135deg, var(--military-accent), var(--scope-green));
    color: white;
    font-size: 18px; font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.number-btn:hover { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark));
    transform: scale(1.05);
}

.number-btn:active { 
    background: linear-gradient(135deg, var(--primary-dark), var(--scope-green));
    transform: scale(0.95);
}

/* 숫자 입력 필드의 스핀 버튼 숨기기 */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
}

/* ===== 코멘트 섹션 ===== */
#commentDetails summary { 
    font-weight: 700; 
    color: var(--text-color); 
    cursor: pointer; 
    padding: 12px; 
    border-radius: 8px; 
    background: linear-gradient(135deg, var(--primary-light), #e8ede7); 
    border: 2px solid var(--tactical-border); 
    list-style: none; 
    position: relative; 
    padding-left: 35px;
    transition: all 0.2s ease;
}

#commentDetails summary::-webkit-details-marker { display: none; }

#commentDetails summary::before { 
    content: '▶'; 
    position: absolute; 
    left: 12px; top: 50%; 
    transform: translateY(-50%); 
    font-size: 12px; 
    transition: transform 0.3s ease;
    color: var(--scope-green);
    font-weight: bold;
}

#commentDetails[open] > summary::before { 
    transform: translateY(-50%) rotate(90deg); 
}

#commentDetails summary:hover {
    background: linear-gradient(135deg, #e0e8df, var(--primary-light));
    border-color: var(--scope-green);
}

#modalCommentSection { margin-top: 25px; }

#modalComment { 
    width: 100%; 
    margin-top: 18px; 
    height: 90px; 
    resize: vertical; 
    font-size: 16px;
    border: 2px solid var(--border-color);
    background: linear-gradient(135deg, #ffffff, #f8faf7);
    border-radius: 8px;
    padding: 15px;
}

/* ===== 모달 폼 스타일 ===== */
#dayModal .form-group { margin-bottom: 0; }
#dayModal .form-group label { font-size: 13px; margin-bottom: 6px; }
#dayModal .form-group input { padding: 10px; font-size: 16px; }
#dayModal .modal-input-group,
#dayModal .score-display-card { margin-bottom: 5px; }
#dayModal .modal-layout > div:last-child { margin-bottom: 0; }
#modalPersonalGoalsList input[type="number"] { 
    font-size: 16px;
    font-weight: 600;
}

/* ===== 범례 ===== */
.legend { 
    display: flex; 
    justify-content: center; 
    flex-wrap: wrap; 
    margin: 20px 0 0; 
    font-size: 12px; 
    gap: 15px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
    border-radius: 8px;
    border: 1px solid var(--tactical-border);
}

.legend-item { 
    display: flex; 
    align-items: center; 
    gap: 6px;
    font-weight: 600;
    color: var(--text-color);
}

.legend-color { 
    width: 12px; height: 12px; 
    border-radius: 3px;
    border: 1px solid var(--tactical-border);
}

/* ===== D-Day 헤더 ===== */
.dday-header-container { 
    height: auto; 
    margin-bottom: 5px; 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; 
    position: absolute; 
    top: 12px; left: 12px; right: 12px; 
    z-index: 10; 
    pointer-events: none; 
}

.dday-chip { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.9), rgba(61, 92, 58, 0.9)); 
    backdrop-filter: blur(8px); 
    color: white; 
    padding: 6px 12px; 
    border-radius: 15px; 
    font-weight: 800; 
    font-size: 11px; 
    display: none; 
    box-shadow: 
        0 2px 8px rgba(0,0,0,0.3),
        0 0 0 1px rgba(255,255,255,0.2); 
    pointer-events: all; 
    border: 1px solid var(--tactical-border);
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.battery { 
    display: none; 
    width: 32px; height: 16px; 
    border: 2px solid var(--scope-green); 
    border-radius: 4px; 
    position: relative; 
    padding: 2px;
    background: rgba(255,255,255,0.9);
}

.battery::after { 
    content: ''; 
    position: absolute; 
    top: 50%; right: -5px; 
    transform: translateY(-50%); 
    width: 3px; height: 8px; 
    background: var(--scope-green); 
    border-radius: 0 2px 2px 0; 
}

.battery-level { 
    height: 100%; 
    border-radius: 2px; 
    transition: width 0.3s ease; 
}

.battery-level.green { background: var(--success-color); } 
.battery-level.yellow { background: var(--warning-color); } 
.battery-level.red { background: var(--danger-color); } 
.battery-level.black { background: var(--text-color); }

/* ===== 예산 관련 (음각 효과) ===== */
.budget-summary { display: flex; gap: 12px; margin-bottom: 20px; }

.budget-card { 
    flex: 1; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    color: var(--scope-green); 
    padding: 18px; 
    border-radius: 12px; 
    text-align: center;
    border: 2px solid var(--tactical-border);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.budget-card-title { 
    font-size: 12px; 
    opacity: 0.8; 
    margin-bottom: 10px; 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.budget-card-value { 
    font-size: 24px; 
    font-weight: 800;
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
    color: var(--scope-green);
}

#budgetPage .header p { 
    font-size: 16px; 
    font-weight: 700; 
    color: var(--text-color); 
}

/* ===== 개인 목표 아이템 ===== */
.personal-goal-item { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 2px solid var(--border-color); 
    border-radius: 12px; 
    padding: 18px; 
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.personal-goal-item:hover {
    border-color: var(--scope-green);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.personal-goal-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 8px; 
}

.personal-goal-name { font-weight: 700; color: var(--text-color); }

.personal-goal-actions button { 
    padding: 6px 12px; 
    border-radius: 6px; 
    font-size: 12px; 
    border: 1px solid var(--tactical-border); 
    cursor: pointer; 
    color: white;
    font-weight: 600;
    transition: all 0.2s ease;
}

.edit-btn { background: linear-gradient(135deg, var(--warning-color), #c7941c); }
.delete-btn { background: linear-gradient(135deg, var(--danger-color), #a0541a); }
.complete-btn { background: linear-gradient(135deg, var(--success-color), #5a7a51); }
.reopen-btn { background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); }

.personal-goal-actions button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.empty-goals { 
    text-align: center; 
    color: var(--text-color-light); 
    padding: 40px 20px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border-radius: 12px; 
    margin-top: 20px; 
    border: 2px solid var(--tactical-border); 
}

/* ===== 기타 설정들 ===== */
.budget-settings, .dday-settings { margin-bottom: 30px; }
.budget-input, .dday-actions { display: flex; gap: 12px; align-items: center; }

.dday-item { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border-radius: 12px; 
    padding: 15px 18px; 
    margin-bottom: 12px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    border: 2px solid var(--tactical-border);
    transition: all 0.2s ease;
}

.dday-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--scope-green);
}

.budget-input button { 
    padding: 12px 20px; 
    background: linear-gradient(135deg, var(--success-color), #5a7a51); 
    color: white; 
    border: 2px solid var(--tactical-border); 
    border-radius: 8px; 
    font-weight: 700; 
    cursor: pointer;
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.budget-input button:hover {
    background: linear-gradient(135deg, #5a7a51, var(--success-color));
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.wakeup-prompt { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.15), rgba(61, 92, 58, 0.15)); 
    color: var(--scope-green); 
    padding: 25px; 
    border-radius: 15px; 
    text-align: center; 
    margin-bottom: 20px;
    border: 2px solid var(--tactical-border);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-weight: 600;
}

/* ===== 월간/주간 요약 (음각 효과) ===== */
.monthly-summary { 
    display: flex; 
    justify-content: space-around; 
    gap: 15px; 
    margin-bottom: 30px; 
}

.summary-card { 
    flex-basis: 30%; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    color: var(--scope-green); 
    padding: 25px; 
    border-radius: 15px; 
    text-align: center;
    border: 2px solid var(--tactical-border);
    transition: all 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    border-color: var(--scope-green);
}

.summary-title { 
    font-size: 14px; 
    opacity: 0.8; 
    margin-bottom: 12px; 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value { 
    font-size: 26px; 
    font-weight: 800;
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
    color: var(--scope-green);
}

.week-card { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border-radius: 15px; 
    padding: 25px; 
    margin-bottom: 15px; 
    border: 2px solid var(--tactical-border);
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.week-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-color: var(--scope-green);
}

.week-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 18px; 
    font-weight: 700;
    color: var(--text-color);
    border-bottom: 2px solid var(--tactical-border);
    padding-bottom: 10px;
}

.week-stats { 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    text-align: center; 
    font-size: 24px; 
    font-weight: 700;
    color: var(--scope-green);
}

.week-stats > * {
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
}

.empty-expenses { 
    text-align: center; 
    color: var(--text-color-light); 
    padding: 40px 20px; 
}

/* ===== 피드백 팝업 ===== */
.feedback-popup { 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(44, 62, 66, 0.8); 
    display: none; 
    z-index: 2000; 
    animation: fadeIn 0.3s ease; 
    justify-content: center; 
    align-items: center;
    backdrop-filter: blur(8px);
}

.feedback-content { 
    position: relative; 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    padding: 45px; 
    border-radius: 25px; 
    width: 90%; 
    max-width: 400px; 
    text-align: center; 
    box-shadow: 
        0 0 0 3px var(--tactical-border),
        0 20px 60px rgba(0,0,0,0.4); 
    animation: popIn 0.5s ease;
    border: 2px solid var(--tactical-border);
}

.feedback-emoji { font-size: 60px; margin-bottom: 20px; display: block; }

.feedback-title { 
    font-size: 24px; 
    font-weight: 800; 
    margin-bottom: 15px; 
    color: var(--text-color);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.feedback-message { 
    font-size: 16px; 
    color: var(--text-color-light); 
    line-height: 1.6; 
    margin-bottom: 25px;
    font-weight: 500;
}

.feedback-celebration .feedback-title, 
.feedback-celebration .feedback-message, 
.feedback-reflection .feedback-title, 
.feedback-reflection .feedback-message, 
.feedback-disaster .feedback-title, 
.feedback-disaster .feedback-message, 
.feedback-encouragement .feedback-title, 
.feedback-encouragement .feedback-message, 
.feedback-warning .feedback-title, 
.feedback-warning .feedback-message { 
    color: rgba(255,255,255,0.95); 
}

.feedback-celebration { 
    background: linear-gradient(135deg, var(--success-color), #5a7a51);
    border-color: var(--success-color);
} 

.feedback-reflection { 
    background: linear-gradient(135deg, var(--warning-color), #c7941c);
    border-color: var(--warning-color);
} 

.feedback-disaster { 
    background: linear-gradient(135deg, #34495e, #2c3e50);
    border-color: #34495e;
} 

.feedback-encouragement { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark));
    border-color: var(--scope-green);
} 

.feedback-warning { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a);
    border-color: var(--danger-color);
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { 
    from { opacity: 0; transform: scale(0.8) translateY(20px); } 
    to { opacity: 1; transform: scale(1) translateY(0); } 
}

.feedback-btn { 
    background: rgba(0,0,0,0.2); 
    color: white; 
    border: 2px solid rgba(255,255,255,0.4); 
    padding: 12px 30px; 
    border-radius: 25px; 
    font-size: 16px; 
    font-weight: 700; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    margin: 0 10px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.feedback-btn:hover { 
    background: rgba(0,0,0,0.3); 
    border-color: rgba(255,255,255,0.6); 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.feedback-budget-red { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a) !important;
    border-color: var(--danger-color) !important;
}

.feedback-budget-black { 
    background: linear-gradient(135deg, #34495e, #2c3e50) !important;
    border-color: #34495e !important;
}

/* ===== 지출 입력 ===== */
.expense-input-row { 
    display: flex; 
    flex-direction: column;
    gap: 12px; 
    margin-top: 12px; 
}

.expense-input-row input { 
    flex: 1; 
    padding: 12px; 
    width: 100%;
    font-size: 14px; 
    border-radius: 8px;
    border: 2px solid var(--border-color);
    background: linear-gradient(135deg, #ffffff, #f8faf7);
}

.expense-input-row button { 
    flex-shrink: 0; 
    width: 100%; height: 48px; 
    border-radius: 12px; 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    border: 2px solid var(--tactical-border); 
    color: white; 
    font-weight: bold; 
    cursor: pointer; 
    font-size: 24px; 
    line-height: 1; 
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.expense-input-row button:hover { 
    background: linear-gradient(135deg, var(--primary-dark), var(--scope-green));
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.expense-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 8px 0; 
    font-size: 14px;
    border-bottom: 1px solid rgba(74, 103, 65, 0.1);
    font-weight: 500;
}

/* ===== D-Day 관련 ===== */
.dday-settings h4 { 
    margin-bottom: 15px;
    color: var(--scope-green);
    font-weight: 700;
    font-size: 18px;
}

.dday-item .dday-actions { display: flex; gap: 8px; }

.dday-item .dday-actions button { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border: 2px solid var(--border-color); 
    width: 32px; height: 32px; 
    border-radius: 8px; 
    font-size: 14px; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    color: var(--scope-green);
    font-weight: bold;
}

.dday-item .dday-actions button:hover { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    color: white; 
    transform: scale(1.1);
    border-color: var(--scope-green);
}

/* ===== 엑셀 옵션 ===== */
.excel-option-item { 
    display: flex; 
    align-items: center; 
    padding: 10px 0; 
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 6px;
    padding-left: 10px;
}

.excel-option-item:hover {
    background: rgba(74, 103, 65, 0.1);
}

.excel-option-item input[type="radio"] { 
    width: 18px; height: 18px; 
    margin-right: 12px;
    accent-color: var(--scope-green);
}

.excel-option-item label { 
    font-size: 16px;
    font-weight: 500;
    color: var(--text-color);
}

#customDateRange { 
    display: flex; 
    gap: 12px; 
    align-items: center; 
    margin-top: 12px; 
    margin-bottom: 20px; 
}

#customDateRange input[type="date"] { 
    padding: 12px; 
    border-radius: 8px; 
    border: 2px solid var(--border-color); 
    flex: 1; 
    font-family: inherit;
    background: linear-gradient(135deg, #ffffff, #f8faf7);
}

/* ===== 음식 관련 ===== */
.food-page-actions { display: flex; gap: 12px; margin-bottom: 12px; }

.food-page-actions .btn.secondary.danger { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a); 
    color: white;
    border-color: var(--danger-color);
}

.food-date-header { 
    display: flex; 
    align-items: center; 
    text-align: center; 
    margin: 30px 0 15px; 
    color: var(--text-color-light); 
}

.food-date-header::before, .food-date-header::after { 
    content: ''; 
    flex: 1; 
    border-bottom: 2px solid var(--tactical-border); 
}

.food-date-header span { 
    padding: 0 20px; 
    font-size: 13px; 
    font-weight: 700;
    color: var(--scope-green);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.food-record-item { 
    display: grid; 
    grid-template-columns: 50px 30px 1fr auto; 
    gap: 15px; 
    align-items: center; 
    padding: 16px 8px; 
    border-bottom: 1px solid rgba(74, 103, 65, 0.2); 
    position: relative;
    transition: all 0.2s ease;
}

.food-record-item:hover {
    background: rgba(74, 103, 65, 0.05);
    transform: translateX(5px);
}

.food-record-item .food-admin-actions { 
    position: absolute; 
    right: 5px; top: 50%; 
    transform: translateY(-50%); 
    display: flex; 
    gap: 6px; 
    opacity: 0; 
    transition: opacity 0.2s; 
    pointer-events: none; 
}

.food-records.admin-mode .food-record-item .food-admin-actions { 
    opacity: 1; 
    pointer-events: auto; 
}

.food-admin-actions button { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border: 1px solid var(--border-color); 
    width: 30px; height: 30px; 
    border-radius: 6px; 
    cursor: pointer; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-size: 13px; 
    transition: all 0.2s ease;
    font-weight: bold;
}

.food-admin-actions button.edit { 
    color: var(--warning-color); 
    border-color: var(--warning-color);
}

.food-admin-actions button.delete { 
    color: var(--danger-color);
    border-color: var(--danger-color);
}

.food-admin-actions button:hover { 
    background: var(--scope-green); 
    color: white;
    transform: scale(1.1);
}

/* ===== 음식 모달 ===== */
.food-modal { 
    max-width: 420px; 
    background: linear-gradient(135deg, #c0c0c0, #d3d3d3);
    overflow: hidden;
    border: 3px solid var(--tactical-border);
    clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
    border-left: 3px dotted rgba(74, 103, 65, 0.4);
    border-right: 3px dotted rgba(74, 103, 65, 0.4);
    position: relative;
}

.food-modal::before {
    content: '';
    position: absolute;
    left: -6px; top: 0; bottom: 0;
    width: 12px;
    background-image: 
        radial-gradient(circle at center, var(--bg-color) 40%, transparent 41%),
        radial-gradient(circle at center, rgba(0,0,0,0.2) 35%, transparent 36%);
    background-size: 12px 35px;
    background-repeat: repeat-y;
    background-position: 0 15px;
    z-index: 10;
}

.food-modal::after {
    content: '';
    position: absolute;
    right: -6px; top: 0; bottom: 0;
    width: 12px;
    background-image: 
        radial-gradient(circle at center, var(--bg-color) 40%, transparent 41%),
        radial-gradient(circle at center, rgba(0,0,0,0.2) 35%, transparent 36%);
    background-size: 12px 35px;
    background-repeat: repeat-y;
    background-position: 0 15px;
    z-index: 10;
}

.food-modal .modal-header { 
    padding: 20px 25px; 
    background: linear-gradient(135deg, #a8a8a8, #b8b8b8);
    border-bottom: 2px solid var(--tactical-border); 
}

.food-modal .modal-header h2 { 
    font-size: 18px;
    color: var(--scope-green);
    font-weight: 700;
}

.food-modal .modal-body { 
    padding: 25px;
    background: inherit;
}

.food-modal .form-group { margin-bottom: 18px; }

.food-modal .form-group label { 
    font-size: 14px; 
    margin-bottom: 8px;
    font-weight: 700;
    color: var(--text-color);
}

.food-modal .form-group input, .food-modal .form-group select { 
    padding: 12px; 
    font-size: 15px;
    border: 2px solid var(--border-color);
    background: linear-gradient(135deg, #ffffff, #f8faf7);
}

.food-modal .quantity-input { display: flex; gap: 10px; }
.food-modal .quantity-input select { width: 100px; }

.food-modal .food-modal-actions { 
    margin-top: 25px; 
    display: flex; 
    gap: 12px; 
}

.food-modal .food-modal-actions .btn { 
    flex: 1; 
    padding: 15px; 
}

/* ===== 명예의 전당 (음각 효과) ===== */
.fame-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
    gap: 12px; 
}

.fame-card { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 2px solid var(--tactical-border); 
    border-radius: 12px; 
    padding: 20px; 
    text-align: center;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.fame-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-color: var(--scope-green);
}

.fame-card-title { 
    font-size: 18px; 
    margin-bottom: 10px;
    color: var(--text-color);
    font-weight: 700;
}

.fame-card-value { 
    font-size: 22px; 
    font-weight: 800; 
    color: var(--scope-green);
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
}

.fame-card-date { 
    font-size: 12px; 
    color: var(--text-color-light); 
    margin-top: 6px;
    font-weight: 600;
}

#wallOfShame .fame-card-value { color: var(--danger-color); }
#wallOfShame .fame-card:hover { border-color: var(--danger-color); }

/* ===== 댓글 관련 ===== */
.comment-history-list { 
    max-height: 450px; 
    overflow-y: auto; 
    padding-right: 8px; 
}

.comment-item { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 2px solid var(--border-color); 
    border-radius: 12px; 
    padding: 20px 25px; 
    margin-bottom: 15px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.comment-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    border-color: var(--scope-green);
}

.comment-item-header { 
    font-size: 13px; 
    color: var(--text-color-light); 
    font-weight: 700; 
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.comment-item-body { 
    font-size: 15px; 
    line-height: 1.7; 
    white-space: pre-wrap; 
    word-break: break-word;
    color: var(--text-color);
    font-weight: 500;
}

.empty-comments { 
    text-align: center; 
    color: var(--text-color-light); 
    padding: 50px 25px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border-radius: 12px; 
    border: 2px solid var(--tactical-border); 
}

/* ===== 영수증 스타일 (음각 효과) ===== */
.receipt-container { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border-radius: 8px; 
    padding: 0; 
    margin-top: 0; margin-bottom: 25px; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
    font-family: 'Courier New', monospace; 
    max-width: 100%; 
    overflow: hidden;
    border: 2px solid var(--tactical-border);
}

.receipt-header { 
    padding: 20px 25px 15px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
    border-bottom: 2px solid var(--tactical-border);
}

.receipt-title { 
    display: block; 
    text-align: center; 
    margin-bottom: 8px; 
    position: relative; 
}

.receipt-title h3 { 
    margin: 0; 
    font-size: 18px; 
    color: var(--scope-green); 
    font-weight: 800;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.budget-info { 
    display: flex; 
    flex-direction: column; 
    gap: 4px; 
    font-size: 11px; 
    color: var(--text-color); 
    font-weight: 700; 
    text-align: right; 
    position: absolute; 
    top: -8px; right: -10px; 
}

.receipt-header p { 
    margin: 0; 
    font-size: 12px; 
    color: var(--text-color-light); 
    text-align: center;
    font-weight: 600;
}

.receipt-divider { 
    height: 2px; 
    background: repeating-linear-gradient(
        to right, 
        var(--tactical-border) 0px, 
        var(--tactical-border) 4px, 
        transparent 4px, 
        transparent 8px
    ); 
    margin: 0 20px; 
}

.receipt-items { padding: 20px 25px 15px; }

.receipt-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 6px 10px; 
    font-size: 13px; 
    line-height: 1.4; 
}

.receipt-date { 
    color: var(--text-color-light); 
    font-size: 11px; 
    min-width: 70px; 
    margin-right: 20px;
    font-weight: 600;
}

.receipt-desc { 
    flex: 1; 
    font-weight: 700; 
    color: var(--text-color); 
    margin-right: 20px; 
}

.receipt-amount { 
    font-weight: 800; 
    color: var(--scope-green); 
    font-size: 13px; 
    text-align: right; 
    min-width: 80px;
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
}

.receipt-total { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 20px 25px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    font-weight: 800; 
    font-size: 18px; 
    font-family: 'Courier New', monospace; 
    color: var(--scope-green);
    border-top: 2px solid var(--tactical-border);
    text-shadow: 
        0 2px 0 rgba(255,255,255,1),
        0 -2px 0 rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(0,0,0,0.3);
    filter: drop-shadow(inset 0 0 3px rgba(0,0,0,0.4));
}

/* ===== 로딩 & 스켈레톤 ===== */
.calendar-cell.skeleton { 
    background: linear-gradient(135deg, #f5f5f5, #eeeeee); 
    border: 2px solid #e0e0e0; 
    position: relative; 
    overflow: hidden; 
}

.calendar-cell.skeleton::before { 
    content: ''; 
    position: absolute; 
    top: 0; left: -100%; 
    width: 100%; height: 100%; 
    background: linear-gradient(90deg, transparent, rgba(74, 103, 65, 0.1), transparent); 
    animation: shimmer 2s infinite; 
}

.calendar-cell.skeleton .cell-day-number { 
    color: #d5d5d5; 
    background: transparent; 
}

.calendar-cell.skeleton .cell-top-icons,
.calendar-cell.skeleton .cell-bottom-info { 
    background: transparent; 
}

@keyframes shimmer { 
    0% { left: -100%; } 
    100% { left: 100%; } 
}

.loading-indicator {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: var(--scope-green);
    font-size: 12px;
    z-index: 10;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 15px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 2px solid var(--tactical-border);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ===== 목표 탭 ===== */
.goal-tabs { display: flex; gap: 12px; margin-bottom: 25px; }

.goal-tab { 
    padding: 10px 18px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border: 2px solid var(--tactical-border); 
    border-radius: 8px; 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 700; 
    transition: all 0.3s ease;
    color: var(--text-color);
}

.goal-tab.active { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    color: white; 
    border-color: var(--scope-green);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.goal-type-toggle { display: flex; gap: 5px; margin-bottom: 15px; }

.goal-type-toggle button { 
    flex: 1; 
    padding: 10px; 
    font-size: 14px; 
    border: 2px solid var(--tactical-border); 
    background: linear-gradient(135deg, var(--primary-light), #e8ede7); 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 700; 
    transition: all 0.3s ease;
    color: var(--text-color);
}

.goal-type-toggle button.active { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    color: white; 
    border-color: var(--scope-green);
}

#personalGoalsPage .header { text-align: left; }

/* ===== 퀘스트 시스템 ===== */
#dailyQuestModal .modal-header { 
    padding-top: 30px; 
    padding-bottom: 20px; 
}

.quest-tabs { display: flex; gap: 12px; margin-bottom: 25px; }

.quest-tab { 
    padding: 10px 18px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border: 2px solid var(--tactical-border); 
    border-radius: 8px; 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 700; 
    transition: all 0.3s ease;
    color: var(--text-color);
}

.quest-tab.active { 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    color: white; 
    border-color: var(--scope-green);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.quest-list { display: flex; flex-direction: column; gap: 12px; }

.quest-item { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 2px solid var(--border-color); 
    padding: 20px; 
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

.quest-item:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-color: var(--scope-green);
}

.quest-item.completed { 
    background: linear-gradient(135deg, var(--success-color), #5a7a51); 
    color: white; 
    border-color: var(--success-color);
    box-shadow: 0 4px 16px rgba(74, 103, 65, 0.3);
}

.quest-item.completed .quest-reward { 
    color: rgba(255,255,255,0.9); 
}

.quest-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
}

.quest-title { 
    font-weight: 700; 
    font-size: 14px;
    color: var(--text-color);
}

.quest-item.completed .quest-title {
    color: white;
}

.quest-reward { 
    font-size: 12px; 
    color: var(--scope-green); 
    font-weight: 700;
    padding: 4px 8px;
    background: rgba(74, 103, 65, 0.1);
    border-radius: 6px;
    border: 1px solid var(--scope-green);
}

.quest-desc { 
    font-size: 13px; 
    color: var(--text-color-light); 
    margin-bottom: 12px;
    line-height: 1.5;
    font-weight: 500;
}

.quest-item.completed .quest-desc {
    color: rgba(255,255,255,0.8);
}

.quest-progress { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}

.quest-progress-bar { 
    flex: 1; 
    height: 8px; 
    background: rgba(74, 103, 65, 0.2); 
    border-radius: 4px; 
    margin-right: 12px; 
    overflow: hidden;
    border: 1px solid var(--tactical-border);
}

.quest-progress-fill { 
    height: 100%; 
    background: linear-gradient(135deg, var(--scope-green), var(--primary-dark)); 
    transition: width 0.3s ease;
    box-shadow: 0 0 8px rgba(74, 103, 65, 0.3);
}

.quest-progress-text { 
    font-size: 11px; 
    color: var(--text-color-light); 
    min-width: 50px; 
    text-align: right;
    font-weight: 700;
    text-shadow: 
        0 1px 0 rgba(255,255,255,0.5),
        0 -1px 0 rgba(0,0,0,0.1);
}

.quest-item.completed .quest-progress-bar { 
    background: rgba(255,255,255,0.3); 
}

.quest-item.completed .quest-progress-fill { 
    background: rgba(255,255,255,0.8); 
}

.quest-item.completed .quest-progress-text { 
    color: rgba(255,255,255,0.9); 
}

/* ===== 보상 시스템 ===== */
#rewardsModal .modal-header { 
    padding: 35px 25px 25px 25px; 
    border-bottom: 2px solid var(--tactical-border); 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    border-top-left-radius: 13px; 
    border-top-right-radius: 13px; 
}

.rewards-list { 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
    max-height: 400px; 
    overflow-y: auto; 
}

.reward-item { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 3px solid var(--border-color); 
    padding: 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
}

.reward-item:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
}

.reward-item.bronze { 
    border-color: #CD7F32; 
    background: linear-gradient(135deg, #FFF8DC, #F5F5DC); 
}

.reward-item.silver { 
    border-color: #C0C0C0; 
    background: linear-gradient(135deg, #F8F8FF, #E6E6FA); 
}

.reward-item.gold { 
    border-color: #FFD700; 
    background: linear-gradient(135deg, #FFFACD, #FFEFD5); 
}

.reward-item.legend { 
    border-color: #9400D3; 
    background: linear-gradient(135deg, #F8F0FF, #E6E6FA); 
}

.reward-item.used { 
    opacity: 0.5; 
    filter: grayscale(50%); 
}

.reward-info { flex: 1; }

.reward-name { 
    font-weight: 700; 
    font-size: 16px; 
    margin-bottom: 6px;
    color: var(--text-color);
}

.reward-desc { 
    font-size: 13px; 
    color: var(--text-color-light);
    line-height: 1.4;
}

.reward-tier { 
    font-size: 11px; 
    font-weight: 700; 
    padding: 3px 8px; 
    border-radius: 6px; 
    margin-bottom: 6px; 
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.reward-tier.bronze { background: #CD7F32; color: white; }
.reward-tier.silver { background: #C0C0C0; color: white; }
.reward-tier.gold { background: #FFD700; color: #333; }
.reward-tier.legend { background: #9400D3; color: white; }

.reward-actions { display: flex; gap: 10px; }

.reward-btn { 
    padding: 10px 15px; 
    border: 2px solid var(--tactical-border); 
    border-radius: 8px; 
    font-size: 12px; 
    font-weight: 700; 
    cursor: pointer; 
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.reward-btn.use { 
    background: linear-gradient(135deg, var(--success-color), #5a7a51); 
    color: white;
    border-color: var(--success-color);
}

.reward-btn.use:hover { 
    background: linear-gradient(135deg, #5a7a51, var(--success-color));
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.reward-btn.delete { 
    background: linear-gradient(135deg, var(--danger-color), #a0541a); 
    color: white;
    border-color: var(--danger-color);
}

.reward-btn.delete:hover { 
    background: linear-gradient(135deg, #a0541a, var(--danger-color));
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.reward-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

.empty-rewards { 
    text-align: center; 
    padding: 50px 25px; 
    color: var(--text-color-light);
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
    border-radius: 12px;
    border: 2px solid var(--tactical-border);
}

/* ===== 업적 시스템 ===== */
.achievements-list { 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
    max-height: 400px; 
    overflow-y: auto; 
}

.achievement-item { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border: 3px solid var(--border-color); 
    padding: 20px; 
    display: flex; 
    align-items: center; 
    gap: 18px; 
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
}

.achievement-item.unlocked { 
    border-color: var(--success-color); 
    background: linear-gradient(135deg, #f8fff8, #e8f5e8);
    box-shadow: 0 4px 16px rgba(74, 103, 65, 0.2);
}

.achievement-item.locked { 
    opacity: 0.6; 
}

.achievement-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.achievement-emoji { 
    font-size: 28px; 
    min-width: 45px; 
    text-align: center; 
}

.achievement-info { flex: 1; }

.achievement-name { 
    font-weight: 700; 
    font-size: 16px; 
    margin-bottom: 6px;
    color: var(--text-color);
}

.achievement-desc { 
    font-size: 13px; 
    color: var(--text-color-light);
    line-height: 1.4;
}

.achievement-status { 
    font-size: 12px; 
    font-weight: 700; 
    padding: 6px 10px; 
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.achievement-status.unlocked { 
    background: var(--success-color); 
    color: white; 
}

.achievement-status.locked { 
    background: var(--border-color); 
    color: var(--text-color-light); 
}

.achievement-item.hidden { 
    background: linear-gradient(135deg, #2c3e50, #34495e); 
    color: #ecf0f1; 
    border-color: #34495e; 
}

.achievement-item.hidden .achievement-desc { 
    color: #bdc3c7; 
    font-style: italic; 
}

/* ===== 프로필 관련 ===== */
.profile-menu-item:hover { 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1)); 
    color: var(--scope-green);
    border-radius: 8px;
}

#profileWidget:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

#profileWidget { 
    transition: all 0.3s ease;
    border: 2px solid var(--tactical-border);
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
}

/* ===== 음식 엑스포트 모달 ===== */
#foodExportModal .modal-content { 
    max-width: 90vw; 
    background: var(--container-bg); 
    padding: 0;
    border: 3px solid var(--tactical-border);
}

#foodExportPreview { 
    background: linear-gradient(135deg, #ffffff, #f8faf7); 
    border-radius: 8px; 
    padding: 0; 
    margin: 20px; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
    font-family: 'Courier New', monospace;
    border: 2px solid var(--tactical-border);
}

.food-receipt-header { 
    padding: 20px 25px 15px; 
    background: linear-gradient(135deg, rgba(74, 103, 65, 0.1), rgba(61, 92, 58, 0.1));
    border-bottom: 2px solid var(--tactical-border);
}

.food-receipt-title { 
    display: block; 
    text-align: center; 
    margin-bottom: 8px; 
}

.food-receipt-title h3 { 
    margin: 0; 
    font-size: 18px; 
    color: var(--scope-green); 
    font-weight: 800;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.food-receipt-header p { 
    margin: 0; 
    font-size: 12px; 
    color: var(--text-color-light); 
    text-align: center;
    font-weight: 600;
}

.food-receipt-divider {
    height: 2px;
    background: repeating-linear-gradient(
        to right,
        var(--tactical-border) 0px,
        var(--tactical-border) 4px,
        transparent 4px,
        transparent 8px
    );
    margin: 0 20px;
}

.food-receipt-items { padding: 20px 25px 15px; }

.food-receipt-date-header { 
    font-weight: 800; 
    color: var(--scope-green); 
    font-size: 14px; 
    margin: 20px 0 10px 0; 
    padding-bottom: 8px; 
    border-bottom: 2px dashed var(--tactical-border);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.food-receipt-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 6px 0; 
    font-size: 13px; 
    line-height: 1.4; 
}

.food-receipt-time { 
    color: var(--text-color-light); 
    font-size: 11px; 
    min-width: 50px; 
    margin-right: 15px;
    font-weight: 600;
}

.food-receipt-desc { 
    flex: 1; 
    font-weight: 700; 
    color: var(--text-color); 
    margin-right: 15px; 
}

.food-receipt-quantity { 
    font-weight: 800; 
    color: var(--scope-green); 
    font-size: 13px; 
    text-align: right; 
    min-width: 70px; 
}

#foodExportModal .close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, var(--danger-color), #a0541a);
    border: 2px solid var(--tactical-border);
    width: 40px;
    height: 40px;
    border-radius: 8px;
    font-size: 20px;
    color: white;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: bold;
}

#foodExportModal .close-btn:hover { 
    background: linear-gradient(135deg, #a0541a, var(--danger-color));
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== 모바일 반응형 ===== */
@media (max-width: 767px) {
    .modal-content { 
        padding: 0; 
        width: 100%; height: 100%; 
        max-height: 100vh;
        border: none;
    }
    
    .food-modal { 
        width: 90%; 
        height: auto; 
        border-radius: 16px; 
        max-height: 90vh;
        border: 3px solid var(--tactical-border);
    }
    
    .food-modal .modal-body { 
        overflow-y: auto; 
        max-height: calc(90vh - 120px); 
    }
    
    #dayModal .modal-body { 
        padding: 25px 20px; 
    }
    
    .modal-input-group { 
        padding: 18px; 
    }
    
    .modal-input-group h4 { 
        font-size: 15px; 
    }
    
    #dayModal .form-group label { font-size: 13px; }
    
    #dayModal .modal-input-row { 
        grid-template-columns: 1fr; 
        gap: 15px; 
    }
    
    .exercise-toggle-btns { max-width: 200px; }
    
    .score-display-card, .personal-goals-section { 
        width: 100%; 
        max-width: none; 
        margin: 0; 
        padding: 18px; 
    }
    
    .score-display-card .score { font-size: 38px; }

    #modalTotalExpense { text-align: left !important; }
    
    .expense-item { font-size: 13px; word-break: break-all; }
    .expense-item span:first-child { flex-grow: 1; margin-right: 12px; }
    .expense-item > div { flex-shrink: 0; }
    
    .modal-actions-container { 
        padding: 0 20px 25px; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
    }
    
    .modal-actions-container .btn.delete { 
        order: 2; 
        background-color: transparent; 
        color: var(--text-color-light); 
        font-size: 14px; 
        font-weight: normal; 
        padding: 10px; 
        box-shadow: none; 
        margin-top: 12px; 
        max-width: 160px;
        border: 1px solid var(--border-color);
    }
    
    .modal-actions-container .btn.delete:hover { 
        background-color: var(--danger-color); 
        color: white;
        border-color: var(--danger-color);
    }
    
    .modal-actions-container .btn.save { order: 1; }

    #budgetPage .budget-summary { flex-wrap: wrap; }
    #budgetPage .budget-summary .budget-card:first-child { flex-basis: 100%; }
    #budgetPage .budget-card-value { font-size: 22px; }
    
    #dayModal .expense-input-row { flex-direction: column; gap: 12px; }
    #dayModal .expense-input-row input,
    #dayModal .expense-input-row button { width: 100%; }
    
    .dday-header-container { 
        top: 10px; 
        left: 5px; right: 5px; 
    }
    
    .container { 
        padding: 40px 16px 100px 16px; 
        border-width: 2px; 
        max-width: 100%; 
        margin: 0 10px; 
    }
    
    .dday-chip { 
        font-size: 10px; 
        padding: 4px 10px; 
    }
    
    .battery { width: 28px; height: 14px; }

    .receipt-item { font-size: 12px; }
    .receipt-date { min-width: 55px; margin-right: 12px; font-size: 10px; }
    .receipt-desc { margin-right: 12px; }
    .receipt-amount { min-width: 65px; font-size: 12px; }
    
    .budget-info { 
        flex-direction: column; 
        gap: 3px; 
        font-size: 10px; 
        text-align: right; 
    }
    
    .btn { min-height: 48px; }
    
    .calendar-cell {
        border: 1px solid var(--border-color);
        padding: 2px; /* 패딩 더 줄임 */
        min-height: 40px; /* 최소 높이 설정 */
        clip-path: polygon(0 0, calc(100% - 2px) 0, 100% 2px, 100% 100%, 2px 100%, 0 calc(100% - 2px)); /* 클립패스 줄임 */
    }
    .cell-day-number {font-size: 13px; }
    .cell-top-icons { font-size: 8px; }
    .cell-bottom-info { font-size: 7px; }
    .calendar-header-cell { padding: 8px 3px; font-size: 11px; }
    
    .date-nav-btn, .close-btn {
        min-width: 44px;
        min-height: 44px;
    }
    
    .month-nav {
        min-width: 44px;
        min-height: 44px;
    }
    
    #foodExportModal.modal-overlay { 
        background: var(--bg-color); 
        backdrop-filter: none; 
    }
    
    #foodExportModal .modal-content { 
        max-width: 100vw; 
        width: 100vw; 
        height: 100vh; 
        margin: 0; 
        padding: 0; 
        border-radius: 0; 
        box-shadow: none;
        border: none;
    }
    
    #foodExportPreview { 
        margin: 0; 
        border-radius: 0; 
        box-shadow: none; 
        height: calc(100vh - 60px); 
        overflow-y: auto;
        border: none;
    }
    
    #foodExportModal .close-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 22px;
        background: linear-gradient(135deg, var(--danger-color), #a0541a);
        color: white;
        z-index: 1000;
        border-radius: 50%;
    }
    
    #foodExportModal .modal-content > div:last-child { 
        position: fixed; 
        bottom: 0; 
        left: 0; right: 0; 
        background: var(--container-bg); 
        padding: 20px; 
        border-top: 2px solid var(--tactical-border);
        box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
    }
}
    `
};

// 확장된 언어 데이터
const LANGUAGE_DATA = {
    ko: {
        // 기본 정보
        langDisplay: "한국어",
        
        // 캘린더 관련
        routineCalendar: "🗓️ 루틴 캘린더",
        monthNames: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
        weekdays: ['일', '월', '화', '수', '목', '금', '토'],
        
        // 메인 버튼들
        statistics: "통계",
        goals: "목표",
        budget: "가계부",
        diet: "식단",
        settings: "⚙️ 설정",
        
        // 점수 범례
        excellent: "우수(80+)",
        good: "보통(40+)",
        poor: "미흡(1+)",
        worst: "최악(0미만)",
        restDay: "휴식일",
        
        // 퀘스트 관련
        questsTitle: "🧩 퀘스트",
        questsSubtitle: "경험치를 획득하고 레벨업하세요!",
        dailyTab: "일간",
        weeklyTab: "주간",
        monthlyTab: "월간",
        questLogTitle: "🧩 퀘스트",
        questLogSubtitle: "퀘스트를 완료하여 경험치를 획득하세요!",
        
        // 프로필 위젯
        profileLevel: "LV.",
        profileNewbie: "뉴비",
        profileQuests: "퀘스트",
        profileRewards: "보상 목록",
        profileAchievements: "업적",
        
        // 인증 관련
        googleLogin: "Google 로그인",
        logout: "로그아웃",
        syncing: "☁️ 동기화 중...",
        
        // 목표 설정 페이지
        missionSetup: "🎯 목표 설정",
        missionSetupSubtitle: "시작이 반! 목표 기상 시간을 설정해주세요.",
        targetWakeTime: "목표 기상 시간",
        targetWakeTimePlaceholder: "HH:MM (예: 07:30)",
        autoSaveNote: "한 번 설정하면 자동으로 저장됩니다.",
        saveAndStart: "저장하고 시작하기",
        
        // 기상 프롬프트 페이지
        goodMorning: "🌅 좋은 아침이에요!",
        inputTodayWakeTime: "오늘의 기상 시간을 입력해주세요.",
        actualWakeTime: "실제 기상 시간",
        actualWakeTimePlaceholder: "HH:MM (예: 07:30)",
        saveAndStartDaily: "저장하고 시작",
        skipForNow: "나중에 입력",
        
        // 일간 모달
        timingProtocol: "⏰ 인생은 타이밍",
        wakeTime: "기상 시간",
        seatTime: "착석 시간",
        sleepTime: "취침 시간",
        sleepTimePlaceholder: "HH:MM (익일 1시→25:00)",
        
        focusModules: "🍅 집중의 뽀모도로",
        morning: "오전",
        afternoon: "오후",
        evening: "저녁",
        
        personalMissions: "🎯 개인 목표",
        
        selfUpgrade: "💪 자기계발",
        didYouExercise: "오늘 운동했나요?",
        yes: "✔️ Yes",
        no: "✖️ No",
        exerciseTimeMin: "운동 시간 (분)",
        writingChars: "글쓰기 (자)",
        gamingMin: "게임 (분)",
        
        creditUsage: "💰 지출 기록",
        todayTotalExpense: "오늘 총 지출:",
        expenseDescription: "지출 내역",
        amount: "금액",
        
        dailyScore: "오늘의 점수",
        
        dailyLogEntry: "💬 오늘의 한마디 남기기",
        dailyLogPlaceholder: "오늘 하루는 어땠나요? (최대 500자)",
        
        restMode: "☕️ 오늘 쉬기 (Off Day)",
        
        endDaySession: "오늘의 일정 종료",
        delete: "삭제",
        
        // 개인 목표 페이지
        missionObjectives: "🎯 집중 목표",
        missionObjectivesSubtitle: "나만의 목표를 추가하고 달성률을 관리하세요.",
        active: "진행 중",
        completed: "완료",
        createNewMission: "새 목표 추가",
        increaseGoodHabits: "👍 늘리기 (Good Habits)",
        decreaseBadHabits: "👎 줄이기 (Bad Habits)",
        missionName: "목표 이름",
        missionNamePlaceholder: "예: 수학 문제집 풀기",
        targetAmount: "목표량",
        targetAmountPlaceholder: "예: 200",
        unit: "기간 (일)",
        unitPlaceholder: "예: 10",
        addMission: "목표 추가",
        backToHub: "돌아가기",
        
        // 설정 페이지
        systemConfig: "⚙️ 설정",
        targetWakeTimeSetting: "☀️ 목표 기상 시간",
        monthlyCreditLimit: "💰 월 예산 설정",
        monthlyBudgetPlaceholder: "월 예산 (원)",
        accountabilityPartner: "🤝 책임 공유 파트너 이메일",
        partnerEmailPlaceholder: "주간 리포트를 받을 파트너의 이메일",
        autoSendNote: "주간 평균 점수가 40점 미만일 경우, 파트너에게 자동으로 성과 보고서가 발송됩니다.",
        ddayCountdown: "⏰ D-Day 설정",
        addDday: "D-Day 추가",
        saveConfig: "설정 저장",
        viewLogHistory: "💬 나의 기록들 보기",
        exportToExcel: "📈 엑셀로 내보내기",
        exportDataBackup: "데이터 내보내기 (백업)",
        importDataRestore: "데이터 불러오기 (복구)",
        cloudBackup: "☁️ 클라우드 백업",
        cloudRestore: "📥 클라우드에서 복원",
        
        // 가계부 페이지
        credits: "가계부",
        
        // 식단 페이지
        rationLog: "🍽️ 식단 기록",
        rationLogSubtitle: "오늘 뭘 드셨나요?",
        addRation: "+ 식단 추가",
        manage: "🔧 관리",
        manageMode: "🔧 관리",
        manageModeEnd: "✅ 관리모드 종료",
        exportAsImage: "📸 이미지로 내보내기",
        
        // 통계 페이지
        monthlyAnalytics: "📊 월간통계",
        avgScore: "평균 점수",
        missionRate: "개인목표 달성률",
        writingBooks: "글쓰기 완성",
        hallOfFame: "🏆 명예의 전당 🏆",
        wallOfShame: "🧱 반성의 벽 🧱",
        
        // 퀘스트 관련
        todaysQuests: "🔖 오늘의 퀘스트 (5개)",
        thisWeeksQuests: "🥏 이번 주 퀘스트 (8개)",
        thisMonthsQuests: "⛳ 이번 달 퀘스트",
        expPerQuest: "완료한 퀘스트마다",
        expGain: "경험치 획득!",
        
        // 모달 제목들
        todaysQuestLog: "🔖 오늘의 퀘스트",
        levelUpGacha: "🎰 레벨업 보상 뽑기",
        rewardInventory: "🎁 보상 목록",
        achievementList: "🏅 업적 목록",
        
        // 버튼들
        confirm: "확인",
        cancel: "취소",
        save: "저장",
        close: "닫기",
        use: "사용",
        useNow: "지금 사용",
        saveForLater: "나중에 사용",
        viewAllQuests: "전체 퀘스트 보기",
        
        // 단위들
        pieces: "개",
        cups: "잔",
        packets: "봉지",
        slices: "조각",
        bowls: "그릇",
        servings: "인분",
        bottles: "병",
        
        // 기타
        noData: "기록된 데이터가 없습니다",
        loading: "데이터 로딩 중...",
        saveInProgress: "저장 중...",
        saveComplete: "모든 변경사항이 저장되었습니다."
    },
    
    en: {
        // 기본 정보
        langDisplay: "English",
        
        // 캘린더 관련
        routineCalendar: "ROUTINE SYSTEM",
        monthNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        weekdays: ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'],
        
        // 메인 버튼들
        statistics: "STATISTICS",
        goals: "MISSIONS",
        budget: "CREDITS",
        diet: "RATIONS",
        settings: "⚙️ CONFIG",
        
        // 점수 범례
        excellent: "EXCELLENT(80+)",
        good: "GOOD(40+)",
        poor: "BAD(1+)",
        worst: "CRITICAL(0-)",
        restDay: "REST DAY",
        
        // 퀘스트 관련
        questsTitle: "🧩 QUEST LOG",
        questsSubtitle: "GAIN EXPERIENCE AND LEVEL UP!",
        dailyTab: "DAILY",
        weeklyTab: "WEEKLY",
        monthlyTab: "MONTHLY",
        questLogTitle: "🧩 QUEST LOG",
        questLogSubtitle: "COMPLETE QUESTS TO GAIN EXPERIENCE POINTS!",
        
        // 프로필 위젯
        profileLevel: "LV.",
        profileNewbie: "NEWBIE",
        profileQuests: "QUESTS",
        profileRewards: "REWARDS",
        profileAchievements: "ACHIEVEMENTS",
        
        // 인증 관련
        googleLogin: "GOOGLE LOGIN",
        logout: "LOGOUT",
        syncing: "☁️ SYNCING...",
        
        // 목표 설정 페이지
        missionSetup: "🎯 MISSION SETUP",
        missionSetupSubtitle: "CONFIGURE YOUR PRIMARY OBJECTIVE",
        targetWakeTime: "TARGET WAKE TIME",
        targetWakeTimePlaceholder: "HH:MM (EX: 07:30)",
        autoSaveNote: "AUTO-SAVE AFTER CONFIGURATION",
        saveAndStart: "SAVE & START GAME",
        
        // 기상 프롬프트 페이지
        goodMorning: "🌅 GOOD MORNING, PLAYER",
        inputTodayWakeTime: "INPUT TODAY'S WAKE TIME",
        actualWakeTime: "ACTUAL WAKE TIME",
        actualWakeTimePlaceholder: "HH:MM (EX: 07:30)",
        saveAndStartDaily: "SAVE & START",
        skipForNow: "SKIP FOR NOW",
        
        // 일간 모달
        timingProtocol: "⏰ TIMING PROTOCOL",
        wakeTime: "WAKE TIME",
        seatTime: "SEAT TIME",
        sleepTime: "SLEEP TIME",
        sleepTimePlaceholder: "HH:MM (NEXT DAY 1AM→25:00)",
        
        focusModules: "🍅 FOCUS MODULES",
        morning: "MORNING",
        afternoon: "AFTERNOON",
        evening: "EVENING",
        
        personalMissions: "🎯 PERSONAL MISSIONS",
        
        selfUpgrade: "💪 SELF UPGRADE",
        didYouExercise: "DID YOU EXERCISE TODAY?",
        yes: "✔️ YES",
        no: "✖️ NO",
        exerciseTimeMin: "EXERCISE TIME (MIN)",
        writingChars: "WRITING (CHARS)",
        gamingMin: "GAMING (MIN)",
        
        creditUsage: "💰 CREDIT USAGE",
        todayTotalExpense: "TODAY TOTAL EXPENSE:",
        expenseDescription: "EXPENSE DESCRIPTION",
        amount: "AMOUNT",
        
        dailyScore: "DAILY SCORE",
        
        dailyLogEntry: "💬 DAILY LOG ENTRY",
        dailyLogPlaceholder: "HOW WAS YOUR DAY? (MAX 500 CHARS)",
        
        restMode: "☕️ REST DAY (OFF MODE)",
        
        endDaySession: "END DAY SESSION",
        delete: "DELETE",
        
        // 개인 목표 페이지
        missionObjectives: "🎯 MISSION OBJECTIVES",
        missionObjectivesSubtitle: "CREATE AND MANAGE YOUR PERSONAL MISSIONS.",
        active: "ACTIVE",
        completed: "COMPLETED",
        createNewMission: "CREATE NEW MISSION",
        increaseGoodHabits: "👍 INCREASE (GOOD HABITS)",
        decreaseBadHabits: "👎 DECREASE (BAD HABITS)",
        missionName: "MISSION NAME",
        missionNamePlaceholder: "EX: SOLVE MATH PROBLEMS",
        targetAmount: "TARGET AMOUNT",
        targetAmountPlaceholder: "EX: 20",
        unit: "UNIT",
        unitPlaceholder: "EX: PAGES, MINUTES",
        addMission: "ADD MISSION",
        backToHub: "BACK TO HUB",
        
        // 설정 페이지
        systemConfig: "⚙️ SYSTEM CONFIG",
        targetWakeTimeSetting: "☀️ TARGET WAKE TIME",
        monthlyCreditLimit: "💰 MONTHLY CREDIT LIMIT",
        monthlyBudgetPlaceholder: "MONTHLY BUDGET (CREDITS)",
        accountabilityPartner: "🤝 ACCOUNTABILITY PARTNER EMAIL",
        partnerEmailPlaceholder: "PARTNER'S EMAIL FOR WEEKLY REPORTS",
        autoSendNote: "AUTO-SEND REPORT IF WEEKLY AVERAGE < 40 POINTS",
        ddayCountdown: "⏰ D-DAY COUNTDOWN",
        addDday: "ADD D-DAY",
        saveConfig: "SAVE CONFIG",
        viewLogHistory: "💬 VIEW LOG HISTORY",
        exportToExcel: "📈 EXPORT TO EXCEL",
        exportDataBackup: "EXPORT DATA (BACKUP)",
        importDataRestore: "IMPORT DATA (RESTORE)",
        cloudBackup: "☁️ CLOUD BACKUP",
        cloudRestore: "📥 CLOUD RESTORE",
        
        // 가계부 페이지
        credits: "CREDITS",
        
        // 식단 페이지
        rationLog: "🍽️ RATION LOG",
        rationLogSubtitle: "TRACK YOUR DAILY FOOD INTAKE",
        addRation: "+ ADD RATION",
        manage: "🔧 MANAGE",
        manageMode: "🔧 MANAGE",
        manageModeEnd: "✅ END MANAGE MODE",
        exportAsImage: "📸 EXPORT AS IMAGE",
        
        // 통계 페이지
        monthlyAnalytics: "📊 MONTHLY ANALYTICS",
        avgScore: "AVG SCORE",
        missionRate: "MISSION RATE",
        writingBooks: "WRITING BOOKS",
        hallOfFame: "🏆 HALL OF FAME 🏆",
        wallOfShame: "🧱 WALL OF SHAME 🧱",
        
        // 퀘스트 관련
        todaysQuests: "🔖 TODAY'S QUESTS (5 AVAILABLE)",
        thisWeeksQuests: "🥏 THIS WEEK'S QUESTS (8 AVAILABLE)",
        thisMonthsQuests: "⛳ THIS MONTH'S QUESTS",
        expPerQuest: "+2 EXP PER COMPLETED QUEST!",
        expGain: "EXP PER COMPLETED QUEST!",
        
        // 모달 제목들
        todaysQuestLog: "🔖 TODAY'S QUEST LOG",
        levelUpGacha: "🎰 LEVEL UP GACHA",
        rewardInventory: "🎁 REWARD INVENTORY",
        achievementList: "🏅 ACHIEVEMENT LIST",
        
        // 버튼들
        confirm: "CONFIRM",
        cancel: "CANCEL",
        save: "SAVE",
        close: "CLOSE",
        use: "USE",
        useNow: "USE NOW",
        saveForLater: "SAVE FOR LATER",
        viewAllQuests: "VIEW ALL QUESTS",
        
        // 단위들
        pieces: "PIECES",
        cups: "CUPS",
        packets: "PACKETS",
        slices: "SLICES",
        bowls: "BOWLS",
        servings: "SERVINGS",
        bottles: "BOTTLES",
        
        // 기타
        noData: "NO DATA RECORDED",
        loading: "DATA LOADING...",
        saveInProgress: "SAVING...",
        saveComplete: "ALL CHANGES SAVED."
    }
};

let currentLanguage = 'ko';
let currentTheme = 'light';

// 테마 변경 함수
async function changeTheme(themeName) {
    currentTheme = themeName;
    
    // 기존 동적 스타일 제거
    const existingStyle = document.getElementById('dynamic-theme-style');
    if (existingStyle) {
        existingStyle.remove();
    }
    
    if (themeName === 'light') {
        // 라이트 테마는 기본 CSS 사용
        console.log('🎨 라이트 테마로 변경 (기본 CSS 사용)');
    } else if (THEME_STYLES[themeName]) {
        // 다른 테마들은 동적으로 적용
        const styleElement = document.createElement('style');
        styleElement.id = 'dynamic-theme-style';
        styleElement.textContent = THEME_STYLES[themeName];
        document.head.appendChild(styleElement);
        console.log(`🎨 ${themeName} 테마로 변경`);
    }
    
    await dbSet('userTheme', themeName);
    showExpGainNotification(0, `테마가 ${themeName}으로 변경되었습니다`);
}

// 확장된 언어 표시 업데이트 함수
async function updateLanguageDisplay() {
    const lang = LANGUAGE_DATA[currentLanguage];
    
    // ===========================================
    // 1. 프로필 위젯 업데이트
    // ===========================================
    const profileTitle = document.getElementById('profileTitle');
    if (profileTitle && profileTitle.textContent.includes('뉴비')) {
        profileTitle.textContent = lang.profileNewbie;
    }
    
    // 프로필 메뉴 항목들
    const menuItems = document.querySelectorAll('.profile-menu-item');
    if (menuItems.length >= 3) {
        menuItems[0].innerHTML = `<span>🎯</span> ${lang.profileQuests}`;
        menuItems[1].innerHTML = `<span>🎁</span> ${lang.profileRewards}`;
        menuItems[2].innerHTML = `<span>🏅</span> ${lang.profileAchievements}`;
    }
    
    // ===========================================
    // 2. 인증 컨테이너 업데이트
    // ===========================================
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if (loginBtn) loginBtn.textContent = lang.googleLogin;
    if (logoutBtn) logoutBtn.textContent = lang.logout;
    
    // 동기화 상태
    const syncStatus = document.getElementById('syncStatus');
    if (syncStatus && syncStatus.textContent.includes('동기화')) {
        syncStatus.textContent = lang.syncing;
    }
    
    // ===========================================
    // 3. 목표 설정 페이지
    // ===========================================
    const goalSetupTitle = document.querySelector('#goalSetup .header h1');
    const goalSetupSubtitle = document.querySelector('#goalSetup .header p');
    if (goalSetupTitle) goalSetupTitle.textContent = lang.missionSetup;
    if (goalSetupSubtitle) goalSetupSubtitle.textContent = lang.missionSetupSubtitle;
    
    const targetWakeTimeLabel = document.querySelector('label[for="targetWakeTime"]');
    const targetWakeTimeInput = document.getElementById('targetWakeTime');
    const autoSaveNote = document.querySelector('#goalSetup small');
    const saveAndStartBtn = document.querySelector('#goalSetup .btn');
    
    if (targetWakeTimeLabel) targetWakeTimeLabel.textContent = lang.targetWakeTime;
    if (targetWakeTimeInput) targetWakeTimeInput.placeholder = lang.targetWakeTimePlaceholder;
    if (autoSaveNote) autoSaveNote.textContent = lang.autoSaveNote;
    if (saveAndStartBtn) saveAndStartBtn.textContent = lang.saveAndStart;
    
    // ===========================================
    // 4. 기상 프롬프트 페이지
    // ===========================================
    const wakeupTitle = document.querySelector('#wakeUpPrompt h2');
    const wakeupInputText = document.querySelector('#wakeUpPrompt .wakeup-prompt p:last-child');
    const actualWakeTimeLabel = document.querySelector('label[for="promptWakeTime"]');
    const actualWakeTimeInput = document.getElementById('promptWakeTime');
    const saveStartBtn = document.querySelector('#wakeUpPrompt .btn:first-of-type');
    const skipBtn = document.querySelector('#wakeUpPrompt .btn.secondary');
    
    if (wakeupTitle) wakeupTitle.textContent = lang.goodMorning;
    if (wakeupInputText) wakeupInputText.textContent = lang.inputTodayWakeTime;
    if (actualWakeTimeLabel) actualWakeTimeLabel.textContent = lang.actualWakeTime;
    if (actualWakeTimeInput) actualWakeTimeInput.placeholder = lang.actualWakeTimePlaceholder;
    if (saveStartBtn) saveStartBtn.textContent = lang.saveAndStartDaily;
    if (skipBtn) skipBtn.textContent = lang.skipForNow;
    
    // ===========================================
    // 5. 캘린더 페이지
    // ===========================================
    const calendarTitle = document.querySelector('#calendarPage .header h1');
    if (calendarTitle) {
        calendarTitle.textContent = lang.routineCalendar;
    }
    
    // 요일 헤더 업데이트
    const weekdayHeaders = document.querySelectorAll('.calendar-header-cell');
    weekdayHeaders.forEach((header, index) => {
        if (index < lang.weekdays.length) {
            header.textContent = lang.weekdays[index];
        }
    });
    
    // 월년 표시 업데이트
    updateMonthYearDisplay();
    
    // 메인 버튼들 업데이트
    const mainActions = document.querySelectorAll('#calendarPage .main-actions .btn');
    if (mainActions.length >= 4) {
        mainActions[0].textContent = lang.statistics;
        mainActions[1].textContent = lang.goals;
        mainActions[2].textContent = lang.budget;
        mainActions[3].textContent = lang.diet;
    }
    
    // 설정 버튼 업데이트
    const settingsBtn = document.querySelector('#calendarPage .btn.secondary');
    if (settingsBtn) {
        settingsBtn.textContent = lang.settings;
    }
    
    // 범례 업데이트
    const legendItems = document.querySelectorAll('.legend-item span');
    if (legendItems.length >= 5) {
        legendItems[0].textContent = lang.excellent;
        legendItems[1].textContent = lang.good;
        legendItems[2].textContent = lang.poor;
        legendItems[3].textContent = lang.worst;
        legendItems[4].textContent = lang.restDay;
    }
    
    // ===========================================
    // 6. 일간 모달 업데이트
    // ===========================================
    // 타이밍 프로토콜 섹션
    const timingProtocolTitle = document.querySelector('#dayModal h4:first-of-type');
    if (timingProtocolTitle && timingProtocolTitle.textContent.includes('타이밍')) {
        timingProtocolTitle.textContent = lang.timingProtocol;
    }
    
    const modalLabels = document.querySelectorAll('#dayModal label');
    modalLabels.forEach(label => {
        const forAttr = label.getAttribute('for');
        switch (forAttr) {
            case 'modalWakeTime':
                label.textContent = lang.wakeTime;
                break;
            case 'modalSeatTime':
                label.textContent = lang.seatTime;
                break;
            case 'modalSleepTime':
                label.textContent = lang.sleepTime;
                break;
            case 'modalMorningPomodoro':
                label.textContent = lang.morning;
                break;
            case 'modalAfternoonPomodoro':
                label.textContent = lang.afternoon;
                break;
            case 'modalEveningPomodoro':
                label.textContent = lang.evening;
                break;
            case 'modalExerciseMinutes':
                label.textContent = lang.exerciseTimeMin;
                break;
            case 'modalWriting':
                label.textContent = lang.writingChars;
                break;
            case 'modalGameTime':
                label.textContent = lang.gamingMin;
                break;
            case 'modalOffDay':
                label.textContent = lang.restMode;
                break;
        }
    });
    
    // 섹션 제목들
    const modalSectionTitles = document.querySelectorAll('#dayModal h4');
    modalSectionTitles.forEach(title => {
        const text = title.textContent;
        if (text.includes('뽀모도로')) title.textContent = lang.focusModules;
        else if (text.includes('개인 목표')) title.textContent = lang.personalMissions;
        else if (text.includes('자기계발')) title.textContent = lang.selfUpgrade;
        else if (text.includes('지출')) title.textContent = lang.creditUsage;
    });
    
    // 운동 관련
    const exerciseLabel = document.querySelector('.exercise-toggle-group label');
    if (exerciseLabel) exerciseLabel.textContent = lang.didYouExercise;
    
    const exerciseYesBtn = document.getElementById('exerciseBtnYes');
    const exerciseNoBtn = document.getElementById('exerciseBtnNo');
    if (exerciseYesBtn) exerciseYesBtn.textContent = lang.yes;
    if (exerciseNoBtn) exerciseNoBtn.textContent = lang.no;
    
    // 플레이스홀더들
    const modalSleepTimeInput = document.getElementById('modalSleepTime');
    if (modalSleepTimeInput) modalSleepTimeInput.placeholder = lang.sleepTimePlaceholder;
    
    const expenseDescInput = document.getElementById('expenseDesc');
    const expenseAmountInput = document.getElementById('expenseAmount');
    if (expenseDescInput) expenseDescInput.placeholder = lang.expenseDescription;
    if (expenseAmountInput) expenseAmountInput.placeholder = lang.amount;
    
    // 점수 카드
    const scoreCard = document.querySelector('.score-display-card div:last-child');
    if (scoreCard && scoreCard.textContent.includes('점수')) {
        scoreCard.textContent = lang.dailyScore;
    }
    
    // 오늘의 한마디
    const commentSummary = document.querySelector('#commentDetails summary');
    const commentTextarea = document.getElementById('modalComment');
    if (commentSummary) commentSummary.textContent = lang.dailyLogEntry;
    if (commentTextarea) commentTextarea.placeholder = lang.dailyLogPlaceholder;
    
    // 모달 액션 버튼들
    const endDayBtn = document.querySelector('.btn.save');
    const deleteBtn = document.querySelector('.btn.delete');
    if (endDayBtn) endDayBtn.textContent = lang.endDaySession;
    if (deleteBtn) deleteBtn.textContent = lang.delete;
    
    // ===========================================
    // 7. 퀘스트 페이지 업데이트
    // ===========================================
    const questTitle = document.querySelector('#questPage .header h1');
    const questSubtitle = document.querySelector('#questPage .header p');
    if (questTitle) questTitle.textContent = lang.questsTitle;
    if (questSubtitle) questSubtitle.textContent = lang.questsSubtitle;
    
    // 퀘스트 탭 업데이트
    const questTabs = document.querySelectorAll('.quest-tab');
    if (questTabs.length >= 3) {
        questTabs[0].textContent = lang.dailyTab;
        questTabs[1].textContent = lang.weeklyTab;
        questTabs[2].textContent = lang.monthlyTab;
    }
    
    // 퀘스트 섹션 제목들
    const questSectionTitles = document.querySelectorAll('#questPage h3');
    questSectionTitles.forEach(title => {
        const text = title.textContent;
        if (text.includes('오늘의 퀘스트')) title.textContent = lang.todaysQuests;
        else if (text.includes('이번 주 퀘스트')) title.textContent = lang.thisWeeksQuests;
        else if (text.includes('이번 달 퀘스트')) title.textContent = lang.thisMonthsQuests;
    });
    
    // 백투허브 버튼들
    const backToHubBtns = document.querySelectorAll('.btn.secondary');
    backToHubBtns.forEach(btn => {
        if (btn.textContent.includes('돌아가기')) {
            btn.textContent = lang.backToHub;
        }
    });
    
    // ===========================================
    // 8. 개인 목표 페이지
    // ===========================================
    const goalPageTitle = document.querySelector('#personalGoalsPage .header h1');
    const goalPageSubtitle = document.querySelector('#personalGoalsPage .header p');
    if (goalPageTitle) goalPageTitle.textContent = lang.missionObjectives;
    if (goalPageSubtitle) goalPageSubtitle.textContent = lang.missionObjectivesSubtitle;
    
    // 목표 탭들
    const goalTabs = document.querySelectorAll('.goal-tab');
    if (goalTabs.length >= 2) {
        goalTabs[0].textContent = lang.active;
        goalTabs[1].textContent = lang.completed;
    }
    
    // 새 목표 추가 섹션
    const newMissionTitle = document.querySelector('#personalGoalsPage h4');
    if (newMissionTitle) newMissionTitle.textContent = lang.createNewMission;
    
    const goalTypeButtons = document.querySelectorAll('.goal-type-toggle button');
    if (goalTypeButtons.length >= 2) {
        goalTypeButtons[0].textContent = lang.increaseGoodHabits;
        goalTypeButtons[1].textContent = lang.decreaseBadHabits;
    }
    
    // 목표 입력 필드들
    const goalLabels = document.querySelectorAll('#personalGoalsPage label');
    goalLabels.forEach(label => {
        const forAttr = label.getAttribute('for');
        switch (forAttr) {
            case 'newGoalName':
                label.textContent = lang.missionName;
                break;
            case 'newGoalTarget':
                label.textContent = lang.targetAmount;
                break;
            case 'newGoalUnit':
                label.textContent = lang.unit;
                break;
        }
    });
    
    const goalInputs = document.querySelectorAll('#personalGoalsPage input');
    goalInputs.forEach(input => {
        const id = input.id;
        switch (id) {
            case 'newGoalName':
                input.placeholder = lang.missionNamePlaceholder;
                break;
            case 'newGoalTarget':
                input.placeholder = lang.targetAmountPlaceholder;
                break;
            case 'newGoalUnit':
                input.placeholder = lang.unitPlaceholder;
                break;
        }
    });
    
    const addMissionBtn = document.querySelector('#personalGoalsPage .btn:not(.secondary)');
    if (addMissionBtn && addMissionBtn.textContent.includes('목표 추가')) {
        addMissionBtn.textContent = lang.addMission;
    }
    
    // ===========================================
    // 9. 설정 페이지
    // ===========================================
    const settingsTitle = document.querySelector('#settingsPage .header h1');
    if (settingsTitle) settingsTitle.textContent = lang.systemConfig;
    
    const settingsLabels = document.querySelectorAll('#settingsPage label');
    settingsLabels.forEach(label => {
        const forAttr = label.getAttribute('for');
        const text = label.textContent;
        switch (forAttr) {
            case 'settingsWakeTime':
                label.textContent = lang.targetWakeTimeSetting;
                break;
            case 'monthlyBudgetInput':
                label.textContent = lang.monthlyCreditLimit;
                break;
            case 'partnerEmailInput':
                label.textContent = lang.accountabilityPartner;
                break;
        }
        
        if (text.includes('D-Day 설정')) {
            label.textContent = lang.ddayCountdown;
        }
    });
    
    // 설정 입력 플레이스홀더들
    const monthlyBudgetInput = document.getElementById('monthlyBudgetInput');
    const partnerEmailInput = document.getElementById('partnerEmailInput');
    if (monthlyBudgetInput) monthlyBudgetInput.placeholder = lang.monthlyBudgetPlaceholder;
    if (partnerEmailInput) partnerEmailInput.placeholder = lang.partnerEmailPlaceholder;
    
    // 설정 페이지 버튼들
    const settingsButtons = document.querySelectorAll('#settingsPage .btn');
    settingsButtons.forEach(btn => {
        const text = btn.textContent;
        if (text.includes('설정 저장')) btn.textContent = lang.saveConfig;
        else if (text.includes('나의 기록들')) btn.textContent = lang.viewLogHistory;
        else if (text.includes('엑셀로 내보내기')) btn.textContent = lang.exportToExcel;
        else if (text.includes('데이터 내보내기')) btn.textContent = lang.exportDataBackup;
        else if (text.includes('데이터 불러오기')) btn.textContent = lang.importDataRestore;
        else if (text.includes('클라우드 백업')) btn.textContent = lang.cloudBackup;
        else if (text.includes('클라우드에서 복원')) btn.textContent = lang.cloudRestore;
        else if (text.includes('D-Day 추가')) btn.textContent = lang.addDday;
    });
    
    // 설정 페이지 small 텍스트
    const settingsSmall = document.querySelector('#settingsPage small');
    if (settingsSmall) settingsSmall.textContent = lang.autoSendNote;
    
    // ===========================================
    // 10. 식단 페이지
    // ===========================================
    const foodPageTitle = document.querySelector('#foodPage .header h1');
    const foodPageSubtitle = document.querySelector('#foodPage .header p');
    if (foodPageTitle) foodPageTitle.textContent = lang.rationLog;
    if (foodPageSubtitle) foodPageSubtitle.textContent = lang.rationLogSubtitle;
    
    // 식단 페이지 버튼들
    const foodButtons = document.querySelectorAll('#foodPage .btn');
    foodButtons.forEach(btn => {
        const text = btn.textContent;
        if (text.includes('식단 추가')) btn.textContent = lang.addRation;
        else if (text.includes('관리')) btn.textContent = lang.manage;
        else if (text.includes('이미지로 내보내기')) btn.textContent = lang.exportAsImage;
    });
    
    // ===========================================
    // 11. 통계 페이지
    // ===========================================
    const statsTitle = document.querySelector('#monthlyStatsPage .header h1');
    if (statsTitle) statsTitle.textContent = lang.monthlyAnalytics;
    
    // 통계 카드들
    const statsTitles = document.querySelectorAll('.summary-title');
    statsTitles.forEach(title => {
        const text = title.textContent;
        if (text.includes('평균 점수')) title.textContent = lang.avgScore;
        else if (text.includes('개인목표')) title.textContent = lang.missionRate;
        else if (text.includes('글쓰기')) title.textContent = lang.writingBooks;
    });
    
    // 명예의 전당 / 반성의 벽
    const hallTitle = document.querySelector('.hall-of-fame-container h3');
    const shameTitle = document.querySelector('.wall-of-shame-container h3');
    if (hallTitle) hallTitle.textContent = lang.hallOfFame;
    if (shameTitle) shameTitle.textContent = lang.wallOfShame;
    
    // ===========================================
    // 12. 모달들 업데이트
    // ===========================================
    
    // 일간 퀘스트 모달
    const dailyQuestModalTitle = document.querySelector('#dailyQuestModal .modal-title');
    if (dailyQuestModalTitle) dailyQuestModalTitle.textContent = lang.todaysQuestLog;
    
    // 가챠 모달
    const gachaModalTitle = document.querySelector('#gachaModal .modal-title');
    if (gachaModalTitle) gachaModalTitle.textContent = lang.levelUpGacha;
    
    // 보상 모달
    const rewardsModalTitle = document.querySelector('#rewardsModal .modal-title');
    if (rewardsModalTitle) rewardsModalTitle.textContent = lang.rewardInventory;
    
    // 업적 모달
    const achievementsModalTitle = document.querySelector('#achievementsModal .modal-title');
    if (achievementsModalTitle) achievementsModalTitle.textContent = lang.achievementList;
    
    // 일반적인 모달 버튼들
    const modalButtons = document.querySelectorAll('.modal-content .btn, .feedback-btn');
    modalButtons.forEach(btn => {
        const text = btn.textContent;
        if (text.includes('확인')) btn.textContent = lang.confirm;
        else if (text.includes('취소')) btn.textContent = lang.cancel;
        else if (text.includes('저장')) btn.textContent = lang.save;
        else if (text.includes('닫기')) btn.textContent = lang.close;
        else if (text.includes('사용')) {
            if (text.includes('지금')) btn.textContent = lang.useNow;
            else if (text.includes('나중에')) btn.textContent = lang.saveForLater;
            else btn.textContent = lang.use;
        }
        else if (text.includes('전체 퀘스트')) btn.textContent = lang.viewAllQuests;
    });
    
    // ===========================================
    // 13. 식단 모달들
    // ===========================================
    
    // 식단 단위 옵션들
    const foodUnitSelects = document.querySelectorAll('#foodUnitSelect option, #manualFoodUnit option');
    foodUnitSelects.forEach((option, index) => {
        const units = [lang.pieces, lang.cups, 'ML', 'G', 'PACKETS', lang.slices, lang.bowls, lang.servings, lang.bottles];
        if (index < units.length) {
            option.textContent = units[index];
        }
    });
    
    // ===========================================
    // 14. 저장 상태 메시지들
    // ===========================================
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
        const text = saveStatus.textContent;
        if (text.includes('저장 중')) saveStatus.textContent = lang.saveInProgress;
        else if (text.includes('저장되었습니다')) saveStatus.textContent = lang.saveComplete;
    }
    
    // ===========================================
    // 15. 로딩 및 기타 상태 메시지들
    // ===========================================
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) loadingIndicator.textContent = lang.loading;
    
    // 빈 상태 메시지들
    const emptyStates = document.querySelectorAll('.empty-goals, .empty-rewards, .empty-comments, .empty-expenses');
    emptyStates.forEach(empty => {
        if (empty.textContent.includes('기록된') || empty.textContent.includes('없습니다')) {
            const p = empty.querySelector('p');
            if (p) p.textContent = lang.noData;
        }
    });
}

// 월년 표시 업데이트 함수 (개선됨)
function updateMonthYearDisplay() {
    const monthYearEl = document.getElementById('monthYear');
    if (!monthYearEl) return;
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    if (currentLanguage === 'en') {
        monthYearEl.textContent = `${LANGUAGE_DATA.en.monthNames[month]} ${year}`;
    } else {
        monthYearEl.textContent = `${year}년 ${month + 1}월`;
    }
}

// 언어 전환 함수 (확장됨)
async function toggleLanguage() {
    currentLanguage = currentLanguage === 'ko' ? 'en' : 'ko';
    await dbSet('userLanguage', currentLanguage);
    
    // body에 언어 클래스 추가/제거
    document.body.classList.remove('lang-ko', 'lang-en');
    document.body.classList.add(`lang-${currentLanguage}`);
    
    // 전체 언어 표시 업데이트
    await updateLanguageDisplay();
    
    // 현재 언어 표시 업데이트
    const langDisplay = document.getElementById('currentLangDisplay');
    if (langDisplay) {
        langDisplay.textContent = LANGUAGE_DATA[currentLanguage].langDisplay;
    }
    
    console.log(`🌐 언어가 ${currentLanguage}로 변경되었습니다.`);
    showExpGainNotification(0, `언어가 ${LANGUAGE_DATA[currentLanguage].langDisplay}로 변경되었습니다`);
}

// 언어 설정 로드 함수 (확장됨)
async function loadUserSettings() {
    const savedTheme = await dbGet('userTheme');
    const savedLanguage = await dbGet('userLanguage');
    
    if (savedTheme && savedTheme !== 'light') {
        await changeTheme(savedTheme); 
    } else {
        currentTheme = 'light';
    }
    
    if (savedLanguage) {
        currentLanguage = savedLanguage;
        // 언어 설정 후 전체 UI 업데이트
        setTimeout(async () => {
            await updateLanguageDisplay();
        }, 100);
    }
    
    // 현재 언어 표시 업데이트
    const langDisplay = document.getElementById('currentLangDisplay');
    if (langDisplay) {
        langDisplay.textContent = LANGUAGE_DATA[currentLanguage].langDisplay;
    }
}

// 동적 텍스트 업데이트를 위한 헬퍼 함수들
function updateDynamicText(selector, koText, enText) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = currentLanguage === 'ko' ? koText : enText;
    }
}

function updatePlaceholder(selector, koText, enText) {
    const element = document.querySelector(selector);
    if (element) {
        element.placeholder = currentLanguage === 'ko' ? koText : enText;
    }
}

// 특정 페이지 로드 시 언어 업데이트 함수
async function updatePageLanguage(pageId) {
    const lang = LANGUAGE_DATA[currentLanguage];
    
    switch (pageId) {
        case 'calendarPage':
            updateMonthYearDisplay();
            break;
        case 'questPage':
            // 퀘스트 페이지 특정 업데이트
            await renderQuestPage();
            break;
        case 'personalGoalsPage':
            // 개인 목표 페이지 특정 업데이트
            await renderPersonalGoalsList();
            break;
        // 다른 페이지들도 필요에 따라 추가
    }
}

// 페이지 로드 시 설정
window.addEventListener('load', function() { setupSecretDevTools(); });

// 퀘스트만 리셋
async function resetQuests() {
    if (!confirm('정말로 모든 퀘스트를 리셋하시겠습니까?')) return;
    
    const allData = await dbGetAll();
    let count = 0;
    
    for (const item of allData) {
        if (item.key.startsWith('dailyQuests_') || 
            item.key.startsWith('weeklyQuests_') || 
            item.key.startsWith('monthlyQuests_')) {
            await dbDelete(item.key);
            count++;
        }
    }
    
    alert(`${count}개 퀘스트 리셋 완료!`);
}

// 경험치만 리셋
async function resetExperience() {
    if (!confirm('정말로 레벨과 경험치를 모두 리셋하시겠습니까?')) return;
    
    const defaultLevelData = {
        totalExp: 0,
        level: 1,
        currentExp: 0,
        maxExp: 10,
        unlockedRewards: [],
        activeBuffs: {}
    };
    
    await dbSet('userLevelData', defaultLevelData);
    await updateProfileWidget();
    
    alert('레벨과 경험치가 초기화되었습니다!');
}

// 업적만 리셋
async function resetAchievements() {
    if (!confirm('정말로 모든 업적을 리셋하시겠습니까?\n\n달성한 업적들이 모두 사라집니다!')) return;
    
    // 업적 리셋
    await dbDelete('unlockedAchievements');
    
    // 업적 모달이 열려있으면 새로고침
    if (document.getElementById('achievementsModal').style.display === 'flex') {
        await renderAchievementsList();
    }
    
    alert('모든 업적이 초기화되었습니다!');
    console.log('🏅 업적 리셋 완료');
}

// 전체 리셋 함수에 업적 리셋도 추가
async function resetAll() {
    if (!confirm('정말로 퀘스트, 경험치, 업적을 모두 리셋하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) return;
    
    // 퀘스트 리셋
    const allData = await dbGetAll();
    let questCount = 0;
    
    for (const item of allData) {
        if (item.key.startsWith('dailyQuests_') || 
            item.key.startsWith('weeklyQuests_') || 
            item.key.startsWith('monthlyQuests_')) {
            await dbDelete(item.key);
            questCount++;
        }
    }
    
    // 경험치 리셋
    const defaultLevelData = {
        totalExp: 0,
        level: 1,
        currentExp: 0,
        maxExp: 10,
        unlockedRewards: [],
        activeBuffs: {}
    };
    
    await dbSet('userLevelData', defaultLevelData);
    
    // 업적 리셋 추가
    await dbDelete('unlockedAchievements');
    
    await updateProfileWidget();
    
    alert(`전체 리셋 완료!\n퀘스트: ${questCount}개 삭제\n레벨: 1로 초기화\n업적: 모두 초기화`);
}

// 개인 목표 업적 테스트 함수
async function testPersonalGoalAchievements() {
    const today = new Date();
    const todayData = await getDayData(today);
    const allData = await dbGetAll();
    
    await checkPersonalGoalAchievements(today, todayData, allData);
    console.log('🎯 개인 목표 업적 체크 완료');
}

// 기존 window.addEventListener('load', ...) 부분을 아래 코드로 통째로 교체해주세요.

window.addEventListener('load', async function () {
    // 1. IndexedDB 초기화가 가장 먼저 실행되도록 보장합니다.
    await localDB.init();
    await loadUserSettings(); // 테마 및 언어 설정 로드

    // 2. 인증 상태 변경을 감지하고 그에 맞게 UI를 설정합니다.
    auth.onAuthStateChanged(async (user) => {
        try {
            const result = await auth.getRedirectResult();
            if (result.user) {
                console.log('리디렉션 로그인 성공:', result.user.displayName);
            }
        } catch (error) {
            console.error('리디렉션 로그인 에러:', error);
        }
        
        if (user) {
            currentUser = user;
            currentUserName = user.displayName || "사용자";
            
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userInfo').textContent = `${user.displayName}님`;
            document.getElementById('userInfo').style.display = 'block';
            
            startAutoSync();
            updateSyncStatus('☁️ 자동 백업 활성화');
            
        } else {
            currentUser = null;
            
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            stopAutoSync();
            updateSyncStatus('💾 로컬 저장 중 (로그인하여 데이터 보호)');
        }

        // 3. 인증 상태가 결정된 후에 앱의 메인 로직을 시작합니다.
        //    (initApp은 이제 로그인 여부와 관계없이 실행됩니다)
        if (!document.body.dataset.appInitialized) {
             await initApp();
             document.body.dataset.appInitialized = 'true'; // 중복 실행 방지
        }
    });

    // 기타 이벤트 리스너 설정
    document.getElementById('loginBtn').addEventListener('click', signIn);
    document.getElementById('logoutBtn').addEventListener('click', signOut);

    document.addEventListener('keydown', (e) => { 
        if (e.key === 'Escape') {
            closeDayModal(); closeFeedbackPopup(); closeReasonModal(); 
            closeFoodSuggestion(); closeManualFoodModal(); closeExcelModal();
        }
        if (document.getElementById('dayModal').style.display === 'flex') {
            if (e.key === 'ArrowLeft') navigateModalDate(-1);
            else if (e.key === 'ArrowRight') navigateModalDate(1);
        }
        if (document.getElementById('calendarPage').classList.contains('active')) { 
            if (e.key === 'ArrowLeft') changeMonth(-1); 
            else if (e.key === 'ArrowRight') changeMonth(1); 
        } 
    });
    
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function (e) {
             if (e.target === this) {
                const closeBtn = this.querySelector('.close-btn');
                if(closeBtn) closeBtn.click();
             }
        });
    });
    
    const inputsToUpdateScoreAndSave = [
        'modalWakeTime', 'modalSeatTime', 'modalMorningPomodoro', 'modalAfternoonPomodoro', 
        'modalEveningPomodoro', 'modalGameTime', 'modalExerciseMinutes', 'modalWriting', 
        'modalSleepTime', 'modalOffDay', 'modalComment'
    ];
    inputsToUpdateScoreAndSave.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            const eventType = (el.type === 'checkbox' || el.tagName === 'SELECT') ? 'change' : 'input';
            el.addEventListener(eventType, () => {
                updateModalScore();
                autoSaveModalData();
            });
        }
    });
    
    document.addEventListener('input', function(e) {
        if (e.target.id && e.target.id.startsWith('personalGoal_')) {
            const goalId = e.target.id.replace('personalGoal_', '');
            updatePersonalGoalValue(goalId, e.target.value);
        }
    });
});
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</body>
</html>
